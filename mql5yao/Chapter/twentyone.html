<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>智能交易*姚 文档站</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/mql5yao/favicon.ico">
    <meta name="description" content="这是智能交易的文档站点。">
    <meta name="keywords" content="MQL,EA,智能交易,自动交易,量化,编程,培训">
    
    <link rel="preload" href="/mql5yao/assets/css/0.styles.c167a2d0.css" as="style"><link rel="preload" href="/mql5yao/assets/js/app.f23448f4.js" as="script"><link rel="preload" href="/mql5yao/assets/js/3.a8269cb7.js" as="script"><link rel="preload" href="/mql5yao/assets/js/17.76fde0dd.js" as="script"><link rel="prefetch" href="/mql5yao/assets/js/10.a59489eb.js"><link rel="prefetch" href="/mql5yao/assets/js/11.1fde020f.js"><link rel="prefetch" href="/mql5yao/assets/js/12.a5634cbb.js"><link rel="prefetch" href="/mql5yao/assets/js/13.1e1b93d8.js"><link rel="prefetch" href="/mql5yao/assets/js/14.17d955a5.js"><link rel="prefetch" href="/mql5yao/assets/js/15.429599a3.js"><link rel="prefetch" href="/mql5yao/assets/js/16.bcf982ab.js"><link rel="prefetch" href="/mql5yao/assets/js/18.49626d28.js"><link rel="prefetch" href="/mql5yao/assets/js/19.0f21f003.js"><link rel="prefetch" href="/mql5yao/assets/js/2.45a03fa6.js"><link rel="prefetch" href="/mql5yao/assets/js/20.18311061.js"><link rel="prefetch" href="/mql5yao/assets/js/21.63b34e06.js"><link rel="prefetch" href="/mql5yao/assets/js/22.a49527a7.js"><link rel="prefetch" href="/mql5yao/assets/js/23.2584759c.js"><link rel="prefetch" href="/mql5yao/assets/js/24.05b32517.js"><link rel="prefetch" href="/mql5yao/assets/js/25.991ff096.js"><link rel="prefetch" href="/mql5yao/assets/js/26.07e08c10.js"><link rel="prefetch" href="/mql5yao/assets/js/27.11150f9e.js"><link rel="prefetch" href="/mql5yao/assets/js/28.b5c9f3ea.js"><link rel="prefetch" href="/mql5yao/assets/js/29.a1ad142f.js"><link rel="prefetch" href="/mql5yao/assets/js/30.6da01d3d.js"><link rel="prefetch" href="/mql5yao/assets/js/31.28fa5dac.js"><link rel="prefetch" href="/mql5yao/assets/js/32.46aab1c1.js"><link rel="prefetch" href="/mql5yao/assets/js/33.f178c7a3.js"><link rel="prefetch" href="/mql5yao/assets/js/34.cd1eae3b.js"><link rel="prefetch" href="/mql5yao/assets/js/35.ee55e50b.js"><link rel="prefetch" href="/mql5yao/assets/js/36.56370362.js"><link rel="prefetch" href="/mql5yao/assets/js/37.2cc5b283.js"><link rel="prefetch" href="/mql5yao/assets/js/38.c3bba64a.js"><link rel="prefetch" href="/mql5yao/assets/js/39.86103eac.js"><link rel="prefetch" href="/mql5yao/assets/js/4.ffd96de7.js"><link rel="prefetch" href="/mql5yao/assets/js/40.0e36f079.js"><link rel="prefetch" href="/mql5yao/assets/js/41.17bccbf6.js"><link rel="prefetch" href="/mql5yao/assets/js/42.a40ca8ac.js"><link rel="prefetch" href="/mql5yao/assets/js/43.5a883397.js"><link rel="prefetch" href="/mql5yao/assets/js/44.19bdddfe.js"><link rel="prefetch" href="/mql5yao/assets/js/45.dec8257c.js"><link rel="prefetch" href="/mql5yao/assets/js/46.ed29615c.js"><link rel="prefetch" href="/mql5yao/assets/js/47.b6d07db1.js"><link rel="prefetch" href="/mql5yao/assets/js/48.d7ca24ca.js"><link rel="prefetch" href="/mql5yao/assets/js/5.47d44717.js"><link rel="prefetch" href="/mql5yao/assets/js/6.1f5c1ae1.js"><link rel="prefetch" href="/mql5yao/assets/js/7.1a679445.js"><link rel="prefetch" href="/mql5yao/assets/js/8.e80e8a9d.js"><link rel="prefetch" href="/mql5yao/assets/js/9.261aef18.js">
    <link rel="stylesheet" href="/mql5yao/assets/css/0.styles.c167a2d0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mql5yao/" class="home-link router-link-active"><img src="/mql5yao/logo.png" alt="智能交易*姚 文档站" class="logo"> <span class="site-name can-hide">智能交易*姚 文档站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mql5yao/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mql5yao/Chapter/start.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/mql5yao/Cutleeks/" class="nav-link">
  割韭菜XX招
</a></div><div class="nav-item"><a href="/mql5yao/support/" class="nav-link">
  支持本站
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mql5yao/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mql5yao/Chapter/start.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/mql5yao/Cutleeks/" class="nav-link">
  割韭菜XX招
</a></div><div class="nav-item"><a href="/mql5yao/support/" class="nav-link">
  支持本站
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MQL5线上手册</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mql5yao/Chapter/start.html" class="sidebar-link">MQL5 参考</a></li><li><a href="/mql5yao/Chapter/one.html" class="sidebar-link">01 第一章 语言基础</a></li><li><a href="/mql5yao/Chapter/two.html" class="sidebar-link">02 第二章 标准常量，列举和架构</a></li><li><a href="/mql5yao/Chapter/three.html" class="sidebar-link">03 第三章 MQL5程序</a></li><li><a href="/mql5yao/Chapter/four.html" class="sidebar-link">04 第四章 预定义变量</a></li><li><a href="/mql5yao/Chapter/five.html" class="sidebar-link">05 第五章 普通函数</a></li><li><a href="/mql5yao/Chapter/six.html" class="sidebar-link">06 第六章 数组函数</a></li><li><a href="/mql5yao/Chapter/add1.html" class="sidebar-link">07 第add1章 矩阵和向量方法</a></li><li><a href="/mql5yao/Chapter/seven.html" class="sidebar-link">07 第七章 函数转换</a></li><li><a href="/mql5yao/Chapter/eight.html" class="sidebar-link">08 第八章 数学函数</a></li><li><a href="/mql5yao/Chapter/nine.html" class="sidebar-link">09 第九章 字符串函数</a></li><li><a href="/mql5yao/Chapter/ten.html" class="sidebar-link">10 第十章 日期和时间</a></li><li><a href="/mql5yao/Chapter/eleven.html" class="sidebar-link">11 第十一章 账户信息</a></li><li><a href="/mql5yao/Chapter/twelve.html" class="sidebar-link">12 第十二章 检测</a></li><li><a href="/mql5yao/Chapter/thirteen.html" class="sidebar-link">13 第十三章 事件处理</a></li><li><a href="/mql5yao/Chapter/fourteen.html" class="sidebar-link">14 第十四章 市场信息</a></li><li><a href="/mql5yao/Chapter/fifteen.html" class="sidebar-link">15 第十五章 经济日历函数</a></li><li><a href="/mql5yao/Chapter/sixteen.html" class="sidebar-link">16 第十六章 时间序列和指标访问</a></li><li><a href="/mql5yao/Chapter/seventeen.html" class="sidebar-link">17 第十七章 自定义交易品种</a></li><li><a href="/mql5yao/Chapter/eighteen.html" class="sidebar-link">18 第十八章 图表操作</a></li><li><a href="/mql5yao/Chapter/ninteen.html" class="sidebar-link">19 第十九章 交易函数</a></li><li><a href="/mql5yao/Chapter/twenty.html" class="sidebar-link">20 第二十章 交易信号</a></li><li><a href="/mql5yao/Chapter/twentyone.html" aria-current="page" class="active sidebar-link">21 第二十一章 网络函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-1-socketcreate" class="sidebar-link">21.1 SocketCreate</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-2-socketclose" class="sidebar-link">21.2 SocketClose</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-3-socketconnect" class="sidebar-link">21.3 SocketConnect</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-4-socketisconnected" class="sidebar-link">21.4 SocketIsConnected</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-5-socketisreadable" class="sidebar-link">21.5 SocketIsReadable</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-6-socketiswritable" class="sidebar-link">21.6 SocketIsWritable</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-7-sockettimeouts" class="sidebar-link">21.7 SocketTimeouts</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-8-socketread" class="sidebar-link">21.8 SocketRead</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-9-socketsend" class="sidebar-link">21.9 SocketSend</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-10-sockettlshandshake" class="sidebar-link">21.10 SocketTlsHandshake</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-11-sockettlscertificate" class="sidebar-link">21.11 SocketTlsCertificate</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-12-sockettlsread" class="sidebar-link">21.12 SocketTlsRead</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-13-sockettlsreadavailable" class="sidebar-link">21.13 SocketTlsReadAvailable</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-15-webrequest" class="sidebar-link">21.15 WebRequest</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-16-sendftp" class="sidebar-link">21.16 SendFTP</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-17-sendmail" class="sidebar-link">21.17 SendMail</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentyone.html#_21-18-sendnotification" class="sidebar-link">21.18 SendNotification</a></li></ul></li><li><a href="/mql5yao/Chapter/twentytwo.html" class="sidebar-link">22 第二十二章 程序端全局变量</a></li><li><a href="/mql5yao/Chapter/twentythree.html" class="sidebar-link">23 第二十三章 文件函数</a></li><li><a href="/mql5yao/Chapter/twentyfour.html" class="sidebar-link">24 第二十四章 自定义指标</a></li><li><a href="/mql5yao/Chapter/twentyfive.html" class="sidebar-link">25 第二十五章 物件函数</a></li><li><a href="/mql5yao/Chapter/twentysix.html" class="sidebar-link">26 第二十六章 技术指标</a></li><li><a href="/mql5yao/Chapter/twentyseven.html" class="sidebar-link">27 第二十七章 处理优化结果</a></li><li><a href="/mql5yao/Chapter/twentyeight.html" class="sidebar-link">28 第二十八章 工作事件</a></li><li><a href="/mql5yao/Chapter/twentynine.html" class="sidebar-link">29 第二十九章 使用OpenCL工作</a></li><li><a href="/mql5yao/Chapter/thirty.html" class="sidebar-link">30 第三十章 使用数据库</a></li><li><a href="/mql5yao/Chapter/thirtyone.html" class="sidebar-link">31 第三十一章 使用DirectX</a></li><li><a href="/mql5yao/Chapter/thirtytwo.html" class="sidebar-link">32 第三十二章 集成</a></li><li><a href="/mql5yao/Chapter/add2.html" class="sidebar-link">32 第add2章 ONNX模型</a></li><li><a href="/mql5yao/Chapter/thirtythree.html" class="sidebar-link">33 第三十三章 标准程序库</a></li><li><a href="/mql5yao/Chapter/AppendixI.html" class="sidebar-link">34 附录一 来自MQL4</a></li><li><a href="/mql5yao/Chapter/AppendixII.html" class="sidebar-link">35 附录二 MQL5 函数列表</a></li><li><a href="/mql5yao/Chapter/AppendixIII.html" class="sidebar-link">36 附录三 MQL5常量列表</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2> 第二十一章  网络功能（函数）</h2> <p>MQL 5程序可以与远程服务器交换数据，还可以通过FTP发送推送通知、电子邮件和数据。</p> <p>• Socket 开头的函数组允许通过系统套接字与远程主机建立TCP连接(包括安全的TLS)。操作原理很简单：创建一个套接字，连接到 服务器并开始读取和写入数据。
• WebRequest函数设计用于处理Web资源，并允许轻松发送HTTP请求(包括GET和POST).
• SendFTP、Sendmail和SendNotification是发送文件、电子邮件和移动通知的更简单的功能。</p> <p><img src="/mql5yao/assets/img/thi36.d3501c97.png" alt="浏览器开发工具"></p> <p>为了最终用户安全，允许的IP地址列表在客户端实现.该列表包含允许通过套接字 和WebReq连接到的MQL 5程序的IP地址。 最重要的功能。例如，如果程序需要连接到 <code>https://www.someserver.com</code>,此地址应由列表中的终端用户显式指示。不能以编程方式添加地址.</p> <p>将地址添加到列表中</p> <p>向MQL 5程序添加显式消息，通知用户需要附加配置。您可以通过#property description, Alert 或 Print.来做到这一点。</p> <table><thead><tr><th>函数</th> <th>功能</th></tr></thead> <tbody><tr><td>SocketCreate</td> <td>创建带有指定标志的连接套接字并返回其句柄</td></tr> <tr><td>SocketClose</td> <td>关闭连接</td></tr> <tr><td>SocketConnect</td> <td>使用超时控件连接到服务器</td></tr> <tr><td>SocketIsReadable</td> <td>获取可以从套接字读取的字节数。</td></tr> <tr><td>SocketIsWritable</td> <td>检查当前是否可以将数据写入套接字。</td></tr> <tr><td>SocketTimeouts</td> <td>为套接字系统对象设置接收和发送数据的超时</td></tr> <tr><td>SocketRead</td> <td>从套接字读取数据</td></tr> <tr><td>SocketSend</td> <td>将数据写入套接字</td></tr> <tr><td>SocketTlsHandshake</td> <td>通过TLS握手协议启动到指定主机的安全TLS(SSL)连接。</td></tr> <tr><td>SocketTlsCertificate</td> <td>获取用于保护网络连接的证书上的数据。</td></tr> <tr><td>SocketTlsRead</td> <td>从安全的TLS连接读取数据</td></tr> <tr><td>SocketTlsReadAvailable</td> <td>从安全的TLS连接读取所有可用数据。</td></tr> <tr><td>SocketTlsSend</td> <td>通过安全的TLS连接发送数据</td></tr> <tr><td>WebRequest</td> <td>发送 HTTP 请求到指定服务器</td></tr> <tr><td>SendFTP</td> <td>在&quot;Publisher&quot; 标签窗口中设置发送文件地址</td></tr> <tr><td>SendMail</td> <td>在&quot;Mailbox&quot;标签窗口中发送邮件到指定地址</td></tr> <tr><td>SendNotification</td> <td>向在“通知”标签指定MetaQuotes ID的移动程序端发送推送通知</td></tr></tbody></table> <h2 id="_21-1-socketcreate"><a href="#_21-1-socketcreate" class="header-anchor">#</a> 21.1 SocketCreate</h2> <p>创建具有指定标志的套接字并返回其句柄。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">SocketCreate</span><span class="token punctuation">(</span> 
   uint     flags         <span class="token comment">// flags </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>flags</p> <p>[in] 定义使用套接字的模式的标志组合。目前，只支持一个标志-Socket_DEFAULT。</p> <p>返回值</p> <p>如果套接字创建成功，返回其句柄，否则无效句柄。</p> <p>注意</p> <p>若要从未使用的套接字中释放计算机内存，请调用套接字。</p> <p>您可以从一个MQL 5程序最多创建128个套接字。如果超出限制，则将错误5271(ERR_NETSOCKET_OUL_ONY_OPEN)写入 _LastError。</p> <p>该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标中调用，GetLastError()返回错误4014-“函数禁止调用”。</p> <p>例</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//|                                                SocketExample.mq5 |</span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. |</span>
<span class="token comment">//|                                             https://www.mql5.com |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright   </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link        </span><span class="token string">&quot;https://www.mql5.com&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version     </span><span class="token string">&quot;1.00&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Add Address to the list of allowed ones in the terminal settings to let the example work&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">script_show_inputs</span></span>
 
input string Address<span class="token operator">=</span><span class="token string">&quot;www.mql5.com&quot;</span><span class="token punctuation">;</span>
input <span class="token keyword">int</span>    Port   <span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span>         ExtTLS <span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Send command to the server                                       |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPSend</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>string request<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span> req<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span>  len<span class="token operator">=</span><span class="token function">StringToCharArray</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>req<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if secure TLS connection is used via the port 443</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketTlsSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if standard TCP connection is used</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Read server response                                             |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPRecv</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>uint timeout<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span>   rsp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   string result<span class="token punctuation">;</span>
   uint   timeout_check<span class="token operator">=</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>timeout<span class="token punctuation">;</span>
<span class="token comment">//--- read data from sockets till they are still present but not longer than timeout</span>
   <span class="token keyword">do</span>
     <span class="token punctuation">{</span>
      uint len<span class="token operator">=</span><span class="token function">SocketIsReadable</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token keyword">int</span> rsp_len<span class="token punctuation">;</span>
         <span class="token comment">//--- various reading commands depending on whether the connection is secure or not</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketTlsRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">else</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">,</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//--- analyze the response</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>rsp_len<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            result<span class="token operator">+=</span><span class="token function">CharArrayToString</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>rsp_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- print only the response header</span>
            <span class="token keyword">int</span> header_end<span class="token operator">=</span><span class="token function">StringFind</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token string">&quot;\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>header_end<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token punctuation">{</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP answer header received:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">StringSubstr</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>header_end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> timeout_check <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Script program start function                                    |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">int</span> socket<span class="token operator">=</span><span class="token function">SocketCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- check the handle</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>socket<span class="token operator">!=</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- connect if all is well</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketConnect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>Address<span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Established connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
         string   subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">;</span>
         datetime expiration<span class="token punctuation">;</span>
         <span class="token comment">//--- if connection is secured by the certificate, display its data</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketTlsCertificate</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;TLS certificate:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Owner:  &quot;</span><span class="token punctuation">,</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Issuer:  &quot;</span><span class="token punctuation">,</span>issuer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Number:     &quot;</span><span class="token punctuation">,</span>serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Print: &quot;</span><span class="token punctuation">,</span>thumbprint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Expiration: &quot;</span><span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ExtTLS<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token comment">//--- send GET request to the server</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HTTPSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token string">&quot;GET / HTTP/1.1\r\nHost: www.mql5.com\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;GET request sent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- read the response</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">HTTPRecv</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get a response, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token keyword">else</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to send GET request, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token string">&quot; failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//--- close a socket after using</span>
      <span class="token function">SocketClose</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create a socket, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div><h2 id="_21-2-socketclose"><a href="#_21-2-socketclose" class="header-anchor">#</a> 21.2 SocketClose</h2> <p>关闭连接。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">SocketClose</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> <span class="token keyword">int</span>  socket      <span class="token comment">// socket handle </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>socket</p> <p>[in] 要关闭的插座的手柄。句柄由SocketCreate函数返回。当传递不正确的句柄时，错误5270(ERR_NETSOCKET_INVALIDHANDLE)被写入_LastError。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。</p> <p>注意</p> <p>如果以前为套接字创建了通过SocketConnect的连接，则将停止连接。</p> <p>该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。</p> <p>例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//|                                                SocketExample.mq5 |</span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. |</span>
<span class="token comment">//|                                             https://www.mql5.com |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright   </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link        </span><span class="token string">&quot;https://www.mql5.com&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version     </span><span class="token string">&quot;1.00&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Add Address to the list of allowed ones in the terminal settings to let the example work&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">script_show_inputs</span></span>
 
input string Address<span class="token operator">=</span><span class="token string">&quot;www.mql5.com&quot;</span><span class="token punctuation">;</span>
input <span class="token keyword">int</span>    Port   <span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span>         ExtTLS <span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Send command to the server                                       |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPSend</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>string request<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span> req<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span>  len<span class="token operator">=</span><span class="token function">StringToCharArray</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>req<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if secure TLS connection is used via the port 443</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketTlsSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if standard TCP connection is used</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Read server response                                             |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPRecv</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>uint timeout<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span>   rsp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   string result<span class="token punctuation">;</span>
   uint   timeout_check<span class="token operator">=</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>timeout<span class="token punctuation">;</span>
<span class="token comment">//--- read data from sockets till they are still present but not longer than timeout</span>
   <span class="token keyword">do</span>
     <span class="token punctuation">{</span>
      uint len<span class="token operator">=</span><span class="token function">SocketIsReadable</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token keyword">int</span> rsp_len<span class="token punctuation">;</span>
         <span class="token comment">//--- various reading commands depending on whether the connection is secure or not</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketTlsRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">else</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">,</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//--- analyze the response</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>rsp_len<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            result<span class="token operator">+=</span><span class="token function">CharArrayToString</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>rsp_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- print only the response header</span>
            <span class="token keyword">int</span> header_end<span class="token operator">=</span><span class="token function">StringFind</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token string">&quot;\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>header_end<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token punctuation">{</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP answer header received:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">StringSubstr</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>header_end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>timeout_check <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Script program start function                                    |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">int</span> socket<span class="token operator">=</span><span class="token function">SocketCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- check the handle</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>socket<span class="token operator">!=</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- connect if all is well</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketConnect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>Address<span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Established connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
         string   subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">;</span>
         datetime expiration<span class="token punctuation">;</span>
         <span class="token comment">//--- if connection is secured by the certificate, display its data</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketTlsCertificate</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;TLS certificate:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Owner:  &quot;</span><span class="token punctuation">,</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Issuer:  &quot;</span><span class="token punctuation">,</span>issuer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Number:     &quot;</span><span class="token punctuation">,</span>serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Print: &quot;</span><span class="token punctuation">,</span>thumbprint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Expiration: &quot;</span><span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ExtTLS<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token comment">//--- send GET request to the server</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HTTPSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token string">&quot;GET / HTTP/1.1\r\nHost: www.mql5.com\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;GET request sent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- read the response</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">HTTPRecv</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get a response, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token keyword">else</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to send GET request, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token string">&quot; failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//--- close a socket after using</span>
      <span class="token function">SocketClose</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create a socket, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div><h2 id="_21-3-socketconnect"><a href="#_21-3-socketconnect" class="header-anchor">#</a> 21.3 SocketConnect</h2> <p>使用超时控件连接到服务器.</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">SocketConnect</span><span class="token punctuation">(</span> 
   <span class="token keyword">int</span>           socket<span class="token punctuation">,</span>               <span class="token comment">// socket </span>
   <span class="token keyword">const</span> string  server<span class="token punctuation">,</span>               <span class="token comment">// connection address </span>
   uint          port<span class="token punctuation">,</span>                 <span class="token comment">// connection port </span>
   uint          timeout_receive_ms    <span class="token comment">// connection timeout </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数</p> <p>socket</p> <p>[in] SocketCreate函数返回的套接字句柄。当传递不正确的句柄时，错误5270(ERR_NETSOCKET_INVALIDHANDLE)被写入_LastError。</p> <p>server</p> <p>[in] 要连接到的服务器的域名或其IP地址。</p> <p>port</p> <p>[in] 连接的端口号</p> <p>timeout_receive_ms</p> <p>[in] 连接超时(毫秒)。如果在此时间间隔内未建立连接，则停止尝试。</p> <p>返回值</p> <p>如果连接成功，则返回true，否则返回false。</p> <p>注意</p> <p>连接地址应该添加到客户端允许的连接地址列表中(Tools\Options\ExpertAdvisors)。</p> <p>如果连接失败，则将错误5272(ERR_NETSOCKET_NOT_CONNECT)写入_LastError。</p> <p>该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。</p> <p>例:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//|                                                SocketExample.mq5 |</span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. |</span>
<span class="token comment">//|                                             https://www.mql5.com |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright   </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link        </span><span class="token string">&quot;https://www.mql5.com&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version     </span><span class="token string">&quot;1.00&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Add Address to the list of allowed ones in the terminal settings to let the example work&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">script_show_inputs</span></span>
 
input string Address<span class="token operator">=</span><span class="token string">&quot;www.mql5.com&quot;</span><span class="token punctuation">;</span>
input <span class="token keyword">int</span>    Port   <span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span>         ExtTLS <span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Send command to the server                                       |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPSend</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>string request<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span> req<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span>  len<span class="token operator">=</span><span class="token function">StringToCharArray</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>req<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if secure TLS connection is used via the port 443</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketTlsSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if standard TCP connection is used</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Read server response                                             |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPRecv</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>uint timeout<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span>   rsp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   string result<span class="token punctuation">;</span>
   uint   timeout_check<span class="token operator">=</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>timeout<span class="token punctuation">;</span>
<span class="token comment">//--- read data from sockets till they are still present but not longer than timeout</span>
   <span class="token keyword">do</span>
     <span class="token punctuation">{</span>
      uint len<span class="token operator">=</span><span class="token function">SocketIsReadable</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token keyword">int</span> rsp_len<span class="token punctuation">;</span>
         <span class="token comment">//--- various reading commands depending on whether the connection is secure or not</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketTlsRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">else</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">,</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//--- analyze the response</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>rsp_len<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            result<span class="token operator">+=</span><span class="token function">CharArrayToString</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>rsp_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- print only the response header</span>
            <span class="token keyword">int</span> header_end<span class="token operator">=</span><span class="token function">StringFind</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token string">&quot;\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>header_end<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token punctuation">{</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP answer header received:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">StringSubstr</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>header_end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>timeout_check <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Script program start function                                    |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">int</span> socket<span class="token operator">=</span><span class="token function">SocketCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- check the handle</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>socket<span class="token operator">!=</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- connect if all is well</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketConnect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>Address<span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Established connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
         string   subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">;</span>
         datetime expiration<span class="token punctuation">;</span>
         <span class="token comment">//--- if connection is secured by the certificate, display its data</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketTlsCertificate</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;TLS certificate:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Owner:  &quot;</span><span class="token punctuation">,</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Issuer:  &quot;</span><span class="token punctuation">,</span>issuer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Number:     &quot;</span><span class="token punctuation">,</span>serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Print: &quot;</span><span class="token punctuation">,</span>thumbprint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Expiration: &quot;</span><span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ExtTLS<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token comment">//--- send GET request to the server</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HTTPSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token string">&quot;GET / HTTP/1.1\r\nHost: www.mql5.com\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;GET request sent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- read the response</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">HTTPRecv</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get a response, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token keyword">else</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to send GET request, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token string">&quot; failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//--- close a socket after using</span>
      <span class="token function">SocketClose</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create a socket, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div><h2 id="_21-4-socketisconnected"><a href="#_21-4-socketisconnected" class="header-anchor">#</a> 21.4 SocketIsConnected</h2> <p>检查套接字当前是否已连接。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">SocketIsConnected</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> <span class="token keyword">int</span>  socket      <span class="token comment">// socket handle </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>socket</p> <p>[in] SocketCreate()函数返回的套接字句柄。当将不正确的句柄传递给_LastError时，将激活错误5270(ERR_NETSOCKET_INVALIDHANDLE)。</p> <p>返回值</p> <p>如果套接字已连接，则返回true，否则为false。</p> <p>注意</p> <p>函数允许检查当前套接字连接状态。</p> <p>该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。</p> <p>参考</p> <p>SocketConnect, SocketIsWritable, SocketCreate, SocketClose</p> <h2 id="_21-5-socketisreadable"><a href="#_21-5-socketisreadable" class="header-anchor">#</a> 21.5 SocketIsReadable</h2> <p>获取可以从套接字读取的字节数。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>uint  <span class="token function">SocketIsReadable</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> <span class="token keyword">int</span>  socket      <span class="token comment">// socket handle </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>socket</p> <p>[in] SocketCreate函数返回的套接字句柄。当将不正确的句柄传递给_LastError时，将激活错误5270(ERR_NETSOCKET_INVALIDHANDLE)。</p> <p>返回值</p> <p>可计算的字节数。如果出现错误，则返回0。</p> <p>注意</p> <p>如果在执行函数时系统套接字上发生错误，则将停止通过SocketConnect建立的连接。</p> <p>在调用SocketRead之前，请检查套接字是否具有读取数据的功能。否则，如果没有数据，SocketRead函数将在timeout_ms内等待数据，延迟程序执行。</p> <p>该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。</p> <p>例:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//|                                                SocketExample.mq5 |</span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. |</span>
<span class="token comment">//|                                             https://www.mql5.com |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright   </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link        </span><span class="token string">&quot;https://www.mql5.com&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version     </span><span class="token string">&quot;1.00&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Add Address to the list of allowed ones in the terminal settings to let the example work&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">script_show_inputs</span></span>
 
input string Address<span class="token operator">=</span><span class="token string">&quot;www.mql5.com&quot;</span><span class="token punctuation">;</span>
input <span class="token keyword">int</span>    Port   <span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span>         ExtTLS <span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Send command to the server                                       |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPSend</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>string request<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span> req<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span>  len<span class="token operator">=</span><span class="token function">StringToCharArray</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>req<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if secure TLS connection is used via the port 443</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketTlsSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if standard TCP connection is used</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Read server response                                             |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPRecv</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>uint timeout<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span>   rsp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   string result<span class="token punctuation">;</span>
   uint   timeout_check<span class="token operator">=</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>timeout<span class="token punctuation">;</span>
<span class="token comment">//--- read data from sockets till they are still present but not longer than timeout</span>
   <span class="token keyword">do</span>
     <span class="token punctuation">{</span>
      uint len<span class="token operator">=</span><span class="token function">SocketIsReadable</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token keyword">int</span> rsp_len<span class="token punctuation">;</span>
         <span class="token comment">//--- various reading commands depending on whether the connection is secure or not</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketTlsRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">else</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">,</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//--- analyze the response</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>rsp_len<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            result<span class="token operator">+=</span><span class="token function">CharArrayToString</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>rsp_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- print only the response header</span>
            <span class="token keyword">int</span> header_end<span class="token operator">=</span><span class="token function">StringFind</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token string">&quot;\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>header_end<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token punctuation">{</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP answer header received:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">StringSubstr</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>header_end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>timeout_check <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Script program start function                                    |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">int</span> socket<span class="token operator">=</span><span class="token function">SocketCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- check the handle</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>socket<span class="token operator">!=</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- connect if all is well</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketConnect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>Address<span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Established connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
         string   subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">;</span>
         datetime expiration<span class="token punctuation">;</span>
         <span class="token comment">//--- if connection is secured by the certificate, display its data</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketTlsCertificate</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;TLS certificate:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Owner:  &quot;</span><span class="token punctuation">,</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Issuer:  &quot;</span><span class="token punctuation">,</span>issuer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Number:     &quot;</span><span class="token punctuation">,</span>serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Print: &quot;</span><span class="token punctuation">,</span>thumbprint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Expiration: &quot;</span><span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ExtTLS<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token comment">//--- send GET request to the server</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HTTPSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token string">&quot;GET / HTTP/1.1\r\nHost: www.mql5.com\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;GET request sent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- read the response</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">HTTPRecv</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get a response, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token keyword">else</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to send GET request, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token string">&quot; failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//--- close a socket after using</span>
      <span class="token function">SocketClose</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create a socket, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br></div></div><h2 id="_21-6-socketiswritable"><a href="#_21-6-socketiswritable" class="header-anchor">#</a> 21.6 SocketIsWritable</h2> <p>检查当前是否可以将数据写入套接字。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">SocketIsWritable</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> <span class="token keyword">int</span>  socket      <span class="token comment">// socket handle </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>socket</p> <p>[in] SocketCreate函数返回的套接字句柄。当传递不正确的句柄时，错误5270(ERR_NETSOCKET_INVALIDHANDLE)被写入_LastError。</p> <p>返回值</p> <p>如果可能写入，则返回true，否则为false。.</p> <p>注意</p> <p>此函数允许您检查是否可以立即将数据写入套接字。</p> <p>如果在执行函数时系统套接字上发生错误，则将停止通过SocketConnect建立的连接。</p> <p>该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。</p> <h2 id="_21-7-sockettimeouts"><a href="#_21-7-sockettimeouts" class="header-anchor">#</a> 21.7 SocketTimeouts</h2> <p>设置接收和发送套接字系统对象数据的超时。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">SocketTimeouts</span><span class="token punctuation">(</span> 
   <span class="token keyword">int</span>           socket<span class="token punctuation">,</span>               <span class="token comment">// socket </span>
   uint          timeout_send_ms<span class="token punctuation">,</span>      <span class="token comment">// data sending timeout </span>
   uint          timeout_receive_ms    <span class="token comment">// data obtaining timeout </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>socket</p> <p>[in] SocketCreate函数返回的套接字句柄。当传递不正确的句柄时，错误5270(ERR_NETSOCKET_INVALIDHANDLE)被写入_LastError。</p> <p>timeout_send_ms</p> <p>[in] 发送超时的数据以毫秒为单位。</p> <p>timeout_receive_ms</p> <p>[in] 数据获取超时(以毫秒为单位)。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。</p> <p>注意</p> <p>不要混淆系统对象超时和通过SocketRead读取数据时设置的超时。SocketTimeout为操作系统中的套接字对象设置一次超时。这些超时将被应用 d通过这个套接字读取和发送数据的所有函数。在SocketRead中，为特定的数据读取操作设置超时。</p> <p>该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。</p> <h2 id="_21-8-socketread"><a href="#_21-8-socketread" class="header-anchor">#</a> 21.8 SocketRead</h2> <p>从套接字读取数据。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">SocketRead</span><span class="token punctuation">(</span> 
   <span class="token keyword">int</span>           socket<span class="token punctuation">,</span>               <span class="token comment">// socket </span>
   uchar<span class="token operator">&amp;</span>        buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment">// buffer for reading data from socket </span>
   uint          buffer_maxlen<span class="token punctuation">,</span>        <span class="token comment">// number of bytes to read </span>
   uint          timeout_ms            <span class="token comment">// reading timeout </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数</p> <p>socket</p> <p>[in] SocketCreate函数返回的套接字句柄。当将不正确的句柄传递给_LastError时，将激活错误5270(ERR_NETSOCKET_INVALIDHANDLE)。</p> <p>buffer</p> <p>[out] 对数据读取的uchar类型数组的引用。动态数组大小随读取字节数的增加而增加。数组大小不能超过int_max(2147483647)。</p> <p>buffer_maxlen</p> <p>[in] 要读取到缓冲区[]数组的字节数。不适合数组的数据保留在套接字中。它们可以在下一个SocketRead电话中接收到。缓冲器_maxlen不能超过int_max(2147483647) .</p> <p>timeout_ms</p> <p>[in] 数据读取超时(毫秒)。如果在此时间内未获得数据，则停止尝试，函数返回-1。</p> <p>返回值</p> <p>如果成功，则返回读取字节数。如果出现错误，则返回-1。</p> <p>注意</p> <p>如果在执行函数时系统套接字上发生错误，则将停止通过SocketConnect建立的连接。</p> <p>在数据读取错误的情况下，错误5273(Err_NETSOCKET_IO_Error)用_LastError编写。</p> <p>该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。</p> <p>例:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//|                                                SocketExample.mq5 |</span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. |</span>
<span class="token comment">//|                                             https://www.mql5.com |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright   </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link        </span><span class="token string">&quot;https://www.mql5.com&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version     </span><span class="token string">&quot;1.00&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Add Address to the list of allowed ones in the terminal settings to let the example work&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">script_show_inputs</span></span>
 
input string Address<span class="token operator">=</span><span class="token string">&quot;www.mql5.com&quot;</span><span class="token punctuation">;</span>
input <span class="token keyword">int</span>    Port   <span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span>         ExtTLS <span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Send command to the server                                       |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPSend</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>string request<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span> req<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span>  len<span class="token operator">=</span><span class="token function">StringToCharArray</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>req<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if secure TLS connection is used via the port 443</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketTlsSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if standard TCP connection is used</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Read server response                                            |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPRecv</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>uint timeout<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span>   rsp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   string result<span class="token punctuation">;</span>
   uint   timeout_check<span class="token operator">=</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>timeout<span class="token punctuation">;</span>
<span class="token comment">//--- read data from sockets till they are still present but not longer than timeout</span>
   <span class="token keyword">do</span>
     <span class="token punctuation">{</span>
      uint len<span class="token operator">=</span><span class="token function">SocketIsReadable</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token keyword">int</span> rsp_len<span class="token punctuation">;</span>
         <span class="token comment">//--- various reading commands depending on whether the connection is secure or not</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketTlsRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">else</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">,</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//--- analyze the response</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>rsp_len<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            result<span class="token operator">+=</span><span class="token function">CharArrayToString</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>rsp_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- print only the response header</span>
            <span class="token keyword">int</span> header_end<span class="token operator">=</span><span class="token function">StringFind</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token string">&quot;\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>header_end<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token punctuation">{</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP answer header received:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">StringSubstr</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>header_end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>timeout_check <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Script program start function                                    |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">int</span> socket<span class="token operator">=</span><span class="token function">SocketCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- check the handle</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>socket<span class="token operator">!=</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- connect if all is well</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketConnect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>Address<span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Established connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
         string   subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">;</span>
         datetime expiration<span class="token punctuation">;</span>
         <span class="token comment">//--- if connection is secured by the certificate, display its data</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketTlsCertificate</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;TLS certificate:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Owner:  &quot;</span><span class="token punctuation">,</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Issuer:  &quot;</span><span class="token punctuation">,</span>issuer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Number:     &quot;</span><span class="token punctuation">,</span>serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Print: &quot;</span><span class="token punctuation">,</span>thumbprint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Expiration: &quot;</span><span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ExtTLS<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token comment">//--- send GET request to the server</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HTTPSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token string">&quot;GET / HTTP/1.1\r\nHost: www.mql5.com\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;GET request sent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- read the response</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">HTTPRecv</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get a response, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token keyword">else</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to send GET request, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token string">&quot; failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//--- close a socket after using</span>
      <span class="token function">SocketClose</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create a socket, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div><h2 id="_21-9-socketsend"><a href="#_21-9-socketsend" class="header-anchor">#</a> 21.9 SocketSend</h2> <p>将数据写入套接字。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">SocketSend</span><span class="token punctuation">(</span> 
   <span class="token keyword">int</span>           socket<span class="token punctuation">,</span>               <span class="token comment">// socket </span>
   <span class="token keyword">const</span> uchar<span class="token operator">&amp;</span>  buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment">// data buffer </span>
   uint          buffer_len            <span class="token comment">// buffer size </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>返回值</p> <p>socket</p> <p>[in] SocketCreate函数返回的套接字句柄。当传递不正确的句柄时，错误5270(ERR_NETSOCKET_INVALIDHANDLE)被写入_LastError。</p> <p>buffer</p> <p>[in] 引用带有要发送到套接字的数据的uchar类型数组。</p> <p>buffer_len</p> <p>[in] “缓冲区”数组大小。</p> <p>返回值</p> <p>如果成功，则返回写入套接字的字节数。如果出现错误，则返回-1。</p> <p>注意</p> <p>如果在执行函数时系统套接字上发生错误，则将停止通过SocketConnect建立的连接。</p> <p>在数据写入错误的情况下，将错误5273(Err_NETSOCKET_IO_Error)写入_LastError。</p> <p>该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。</p> <p>例:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//|                                                SocketExample.mq5 |</span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. |</span>
<span class="token comment">//|                                             https://www.mql5.com |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright   </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link        </span><span class="token string">&quot;https://www.mql5.com&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version     </span><span class="token string">&quot;1.00&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Add Address to the list of allowed ones in the terminal settings to let the example work&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">script_show_inputs</span></span>
 
input string Address<span class="token operator">=</span><span class="token string">&quot;www.mql5.com&quot;</span><span class="token punctuation">;</span>
input <span class="token keyword">int</span>    Port   <span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span>         ExtTLS <span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Send command to the server                                       |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPSend</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>string request<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span> req<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span>  len<span class="token operator">=</span><span class="token function">StringToCharArray</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>req<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if secure TLS connection is used via the port 443</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketTlsSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if standard TCP connection is used</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Read server response                                             |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPRecv</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>uint timeout<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span>   rsp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   string result<span class="token punctuation">;</span>
   uint   timeout_check<span class="token operator">=</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>timeout<span class="token punctuation">;</span>
<span class="token comment">//--- read data from sockets till they are still present but not longer than timeout</span>
   <span class="token keyword">do</span>
     <span class="token punctuation">{</span>
      uint len<span class="token operator">=</span><span class="token function">SocketIsReadable</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token keyword">int</span> rsp_len<span class="token punctuation">;</span>
         <span class="token comment">//--- various reading commands depending on whether the connection is secure or not</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketTlsRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">else</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">,</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//--- analyze the response</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>rsp_len<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            result<span class="token operator">+=</span><span class="token function">CharArrayToString</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>rsp_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- print only the response header</span>
            <span class="token keyword">int</span> header_end<span class="token operator">=</span><span class="token function">StringFind</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token string">&quot;\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>header_end<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token punctuation">{</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP answer header received:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">StringSubstr</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>header_end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>timeout_check <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Script program start function                                    |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">int</span> socket<span class="token operator">=</span><span class="token function">SocketCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- check the handle</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>socket<span class="token operator">!=</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- connect if all is well</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketConnect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>Address<span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Established connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
         string   subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">;</span>
         datetime expiration<span class="token punctuation">;</span>
         <span class="token comment">//--- if connection is secured by the certificate, display its data</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketTlsCertificate</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;TLS certificate:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Owner:  &quot;</span><span class="token punctuation">,</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Issuer:  &quot;</span><span class="token punctuation">,</span>issuer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Number:     &quot;</span><span class="token punctuation">,</span>serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Print: &quot;</span><span class="token punctuation">,</span>thumbprint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Expiration: &quot;</span><span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ExtTLS<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token comment">//--- send GET request to the server</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HTTPSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token string">&quot;GET / HTTP/1.1\r\nHost: www.mql5.com\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;GET request sent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- read the response</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">HTTPRecv</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get a response, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token keyword">else</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to send GET request, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token string">&quot; failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//--- close a socket after using</span>
      <span class="token function">SocketClose</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create a socket, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div><p>参见
SocketTimeouts, MathSwap, StringToCharArray</p> <h2 id="_21-10-sockettlshandshake"><a href="#_21-10-sockettlshandshake" class="header-anchor">#</a> 21.10 SocketTlsHandshake</h2> <p>通过TLS握手协议启动到指定主机的安全TLS(SSL)连接。在握手过程中，客户端和服务器在连接参数上达成一致：应用协议版本和数据加密。 关于方法。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">SocketTlsHandshake</span><span class="token punctuation">(</span> 
   <span class="token keyword">int</span>           socket<span class="token punctuation">,</span>               <span class="token comment">// socket </span>
   <span class="token keyword">const</span> string  host                  <span class="token comment">// host address </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数</p> <p>socket</p> <p>[in] SocketCreate函数返回的套接字句柄。当传递不正确的句柄时，错误5270(ERR_NETSOCKET_INVALIDHANDLE)被写入_LastError。</p> <p>host</p> <p>[in] 建立安全连接的主机的地址。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。</p> <p>注意</p> <p>在安全连接之前，程序应该使用SocketConnect与主机建立标准TCP连接。</p> <p>如果安全连接失败，则将错误5274(ERR_NETSOCKET_HANDHAND_FILED)写入_LastError。</p> <p>连接到端口443时不需要调用该函数。这是用于安全TLS(SSL)连接的标准TCP端口。 该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。</p> <h2 id="_21-11-sockettlscertificate"><a href="#_21-11-sockettlscertificate" class="header-anchor">#</a> 21.11 SocketTlsCertificate</h2> <p>获取用于保护网络连接的证书上的数据。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">SocketTlsCertificate</span><span class="token punctuation">(</span> 
   <span class="token keyword">int</span>           socket<span class="token punctuation">,</span>               <span class="token comment">// socket </span>
   string<span class="token operator">&amp;</span>       subject<span class="token punctuation">,</span>              <span class="token comment">// certificate owner </span>
   string<span class="token operator">&amp;</span>       issuer<span class="token punctuation">,</span>               <span class="token comment">// certificate issuer </span>
   string<span class="token operator">&amp;</span>       serial<span class="token punctuation">,</span>               <span class="token comment">// certificate serial number </span>
   string<span class="token operator">&amp;</span>       thumbprint<span class="token punctuation">,</span>           <span class="token comment">// certificate print </span>
   datetime<span class="token operator">&amp;&amp;</span>     expiration            <span class="token comment">// certificate expiration </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>参数</p> <p>socket</p> <p>[in] SocketCreate函数返回的套接字句柄。当传递不正确的句柄时，错误5270(ERR_NETSOCKET_INVALIDHANDLE)被写入_LastError。</p> <p>subject</p> <p>[in] 证书所有者名称。对应于主题字段。</p> <p>issuer</p> <p>[in] 证书所有者名称。对应于Issuer字段。</p> <p>serial</p> <p>[in] 证书序列号。对应于SerialNumber字段。</p> <p>thumbprint</p> <p>[in] 证书打印。对应于来自整个证书文件的SHA-1散列(所有字段，包括颁发者签名)。</p> <p>expiration</p> <p>[in] 日期时间格式的证书过期日期。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。 注意</p> <p>只有在使用SocketTlsHand握手建立安全连接之后才能请求证书数据。</p> <p>如果证书获取错误，则将错误5275(err_NETSOCKET_NO_证书)写入_LastError。</p> <p>该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。</p> <h2 id="_21-12-sockettlsread"><a href="#_21-12-sockettlsread" class="header-anchor">#</a> 21.12 SocketTlsRead</h2> <p>取消订阅。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">SocketTlsRead</span><span class="token punctuation">(</span> 
   <span class="token keyword">int</span>           socket<span class="token punctuation">,</span>               <span class="token comment">// socket </span>
   uchar<span class="token operator">&amp;</span>        buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment">// buffer for reading data from socket </span>
   uint          buffer_maxlen         <span class="token comment">// number of bytes to read </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>socket</p> <p>[in] SocketCreate函数返回的套接字句柄。当将不正确的句柄传递给_LastError时，将激活错误5270(ERR_NETSOCKET_INVALIDHANDLE)。</p> <p>buffer</p> <p>[out] 对数据读取的uchar类型数组的引用。动态数组大小随读取字节数的增加而增加。数组大小不能超过int_max(2147483647)。</p> <p>buffer_maxlen</p> <p>[in] 要读取到缓冲区[]数组的字节数。不适合数组的数据保留在套接字中。它们可以在下一个SocketTLSRead电话中接收到。缓冲区最大限度不能超过int_max(21474836) 47).</p> <p>返回值</p> <p>如果成功，则返回读取字节数。如果出现错误，则返回-1。</p> <p>注意</p> <p>如果在执行函数时系统套接字上发生错误，则将停止通过SocketConnect建立的连接。</p> <p>函数将被执行，直到它接收到指定的数据量或达到超时为止(SocketTimeout)。</p> <p>在数据读取错误的情况下，错误5273(Err_NETSOCKET_IO_Error)用_LastError编写。</p> <p>该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。</p> <p>例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//|                                                SocketExample.mq5 |</span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. |</span>
<span class="token comment">//|                                             https://www.mql5.com |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright   </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link        </span><span class="token string">&quot;https://www.mql5.com&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version     </span><span class="token string">&quot;1.00&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Add Address to the list of allowed ones in the terminal settings to let the example work&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">script_show_inputs</span></span>
 
input string Address<span class="token operator">=</span><span class="token string">&quot;www.mql5.com&quot;</span><span class="token punctuation">;</span>
input <span class="token keyword">int</span>    Port   <span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span>         ExtTLS <span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Send command to the server                                       |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPSend</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>string request<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span> req<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span>  len<span class="token operator">=</span><span class="token function">StringToCharArray</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>req<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if secure TLS connection is used via the port 443</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketTlsSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if standard TCP connection is used</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">SocketSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>req<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token operator">==</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Read server response                                            |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">HTTPRecv</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">,</span>uint timeout<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span>   rsp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   string result<span class="token punctuation">;</span>
   uint   timeout_check<span class="token operator">=</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>timeout<span class="token punctuation">;</span>
<span class="token comment">//--- read data from sockets till they are still present but not longer than timeout</span>
   <span class="token keyword">do</span>
     <span class="token punctuation">{</span>
      uint len<span class="token operator">=</span><span class="token function">SocketIsReadable</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token keyword">int</span> rsp_len<span class="token punctuation">;</span>
         <span class="token comment">//--- various reading commands depending on whether the connection is secure or not</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>ExtTLS<span class="token punctuation">)</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketTlsRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">else</span>
            rsp_len<span class="token operator">=</span><span class="token function">SocketRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>rsp<span class="token punctuation">,</span>len<span class="token punctuation">,</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//--- analyze the response</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>rsp_len<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            result<span class="token operator">+=</span><span class="token function">CharArrayToString</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>rsp_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- print only the response header</span>
            <span class="token keyword">int</span> header_end<span class="token operator">=</span><span class="token function">StringFind</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token string">&quot;\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>header_end<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token punctuation">{</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP answer header received:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">StringSubstr</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>header_end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>timeout_check <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Script program start function                                    |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">int</span> socket<span class="token operator">=</span><span class="token function">SocketCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- check the handle</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>socket<span class="token operator">!=</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- connect if all is well</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketConnect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>Address<span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Established connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
         string   subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">;</span>
         datetime expiration<span class="token punctuation">;</span>
         <span class="token comment">//--- if connection is secured by the certificate, display its data</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SocketTlsCertificate</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>issuer<span class="token punctuation">,</span>serial<span class="token punctuation">,</span>thumbprint<span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;TLS certificate:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Owner:  &quot;</span><span class="token punctuation">,</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Issuer:  &quot;</span><span class="token punctuation">,</span>issuer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Number:     &quot;</span><span class="token punctuation">,</span>serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Print: &quot;</span><span class="token punctuation">,</span>thumbprint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;   Expiration: &quot;</span><span class="token punctuation">,</span>expiration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ExtTLS<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token comment">//--- send GET request to the server</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HTTPSend</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token string">&quot;GET / HTTP/1.1\r\nHost: www.mql5.com\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;GET request sent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//--- read the response</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">HTTPRecv</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get a response, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token keyword">else</span>
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to send GET request, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Connection to &quot;</span><span class="token punctuation">,</span>Address<span class="token punctuation">,</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token string">&quot; failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//--- close a socket after using</span>
      <span class="token function">SocketClose</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create a socket, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div><p>参考
SocketTimeouts, MathSwap</p> <h2 id="_21-13-sockettlsreadavailable"><a href="#_21-13-sockettlsreadavailable" class="header-anchor">#</a> 21.13 SocketTlsReadAvailable</h2> <p>从安全的TLS连接读取所有可用数据。
```  cpp`
int  SocketTlsReadAvailable(
int           socket,               // socket
uchar&amp;        buffer[],             // buffer for reading data from socket
const uint    buffer_maxlen         // number of bytes to read
);</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>
参数

socket

[in] SocketCreate函数返回的套接字句柄。当将不正确的句柄传递给_LastError时，将激活错误5270(ERR_NETSOCKET_INVALIDHANDLE)。

buffer

[out] 对数据读取的uchar类型数组的引用。动态数组大小随读取字节数的增加而增加。数组大小不能超过int_max(2147483647)。

buffer_maxlen

[in] 要读取到缓冲区[]数组的字节数。不适合数组的数据保留在套接字中。它们可以由下一个SocketTlsReadAvailable或SocketTlsRead调用接收。缓冲器最大角 t超过int_max（2147483647）。

返回值

如果成功，则返回读取字节数。如果出现错误，则返回-1。

注意

如果在执行函数时系统套接字上发生错误，则将停止通过SocketConnect建立的连接。

在数据读取错误的情况下，错误5273(Err_NETSOCKET_IO_Error)用_LastError编写。

该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。

参考

SocketTimeouts, MathSwap

## 21.14 SocketTlsSend
通过安全的TLS连接发送数据。
```  cpp
int  SocketTlsSend( 
   int           socket,               // socket 
   const uchar&amp;  buffer[],             // data buffer 
   uint          buffer_len            // buffer size 
   );
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>参数</p> <p>socket</p> <p>[in] SocketCreate函数返回的套接字句柄。当传递不正确的句柄时，错误5270(ERR_NETSOCKET_INVALIDHANDLE)被写入_LastError。</p> <p>buffer</p> <p>[in] 引用要发送数据的uchar类型数组。</p> <p>buffer_len</p> <p>[in] “缓冲区”数组大小。</p> <p>返回值</p> <p>如果成功，则返回写入套接字的字节数。如果出现错误，则返回-1。</p> <p>注意</p> <p>如果在执行函数时系统套接字上发生错误，则将停止通过SocketConnect建立的连接。</p> <p>在数据写入错误的情况下，将错误5273(Err_NETSOCKET_IO_Error)写入_LastError。</p> <p>该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。</p> <p>参考</p> <p>SocketTimeouts, MathSwap, StringToCharArray</p> <h2 id="_21-15-webrequest"><a href="#_21-15-webrequest" class="header-anchor">#</a> 21.15 WebRequest</h2> <p>发送 HTTP 请求到指定服务器。 该函数有两个版本：</p> <ol><li>发送简单请求 使用内容-类型标题的&quot;key=value&quot;类型：application/x-www-form-urlencoded</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">WebRequest</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string      method<span class="token punctuation">,</span>           <span class="token comment">// HTTP 请求方式 </span>
   <span class="token keyword">const</span> string      url<span class="token punctuation">,</span>              <span class="token comment">// url 地址 </span>
   <span class="token keyword">const</span> string      cookie<span class="token punctuation">,</span>           <span class="token comment">// cookie </span>
   <span class="token keyword">const</span> string      referer<span class="token punctuation">,</span>          <span class="token comment">// 参照页 </span>
   <span class="token keyword">int</span>               timeout<span class="token punctuation">,</span>          <span class="token comment">// 超时 </span>
   <span class="token keyword">const</span> <span class="token keyword">char</span>        <span class="token operator">&amp;</span>data<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>          <span class="token comment">// HTTP请求信息数组 </span>
   <span class="token keyword">int</span>               data_size<span class="token punctuation">,</span>        <span class="token comment">// data[] 数组大小 </span>
   <span class="token keyword">char</span>              <span class="token operator">&amp;</span>result<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment">// 服务器响应数据数组 </span>
   string            <span class="token operator">&amp;</span>result_headers   <span class="token comment">// 服务器响应标头 </span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="2"><li>发送任何类型的请求 为了各种网络服务的更灵活互动指定自定义的标题设置。</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">WebRequest</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string      method<span class="token punctuation">,</span>           <span class="token comment">// HTTP 方法 </span>
   <span class="token keyword">const</span> string      url<span class="token punctuation">,</span>              <span class="token comment">// URL </span>
   <span class="token keyword">const</span> string      headers<span class="token punctuation">,</span>          <span class="token comment">// 标题  </span>
   <span class="token keyword">int</span>               timeout<span class="token punctuation">,</span>          <span class="token comment">// 超时 </span>
   <span class="token keyword">const</span> <span class="token keyword">char</span>        <span class="token operator">&amp;</span>data<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>          <span class="token comment">// HTTP 信息主体的数组 </span>
   <span class="token keyword">char</span>              <span class="token operator">&amp;</span>result<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment">// 包含服务器反应数据的数组 </span>
   string            <span class="token operator">&amp;</span>result_headers   <span class="token comment">// 服务器响应标题 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>参数</p> <p>method</p> <p>[in] HTTP 请求方法。</p> <p>url</p> <p>[in] URL 地址。</p> <p>headers</p> <p>[in] &quot;key: value&quot;类型的请求标题，以分行符 &quot;\r\n&quot;分隔。</p> <p>cookie</p> <p>[in] Cookie。</p> <p>referer</p> <p>[in] HTTP 请求标头的推荐页字段</p> <p>timeout</p> <p>[in] 超时时间以毫秒为单位。</p> <p>data[]</p> <p>[in] HTTP 请求信息数组。</p> <p>data_size</p> <p>[in] data[] 数组大小。</p> <p>result[]</p> <p>[out] 服务器响应数据数组。</p> <p>result_headers</p> <p>[out] 服务器响应标头。</p> <p>返回值</p> <p>服务器响应的HTTP 状态码，或错误情况下的 -1 。</p> <p>注意</p> <p>若要能够使用WebRequest 函数，您必须在“选项”窗口“EA交易”标签的允许URLs列表中添加一个URL。</p> <p>WebRequest 是一个同步函数。这意味着它会阻止程序执行并且等候请求服务器的响应。当收到发送请求的响应时，延迟至关重要，这就是禁止从指标调用该函数的原因，因为指标按照交易品种组指标的自己的执行线程操作。在一个图表上执行指标延迟可能导致该交易品种的所有图表停止更新。</p> <p>该函数只能从EA和脚本中调用，因为它们在自己的执行线程中运行。如果从指标调用，GetLastError()返回错误4014-“函数禁止调用“。</p> <p>WebRequest() 函数不能在 策略测试中执行。</p> <p>例如：</p> <h2 id="_21-16-sendftp"><a href="#_21-16-sendftp" class="header-anchor">#</a> 21.16 SendFTP</h2> <p>按”选项”设置窗口中“FTP”标签中指定的地址发送一个文件</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">SendFTP</span><span class="token punctuation">(</span> 
   string  filename<span class="token punctuation">,</span>          <span class="token comment">// 通过ftp发送的文件 </span>
   string  ftp_path<span class="token operator">=</span><span class="token constant">NULL</span>      <span class="token comment">// ftp服务器上传的文件 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数</p> <p>filename</p> <p>[in] 发送文件名称</p> <p>ftp_path=NULL</p> <p>[in] FTP目录，如果目录未标明，直接使用在设置中的描述</p> <p>返回值</p> <p>错误返回是“false”。</p> <p>注意</p> <p>发送文件应该保存在 terminal_directory\MQL5\files 或子文件夹中保存，如果在设置中未标明FTP地址或者访问密码，无法发送。</p> <p>SendFTP() 函数在策略测试中不工作。</p> <h2 id="_21-17-sendmail"><a href="#_21-17-sendmail" class="header-anchor">#</a> 21.17 SendMail</h2> <p>按”选项”设置窗口中“电邮”标签中指定的地址发送一个邮件</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">SendMail</span><span class="token punctuation">(</span> 
   string  subject<span class="token punctuation">,</span>       <span class="token comment">// 表头 </span>
   string  some_text      <span class="token comment">// email 文本 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数</p> <p>subject</p> <p>[in] 邮件标题</p> <p>some_text</p> <p>[in] 邮件主题</p> <p>返回值</p> <p>如果邮件发送到派送队列则返回true，否则返回false</p> <p>注意</p> <p>在设置中发送邮件功能可能被禁止，也可能邮件地址未标明，查看错误信息请调用 GetLastError()</p> <p>SendMail() 函数在策略测试中不工作。</p> <h2 id="_21-18-sendnotification"><a href="#_21-18-sendnotification" class="header-anchor">#</a> 21.18 SendNotification</h2> <p>按”选项”设置窗口中“通知”标签中指定的 MetaQuotes ID 推送一个短消息</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">SendNotification</span><span class="token punctuation">(</span> 
   string  text          <span class="token comment">// 通知文本 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>text</p> <p>[in] 通知文本。信息长度不应该超过 255 字符。</p> <p>返回值</p> <p>如果通知从程序端成功发送，则返回true；如果失败则返回false。推送通知失败后检查时，GetLastError () 可能返回其中以下一种错误：
• 4515 —— ERR_NOTIFICATION_SEND_FAILED,
• 4516 —— ERR_NOTIFICATION_WRONG_PARAMETER,
• 4517 —— ERR_NOTIFICATION_WRONG_SETTINGS,
• 4518 —— ERR_NOTIFICATION_TOO_FREQUENT.</p> <p>注意</p> <p>为SendNotification()函数设置了严格的使用限制：每秒钟调用不能超过2次，每分钟调用不能超过10次。动态监控使用频率。如果违反这些限制，函数将被禁用。</p> <p>SendNotification() 函数在策略测试中不工作。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mql5yao/Chapter/twenty.html" class="prev">
        20 第二十章 交易信号
      </a></span> <span class="next"><a href="/mql5yao/Chapter/twentytwo.html">
        22 第二十二章 程序端全局变量
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/mql5yao/assets/js/app.f23448f4.js" defer></script><script src="/mql5yao/assets/js/3.a8269cb7.js" defer></script><script src="/mql5yao/assets/js/17.76fde0dd.js" defer></script>
  </body>
</html>
