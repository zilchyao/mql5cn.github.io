<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>智能交易*姚 文档站</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/mql5yao/favicon.ico">
    <meta name="description" content="这是智能交易的文档站点。">
    <meta name="keywords" content="MQL,EA,智能交易,自动交易,量化,编程,培训">
    
    <link rel="preload" href="/mql5yao/assets/css/0.styles.c167a2d0.css" as="style"><link rel="preload" href="/mql5yao/assets/js/app.33d9106b.js" as="script"><link rel="preload" href="/mql5yao/assets/js/3.64586e1a.js" as="script"><link rel="preload" href="/mql5yao/assets/js/37.c903bf3b.js" as="script"><link rel="prefetch" href="/mql5yao/assets/js/10.f243be4a.js"><link rel="prefetch" href="/mql5yao/assets/js/11.e4fc3b61.js"><link rel="prefetch" href="/mql5yao/assets/js/12.d2b71f90.js"><link rel="prefetch" href="/mql5yao/assets/js/13.d47c9e61.js"><link rel="prefetch" href="/mql5yao/assets/js/14.59ded2e6.js"><link rel="prefetch" href="/mql5yao/assets/js/15.f2836d3d.js"><link rel="prefetch" href="/mql5yao/assets/js/16.fc4e3f11.js"><link rel="prefetch" href="/mql5yao/assets/js/17.069370d9.js"><link rel="prefetch" href="/mql5yao/assets/js/18.e47908ca.js"><link rel="prefetch" href="/mql5yao/assets/js/19.4e8a369f.js"><link rel="prefetch" href="/mql5yao/assets/js/2.7a050c47.js"><link rel="prefetch" href="/mql5yao/assets/js/20.37e31658.js"><link rel="prefetch" href="/mql5yao/assets/js/21.30dc9524.js"><link rel="prefetch" href="/mql5yao/assets/js/22.bb650486.js"><link rel="prefetch" href="/mql5yao/assets/js/23.84e246fd.js"><link rel="prefetch" href="/mql5yao/assets/js/24.3b441f03.js"><link rel="prefetch" href="/mql5yao/assets/js/25.3ceb7172.js"><link rel="prefetch" href="/mql5yao/assets/js/26.ba703a82.js"><link rel="prefetch" href="/mql5yao/assets/js/27.c0597566.js"><link rel="prefetch" href="/mql5yao/assets/js/28.50413136.js"><link rel="prefetch" href="/mql5yao/assets/js/29.04da6b07.js"><link rel="prefetch" href="/mql5yao/assets/js/30.c8071067.js"><link rel="prefetch" href="/mql5yao/assets/js/31.baace808.js"><link rel="prefetch" href="/mql5yao/assets/js/32.d399c058.js"><link rel="prefetch" href="/mql5yao/assets/js/33.9b2114b8.js"><link rel="prefetch" href="/mql5yao/assets/js/34.d6f49f42.js"><link rel="prefetch" href="/mql5yao/assets/js/35.3620d83f.js"><link rel="prefetch" href="/mql5yao/assets/js/36.e26f547b.js"><link rel="prefetch" href="/mql5yao/assets/js/38.2f6e699d.js"><link rel="prefetch" href="/mql5yao/assets/js/39.aca9c106.js"><link rel="prefetch" href="/mql5yao/assets/js/4.21ff370e.js"><link rel="prefetch" href="/mql5yao/assets/js/40.3eb74932.js"><link rel="prefetch" href="/mql5yao/assets/js/41.4f244c9a.js"><link rel="prefetch" href="/mql5yao/assets/js/42.892231ce.js"><link rel="prefetch" href="/mql5yao/assets/js/43.3f173f86.js"><link rel="prefetch" href="/mql5yao/assets/js/44.4e79ffd4.js"><link rel="prefetch" href="/mql5yao/assets/js/45.9e7cd13e.js"><link rel="prefetch" href="/mql5yao/assets/js/46.240ea5cd.js"><link rel="prefetch" href="/mql5yao/assets/js/47.bc498cbd.js"><link rel="prefetch" href="/mql5yao/assets/js/48.752c3ae0.js"><link rel="prefetch" href="/mql5yao/assets/js/5.47d44717.js"><link rel="prefetch" href="/mql5yao/assets/js/6.ee422b91.js"><link rel="prefetch" href="/mql5yao/assets/js/7.b1ec5472.js"><link rel="prefetch" href="/mql5yao/assets/js/8.036d68c0.js"><link rel="prefetch" href="/mql5yao/assets/js/9.4c2d0d8b.js">
    <link rel="stylesheet" href="/mql5yao/assets/css/0.styles.c167a2d0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mql5yao/" class="home-link router-link-active"><img src="/mql5yao/logo.png" alt="智能交易*姚 文档站" class="logo"> <span class="site-name can-hide">智能交易*姚 文档站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mql5yao/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mql5yao/Chapter/start.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/mql5yao/Cutleeks/" class="nav-link">
  割韭菜XX招
</a></div><div class="nav-item"><a href="/mql5yao/support/" class="nav-link">
  支持本站
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mql5yao/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mql5yao/Chapter/start.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/mql5yao/Cutleeks/" class="nav-link">
  割韭菜XX招
</a></div><div class="nav-item"><a href="/mql5yao/support/" class="nav-link">
  支持本站
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MQL5线上手册</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mql5yao/Chapter/start.html" class="sidebar-link">MQL5 参考</a></li><li><a href="/mql5yao/Chapter/one.html" class="sidebar-link">01 第一章 语言基础</a></li><li><a href="/mql5yao/Chapter/two.html" class="sidebar-link">02 第二章 标准常量，列举和架构</a></li><li><a href="/mql5yao/Chapter/three.html" class="sidebar-link">03 第三章 MQL5程序</a></li><li><a href="/mql5yao/Chapter/four.html" class="sidebar-link">04 第四章 预定义变量</a></li><li><a href="/mql5yao/Chapter/five.html" class="sidebar-link">05 第五章 普通函数</a></li><li><a href="/mql5yao/Chapter/six.html" class="sidebar-link">06 第六章 数组函数</a></li><li><a href="/mql5yao/Chapter/add1.html" class="sidebar-link">07 第add1章 矩阵和向量方法</a></li><li><a href="/mql5yao/Chapter/seven.html" class="sidebar-link">07 第七章 函数转换</a></li><li><a href="/mql5yao/Chapter/eight.html" class="sidebar-link">08 第八章 数学函数</a></li><li><a href="/mql5yao/Chapter/nine.html" class="sidebar-link">09 第九章 字符串函数</a></li><li><a href="/mql5yao/Chapter/ten.html" class="sidebar-link">10 第十章 日期和时间</a></li><li><a href="/mql5yao/Chapter/eleven.html" class="sidebar-link">11 第十一章 账户信息</a></li><li><a href="/mql5yao/Chapter/twelve.html" class="sidebar-link">12 第十二章 检测</a></li><li><a href="/mql5yao/Chapter/thirteen.html" class="sidebar-link">13 第十三章 事件处理</a></li><li><a href="/mql5yao/Chapter/fourteen.html" class="sidebar-link">14 第十四章 市场信息</a></li><li><a href="/mql5yao/Chapter/fifteen.html" class="sidebar-link">15 第十五章 经济日历函数</a></li><li><a href="/mql5yao/Chapter/sixteen.html" class="sidebar-link">16 第十六章 时间序列和指标访问</a></li><li><a href="/mql5yao/Chapter/seventeen.html" class="sidebar-link">17 第十七章 自定义交易品种</a></li><li><a href="/mql5yao/Chapter/eighteen.html" class="sidebar-link">18 第十八章 图表操作</a></li><li><a href="/mql5yao/Chapter/ninteen.html" class="sidebar-link">19 第十九章 交易函数</a></li><li><a href="/mql5yao/Chapter/twenty.html" class="sidebar-link">20 第二十章 交易信号</a></li><li><a href="/mql5yao/Chapter/twentyone.html" class="sidebar-link">21 第二十一章 网络函数</a></li><li><a href="/mql5yao/Chapter/twentytwo.html" class="sidebar-link">22 第二十二章 程序端全局变量</a></li><li><a href="/mql5yao/Chapter/twentythree.html" class="sidebar-link">23 第二十三章 文件函数</a></li><li><a href="/mql5yao/Chapter/twentyfour.html" class="sidebar-link">24 第二十四章 自定义指标</a></li><li><a href="/mql5yao/Chapter/twentyfive.html" class="sidebar-link">25 第二十五章 物件函数</a></li><li><a href="/mql5yao/Chapter/twentysix.html" class="sidebar-link">26 第二十六章 技术指标</a></li><li><a href="/mql5yao/Chapter/twentyseven.html" class="sidebar-link">27 第二十七章 处理优化结果</a></li><li><a href="/mql5yao/Chapter/twentyeight.html" class="sidebar-link">28 第二十八章 工作事件</a></li><li><a href="/mql5yao/Chapter/twentynine.html" class="sidebar-link">29 第二十九章 使用OpenCL工作</a></li><li><a href="/mql5yao/Chapter/thirty.html" aria-current="page" class="active sidebar-link">30 第三十章 使用数据库</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-1-databaseopen" class="sidebar-link">30.1 DatabaseOpen</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-2-databaseclose" class="sidebar-link">30.2 DatabaseClose</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-3-databaseimport" class="sidebar-link">30.3 DatabaseImport</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-4-databaseexport" class="sidebar-link">30.4 DatabaseExport</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-5-databaseprint" class="sidebar-link">30.5 DatabasePrint</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-6-databasetableexists" class="sidebar-link">30.6 DatabaseTableExists</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-7-databaseexecute" class="sidebar-link">30.7 DatabaseExecute</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-8-databaseprepare" class="sidebar-link">30.8 DatabasePrepare</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-9-databasereset" class="sidebar-link">30.9 DatabaseReset</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-10-databasebind" class="sidebar-link">30.10 DatabaseBind</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-11-databasebindarray" class="sidebar-link">30.11 DatabaseBindArray</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-12-databaseread" class="sidebar-link">30.12 DatabaseRead</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-13-databasereadbind" class="sidebar-link">30.13 DatabaseReadBind</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-14-databasefinalize" class="sidebar-link">30.14 DatabaseFinalize</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-15-databasetransactionbegin" class="sidebar-link">30.15 DatabaseTransactionBegin</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-16-databasetransactioncommit" class="sidebar-link">30.16 DatabaseTransactionCommit</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-17-databasetransactionrollback" class="sidebar-link">30.17 DatabaseTransactionRollback</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-18-databasecolumnscount" class="sidebar-link">30.18 DatabaseColumnsCount</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-19-databasecolumnname" class="sidebar-link">30.19 DatabaseColumnName</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-20-databasecolumntype" class="sidebar-link">30.20 DatabaseColumnType</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-21-databasecolumnsize" class="sidebar-link">30.21 DatabaseColumnSize</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-22-databasecolumntext" class="sidebar-link">30.22 DatabaseColumnText</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-23-databasecolumninteger" class="sidebar-link">30.23 DatabaseColumnInteger</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-24-databasecolumnlong" class="sidebar-link">30.24 DatabaseColumnLong</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-25-databasecolumndouble" class="sidebar-link">30.25 DatabaseColumnDouble</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirty.html#_30-26-databasecolumnblob" class="sidebar-link">30.26 DatabaseColumnBlob</a></li></ul></li><li><a href="/mql5yao/Chapter/thirtyone.html" class="sidebar-link">31 第三十一章 使用DirectX</a></li><li><a href="/mql5yao/Chapter/thirtytwo.html" class="sidebar-link">32 第三十二章 集成</a></li><li><a href="/mql5yao/Chapter/add2.html" class="sidebar-link">32 第add2章 ONNX模型</a></li><li><a href="/mql5yao/Chapter/thirtythree.html" class="sidebar-link">33 第三十三章 标准程序库</a></li><li><a href="/mql5yao/Chapter/AppendixI.html" class="sidebar-link">34 附录一 来自MQL4</a></li><li><a href="/mql5yao/Chapter/AppendixII.html" class="sidebar-link">35 附录二 MQL5 函数列表</a></li><li><a href="/mql5yao/Chapter/AppendixIII.html" class="sidebar-link">36 附录三 MQL5常量列表</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2>第三十章 使用数据库</h2> <p>这些数据库函数使用了流行且易于使用的SQLite引擎。该引擎的便利之处在于，整个数据库都位于用户PC硬盘上的单个文件中。
这些函数可以方便地创建表格、向表中添加数据、执行更改和使用简单的SQL请求进行采样：</p> <p>接收任何格式的交易历史和报价，<br>
保存优化和测试结果，<br>
通过其他分析组合准备和交换数据，<br>
存储MQL5应用程序设置和状态。</p> <p>数据库函数可以使您通过SQL请求替换重复率最高的大数据组处理操作，因此常常可以使用DatabaseExecute/DatabasePrepare调用，而不是编写复杂的循环和比较。使用DatabaseReadBind函数，方便地获取现有架构中的查询结果。该函数运行在单个调用中一次性读取所有记录字段。</p> <p>若要加快读取、编写和更改速度，可以使用DATABASE_OPEN_MEMORY标识在RAM中打开/创建数据库，虽然这样的数据库只适用于特定的应用程序，不可共享。当处理位于硬盘上的数据库时，应该使用DatabaseTransactionBegin/DatabaseTransactionCommit/DatabaseTransactionRollback将批量数据插入/更改封装在交易事务中。这可以使整个过程加快数百倍。</p> <p>若要开始使用函数，请参阅文章SQLite：本地操作MQL5中的SQL数据库。</p> <table><thead><tr><th>函数</th> <th>功能</th></tr></thead> <tbody><tr><td>DatabaseOpen</td> <td>在指定文件中打开或创建数据库</td></tr> <tr><td>DatabaseClose</td> <td>关闭数据库</td></tr> <tr><td>DatabaseImport</td> <td>从文件导入数据到表格中</td></tr> <tr><td>DatabaseExport</td> <td>将表格或SQL请求执行结果到处到CSV文件</td></tr> <tr><td>DatabasePrint</td> <td>在专家日志中打印表格或SQL执行结果</td></tr> <tr><td>DatabaseTableExists</td> <td>检查数据库中是否存在表格</td></tr> <tr><td>DatabaseExecute</td> <td>执行对指定数据库的请求</td></tr> <tr><td>DatabasePrepare</td> <td>创建可使用DatabaseRead()执行的请求句柄</td></tr> <tr><td>DatabaseReset</td> <td>重置请求，比如调用DatabasePrepare()之后</td></tr> <tr><td>DatabaseBind</td> <td>在请求中设置一个参数值</td></tr> <tr><td>DatabaseBindArray</td> <td>将数组设置为参数值</td></tr> <tr><td>DatabaseRead</td> <td>作为请求结果，移到下一个条目</td></tr> <tr><td>DatabaseFinalize</td> <td>移除在DatabasePrepare()中创建的请求</td></tr> <tr><td>DatabaseTransactionBegin</td> <td>开始事务执行</td></tr> <tr><td>DatabaseTransactionCommit</td> <td>完成事务执行</td></tr> <tr><td>DatabaseTransactionRollback</td> <td>回滚事务</td></tr> <tr><td>DatabaseColumnsCount</td> <td>获取请求中的字段数</td></tr> <tr><td>DatabaseColumnName</td> <td>按索引获取字段名</td></tr> <tr><td>DatabaseColumnType</td> <td>按索引获取字段类型</td></tr> <tr><td>DatabaseColumnSize</td> <td>获取字段大小（以字节为单位）</td></tr> <tr><td>DatabaseColumnText</td> <td>从当前记录中获取作为字符串的字段值</td></tr> <tr><td>DatabaseColumnInteger</td> <td>从当前记录中获取int类型的值</td></tr> <tr><td>DatabaseColumnLong</td> <td>从当前记录中获取long类型的值</td></tr> <tr><td>DatabaseColumnDouble</td> <td>从当前记录中获取double类型的值</td></tr> <tr><td>DatabaseColumnBlob</td> <td>从当前记录中获取作为数组的字段值</td></tr></tbody></table> <h2 id="_30-1-databaseopen"><a href="#_30-1-databaseopen" class="header-anchor">#</a> 30.1 DatabaseOpen</h2> <p>在指定文件中打开或创建数据库。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">DatabaseOpen</span><span class="token punctuation">(</span>
   string  filename<span class="token punctuation">,</span>      <span class="token comment">// 文件名</span>
   uint    flags          <span class="token comment">// 标识组合</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数</p> <p>filename</p> <p>[in]  相对于&quot;MQL5\Files&quot;文件夹的文件名称。</p> <p>flags</p> <p>[in] ENUM_DATABASE_OPEN_FLAGS枚举中的标识组合。</p> <p>返回值</p> <p>如果执行成功，函数返回用于访问数据库的数据库句柄。否则，返回INVALID_HANDLE。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INTERNAL_ERROR (4001)                       – 重要运行时错误；<br>
ERR_WRONG_INTERNAL_PARAMETER (4002)  - 访问&quot;MQL5\Files&quot;文件夹时出现的内部错误；<br>
ERR_INVALID_PARAMETER (4003)                  –<br> 数据库文件的路径包含空字符串，或设置不兼容的标识组合；<br>
ERR_NOT_ENOUGH_MEMORY (4004)              - 内存不足；<br>
ERR_WRONG_FILENAME (5002)                     - 错误的数据库文件名称；<br>
ERR_TOO_LONG_FILENAME (5003)                 - 数据库文件的绝对路径超过最大长度；<br>
ERR_DATABASE_TOO_MANY_OBJECTS (5122) - 超过可接受的数据库对象的最大数目；<br>
ERR_DATABASE_CONNECT (5123)                  - 数据库连接错误；<br>
ERR_DATABASE_MISUSE (5621)                     - 错误使用SQLite库。<br></p> <p>注意</p> <p>如果filename参数为NULL或是空字符串&quot;&quot;，则在磁盘上创建一个临时文件。并会在关闭数据库连接后自动删除。<br>
如果filename参数为&quot;:memory:&quot;，则数据库在内存中创建，并在与其连接关闭后自动删除。<br>
如果flags参数没有DATABASE_OPEN_READONLY或DATABASE_OPEN_READWRITE标识，则使用DATABASE_OPEN_READWRITE标识。<br>
如果没有指定文件扩展名，请使用&quot;.sqlite&quot;。<br></p> <p>ENUM_DATABASE_OPEN_FLAGS</p> <table><thead><tr><th>ID</th> <th>描述</th></tr></thead> <tbody><tr><td>DATABASE_OPEN_READONLY</td> <td>只读</td></tr> <tr><td>DATABASE_OPEN_READWRITE</td> <td>为读写开放</td></tr> <tr><td>DATABASE_OPEN_CREATE</td> <td>必要时，在磁盘上创建文件</td></tr> <tr><td>DATABASE_OPEN_MEMORY</td> <td>在RAM中创建数据库</td></tr> <tr><td>DATABASE_OPEN_COMMON</td> <td>该文件位于所有程序端的通用文件夹</td></tr></tbody></table> <h2 id="_30-2-databaseclose"><a href="#_30-2-databaseclose" class="header-anchor">#</a> 30.2 DatabaseClose</h2> <p>关闭数据库。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>  <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>  database      <span class="token comment">// 在DatabaseOpen中接收的数据库句柄</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>database</p> <p>[in]  在DatabaseOpen()中接收的数据库句柄。</p> <p>返回值</p> <p>无。</p> <p>注意</p> <p>调用DatabaseClose之后，对数据库的所有请求句柄都将被自动删除并变为无效。</p> <p>如果句柄无效，函数设置ERR_DATABASE_INVALID_HANDLE错误。您可以使用GetLastError()检查错误。</p> <h2 id="_30-3-databaseimport"><a href="#_30-3-databaseimport" class="header-anchor">#</a> 30.3 DatabaseImport</h2> <p>从文件导入数据到表格中。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">long</span>  <span class="token function">DatabaseImport</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>           database<span class="token punctuation">,</span>          <span class="token comment">// 在DatabaseOpen中接收的数据库句柄</span>
   <span class="token keyword">const</span> string  table<span class="token punctuation">,</span>             <span class="token comment">// 要插入数据的表格名称</span>
   <span class="token keyword">const</span> string  filename<span class="token punctuation">,</span>          <span class="token comment">// 要导入数据的文件名</span>
   uint          flags<span class="token punctuation">,</span>             <span class="token comment">// 标识组合</span>
   <span class="token keyword">const</span> string  separator<span class="token punctuation">,</span>         <span class="token comment">// 数据分隔符</span>
   ulong         skip_rows<span class="token punctuation">,</span>         <span class="token comment">// 要跳过多少初始字符串</span>
   <span class="token keyword">const</span> string  skip_comments      <span class="token comment">// 定义注释的字符串</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>参数</p> <p>database</p> <p>[in]  在DatabaseOpen()中接收的数据库句柄。</p> <p>table</p> <p>[in]  将要添加文件数据的表格名称。</p> <p>filename</p> <p>[in]  用于读取数据的CSV文件或ZIP存档文件。该名称可能包含子目录，并且是相对于MQL5\Files文件夹设置。</p> <p>标识</p> <p>[in]  标识组合。</p> <p>separator</p> <p>[in]  CSV文件中的数据分隔符。</p> <p>skip_rows</p> <p>[in]  当从文件读取数据时，要跳过的初始字符串数。</p> <p>skip_comments</p> <p>[in]</p> <p>用于将字符串指定为注释的字符串。如果在字符串的开头检测到skip_comments中的任何字符，那么该字符串将被视为注释，并不被导入。</p> <p>返回值</p> <p>返回导入字符串的数量，如果出现错误则返回-1。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INVALID_PARAMETER (4003)              –  没有指定表格名称（空字符串或NULL）；<br>
ERR_DATABASE_INTERNAL (5120)              – 内部数据库错误；<br>
ERR_DATABASE_INVALID_HANDLE (5121)   - 无效数据库句柄。</p> <p>注意</p> <p>如果没有名为 table 的表格，则自动生成该表。根据文件数据自动定义创建表格中的名称和字段类型。</p> <p>另见</p> <p>DatabaseOpen、DatabasePrint</p> <h2 id="_30-4-databaseexport"><a href="#_30-4-databaseexport" class="header-anchor">#</a> 30.4 DatabaseExport</h2> <p>将表格或SQL请求执行结果到处到CSV文件。该文件使用UTF-8编码创建。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">long</span>  <span class="token function">DatabaseExport</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>           database<span class="token punctuation">,</span>           <span class="token comment">//在DatabaseOpen中接收的数据库句柄</span>
   <span class="token keyword">const</span> string  table_or_sql<span class="token punctuation">,</span>       <span class="token comment">// 表格名称或SQL请求</span>
   <span class="token keyword">const</span> string  filename<span class="token punctuation">,</span>           <span class="token comment">// 用于数据导出的CSV文件名称</span>
   uint          flags<span class="token punctuation">,</span>              <span class="token comment">// 标识组合</span>
   <span class="token keyword">const</span> string  separator           <span class="token comment">// CSV文件中的数据分隔符</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数</p> <p>database</p> <p>[in]  在DatabaseOpen()中接收的数据库句柄。</p> <p>table_or_sql</p> <p>[in]   结果将被导出到指定文件的表格名称或SQL请求文本。</p> <p>filename</p> <p>[in]  用于数据导出的文件名。设置相对于MQL5\Files文件夹的路径。</p> <p>标识</p> <p>[in] 定义文件输出的标识组合。标识定义如下：</p> <p>DATABASE_EXPORT_HEADER                 – 显示包含字段名的字符串<br>
DATABASE_EXPORT_INDEX                    – 显示字符串索引<br>
DATABASE_EXPORT_NO_BOM                – 没有在文件开始插入BOM标记（默认插入BOM）<br>
DATABASE_EXPORT_CRLF                     – 使用CRLF换行（默认为LF）<br>
DATABASE_EXPORT_APPEND                 –<br> 将数据添加到现有文件的末尾（默认情况下，覆盖该文件）。如果文件不存在，则将被创建。<br>
DATABASE_EXPORT_QUOTED_STRINGS – 在双引号中显示字符串值。<br>
DATABASE_EXPORT_COMMON_FOLDER - 在所有客户端的常规文件夹中创建CSV文件\Terminal\Common\File。<br></p> <p>separator</p> <p>[in]  数据分隔符。如果指定NULL，则将'\t'制表符用作分隔符。 空字符串&quot;&quot;被认为是有效分隔符，但不能将获取的CSV文件读取为表格 – 它被认为是一组字符串。</p> <p>返回值</p> <p>返回导出条目的数量，或者在错误情况下返回负值。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INTERNAL_ERROR (4001)                       – 重要运行时错误；<br>
ERR_INVALID_PARAMETER (4003)                  –<br> 数据库文件的路径包含空字符串，或设置不兼容的标识组合；<br>
ERR_NOT_ENOUGH_MEMORY (4004)              - 内存不足；<br>
ERR_FUNCTION_NOT_ALLOWED(4014)           – 不允许指定渠道；<br>
ERR_PROGRAM_STOPPED(4022)                    – 操作取消（MQL程序停止）；<br>
ERR_WRONG_FILENAME (5002)                     - 无效文件名；<br>
ERR_TOO_LONG_FILENAME (5003)                 - 文件的绝对路径超过最大长度；<br>
ERR_CANNOT_OPEN_FILE(5004)                    – 无法打开文件进行编写；<br>
ERR_FILE_WRITEERROR(5026)                      – 无法写入文件；<br>
ERR_DATABASE_INTERNAL (5120)                 – 内部数据库错误；<br>
ERR_DATABASE_INVALID_HANDLE (5121)      - 无效数据库句柄；<br>
ERR_DATABASE_QUERY_PREPARE(5125)        – 请求生成错误；<br>
ERR_DATABASE_QUERY_NOT_READONLY       – 允许只读请求。<br></p> <p>注意</p> <p>如果请求结果被导出，则SQL请求应该以&quot;SELECT&quot; 或 &quot;select&quot;开始。换句话说，SQL请求不能改变数据库状态，否则DatabaseExport()失败并显示错误。</p> <p>数据库字符串值可能包含转换字符('\r'或'\r\n' )，以及分隔符参数中设置的值分隔符。在这种情况下，请确保在'flags'参数中使用DATABASE_EXPORT_QUOTED_STRINGS标识。如果该标识已存在，则所有显示的字符串用双引号表示。如果一个字符串包含双引号，则用双层双引号代替。</p> <p>另见</p> <p>DatabasePrint、DatabaseImport</p> <h2 id="_30-5-databaseprint"><a href="#_30-5-databaseprint" class="header-anchor">#</a> 30.5 DatabasePrint</h2> <p>在专家日志中打印表格或SQL执行结果。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">long</span>  <span class="token function">DatabasePrint</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>           database<span class="token punctuation">,</span>          <span class="token comment">// 在DatabaseOpen中接收的数据库句柄</span>
   <span class="token keyword">const</span> string  table_or_sql<span class="token punctuation">,</span>      <span class="token comment">// 表格或SQL请求</span>
   uint          flags              <span class="token comment">// 标识组合</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>database</p> <p>[in]  在DatabaseOpen()中接收的数据库句柄。</p> <p>table_or_sql</p> <p>[in]  结果显示在专家日志中的表格名称或SQL请求文本。</p> <p>标识</p> <p>[in]  轻易输出格式的标识组合。标识定义如下：</p> <p>DATABASE_PRINT_NO_HEADER      – 不显示表格的列名（字段名）<br>
DATABASE_PRINT_NO_INDEX         – 不显示字符串索引<br>
DATABASE_PRINT_NO_FRAME        – 不显示分隔标题和数据的框架<br>
DATABASE_PRINT_STRINGS_RIGHT – 将字符串向右对齐。<br></p> <p>如果flags=0，则显示列和字符串，标题和数据用框架分隔，而字符串向左对齐。</p> <p>返回值</p> <p>返回导出字符串的数量，如果出现错误则返回-1。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INTERNAL_ERROR (4001)                       – 重要运行时错误；<br>
ERR_NOT_ENOUGH_MEMORY (4004)              - 内存不足；<br>
ERR_DATABASE_INTERNAL (5120)                 – 内部数据库错误；<br>
ERR_DATABASE_INVALID_HANDLE (5121)      - 无效数据库句柄；  <br>
注意</p> <p>如果日志显示请求结果，则SQL请求应该以&quot;SELECT&quot; 或 &quot;select&quot;开始。换句话说，SQL请求不能改变数据库状态，否则DatabasePrint()失败并显示错误。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| 脚本程序起始函数                                                  |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   string filename<span class="token operator">=</span><span class="token string">&quot;departments.sqlite&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//--- 在常规程序端文件夹中创建或打开数据库</span>
   <span class="token keyword">int</span> db<span class="token operator">=</span><span class="token function">DatabaseOpen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> DATABASE_OPEN_READWRITE <span class="token operator">|</span> DATABASE_OPEN_CREATE <span class="token operator">|</span>DATABASE_OPEN_COMMON<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>db<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; open failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 创建COMPANY表格</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CreataTableCompany</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 创建DEPARTMENT表格</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CreataTableDepartment</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 显示COMPANY和DEPARTMENT表格中所有字段的列表</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Try to print request \&quot;PRAGMA TABLE_INFO(COMPANY);PRAGMA TABLE_INFO(DEPARTMENT)\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabasePrint</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;PRAGMA TABLE_INFO(COMPANY);PRAGMA TABLE_INFO(DEPARTMENT)&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabasePrint(\&quot;PRAGMA TABLE_INFO()\&quot;) failed, error code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 在日志中显示COMPANY表格</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Try to print request \&quot;SELECT * from COMPANY\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabasePrint</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;SELECT * from COMPANY&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DatabasePrint failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 请求合并COMPANY和DEPARTMENT表格的文本</span>
   string request<span class="token operator">=</span><span class="token string">&quot;SELECT EMP_ID, NAME, DEPT FROM COMPANY LEFT OUTER JOIN DEPARTMENT &quot;</span>
                  <span class="token string">&quot;ON COMPANY.ID = DEPARTMENT.EMP_ID&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//--- 显示表格合并结果</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Try to print request \&quot;SELECT EMP_ID, NAME, DEPT FROM COMPANY LEFT OUTER JOIN DEPARTMENT\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabasePrint</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DatabasePrint failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 关闭数据库</span>
   <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">/*
结论：
Try to print request &quot;PRAGMA TABLE_INFO(COMPANY);PRAGMA TABLE_INFO(DEPARTMENT)&quot;
#| cid name    type     notnull dflt_value pk
-+-------------------------------------------
1|   0 ID      INT            1             1 
2|   1 NAME    TEXT           1             0 
3|   2 AGE     INT            1             0 
4|   3 ADDRESS CHAR(50)       0             0 
5|   4 SALARY  REAL           0             0 
#| cid name   type     notnull dflt_value pk
-+------------------------------------------
1|   0 ID     INT            1             1 
2|   1 DEPT   CHAR(50)       1             0 
3|   2 EMP_ID INT            1             0 
Try to print request &quot;SELECT * from COMPANY&quot;
#| ID NAME  AGE ADDRESS     SALARY
-+--------------------------------
1|  1 Paul   32 California 25000.0 
2|  2 Allen  25 Texas      15000.0 
3|  3 Teddy  23 Norway     20000.0 
4|  4 Mark   25 Rich-Mond  65000.0 
5|  5 David  27 Texas      85000.0 
6|  6 Kim    22 South-Hall 45000.0 
7|  7 James  24 Houston    10000.0 
Try to print request &quot;SELECT EMP_ID, NAME, DEPT FROM COMPANY LEFT OUTER JOIN DEPARTMENT&quot;
#| EMP_ID NAME  DEPT       
-+-------------------------
1|      1 Paul  IT Billing  
2|      2 Allen Engineering 
3|        Teddy             
4|        Mark              
5|        David             
6|        Kim               
7|      7 James Finance     
*/</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| 创建COMPANY表格                                                  |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">CreateTableCompany</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- 如果COMPANY表格已存在，请将其删除</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabaseTableExists</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;COMPANY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- 删除表格</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;DROP TABLE COMPANY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to drop table COMPANY with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 创建COMPANY表格</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;CREATE TABLE COMPANY(&quot;</span>
                       <span class="token string">&quot;ID INT PRIMARY KEY     NOT NULL,&quot;</span>
                       <span class="token string">&quot;NAME           TEXT    NOT NULL,&quot;</span>
                       <span class="token string">&quot;AGE            INT     NOT NULL,&quot;</span>
                       <span class="token string">&quot;ADDRESS        CHAR(50),&quot;</span>
                       <span class="token string">&quot;SALARY         REAL );&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: create table COMPANY failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 将数据输入到COMPANY表格</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY) VALUES (1, 'Paul', 32, 'California', 25000.00); &quot;</span>
                       <span class="token string">&quot;INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY) VALUES (2, 'Allen', 25, 'Texas', 15000.00); &quot;</span>
                       <span class="token string">&quot;INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY) VALUES (3, 'Teddy', 23, 'Norway', 20000.00); &quot;</span>
                       <span class="token string">&quot;INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY) VALUES (4, 'Mark', 25, 'Rich-Mond', 65000.00); &quot;</span>
                       <span class="token string">&quot;INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY) VALUES (5, 'David', 27, 'Texas', 85000.0); &quot;</span>
                       <span class="token string">&quot;INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY) VALUES (6, 'Kim', 22, 'South-Hall', 45000.0); &quot;</span>
                       <span class="token string">&quot;INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY) VALUES (7, 'James', 24, 'Houston', 10000.00); &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;COMPANY insert failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 成功</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| 创建DEPARTMENT表格                                               |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">CreateTableDepartment</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- 如果DEPARTMENT表格已存在，请将其删除</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabaseTableExists</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;DEPARTMENT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- 删除表格</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;DROP TABLE DEPARTMENT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to drop table DEPARTMENT  with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 创建DEPARTMENT表格</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;CREATE TABLE DEPARTMENT (&quot;</span>
                       <span class="token string">&quot;ID      INT PRIMARY KEY   NOT NULL,&quot;</span>
                       <span class="token string">&quot;DEPT    CHAR(50)          NOT NULL,&quot;</span>
                       <span class="token string">&quot;EMP_ID  INT               NOT NULL);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: create table DEPARTMENT failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 将数据输入到DEPARTMENT表格</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;INSERT INTO DEPARTMENT (ID,DEPT,EMP_ID) VALUES (1, 'IT Billing', 1); &quot;</span>
                       <span class="token string">&quot;INSERT INTO DEPARTMENT (ID,DEPT,EMP_ID) VALUES (2, 'Engineering', 2); &quot;</span>
                       <span class="token string">&quot;INSERT INTO DEPARTMENT (ID,DEPT,EMP_ID) VALUES (3, 'Finance', 7);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DEPARTMENT insert failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 成功</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+-------------------------------------------------------------------</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br></div></div><p>另见</p> <p>DatabaseExport、DatabaseImport</p> <h2 id="_30-6-databasetableexists"><a href="#_30-6-databasetableexists" class="header-anchor">#</a> 30.6 DatabaseTableExists</h2> <p>检查数据库中是否存在表格。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">DatabaseTableExists</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>     database<span class="token punctuation">,</span>      <span class="token comment">// 在DatabaseOpen中接收的数据库句柄</span>
   string  table          <span class="token comment">// 表格名称</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数</p> <p>database</p> <p>[in]  在DatabaseOpen()中接收的数据库句柄。</p> <p>table</p> <p>[in]  表格名称。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INVALID_PARAMETER (4003)               –  没有指定表格名称（空字符串或NULL）；<br>
ERR_WRONG_STRING_PARAMETER (5040)  – 将请求转换为UTF-8字符串时出现错误；<br>
ERR_DATABASE_INTERNAL (5120)              – 内部数据库错误；<br>
ERR_DATABASE_INVALID_HANDLE (5121)   - 无效数据库句柄；<br>
ERR_DATABASE_EXECUTE (5124)               -  请求执行错误；<br>
ERR_DATABASE_NO_MORE_DATA (5126)    - 不存在表格（没有错误，正常完成）。<br></p> <h2 id="_30-7-databaseexecute"><a href="#_30-7-databaseexecute" class="header-anchor">#</a> 30.7 DatabaseExecute</h2> <p>执行对指定数据库的请求。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>     database<span class="token punctuation">,</span>      <span class="token comment">// 在DatabaseOpen中接收的数据库句柄</span>
   string  sql            <span class="token comment">// SQL请求</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数</p> <p>database</p> <p>[in]  在DatabaseOpen()中接收的数据库句柄。</p> <p>sql</p> <p>[in]  SQL request.</p> <p>返回值</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INTERNAL_ERROR (4001)                   –  重要运行时错误；<br>
ERR_INVALID_PARAMETER (4003)              –  sql参数包含空字符串；<br>
ERR_NOT_ENOUGH_MEMORY (4004)          –  内存不足；<br>
ERR_WRONG_STRING_PARAMETER (5040)  – 将请求转换为UTF-8字符串时出现错误；<br>
ERR_DATABASE_INTERNAL (5120)              – 内部数据库错误；<br>
ERR_DATABASE_INVALID_HANDLE (5121)   – 无效数据库句柄；<br>
ERR_DATABASE_EXECUTE (5124)               –  请求执行错误。<br></p> <p>例:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//--- symbol statistics</span>
<span class="token keyword">struct</span> <span class="token class-name">Symbol_Stats</span>
  <span class="token punctuation">{</span>
   string            name<span class="token punctuation">;</span>             <span class="token comment">// symbol name</span>
   <span class="token keyword">int</span>               trades<span class="token punctuation">;</span>           <span class="token comment">// number of trades for the symbol</span>
   <span class="token keyword">double</span>            gross_profit<span class="token punctuation">;</span>     <span class="token comment">// total profit for the symbol</span>
   <span class="token keyword">double</span>            gross_loss<span class="token punctuation">;</span>       <span class="token comment">// total loss for the symbol</span>
   <span class="token keyword">double</span>            total_commission<span class="token punctuation">;</span> <span class="token comment">// total commission for the symbol</span>
   <span class="token keyword">double</span>            total_swap<span class="token punctuation">;</span>       <span class="token comment">// total swaps for the symbol</span>
   <span class="token keyword">double</span>            total_profit<span class="token punctuation">;</span>     <span class="token comment">// total profit excluding swaps and commissions</span>
   <span class="token keyword">double</span>            net_profit<span class="token punctuation">;</span>       <span class="token comment">// net profit taking into account swaps and commissions</span>
   <span class="token keyword">int</span>               win_trades<span class="token punctuation">;</span>       <span class="token comment">// number of profitable trades</span>
   <span class="token keyword">int</span>               loss_trades<span class="token punctuation">;</span>      <span class="token comment">// number of losing trades</span>
   <span class="token keyword">double</span>            expected_payoff<span class="token punctuation">;</span>  <span class="token comment">// expected payoff for the trade excluding swaps and commissions</span>
   <span class="token keyword">double</span>            win_percent<span class="token punctuation">;</span>      <span class="token comment">// percentage of winning trades</span>
   <span class="token keyword">double</span>            loss_percent<span class="token punctuation">;</span>     <span class="token comment">// percentage of losing trades</span>
   <span class="token keyword">double</span>            average_profit<span class="token punctuation">;</span>   <span class="token comment">// average profit</span>
   <span class="token keyword">double</span>            average_loss<span class="token punctuation">;</span>     <span class="token comment">// average loss</span>
   <span class="token keyword">double</span>            profit_factor<span class="token punctuation">;</span>    <span class="token comment">// profit factor</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- Magic Number statistics</span>
<span class="token keyword">struct</span> <span class="token class-name">Magic_Stats</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">long</span>              magic<span class="token punctuation">;</span>            <span class="token comment">// EA's Magic Number</span>
   <span class="token keyword">int</span>               trades<span class="token punctuation">;</span>           <span class="token comment">// number of trades for the symbol</span>
   <span class="token keyword">double</span>            gross_profit<span class="token punctuation">;</span>     <span class="token comment">// total profit for the symbol</span>
   <span class="token keyword">double</span>            gross_loss<span class="token punctuation">;</span>       <span class="token comment">// total loss for the symbol</span>
   <span class="token keyword">double</span>            total_commission<span class="token punctuation">;</span> <span class="token comment">// total commission for the symbol</span>
   <span class="token keyword">double</span>            total_swap<span class="token punctuation">;</span>       <span class="token comment">// total swaps for the symbol</span>
   <span class="token keyword">double</span>            total_profit<span class="token punctuation">;</span>     <span class="token comment">// total profit excluding swaps and commissions</span>
   <span class="token keyword">double</span>            net_profit<span class="token punctuation">;</span>       <span class="token comment">// net profit taking into account swaps and commissions</span>
   <span class="token keyword">int</span>               win_trades<span class="token punctuation">;</span>       <span class="token comment">// number of profitable trades</span>
   <span class="token keyword">int</span>               loss_trades<span class="token punctuation">;</span>      <span class="token comment">// number of losing trades</span>
   <span class="token keyword">double</span>            expected_payoff<span class="token punctuation">;</span>  <span class="token comment">// expected payoff for the trade excluding swaps and commissions</span>
   <span class="token keyword">double</span>            win_percent<span class="token punctuation">;</span>      <span class="token comment">// percentage of winning trades</span>
   <span class="token keyword">double</span>            loss_percent<span class="token punctuation">;</span>     <span class="token comment">// percentage of losing trades</span>
   <span class="token keyword">double</span>            average_profit<span class="token punctuation">;</span>   <span class="token comment">// average profit</span>
   <span class="token keyword">double</span>            average_loss<span class="token punctuation">;</span>     <span class="token comment">// average loss</span>
   <span class="token keyword">double</span>            profit_factor<span class="token punctuation">;</span>    <span class="token comment">// profit factor</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- entry hour statistics</span>
<span class="token keyword">struct</span> <span class="token class-name">Hour_Stats</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">char</span>              hour_in<span class="token punctuation">;</span>          <span class="token comment">// market entry hour</span>
   <span class="token keyword">int</span>               trades<span class="token punctuation">;</span>           <span class="token comment">// number of trades in this entry hour</span>
   <span class="token keyword">double</span>            volume<span class="token punctuation">;</span>           <span class="token comment">// volume of trades in this entry hour</span>
   <span class="token keyword">double</span>            gross_profit<span class="token punctuation">;</span>     <span class="token comment">// total profit in this entry hour</span>
   <span class="token keyword">double</span>            gross_loss<span class="token punctuation">;</span>       <span class="token comment">// total loss in this entry hour</span>
   <span class="token keyword">double</span>            net_profit<span class="token punctuation">;</span>       <span class="token comment">// net profit taking into account swaps and commissions</span>
   <span class="token keyword">int</span>               win_trades<span class="token punctuation">;</span>       <span class="token comment">// number of profitable trades</span>
   <span class="token keyword">int</span>               loss_trades<span class="token punctuation">;</span>      <span class="token comment">// number of losing trades</span>
   <span class="token keyword">double</span>            expected_payoff<span class="token punctuation">;</span>  <span class="token comment">// expected payoff for the trade excluding swaps and commissions</span>
   <span class="token keyword">double</span>            win_percent<span class="token punctuation">;</span>      <span class="token comment">// percentage of winning trades</span>
   <span class="token keyword">double</span>            loss_percent<span class="token punctuation">;</span>     <span class="token comment">// percentage of losing trades</span>
   <span class="token keyword">double</span>            average_profit<span class="token punctuation">;</span>   <span class="token comment">// average profit</span>
   <span class="token keyword">double</span>            average_loss<span class="token punctuation">;</span>     <span class="token comment">// average loss</span>
   <span class="token keyword">double</span>            profit_factor<span class="token punctuation">;</span>    <span class="token comment">// profit factor</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">int</span> ExtDealsTotal<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Script program start function                                    |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- create the file name</span>
   string filename<span class="token operator">=</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">AccountInfoInteger</span><span class="token punctuation">(</span>ACCOUNT_LOGIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;_stats.sqlite&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//--- open/create the database in the common terminal folder</span>
   <span class="token keyword">int</span> db<span class="token operator">=</span><span class="token function">DatabaseOpen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> DATABASE_OPEN_READWRITE <span class="token operator">|</span> DATABASE_OPEN_CREATE <span class="token operator">|</span> DATABASE_OPEN_COMMON<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>db<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; open failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- create the DEALS table</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CreateTableDeals</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Deals in the trading history: %d &quot;</span><span class="token punctuation">,</span> ExtDealsTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- get trading statistics per symbols</span>
   <span class="token keyword">int</span> request<span class="token operator">=</span><span class="token function">DatabasePrepare</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;SELECT r.*,&quot;</span>
                               <span class="token string">&quot;   (case when r.trades != 0 then (r.gross_profit+r.gross_loss)/r.trades else 0 end) as expected_payoff,&quot;</span>
                               <span class="token string">&quot;   (case when r.trades != 0 then r.win_trades*100.0/r.trades else 0 end) as win_percent,&quot;</span>
                               <span class="token string">&quot;   (case when r.trades != 0 then r.loss_trades*100.0/r.trades else 0 end) as loss_percent,&quot;</span>
                               <span class="token string">&quot;   r.gross_profit/r.win_trades as average_profit,&quot;</span>
                               <span class="token string">&quot;   r.gross_loss/r.loss_trades as average_loss,&quot;</span>
                               <span class="token string">&quot;   (case when r.gross_loss!=0.0 then r.gross_profit/(-r.gross_loss) else 0 end) as profit_factor &quot;</span>
                               <span class="token string">&quot;FROM &quot;</span>
                               <span class="token string">&quot;   (&quot;</span>
                               <span class="token string">&quot;   SELECT SYMBOL,&quot;</span>
                               <span class="token string">&quot;   sum(case when entry =1 then 1 else 0 end) as trades,&quot;</span>
                               <span class="token string">&quot;   sum(case when profit &gt; 0 then profit else 0 end) as gross_profit,&quot;</span>
                               <span class="token string">&quot;   sum(case when profit &lt; 0 then profit else 0 end) as gross_loss,&quot;</span>
                               <span class="token string">&quot;   sum(swap) as total_swap,&quot;</span>
                               <span class="token string">&quot;   sum(commission) as total_commission,&quot;</span>
                               <span class="token string">&quot;   sum(profit) as total_profit,&quot;</span>
                               <span class="token string">&quot;   sum(profit+swap+commission) as net_profit,&quot;</span>
                               <span class="token string">&quot;   sum(case when profit &gt; 0 then 1 else 0 end) as win_trades,&quot;</span>
                               <span class="token string">&quot;   sum(case when profit &lt; 0 then 1 else 0 end) as loss_trades &quot;</span>
                               <span class="token string">&quot;   FROM DEALS &quot;</span>
                               <span class="token string">&quot;   WHERE SYMBOL &lt;&gt; '' and SYMBOL is not NULL &quot;</span>
                               <span class="token string">&quot;   GROUP BY SYMBOL&quot;</span>
                               <span class="token string">&quot;   ) as r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; request failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   Symbol_Stats stats<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> symbol_stats<span class="token punctuation">;</span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>stats<span class="token punctuation">,</span> ExtDealsTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//--- get records from request results</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token function">DatabaseReadBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> symbol_stats<span class="token punctuation">)</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>trades<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>trades<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>gross_profit<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>gross_profit<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>gross_loss<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>gross_loss<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>total_commission<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>total_commission<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>total_swap<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>total_swap<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>total_profit<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>total_profit<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>net_profit<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>net_profit<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>win_trades<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>win_trades<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>loss_trades<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>loss_trades<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>expected_payoff<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>expected_payoff<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>win_percent<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>win_percent<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>loss_percent<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>loss_percent<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>average_profit<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>average_profit<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>average_loss<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>average_loss<span class="token punctuation">;</span>
      stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>profit_factor<span class="token operator">=</span>symbol_stats<span class="token punctuation">.</span>profit_factor<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>stats<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Trade statistics by Symbol&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">ArrayPrint</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- delete the request</span>
   <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- get trading statistics for Expert Advisors by Magic Numbers</span>
   request<span class="token operator">=</span><span class="token function">DatabasePrepare</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;SELECT r.*,&quot;</span>
                           <span class="token string">&quot;   (case when r.trades != 0 then (r.gross_profit+r.gross_loss)/r.trades else 0 end) as expected_payoff,&quot;</span>
                           <span class="token string">&quot;   (case when r.trades != 0 then r.win_trades*100.0/r.trades else 0 end) as win_percent,&quot;</span>
                           <span class="token string">&quot;   (case when r.trades != 0 then r.loss_trades*100.0/r.trades else 0 end) as loss_percent,&quot;</span>
                           <span class="token string">&quot;   r.gross_profit/r.win_trades as average_profit,&quot;</span>
                           <span class="token string">&quot;   r.gross_loss/r.loss_trades as average_loss,&quot;</span>
                           <span class="token string">&quot;   (case when r.gross_loss!=0.0 then r.gross_profit/(-r.gross_loss) else 0 end) as profit_factor &quot;</span>
                           <span class="token string">&quot;FROM &quot;</span>
                           <span class="token string">&quot;   (&quot;</span>
                           <span class="token string">&quot;   SELECT MAGIC,&quot;</span>
                           <span class="token string">&quot;   sum(case when entry =1 then 1 else 0 end) as trades,&quot;</span>
                           <span class="token string">&quot;   sum(case when profit &gt; 0 then profit else 0 end) as gross_profit,&quot;</span>
                           <span class="token string">&quot;   sum(case when profit &lt; 0 then profit else 0 end) as gross_loss,&quot;</span>
                           <span class="token string">&quot;   sum(swap) as total_swap,&quot;</span>
                           <span class="token string">&quot;   sum(commission) as total_commission,&quot;</span>
                           <span class="token string">&quot;   sum(profit) as total_profit,&quot;</span>
                           <span class="token string">&quot;   sum(profit+swap+commission) as net_profit,&quot;</span>
                           <span class="token string">&quot;   sum(case when profit &gt; 0 then 1 else 0 end) as win_trades,&quot;</span>
                           <span class="token string">&quot;   sum(case when profit &lt; 0 then 1 else 0 end) as loss_trades &quot;</span>
                           <span class="token string">&quot;   FROM DEALS &quot;</span>
                           <span class="token string">&quot;   WHERE SYMBOL &lt;&gt; '' and SYMBOL is not NULL &quot;</span>
                           <span class="token string">&quot;   GROUP BY MAGIC&quot;</span>
                           <span class="token string">&quot;   ) as r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; request failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   Magic_Stats EA_stats<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> magic_stats<span class="token punctuation">;</span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>EA_stats<span class="token punctuation">,</span> ExtDealsTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
   i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//--- print</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token function">DatabaseReadBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> magic_stats<span class="token punctuation">)</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>magic<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>magic<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>trades<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>trades<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>gross_profit<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>gross_profit<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>gross_loss<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>gross_loss<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>total_commission<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>total_commission<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>total_swap<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>total_swap<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>total_profit<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>total_profit<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>net_profit<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>net_profit<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>win_trades<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>win_trades<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>loss_trades<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>loss_trades<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>expected_payoff<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>expected_payoff<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>win_percent<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>win_percent<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>loss_percent<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>loss_percent<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>average_profit<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>average_profit<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>average_loss<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>average_loss<span class="token punctuation">;</span>
      EA_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>profit_factor<span class="token operator">=</span>magic_stats<span class="token punctuation">.</span>profit_factor<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>EA_stats<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Trade statistics by Magic Number&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">ArrayPrint</span><span class="token punctuation">(</span>EA_stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- delete the request</span>
   <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- make sure that hedging system for open position management is used on the account</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ENUM_ACCOUNT_MARGIN_MODE<span class="token punctuation">)</span><span class="token function">AccountInfoInteger</span><span class="token punctuation">(</span>ACCOUNT_MARGIN_MODE<span class="token punctuation">)</span><span class="token operator">!=</span>ACCOUNT_MARGIN_MODE_RETAIL_HEDGING<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- deals cannot be transformed to trades using a simple method through transactions, therefore complete operation</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- now create the TRADES table based on the DEALS table</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CreateTableTrades</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- fill in the TRADES table using an SQL query based on DEALS table data</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabaseTableExists</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;DEALS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//--- populate the TRADES table</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;INSERT INTO TRADES(TIME_IN,HOUR_IN,TICKET,TYPE,VOLUME,SYMBOL,PRICE_IN,TIME_OUT,PRICE_OUT,COMMISSION,SWAP,PROFIT) &quot;</span>
                          <span class="token string">&quot;SELECT &quot;</span>
                          <span class="token string">&quot;   d1.time as time_in,&quot;</span>
                          <span class="token string">&quot;   d1.hour as hour_in,&quot;</span>
                          <span class="token string">&quot;   d1.position_id as ticket,&quot;</span>
                          <span class="token string">&quot;   d1.type as type,&quot;</span>
                          <span class="token string">&quot;   d1.volume as volume,&quot;</span>
                          <span class="token string">&quot;   d1.symbol as symbol,&quot;</span>
                          <span class="token string">&quot;   d1.price as price_in,&quot;</span>
                          <span class="token string">&quot;   d2.time as time_out,&quot;</span>
                          <span class="token string">&quot;   d2.price as price_out,&quot;</span>
                          <span class="token string">&quot;   d1.commission+d2.commission as commission,&quot;</span>
                          <span class="token string">&quot;   d2.swap as swap,&quot;</span>
                          <span class="token string">&quot;   d2.profit as profit &quot;</span>
                          <span class="token string">&quot;FROM DEALS d1 &quot;</span>
                          <span class="token string">&quot;INNER JOIN DEALS d2 ON d1.position_id=d2.position_id &quot;</span>
                          <span class="token string">&quot;WHERE d1.entry=0 AND d2.entry=1     &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: fillng the table TRADES failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
<span class="token comment">//--- get trading statistics by market entry hours</span>
   request<span class="token operator">=</span><span class="token function">DatabasePrepare</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;SELECT r.*,&quot;</span>
                           <span class="token string">&quot;   (case when r.trades != 0 then (r.gross_profit+r.gross_loss)/r.trades else 0 end) as expected_payoff,&quot;</span>
                           <span class="token string">&quot;   (case when r.trades != 0 then r.win_trades*100.0/r.trades else 0 end) as win_percent,&quot;</span>
                           <span class="token string">&quot;   (case when r.trades != 0 then r.loss_trades*100.0/r.trades else 0 end) as loss_percent,&quot;</span>
                           <span class="token string">&quot;   r.gross_profit/r.win_trades as average_profit,&quot;</span>
                           <span class="token string">&quot;   r.gross_loss/r.loss_trades as average_loss,&quot;</span>
                           <span class="token string">&quot;   (case when r.gross_loss!=0.0 then r.gross_profit/(-r.gross_loss) else 0 end) as profit_factor &quot;</span>
                           <span class="token string">&quot;FROM &quot;</span>
                           <span class="token string">&quot;   (&quot;</span>
                           <span class="token string">&quot;   SELECT HOUR_IN,&quot;</span>
                           <span class="token string">&quot;   count() as trades,&quot;</span>
                           <span class="token string">&quot;   sum(volume) as volume,&quot;</span>
                           <span class="token string">&quot;   sum(case when profit &gt; 0 then profit else 0 end) as gross_profit,&quot;</span>
                           <span class="token string">&quot;   sum(case when profit &lt; 0 then profit else 0 end) as gross_loss,&quot;</span>
                           <span class="token string">&quot;   sum(profit) as net_profit,&quot;</span>
                           <span class="token string">&quot;   sum(case when profit &gt; 0 then 1 else 0 end) as win_trades,&quot;</span>
                           <span class="token string">&quot;   sum(case when profit &lt; 0 then 1 else 0 end) as loss_trades &quot;</span>
                           <span class="token string">&quot;   FROM TRADES &quot;</span>
                           <span class="token string">&quot;   WHERE SYMBOL &lt;&gt; '' and SYMBOL is not NULL &quot;</span>
                           <span class="token string">&quot;   GROUP BY HOUR_IN&quot;</span>
                           <span class="token string">&quot;   ) as r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; request failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   Hour_Stats hours_stats<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> h_stats<span class="token punctuation">;</span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>hours_stats<span class="token punctuation">,</span> ExtDealsTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
   i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//--- print</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token function">DatabaseReadBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> h_stats<span class="token punctuation">)</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>hour_in<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>hour_in<span class="token punctuation">;</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>trades<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>trades<span class="token punctuation">;</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>volume<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>volume<span class="token punctuation">;</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>gross_profit<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>gross_profit<span class="token punctuation">;</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>gross_loss<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>gross_loss<span class="token punctuation">;</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>net_profit<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>net_profit<span class="token punctuation">;</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>win_trades<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>win_trades<span class="token punctuation">;</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>loss_trades<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>loss_trades<span class="token punctuation">;</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>expected_payoff<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>expected_payoff<span class="token punctuation">;</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>win_percent<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>win_percent<span class="token punctuation">;</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>loss_percent<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>loss_percent<span class="token punctuation">;</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>average_profit<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>average_profit<span class="token punctuation">;</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>average_loss<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>average_loss<span class="token punctuation">;</span>
      hours_stats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>profit_factor<span class="token operator">=</span>h_stats<span class="token punctuation">.</span>profit_factor<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>hours_stats<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Trade statistics by entry hour&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">ArrayPrint</span><span class="token punctuation">(</span>hours_stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- delete the request</span>
   <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- close database</span>
   <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">/*
Deals in the trading history: 2771 
Trade statistics by Symbol
      [name] [trades] [gross_profit] [gross_loss] [total_commission] [total_swap] [total_profit] [net_profit] [win_trades] [loss_trades] [expected_payoff] [win_percent] [loss_percent] [average_profit] [average_loss] [profit_factor]
[0] &quot;AUDUSD&quot;      112      503.20000   -568.00000           -8.83000    -24.64000      -64.80000    -98.27000           70            42          -0.57857      62.50000       37.50000          7.18857      -13.52381         0.88592
[1] &quot;EURCHF&quot;      125      607.71000   -956.85000          -11.77000    -45.02000     -349.14000   -405.93000           54            71          -2.79312      43.20000       56.80000         11.25389      -13.47676         0.63512
[2] &quot;EURJPY&quot;      127     1078.49000  -1057.83000          -10.61000    -45.76000       20.66000    -35.71000           64            63           0.16268      50.39370       49.60630         16.85141      -16.79095         1.01953
[3] &quot;EURUSD&quot;      233     1685.60000  -1386.80000          -41.00000    -83.76000      298.80000    174.04000          127           106           1.28240      54.50644       45.49356         13.27244      -13.08302         1.21546
[4] &quot;GBPCHF&quot;      125     1881.37000  -1424.72000          -22.60000    -51.56000      456.65000    382.49000           80            45           3.65320      64.00000       36.00000         23.51712      -31.66044         1.32052
[5] &quot;GBPJPY&quot;      127     1943.43000  -1776.67000          -18.84000    -52.46000      166.76000     95.46000           76            51           1.31307      59.84252       40.15748         25.57145      -34.83667         1.09386
[6] &quot;GBPUSD&quot;      121     1668.50000  -1438.20000           -7.96000    -49.93000      230.30000    172.41000           77            44           1.90331      63.63636       36.36364         21.66883      -32.68636         1.16013
[7] &quot;USDCAD&quot;       99      405.28000   -475.47000           -8.68000    -31.68000      -70.19000   -110.55000           51            48          -0.70899      51.51515       48.48485          7.94667       -9.90563         0.85238
[8] &quot;USDCHF&quot;      206     1588.32000  -1241.83000          -17.98000    -65.92000      346.49000    262.59000          131            75           1.68199      63.59223       36.40777         12.12458      -16.55773         1.27902
[9] &quot;USDJPY&quot;      107      464.73000   -730.64000          -35.12000    -34.24000     -265.91000   -335.27000           50            57          -2.48514      46.72897       53.27103          9.29460      -12.81825         0.63606
 
Trade statistics by Magic Number
    [magic] [trades] [gross_profit] [gross_loss] [total_commission] [total_swap] [total_profit] [net_profit] [win_trades] [loss_trades] [expected_payoff] [win_percent] [loss_percent] [average_profit] [average_loss] [profit_factor]
[0]     100      242     2584.80000  -2110.00000          -33.36000    -93.53000      474.80000    347.91000          143            99           1.96198      59.09091       40.90909         18.07552      -21.31313         1.22502
[1]     200      254     3021.92000  -2834.50000          -29.45000    -98.22000      187.42000     59.75000          140           114           0.73787      55.11811       44.88189         21.58514      -24.86404         1.06612
[2]     300      250     2489.08000  -2381.57000          -34.37000    -96.58000      107.51000    -23.44000          134           116           0.43004      53.60000       46.40000         18.57522      -20.53078         1.04514
[3]     400      224     1272.50000  -1283.00000          -24.43000    -64.80000      -10.50000    -99.73000          131            93          -0.04687      58.48214       41.51786          9.71374      -13.79570         0.99182
[4]     500      198     1141.23000  -1051.91000          -27.66000    -63.36000       89.32000     -1.70000          116            82           0.45111      58.58586       41.41414          9.83819      -12.82817         1.08491
[5]     600      214     1317.10000  -1396.03000          -34.12000    -68.48000      -78.93000   -181.53000          116            98          -0.36883      54.20561       45.79439         11.35431      -14.24520         0.94346
 
Trade statistics by entry hour
     [hour_in] [trades] [volume] [gross_profit] [gross_loss] [net_profit] [win_trades] [loss_trades] [expected_payoff] [win_percent] [loss_percent] [average_profit] [average_loss] [profit_factor]
[ 0]         0       50  5.00000      336.51000   -747.47000   -410.96000           21            29          -8.21920      42.00000       58.00000         16.02429      -25.77483         0.45020
[ 1]         1       20  2.00000      102.56000    -57.20000     45.36000           12             8           2.26800      60.00000       40.00000          8.54667       -7.15000         1.79301
[ 2]         2        6  0.60000       38.55000    -14.60000     23.95000            5             1           3.99167      83.33333       16.66667          7.71000      -14.60000         2.64041
[ 3]         3       38  3.80000      173.84000   -200.15000    -26.31000           22            16          -0.69237      57.89474       42.10526          7.90182      -12.50938         0.86855
[ 4]         4       60  6.00000      361.44000   -389.40000    -27.96000           27            33          -0.46600      45.00000       55.00000         13.38667      -11.80000         0.92820
[ 5]         5       32  3.20000      157.43000   -179.89000    -22.46000           20            12          -0.70187      62.50000       37.50000          7.87150      -14.99083         0.87515
[ 6]         6       18  1.80000       95.59000   -162.33000    -66.74000           11             7          -3.70778      61.11111       38.88889          8.69000      -23.19000         0.58886
[ 7]         7       14  1.40000       38.48000   -134.30000    -95.82000            9             5          -6.84429      64.28571       35.71429          4.27556      -26.86000         0.28652
[ 8]         8       42  4.20000      368.48000   -322.30000     46.18000           24            18           1.09952      57.14286       42.85714         15.35333      -17.90556         1.14328
[ 9]         9      118 11.80000     1121.62000   -875.21000    246.41000           72            46           2.08822      61.01695       38.98305         15.57806      -19.02630         1.28154
[10]        10      206 20.60000     2280.59000  -2021.80000    258.79000          115            91           1.25626      55.82524       44.17476         19.83122      -22.21758         1.12800
[11]        11      138 13.80000     1377.02000   -994.18000    382.84000           84            54           2.77420      60.86957       39.13043         16.39310      -18.41074         1.38508
[12]        12      152 15.20000     1247.56000  -1463.80000   -216.24000           84            68          -1.42263      55.26316       44.73684         14.85190      -21.52647         0.85227
[13]        13       64  6.40000      778.27000   -516.22000    262.05000           36            28           4.09453      56.25000       43.75000         21.61861      -18.43643         1.50763
[14]        14       62  6.20000      536.93000   -427.47000    109.46000           38            24           1.76548      61.29032       38.70968         14.12974      -17.81125         1.25606
[15]        15       50  5.00000      699.92000   -413.00000    286.92000           28            22           5.73840      56.00000       44.00000         24.99714      -18.77273         1.69472
[16]        16       88  8.80000      778.55000   -514.00000    264.55000           51            37           3.00625      57.95455       42.04545         15.26569      -13.89189         1.51469
[17]        17       76  7.60000      533.92000  -1019.46000   -485.54000           44            32          -6.38868      57.89474       42.10526         12.13455      -31.85813         0.52373
[18]        18       52  5.20000      237.17000   -246.78000     -9.61000           24            28          -0.18481      46.15385       53.84615          9.88208       -8.81357         0.96106
[19]        19       52  5.20000      407.67000   -150.36000    257.31000           30            22           4.94827      57.69231       42.30769         13.58900       -6.83455         2.71129
[20]        20       18  1.80000       65.92000    -89.09000    -23.17000            9             9          -1.28722      50.00000       50.00000          7.32444       -9.89889         0.73993
[21]        21       10  1.00000       41.86000    -32.38000      9.48000            7             3           0.94800      70.00000       30.00000          5.98000      -10.79333         1.29277
[22]        22       14  1.40000       45.55000    -83.72000    -38.17000            6             8          -2.72643      42.85714       57.14286          7.59167      -10.46500         0.54408
[23]        23        2  0.20000        1.20000     -1.90000     -0.70000            1             1          -0.35000      50.00000       50.00000          1.20000       -1.90000         0.63158
*/</span>  
  
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Creates the DEALS table                                          |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">CreateTableDeals</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- if the DEALS table already exists, delete it</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DeleteTable</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;DEALS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- check if the table exists</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseTableExists</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;DEALS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//--- create the table</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;CREATE TABLE DEALS(&quot;</span>
                          <span class="token string">&quot;ID          INT KEY NOT NULL,&quot;</span>
                          <span class="token string">&quot;ORDER_ID    INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;POSITION_ID INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;TIME        INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;TYPE        INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;ENTRY       INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;SYMBOL      CHAR(10),&quot;</span>
                          <span class="token string">&quot;VOLUME      REAL,&quot;</span>
                          <span class="token string">&quot;PRICE       REAL,&quot;</span>
                          <span class="token string">&quot;PROFIT      REAL,&quot;</span>
                          <span class="token string">&quot;SWAP        REAL,&quot;</span>
                          <span class="token string">&quot;COMMISSION  REAL,&quot;</span>
                          <span class="token string">&quot;MAGIC       INT,&quot;</span>
                          <span class="token string">&quot;HOUR        INT,&quot;</span>
                          <span class="token string">&quot;REASON      INT);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: create the DEALS table  failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">//---  request the entire trading history</span>
   datetime from_date<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
   datetime to_date<span class="token operator">=</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- request the history of deals in the specified interval</span>
   <span class="token function">HistorySelect</span><span class="token punctuation">(</span>from_date<span class="token punctuation">,</span> to_date<span class="token punctuation">)</span><span class="token punctuation">;</span>
   ExtDealsTotal<span class="token operator">=</span><span class="token function">HistoryDealsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- add deals to the table</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">InsertDeals</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- the table has been successfully created</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Deletes a table with the specified name from the database        |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">DeleteTable</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">,</span> string table_name<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;DROP TABLE IF EXISTS &quot;</span><span class="token operator">+</span>table_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to drop the DEALS table with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- the table has been successfully deleted</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Adds deals to the database table                                 |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">InsertDeals</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- Auxiliary variables</span>
   ulong    deal_ticket<span class="token punctuation">;</span>         <span class="token comment">// deal ticket</span>
   <span class="token keyword">long</span>     order_ticket<span class="token punctuation">;</span>        <span class="token comment">// the ticket of the order by which the deal was executed</span>
   <span class="token keyword">long</span>     position_ticket<span class="token punctuation">;</span>     <span class="token comment">// ID of the position to which the deal belongs</span>
   datetime time<span class="token punctuation">;</span>                <span class="token comment">// deal execution time</span>
   <span class="token keyword">long</span>     type <span class="token punctuation">;</span>               <span class="token comment">// deal type</span>
   <span class="token keyword">long</span>     entry <span class="token punctuation">;</span>              <span class="token comment">// deal direction</span>
   string   symbol<span class="token punctuation">;</span>              <span class="token comment">// the symbol fro which the deal was executed</span>
   <span class="token keyword">double</span>   volume<span class="token punctuation">;</span>              <span class="token comment">// operation volume</span>
   <span class="token keyword">double</span>   price<span class="token punctuation">;</span>               <span class="token comment">// price</span>
   <span class="token keyword">double</span>   profit<span class="token punctuation">;</span>              <span class="token comment">// financial result</span>
   <span class="token keyword">double</span>   swap<span class="token punctuation">;</span>                <span class="token comment">// swap</span>
   <span class="token keyword">double</span>   commission<span class="token punctuation">;</span>          <span class="token comment">// commission</span>
   <span class="token keyword">long</span>     magic<span class="token punctuation">;</span>               <span class="token comment">// Magic number (Expert Advisor ID)</span>
   <span class="token keyword">long</span>     reason<span class="token punctuation">;</span>              <span class="token comment">// deal execution reason or source</span>
   <span class="token keyword">char</span>     hour<span class="token punctuation">;</span>                <span class="token comment">// deal execution hour</span>
   MqlDateTime time_strusture<span class="token punctuation">;</span>
<span class="token comment">//--- go through all deals and add them to the database</span>
   <span class="token keyword">bool</span> failed<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> deals<span class="token operator">=</span><span class="token function">HistoryDealsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// --- lock the database before executing transactions</span>
   <span class="token function">DatabaseTransactionBegin</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> deals<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      deal_ticket<span class="token operator">=</span>    <span class="token function">HistoryDealGetTicket</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      order_ticket<span class="token operator">=</span>   <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_ORDER<span class="token punctuation">)</span><span class="token punctuation">;</span>
      position_ticket<span class="token operator">=</span><span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_POSITION_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      time<span class="token operator">=</span> <span class="token punctuation">(</span>datetime<span class="token punctuation">)</span><span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
      type<span class="token operator">=</span>           <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      entry<span class="token operator">=</span>          <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_ENTRY<span class="token punctuation">)</span><span class="token punctuation">;</span>
      symbol<span class="token operator">=</span>         <span class="token function">HistoryDealGetString</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_SYMBOL<span class="token punctuation">)</span><span class="token punctuation">;</span>
      volume<span class="token operator">=</span>         <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_VOLUME<span class="token punctuation">)</span><span class="token punctuation">;</span>
      price<span class="token operator">=</span>          <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_PRICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      profit<span class="token operator">=</span>         <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_PROFIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
      swap<span class="token operator">=</span>           <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_SWAP<span class="token punctuation">)</span><span class="token punctuation">;</span>
      commission<span class="token operator">=</span>     <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_COMMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
      magic<span class="token operator">=</span>          <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_MAGIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
      reason<span class="token operator">=</span>         <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_REASON<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">TimeToStruct</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> time_strusture<span class="token punctuation">)</span><span class="token punctuation">;</span>
      hour<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>time_strusture<span class="token punctuation">.</span>hour<span class="token punctuation">;</span>
      <span class="token comment">//--- add each deal to the table using the following request</span>
      string request_text<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;INSERT INTO DEALS (ID,ORDER_ID,POSITION_ID,TIME,TYPE,ENTRY,SYMBOL,VOLUME,PRICE,PROFIT,SWAP,COMMISSION,MAGIC,REASON,HOUR)&quot;</span>
                                       <span class="token string">&quot;VALUES (%d, %d, %d, %d, %d, %d, '%s', %G, %G, %G, %G, %G, %d, %d,%d)&quot;</span><span class="token punctuation">,</span>
                                       deal_ticket<span class="token punctuation">,</span> order_ticket<span class="token punctuation">,</span> position_ticket<span class="token punctuation">,</span> time<span class="token punctuation">,</span> type<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> symbol<span class="token punctuation">,</span> volume<span class="token punctuation">,</span> price<span class="token punctuation">,</span> profit<span class="token punctuation">,</span> swap<span class="token punctuation">,</span> commission<span class="token punctuation">,</span> magic<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> hour<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> request_text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: failed to insert deal #%d with code %d&quot;</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> deal_ticket<span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;i=%d: deal #%d  %s&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> deal_ticket<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span><span class="token punctuation">;</span>
         failed<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- check for transaction execution errors</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- roll back all transactions and unlock the database</span>
      <span class="token function">DatabaseTransactionRollback</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: DatabaseExecute() failed with code &quot;</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- all transactions have been performed successfully - record changes and unlock the database</span>
   <span class="token function">DatabaseTransactionCommit</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Creates the TRADES table                                         |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">CreateTableTrades</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- if the TRADES table already exists, delete it</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DeleteTable</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;TRADES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- check if the table exists</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseTableExists</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;TRADES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//--- create the table</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;CREATE TABLE TRADES(&quot;</span>
                          <span class="token string">&quot;TIME_IN     INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;HOUR_IN     INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;TICKET      INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;TYPE        INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;VOLUME      REAL,&quot;</span>
                          <span class="token string">&quot;SYMBOL      CHAR(10),&quot;</span>
                          <span class="token string">&quot;PRICE_IN    REAL,&quot;</span>
                          <span class="token string">&quot;TIME_OUT    INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;PRICE_OUT   REAL,&quot;</span>
                          <span class="token string">&quot;COMMISSION  REAL,&quot;</span>
                          <span class="token string">&quot;SWAP        REAL,&quot;</span>
                          <span class="token string">&quot;PROFIT      REAL);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: create the TRADES table failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">//--- the table has been successfully created</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br><span class="line-number">473</span><br><span class="line-number">474</span><br><span class="line-number">475</span><br><span class="line-number">476</span><br><span class="line-number">477</span><br><span class="line-number">478</span><br><span class="line-number">479</span><br><span class="line-number">480</span><br><span class="line-number">481</span><br><span class="line-number">482</span><br><span class="line-number">483</span><br><span class="line-number">484</span><br><span class="line-number">485</span><br><span class="line-number">486</span><br><span class="line-number">487</span><br><span class="line-number">488</span><br><span class="line-number">489</span><br><span class="line-number">490</span><br><span class="line-number">491</span><br><span class="line-number">492</span><br><span class="line-number">493</span><br><span class="line-number">494</span><br><span class="line-number">495</span><br><span class="line-number">496</span><br><span class="line-number">497</span><br><span class="line-number">498</span><br><span class="line-number">499</span><br><span class="line-number">500</span><br><span class="line-number">501</span><br><span class="line-number">502</span><br><span class="line-number">503</span><br><span class="line-number">504</span><br><span class="line-number">505</span><br><span class="line-number">506</span><br><span class="line-number">507</span><br><span class="line-number">508</span><br><span class="line-number">509</span><br><span class="line-number">510</span><br><span class="line-number">511</span><br><span class="line-number">512</span><br><span class="line-number">513</span><br><span class="line-number">514</span><br></div></div><p>另见</p> <p>DatabasePrepare、DatabaseFinalize</p> <h2 id="_30-8-databaseprepare"><a href="#_30-8-databaseprepare" class="header-anchor">#</a> 30.8 DatabasePrepare</h2> <p>创建可使用DatabaseRead()执行的请求句柄。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">DatabasePrepare</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>     database<span class="token punctuation">,</span>      <span class="token comment">// 在DatabaseOpen中接收的数据库句柄</span>
   string  sql<span class="token punctuation">,</span>           <span class="token comment">// SQL 请求</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment">// 请求参数</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>database</p> <p>[in]  在DatabaseOpen()中接收的数据库句柄。</p> <p>sql</p> <p>[in]  SQL请求，可能包含自动替换参数，其名为?1,?2,...</p> <p>...</p> <p>[in]  自动替换请求参数。</p> <p>返回值</p> <p>如果成功，函数返回SQL请求句柄。否则，返回INVALID_HANDLE。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INVALID_PARAMETER (4003)                  – 数据库文件的路径包含空字符串，或设置不兼容的标识组合；<br>
ERR_NOT_ENOUGH_MEMORY (4004)              - 内存不足；<br>
ERR_WRONG_STRING_PARAMETER (5040)      – 将请求转换为UTF-8字符串时出现错误；<br>
ERR_DATABASE_INVALID_HANDLE (5121)       - 无效数据库句柄；<br>
ERR_DATABASE_TOO_MANY_OBJECTS (5122) - 超过可接受的数据库对象的最大数目；<br>
ERR_DATABASE_PREPARE (5125)                   - 请求生成错误。<br></p> <p>注意</p> <p>DatabasePrepare()函数不执行对数据库的请求。其目的是验证请求参数，并根据验证结果返回执行SQL请求的句柄。请求本身在第一次调用DatabaseRead()期间进行设置。</p> <p>例:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//--- Structure to store the deal</span>
<span class="token keyword">struct</span> <span class="token class-name">Deal</span>
  <span class="token punctuation">{</span>
   ulong             ticket<span class="token punctuation">;</span>           <span class="token comment">// DEAL_TICKET</span>
   <span class="token keyword">long</span>              order_ticket<span class="token punctuation">;</span>     <span class="token comment">// DEAL_ORDER</span>
   <span class="token keyword">long</span>              position_ticket<span class="token punctuation">;</span>  <span class="token comment">// DEAL_POSITION_ID</span>
   datetime          time<span class="token punctuation">;</span>             <span class="token comment">// DEAL_TIME</span>
   <span class="token keyword">char</span>              type<span class="token punctuation">;</span>             <span class="token comment">// DEAL_TYPE</span>
   <span class="token keyword">char</span>              entry<span class="token punctuation">;</span>            <span class="token comment">// DEAL_ENTRY</span>
   string            symbol<span class="token punctuation">;</span>           <span class="token comment">// DEAL_SYMBOL</span>
   <span class="token keyword">double</span>            volume<span class="token punctuation">;</span>           <span class="token comment">// DEAL_VOLUME</span>
   <span class="token keyword">double</span>            price<span class="token punctuation">;</span>            <span class="token comment">// DEAL_PRICE</span>
   <span class="token keyword">double</span>            profit<span class="token punctuation">;</span>           <span class="token comment">// DEAL_PROFIT</span>
   <span class="token keyword">double</span>            swap<span class="token punctuation">;</span>             <span class="token comment">// DEAL_SWAP</span>
   <span class="token keyword">double</span>            commission<span class="token punctuation">;</span>       <span class="token comment">// DEAL_COMMISSION</span>
   <span class="token keyword">long</span>              magic<span class="token punctuation">;</span>            <span class="token comment">// DEAL_MAGIC</span>
   <span class="token keyword">char</span>              reason<span class="token punctuation">;</span>           <span class="token comment">// DEAL_REASON</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//--- Structure to store the trade: the order of members corresponds to the position in the terminal</span>
<span class="token keyword">struct</span> <span class="token class-name">Trade</span>
  <span class="token punctuation">{</span>
   datetime          time_in<span class="token punctuation">;</span>          <span class="token comment">// entry time</span>
   ulong             ticket<span class="token punctuation">;</span>           <span class="token comment">// position ID</span>
   <span class="token keyword">char</span>              type<span class="token punctuation">;</span>             <span class="token comment">// buy or sell</span>
   <span class="token keyword">double</span>            volume<span class="token punctuation">;</span>           <span class="token comment">// volume</span>
   string            symbol<span class="token punctuation">;</span>           <span class="token comment">// symbol</span>
   <span class="token keyword">double</span>            price_in<span class="token punctuation">;</span>         <span class="token comment">// entry price</span>
   datetime          time_out<span class="token punctuation">;</span>         <span class="token comment">// exit time</span>
   <span class="token keyword">double</span>            price_out<span class="token punctuation">;</span>        <span class="token comment">// exit price</span>
   <span class="token keyword">double</span>            commission<span class="token punctuation">;</span>       <span class="token comment">// entry and exit commission</span>
   <span class="token keyword">double</span>            swap<span class="token punctuation">;</span>             <span class="token comment">// swap</span>
   <span class="token keyword">double</span>            profit<span class="token punctuation">;</span>           <span class="token comment">// profit or loss</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Script program start function                                    |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- create the file name</span>
   string filename<span class="token operator">=</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">AccountInfoInteger</span><span class="token punctuation">(</span>ACCOUNT_LOGIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;_trades.sqlite&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//--- open/create the database in the common terminal folder</span>
   <span class="token keyword">int</span> db<span class="token operator">=</span><span class="token function">DatabaseOpen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> DATABASE_OPEN_READWRITE <span class="token operator">|</span> DATABASE_OPEN_CREATE <span class="token operator">|</span> DATABASE_OPEN_COMMON<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>db<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; open failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- create the DEALS table</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CreateTableDeals</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//---  request the entire trading history</span>
   datetime from_date<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
   datetime to_date<span class="token operator">=</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- request the history of deals in the specified interval</span>
   <span class="token function">HistorySelect</span><span class="token punctuation">(</span>from_date<span class="token punctuation">,</span> to_date<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> deals_total<span class="token operator">=</span><span class="token function">HistoryDealsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Deals in the trading history: %d &quot;</span><span class="token punctuation">,</span> deals_total<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- add deals to the table</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">InsertDeals</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token comment">//--- show the first 10 deals</span>
   Deal deals<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> deal<span class="token punctuation">;</span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>deals<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> request<span class="token operator">=</span><span class="token function">DatabasePrepare</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;SELECT * FROM DEALS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; request failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">int</span> i<span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token function">DatabaseReadBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> deal<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&gt;=</span><span class="token number">10</span><span class="token punctuation">)</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ticket<span class="token operator">=</span>deal<span class="token punctuation">.</span>ticket<span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>order_ticket<span class="token operator">=</span>deal<span class="token punctuation">.</span>order_ticket<span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>position_ticket<span class="token operator">=</span>deal<span class="token punctuation">.</span>position_ticket<span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>time<span class="token operator">=</span>deal<span class="token punctuation">.</span>time<span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>deal<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>entry<span class="token operator">=</span>deal<span class="token punctuation">.</span>entry<span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>symbol<span class="token operator">=</span>deal<span class="token punctuation">.</span>symbol<span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>volume<span class="token operator">=</span>deal<span class="token punctuation">.</span>volume<span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>price<span class="token operator">=</span>deal<span class="token punctuation">.</span>price<span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>profit<span class="token operator">=</span>deal<span class="token punctuation">.</span>profit<span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>swap<span class="token operator">=</span>deal<span class="token punctuation">.</span>swap<span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>commission<span class="token operator">=</span>deal<span class="token punctuation">.</span>commission<span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>magic<span class="token operator">=</span>deal<span class="token punctuation">.</span>magic<span class="token punctuation">;</span>
      deals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>reason<span class="token operator">=</span>deal<span class="token punctuation">.</span>reason<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- print the deals</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">ArrayResize</span><span class="token punctuation">(</span>deals<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;The first %d deals:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ArrayPrint</span><span class="token punctuation">(</span>deals<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- delete request after use</span>
   <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- make sure that hedging system for open position management is used on the account</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ENUM_ACCOUNT_MARGIN_MODE<span class="token punctuation">)</span><span class="token function">AccountInfoInteger</span><span class="token punctuation">(</span>ACCOUNT_MARGIN_MODE<span class="token punctuation">)</span><span class="token operator">!=</span>ACCOUNT_MARGIN_MODE_RETAIL_HEDGING<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- deals cannot be transformed to trades using a simple method through transactions, therefore complete operation</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- now create the TRADES table based on the DEALS table</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CreateTableTrades</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- fill in the TRADES table using an SQL query based on DEALS table data</span>
   ulong start<span class="token operator">=</span><span class="token function">GetMicrosecondCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabaseTableExists</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;DEALS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//--- populate the TRADES table</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;INSERT INTO TRADES(TIME_IN,TICKET,TYPE,VOLUME,SYMBOL,PRICE_IN,TIME_OUT,PRICE_OUT,COMMISSION,SWAP,PROFIT) &quot;</span>
                          <span class="token string">&quot;SELECT &quot;</span>
                          <span class="token string">&quot;   d1.time as time_in,&quot;</span>
                          <span class="token string">&quot;   d1.position_id as ticket,&quot;</span>
                          <span class="token string">&quot;   d1.type as type,&quot;</span>
                          <span class="token string">&quot;   d1.volume as volume,&quot;</span>
                          <span class="token string">&quot;   d1.symbol as symbol,&quot;</span>
                          <span class="token string">&quot;   d1.price as price_in,&quot;</span>
                          <span class="token string">&quot;   d2.time as time_out,&quot;</span>
                          <span class="token string">&quot;   d2.price as price_out,&quot;</span>
                          <span class="token string">&quot;   d1.commission+d2.commission as commission,&quot;</span>
                          <span class="token string">&quot;   d2.swap as swap,&quot;</span>
                          <span class="token string">&quot;   d2.profit as profit &quot;</span>
                          <span class="token string">&quot;FROM DEALS d1 &quot;</span>
                          <span class="token string">&quot;INNER JOIN DEALS d2 ON d1.position_id=d2.position_id &quot;</span>
                          <span class="token string">&quot;WHERE d1.entry=0 AND d2.entry=1     &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: fillng the TRADES table failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
   ulong transaction_time<span class="token operator">=</span><span class="token function">GetMicrosecondCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">;</span>
   
<span class="token comment">//--- show the first 10 deals</span>
   Trade trades<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trade<span class="token punctuation">;</span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>trades<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   request<span class="token operator">=</span><span class="token function">DatabasePrepare</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;SELECT * FROM TRADES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; request failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token function">DatabaseReadBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> trade<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&gt;=</span><span class="token number">10</span><span class="token punctuation">)</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
      trades<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>time_in<span class="token operator">=</span>trade<span class="token punctuation">.</span>time_in<span class="token punctuation">;</span>
      trades<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ticket<span class="token operator">=</span>trade<span class="token punctuation">.</span>ticket<span class="token punctuation">;</span>
      trades<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>trade<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      trades<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>volume<span class="token operator">=</span>trade<span class="token punctuation">.</span>volume<span class="token punctuation">;</span>
      trades<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>symbol<span class="token operator">=</span>trade<span class="token punctuation">.</span>symbol<span class="token punctuation">;</span>
      trades<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>price_in<span class="token operator">=</span>trade<span class="token punctuation">.</span>price_in<span class="token punctuation">;</span>
      trades<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>time_out<span class="token operator">=</span>trade<span class="token punctuation">.</span>time_out<span class="token punctuation">;</span>
      trades<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>price_out<span class="token operator">=</span>trade<span class="token punctuation">.</span>price_out<span class="token punctuation">;</span>
      trades<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>commission<span class="token operator">=</span>trade<span class="token punctuation">.</span>commission<span class="token punctuation">;</span>
      trades<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>swap<span class="token operator">=</span>trade<span class="token punctuation">.</span>swap<span class="token punctuation">;</span>
      trades<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>profit<span class="token operator">=</span>trade<span class="token punctuation">.</span>profit<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- print trades</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">ArrayResize</span><span class="token punctuation">(</span>trades<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;\r\nThe first %d trades:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ArrayPrint</span><span class="token punctuation">(</span>trades<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Filling the TRADES table took %.2f milliseconds&quot;</span><span class="token punctuation">,</span><span class="token keyword">double</span><span class="token punctuation">(</span>transaction_time<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- delete request after use</span>
   <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- close the database</span>
   <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">/*
Results:
   Deals in the trading history: 2741 
   The first 10 deals:
       [ticket] [order_ticket] [position_ticket]              [time] [type] [entry] [symbol] [volume]   [price]   [profit] [swap] [commission] [magic] [reason]
   [0] 34429573              0                 0 2019.09.05 22:39:59      2       0 &quot;&quot;        0.00000   0.00000 2000.00000 0.0000      0.00000       0        0
   [1] 34432127       51447238          51447238 2019.09.06 06:00:03      0       0 &quot;USDCAD&quot;  0.10000   1.32320    0.00000 0.0000     -0.16000     500        3
   [2] 34432128       51447239          51447239 2019.09.06 06:00:03      1       0 &quot;USDCHF&quot;  0.10000   0.98697    0.00000 0.0000     -0.16000     500        3
   [3] 34432450       51447565          51447565 2019.09.06 07:00:00      0       0 &quot;EURUSD&quot;  0.10000   1.10348    0.00000 0.0000     -0.18000     400        3
   [4] 34432456       51447571          51447571 2019.09.06 07:00:00      1       0 &quot;AUDUSD&quot;  0.10000   0.68203    0.00000 0.0000     -0.11000     400        3
   [5] 34432879       51448053          51448053 2019.09.06 08:00:00      1       0 &quot;USDCHF&quot;  0.10000   0.98701    0.00000 0.0000     -0.16000     600        3
   [6] 34432888       51448064          51448064 2019.09.06 08:00:00      0       0 &quot;USDJPY&quot;  0.10000 106.96200    0.00000 0.0000     -0.16000     600        3
   [7] 34435147       51450470          51450470 2019.09.06 10:30:00      1       0 &quot;EURUSD&quot;  0.10000   1.10399    0.00000 0.0000     -0.18000     100        3
   [8] 34435152       51450476          51450476 2019.09.06 10:30:00      0       0 &quot;GBPUSD&quot;  0.10000   1.23038    0.00000 0.0000     -0.20000     100        3
   [9] 34435154       51450479          51450479 2019.09.06 10:30:00      1       0 &quot;EURJPY&quot;  0.10000 118.12000    0.00000 0.0000     -0.18000     200        3
 
   The first 10 trades:
                 [time_in] [ticket] [type] [volume] [symbol] [price_in]          [time_out] [price_out] [commission]   [swap]  [profit]
   [0] 2019.09.06 06:00:03 51447238      0  0.10000 &quot;USDCAD&quot;    1.32320 2019.09.06 18:00:00     1.31761     -0.32000  0.00000 -42.43000
   [1] 2019.09.06 06:00:03 51447239      1  0.10000 &quot;USDCHF&quot;    0.98697 2019.09.06 18:00:00     0.98641     -0.32000  0.00000   5.68000
   [2] 2019.09.06 07:00:00 51447565      0  0.10000 &quot;EURUSD&quot;    1.10348 2019.09.09 03:30:00     1.10217     -0.36000 -1.31000 -13.10000
   [3] 2019.09.06 07:00:00 51447571      1  0.10000 &quot;AUDUSD&quot;    0.68203 2019.09.09 03:30:00     0.68419     -0.22000  0.03000 -21.60000
   [4] 2019.09.06 08:00:00 51448053      1  0.10000 &quot;USDCHF&quot;    0.98701 2019.09.06 18:00:01     0.98640     -0.32000  0.00000   6.18000
   [5] 2019.09.06 08:00:00 51448064      0  0.10000 &quot;USDJPY&quot;  106.96200 2019.09.06 18:00:01   106.77000     -0.32000  0.00000 -17.98000
   [6] 2019.09.06 10:30:00 51450470      1  0.10000 &quot;EURUSD&quot;    1.10399 2019.09.06 14:30:00     1.10242     -0.36000  0.00000  15.70000
   [7] 2019.09.06 10:30:00 51450476      0  0.10000 &quot;GBPUSD&quot;    1.23038 2019.09.06 14:30:00     1.23040     -0.40000  0.00000   0.20000
   [8] 2019.09.06 10:30:00 51450479      1  0.10000 &quot;EURJPY&quot;  118.12000 2019.09.06 14:30:00   117.94100     -0.36000  0.00000  16.73000
   [9] 2019.09.06 10:30:00 51450480      0  0.10000 &quot;GBPJPY&quot;  131.65300 2019.09.06 14:30:01   131.62500     -0.40000  0.00000  -2.62000
   Filling the TRADES table took 12.51 milliseconds
*/</span>  
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Creates the DEALS table                                          |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">CreateTableDeals</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- if the DEALS table already exists, delete it</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DeleteTable</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;DEALS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- check if the table exists</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseTableExists</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;DEALS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//--- create the table</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;CREATE TABLE DEALS(&quot;</span>
                          <span class="token string">&quot;ID          INT KEY NOT NULL,&quot;</span>
                          <span class="token string">&quot;ORDER_ID    INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;POSITION_ID INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;TIME        INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;TYPE        INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;ENTRY       INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;SYMBOL      CHAR(10),&quot;</span>
                          <span class="token string">&quot;VOLUME      REAL,&quot;</span>
                          <span class="token string">&quot;PRICE       REAL,&quot;</span>
                          <span class="token string">&quot;PROFIT      REAL,&quot;</span>
                          <span class="token string">&quot;SWAP        REAL,&quot;</span>
                          <span class="token string">&quot;COMMISSION  REAL,&quot;</span>
                          <span class="token string">&quot;MAGIC       INT,&quot;</span>
                          <span class="token string">&quot;REASON      INT );&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: create the DEALS table failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">//--- the table has been successfully created</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Deletes a table with the specified name from the database        |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">DeleteTable</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">,</span> string table_name<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;DROP TABLE IF EXISTS &quot;</span><span class="token operator">+</span>table_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to drop the DEALS table  with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- the table has been successfully deleted</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Adds deals to the database table                                 |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">InsertDeals</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- Auxiliary variables</span>
   ulong    deal_ticket<span class="token punctuation">;</span>         <span class="token comment">// deal ticket</span>
   <span class="token keyword">long</span>     order_ticket<span class="token punctuation">;</span>        <span class="token comment">// the ticket of the order by which the deal was executed</span>
   <span class="token keyword">long</span>     position_ticket<span class="token punctuation">;</span>     <span class="token comment">// ID of the position to which the deal belongs</span>
   datetime time<span class="token punctuation">;</span>                <span class="token comment">// deal execution time</span>
   <span class="token keyword">long</span>     type <span class="token punctuation">;</span>               <span class="token comment">// deal type</span>
   <span class="token keyword">long</span>     entry <span class="token punctuation">;</span>              <span class="token comment">// deal direction</span>
   string   symbol<span class="token punctuation">;</span>              <span class="token comment">// the symbol fro which the deal was executed</span>
   <span class="token keyword">double</span>   volume<span class="token punctuation">;</span>              <span class="token comment">// operation volume</span>
   <span class="token keyword">double</span>   price<span class="token punctuation">;</span>               <span class="token comment">// price</span>
   <span class="token keyword">double</span>   profit<span class="token punctuation">;</span>              <span class="token comment">// financial result</span>
   <span class="token keyword">double</span>   swap<span class="token punctuation">;</span>                <span class="token comment">// swap</span>
   <span class="token keyword">double</span>   commission<span class="token punctuation">;</span>          <span class="token comment">// commission</span>
   <span class="token keyword">long</span>     magic<span class="token punctuation">;</span>               <span class="token comment">// Magic number (Expert Advisor ID)</span>
   <span class="token keyword">long</span>     reason<span class="token punctuation">;</span>              <span class="token comment">// deal execution reason or source</span>
<span class="token comment">//--- go through all deals and add them to the database</span>
   <span class="token keyword">bool</span> failed<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> deals<span class="token operator">=</span><span class="token function">HistoryDealsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// --- lock the database before executing transactions</span>
   <span class="token function">DatabaseTransactionBegin</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>deals<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      deal_ticket<span class="token operator">=</span>    <span class="token function">HistoryDealGetTicket</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      order_ticket<span class="token operator">=</span>   <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_ORDER<span class="token punctuation">)</span><span class="token punctuation">;</span>
      position_ticket<span class="token operator">=</span><span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_POSITION_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      time<span class="token operator">=</span> <span class="token punctuation">(</span>datetime<span class="token punctuation">)</span><span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
      type<span class="token operator">=</span>           <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      entry<span class="token operator">=</span>          <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_ENTRY<span class="token punctuation">)</span><span class="token punctuation">;</span>
      symbol<span class="token operator">=</span>         <span class="token function">HistoryDealGetString</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_SYMBOL<span class="token punctuation">)</span><span class="token punctuation">;</span>
      volume<span class="token operator">=</span>         <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_VOLUME<span class="token punctuation">)</span><span class="token punctuation">;</span>
      price<span class="token operator">=</span>          <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_PRICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      profit<span class="token operator">=</span>         <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_PROFIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
      swap<span class="token operator">=</span>           <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_SWAP<span class="token punctuation">)</span><span class="token punctuation">;</span>
      commission<span class="token operator">=</span>     <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_COMMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
      magic<span class="token operator">=</span>          <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_MAGIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
      reason<span class="token operator">=</span>         <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_REASON<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//--- add each deal to the table using the following request</span>
      string request_text<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;INSERT INTO DEALS (ID,ORDER_ID,POSITION_ID,TIME,TYPE,ENTRY,SYMBOL,VOLUME,PRICE,PROFIT,SWAP,COMMISSION,MAGIC,REASON)&quot;</span>
                                       <span class="token string">&quot;VALUES (%d, %d, %d, %d, %d, %d, '%s', %G, %G, %G, %G, %G, %d, %d)&quot;</span><span class="token punctuation">,</span>
                                       deal_ticket<span class="token punctuation">,</span> order_ticket<span class="token punctuation">,</span> position_ticket<span class="token punctuation">,</span> time<span class="token punctuation">,</span> type<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> symbol<span class="token punctuation">,</span> volume<span class="token punctuation">,</span> price<span class="token punctuation">,</span> profit<span class="token punctuation">,</span> swap<span class="token punctuation">,</span> commission<span class="token punctuation">,</span> magic<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> request_text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: failed to insert deal #%d with code %d&quot;</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> deal_ticket<span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;i=%d: deal #%d  %s&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> deal_ticket<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span><span class="token punctuation">;</span>
         failed<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- check for transaction execution errors</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- roll back all transactions and unlock the database</span>
      <span class="token function">DatabaseTransactionRollback</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: DatabaseExecute() failed with code %d&quot;</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- all transactions have been performed successfully - record changes and unlock the database</span>
   <span class="token function">DatabaseTransactionCommit</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Creates the TRADES table                                          |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">CreateTableTrades</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- if the TRADES table already exists, delete it</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DeleteTable</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;TRADES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- check if the table exists</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseTableExists</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;TRADES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//--- create the table</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;CREATE TABLE TRADES(&quot;</span>
                          <span class="token string">&quot;TIME_IN     INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;TICKET      INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;TYPE        INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;VOLUME      REAL,&quot;</span>
                          <span class="token string">&quot;SYMBOL      CHAR(10),&quot;</span>
                          <span class="token string">&quot;PRICE_IN    REAL,&quot;</span>
                          <span class="token string">&quot;TIME_OUT    INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;PRICE_OUT   REAL,&quot;</span>
                          <span class="token string">&quot;COMMISSION  REAL,&quot;</span>
                          <span class="token string">&quot;SWAP        REAL,&quot;</span>
                          <span class="token string">&quot;PROFIT      REAL);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: create the TRADES table failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">//--- the table has been successfully created</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br></div></div><p>另见</p> <p>DatabaseExecute、DatabaseFinalize</p> <h2 id="_30-9-databasereset"><a href="#_30-9-databasereset" class="header-anchor">#</a> 30.9 DatabaseReset</h2> <p>重置请求，比如调用DatabasePrepare()之后。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">DatabaseReset</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>  request      <span class="token comment">//在DatabasePrepare中接收的请求句柄</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>request</p> <p>[in] DatabasePrepare()中获得的请求句柄。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_DATABASE_INVALID_HANDLE (5121) - 无效数据库句柄；<br>
以ERR_DATABASE_ERROR(5601)开始的SQLite错误代码。</p> <p>注意</p> <p>DatabaseReset()函数用于通过不同的参数值多次执行请求。例如，当使用INSERT命令将数据批量添加到表格中时，应该为每个条目形成一组自定义的字段值。</p> <p>与DatabasePrepare()不同，DatabaseReset() 调用不会通过SQL命令将字符串编译到新请求中，因此DatabaseReset()的执行速度要比DatabasePrepare()快得多。</p> <p>如果在执行DatabaseRead()之后应该更改请求参数值，则DatabaseReset()与DatabaseBind()函数和/或DatabaseBindArray()一起使用。这意味着在设置新请求参数值之前（阻止DatabaseBind/DatabaseBindArray调用之前），应该调用DatabaseReset()进行重置。参数化请求本身应该使用DatabasePrepare()来创建。</p> <p>与atabasePrepare()一样，DatabaseReset()不会发出数据库请求。当调用DatabaseRead()或DatabaseReadBind()时，进行直接请求执行。</p> <p>如果通过调用DatabaseBind()/DatabaseBindArray()来设置参数值，则DatabaseReset()调用不会导致重置请求中的参数值，即参数保留其值。因此，只能更改单个参数值。调用DatabaseReset()后不需要重新设置所有请求参数。</p> <p>使用DatabaseFinalize()移除的请求句柄不能传递给DatabaseReset()。这将导致错误。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| 脚本程序起始函数                                                   |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- 创建或打开数据库</span>
   string filename<span class="token operator">=</span><span class="token string">&quot;symbols.sqlite&quot;</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> db<span class="token operator">=</span><span class="token function">DatabaseOpen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> DATABASE_OPEN_READWRITE <span class="token operator">|</span> DATABASE_OPEN_CREATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>db<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; open failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Database: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; opened successfully&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 如果SYMBOLS表格已存在，请将其删除</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabaseTableExists</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;SYMBOLS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- 删除表格</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;DROP TABLE SYMBOLS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to drop table SYMBOLS with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 创建SYMBOLS表格</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;CREATE TABLE SYMBOLS(&quot;</span>
                       <span class="token string">&quot;NAME           TEXT    NOT NULL,&quot;</span>
                       <span class="token string">&quot;DESCRIPTION    TEXT            ,&quot;</span>
                       <span class="token string">&quot;PATH           TEXT            ,&quot;</span>
                       <span class="token string">&quot;SPREAD         INT             ,&quot;</span>
                       <span class="token string">&quot;POINT          REAL    NOT NULL,&quot;</span>
                       <span class="token string">&quot;DIGITS         INT     NOT NULL,&quot;</span>
                       <span class="token string">&quot;JSON           BLOB );&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; create table failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 显示SYMBOLS表格中所有字段列表</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabasePrint</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;PRAGMA TABLE_INFO(SYMBOLS)&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabasePrint(\&quot;PRAGMA TABLE_INFO(SYMBOLS)\&quot;) failed, error code=%d at line %d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 创建参数化请求，将交易品种添加到SYMBOLS表格中</span>
   string sql<span class="token operator">=</span><span class="token string">&quot;INSERT INTO SYMBOLS (NAME,DESCRIPTION,PATH,SPREAD,POINT,DIGITS,JSON)&quot;</span>
              <span class="token string">&quot; VALUES (?1,?2,?3,?4,?5,?6,?7);&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 请求参数</span>
   <span class="token keyword">int</span> request<span class="token operator">=</span><span class="token function">DatabasePrepare</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabasePrepare() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;SQL request: &quot;</span><span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 检查所有交易品种并将其添加到SYMBOLS表格中</span>
   <span class="token keyword">int</span> symbols<span class="token operator">=</span><span class="token function">SymbolsTotal</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">bool</span> request_error<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token function">DatabaseTransactionBegin</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>   
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>symbols<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- 在添加交易品种之前设置参数值</span>
      <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      string symbol<span class="token operator">=</span><span class="token function">SymbolName</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> symbol<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed at line %d with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//--- 如果之前的DatabaseBind()调用成功，则设置下一个参数</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">SymbolInfoString</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_DESCRIPTION<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed at line %d with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">SymbolInfoString</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed at line %d with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_SPREAD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed at line %d with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_POINT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed at line %d with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_DIGITS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed at line %d with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token function">GetSymBolAsJson</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed at line %d with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
      <span class="token comment">//--- 执行插入条目的请求并检查错误</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseRead</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span>ERR_DATABASE_NO_MORE_DATA<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseRead() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%d: added %s&quot;</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> symbol<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//--- 在下一次参数更新之前重置请求</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseReset</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseReset() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token comment">//--- 完成所有交易品种的检查</span>
 
<span class="token comment">//--- 交易事务状态</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request_error<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Table SYMBOLS: failed to add %d symbols&quot;</span><span class="token punctuation">,</span> symbols<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseTransactionRollback</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
     <span class="token punctuation">{</span>
      <span class="token function">DatabaseTransactionCommit</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Table SYMBOLS: added %d symbols&quot;</span><span class="token punctuation">,</span>symbols<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 将SYMBOLS表格保存为CSV文件。</span>
   string csv_filename<span class="token operator">=</span><span class="token string">&quot;symbols.csv&quot;</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabaseExport</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;SELECT * FROM SYMBOLS&quot;</span><span class="token punctuation">,</span> csv_filename<span class="token punctuation">,</span>
                     DATABASE_EXPORT_HEADER<span class="token operator">|</span>DATABASE_EXPORT_INDEX<span class="token operator">|</span>DATABASE_EXPORT_QUOTED_STRINGS<span class="token punctuation">,</span> <span class="token string">&quot;;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Database: table SYMBOLS saved in &quot;</span><span class="token punctuation">,</span> csv_filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">else</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Database: DatabaseExport(\&quot;SELECT * FROM SYMBOLS\&quot;) failed with code&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- 关闭数据库文件并告知</span>
   <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Database: %s created and closed&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| 交易品种规格返回为JSON                                              |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
string <span class="token function">GetSymBolAsJson</span><span class="token punctuation">(</span>string symbol<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- 缩进</span>
   string indent1<span class="token operator">=</span><span class="token function">Indent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   string indent2<span class="token operator">=</span><span class="token function">Indent</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   string indent3<span class="token operator">=</span><span class="token function">Indent</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//---</span>
   <span class="token keyword">int</span> digits<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_DIGITS<span class="token punctuation">)</span><span class="token punctuation">;</span>
   string json<span class="token operator">=</span><span class="token string">&quot;{&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent1<span class="token operator">+</span><span class="token string">&quot;\&quot;ConfigSymbols\&quot;:[&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent2<span class="token operator">+</span><span class="token string">&quot;{&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;Symbol\&quot;:\&quot;&quot;</span><span class="token operator">+</span>symbol<span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;Path\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">SymbolInfoString</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_PATH<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;CurrencyBase\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">SymbolInfoString</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_CURRENCY_BASE<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;CurrencyProfit\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">SymbolInfoString</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_CURRENCY_PROFIT<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;CurrencyMargin\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">SymbolInfoString</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_CURRENCY_MARGIN<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;ColorBackground\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">ColorToString</span><span class="token punctuation">(</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_BACKGROUND_COLOR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;Digits\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_DIGITS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;Point\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_POINT<span class="token punctuation">)</span><span class="token punctuation">,</span> digits<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;TickBookDepth\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_TICKS_BOOKDEPTH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;ChartMode\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_CHART_MODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;TradeMode\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_TRADE_EXEMODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;TradeCalcMode\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_TRADE_CALC_MODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;OrderMode\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_ORDER_MODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;CalculationMode\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_TRADE_CALC_MODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;ExecutionMode\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_TRADE_EXEMODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;ExpirationMode\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_EXPIRATION_MODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;FillFlags\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_FILLING_MODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;ExpirFlags\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_EXPIRATION_MODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;Spread\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_SPREAD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;TickValue\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%G&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_TRADE_TICK_VALUE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;TickSize\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%G&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_TRADE_TICK_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;ContractSize\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%G&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_TRADE_CONTRACT_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;StopsLevel\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_TRADE_STOPS_LEVEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;VolumeMin\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%G&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_VOLUME_MIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;VolumeMax\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%G&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_VOLUME_MAX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;VolumeStep\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%G&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_VOLUME_STEP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;VolumeLimit\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%G&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_VOLUME_STEP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;SwapMode\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_SWAP_MODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;SwapLong\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%G&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_SWAP_LONG<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;SwapShort\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%G&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_SWAP_SHORT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent3<span class="token operator">+</span><span class="token string">&quot;\&quot;Swap3Day\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span> SYMBOL_SWAP_ROLLOVER3DAYS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent2<span class="token operator">+</span><span class="token string">&quot;}&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n&quot;</span><span class="token operator">+</span>indent1<span class="token operator">+</span><span class="token string">&quot;]&quot;</span><span class="token operator">+</span>
               <span class="token string">&quot;\n}&quot;</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| 形成空格缩进                                                       |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
string <span class="token function">Indent</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> number<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> characters<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">int</span> length<span class="token operator">=</span>number<span class="token operator">*</span>characters<span class="token punctuation">;</span>
   string indent<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
   <span class="token function">StringInit</span><span class="token punctuation">(</span>indent<span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token char">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> indent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">/*
 结果：
  Database: symbols.sqlite opened successfully
  #| cid name        type notnull dflt_value pk
  -+-------------------------------------------
  1|   0 NAME        TEXT       1             0 
  2|   1 DESCRIPTION TEXT       0             0 
  3|   2 PATH        TEXT       0             0 
  4|   3 SPREAD      INT        0             0 
  5|   4 POINT       REAL       1             0 
  6|   5 DIGITS      INT        1             0 
  7|   6 JSON        BLOB       0             0 
  1: added EURUSD
  2: added GBPUSD
  3: added USDCHF
  ...
  82: added USDCOP
  83: added USDARS
  84: added USDCLP
  Table SYMBOLS: added 84 symbols
  Database: table SYMBOLS saved in symbols.csv
  Database: symbols.sqlite created and closed
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br></div></div><p>另见</p> <p>DatabasePrepare、DatabaseBind、 DatabaseBindArray、DatabaseFinalize</p> <h2 id="_30-10-databasebind"><a href="#_30-10-databasebind" class="header-anchor">#</a> 30.10 DatabaseBind</h2> <p>在请求中设置一个参数值。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">DatabaseBind</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>  request<span class="token punctuation">,</span>      <span class="token comment">// DatabasePrepare中创建的请求句柄</span>
   <span class="token keyword">int</span>  index<span class="token punctuation">,</span>        <span class="token comment">// 请求中的参数索引</span>
   T    value         <span class="token comment">// 简单类型参数的值</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>request</p> <p>[in] DatabasePrepare()中创建的请求句柄。</p> <p>index</p> <p>[in]  应该为请求中的参数索引设置一个值。编号从0开始。</p> <p>值</p> <p>[in]  要设置的值。扩展类型：bool、char、uchar、short、ushart、int、uint、color、datetime、long、 ulong、float、double、string。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INVALID_PARAMETER (4003)             – 不支持类型；<br>
ERR_DATABASE_INVALID_HANDLE (5121)  - 无效数据库句柄；<br>
ERR_DATABASE_NOT_READY (5128)         - <br> 目前无法使用该函数发出请求。请求正在执行或已经完成。应该调用DatabaseReset()。 <br></p> <p>注意</p> <p>该函数在SQL请求包含&quot;?&quot;或&quot;?N&quot;参数化值的情况下被使用，这里N表示参数索引（从1开始）。同时，DatabaseBind()中的参数索引从0开始。</p> <p>例如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>     INSERT INTO table VALUES (?,?,?)
     SELECT * FROM table WHERE id=?
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>该函数可以在DatabasePrepare()中创建参数化请求或使用DatabaseReset()重置请求之后立即调用。</p> <p>将该函数与DatabaseReset()一起使用，可以根据需要使用不同的参数值来多次执行请求。</p> <p>该函数旨在使用简单的类型参数。如果应对数组检查参数，请使用DatabaseBindArray()函数。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| 脚本程序起始函数                                                   |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   MqlTick ticks<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//--- 记住收到报价的开始时间</span>
   uint start<span class="token operator">=</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 请求每日报价历史</span>
   ulong to<span class="token operator">=</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
   ulong from<span class="token operator">=</span>to<span class="token operator">-</span><span class="token function">PeriodSeconds</span><span class="token punctuation">(</span>PERIOD_D1<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyTicksRange</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span> ticks<span class="token punctuation">,</span> COPY_TICKS_ALL<span class="token punctuation">,</span> from<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: CopyTicksRange(%s - %s) failed, error=%d&quot;</span><span class="token punctuation">,</span>
                  _Symbol<span class="token punctuation">,</span> <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">datetime</span><span class="token punctuation">(</span>from<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">datetime</span><span class="token punctuation">(</span>to<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _LastError<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- 接收多少报价，以及接收报价所花费的时间</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: CopyTicksRange received %d ticks in %d ms (from %s to %s)&quot;</span><span class="token punctuation">,</span>
                  _Symbol<span class="token punctuation">,</span> <span class="token function">ArraySize</span><span class="token punctuation">(</span>ticks<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">,</span>
                  <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">datetime</span><span class="token punctuation">(</span>from<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">datetime</span><span class="token punctuation">(</span>to<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 设置存储数据库的文件名称</span>
   string filename<span class="token operator">=</span>_Symbol<span class="token operator">+</span><span class="token string">&quot; &quot;</span><span class="token operator">+</span><span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">datetime</span><span class="token punctuation">(</span>from<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot; - &quot;</span><span class="token operator">+</span><span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">datetime</span><span class="token punctuation">(</span>to<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;.sqlite&quot;</span><span class="token punctuation">;</span>
   <span class="token function">StringReplace</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;:&quot; character is not allowed in file names</span>
<span class="token comment">//--- 在常规程序端文件夹中打开/创建数据库</span>
   <span class="token keyword">int</span> db<span class="token operator">=</span><span class="token function">DatabaseOpen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> DATABASE_OPEN_READWRITE <span class="token operator">|</span> DATABASE_OPEN_CREATE <span class="token operator">|</span> DATABASE_OPEN_COMMON<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>db<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Database: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; open failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Database: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; opened successfully&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- 创建TICKS表格</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;CREATE TABLE TICKS(&quot;</span>
                       <span class="token string">&quot;SYMBOL             CHAR(10),&quot;</span>
                       <span class="token string">&quot;TIME               INT NOT NULL,&quot;</span>
                       <span class="token string">&quot;BID                REAL,&quot;</span>
                       <span class="token string">&quot;ASK                REAL,&quot;</span>
                       <span class="token string">&quot;LAST               REAL,&quot;</span>
                       <span class="token string">&quot;VOLUME             INT,&quot;</span>
                       <span class="token string">&quot;TIME_MSC           INT,&quot;</span>
                       <span class="token string">&quot;VOLUME_REAL        REAL);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; create table TICKS failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 显示TICKS表格中所有字段列表</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabasePrint</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;PRAGMA TABLE_INFO(TICKS)&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabasePrint(\&quot;PRAGMA TABLE_INFO(TICKS)\&quot;) failed, error code=%d at line %d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 创建参数化请求，将报价添加到TICKS表格中</span>
   string sql<span class="token operator">=</span><span class="token string">&quot;INSERT INTO TICKS (SYMBOL,TIME,BID,ASK,LAST,VOLUME,TIME_MSC,VOLUME_REAL)&quot;</span>
              <span class="token string">&quot; VALUES (?1,?2,?3,?4,?5,?6,?7,?8)&quot;</span><span class="token punctuation">;</span> <span class="token comment">// request parameters</span>
   <span class="token keyword">int</span> request<span class="token operator">=</span><span class="token function">DatabasePrepare</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabasePrepare() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;SQL request: &quot;</span><span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 设置第一个请求参数的值</span>
   <span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> _Symbol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 记住将报价添加到TICKS表格的开始时间</span>
   start<span class="token operator">=</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">DatabaseTransactionBegin</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> total<span class="token operator">=</span><span class="token function">ArraySize</span><span class="token punctuation">(</span>ticks<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">bool</span> request_error<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>total<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- 在添加条目之前设置其余参数的值</span>
      <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> ticks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Tick #%d line=%d&quot;</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//--- 如果之前的DatabaseBind()调用成功，则设置下一个参数     </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request_error <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> ticks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bid<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Tick #%d line=%d&quot;</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request_error <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> ticks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ask<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Tick #%d line=%d&quot;</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request_error <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> ticks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>last<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Tick #%d line=%d&quot;</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request_error <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> ticks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>volume<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Tick #%d line=%d&quot;</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request_error <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> ticks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>time_msc<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Tick #%d line=%d&quot;</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request_error <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> ticks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>volume_real<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Tick #%d line=%d&quot;</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
      <span class="token comment">//--- 执行插入条目的请求并检查错误</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request_error <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">DatabaseRead</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span>ERR_DATABASE_NO_MORE_DATA<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseRead() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//--- 在下一次参数更新之前重置请求</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request_error <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">DatabaseReset</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseReset() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
         request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token comment">//--- 完成所有报价的检查</span>
 
<span class="token comment">//--- 交易事务状态</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request_error<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Table TICKS: failed to add %d ticks &quot;</span><span class="token punctuation">,</span> <span class="token function">ArraySize</span><span class="token punctuation">(</span>ticks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseTransactionRollback</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
     <span class="token punctuation">{</span>
      <span class="token function">DatabaseTransactionCommit</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Table TICKS: added %d ticks in %d ms&quot;</span><span class="token punctuation">,</span>
                  <span class="token function">ArraySize</span><span class="token punctuation">(</span>ticks<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 关闭数据库文件并告知</span>
   <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Database: %s created and closed&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">/*
 结果：
  EURUSD: CopyTicksRange received 268061 ticks in 47 ms (from 2020.03.18 12:40 to 2020.03.19 12:40)
  Database: EURUSD 2020.03.18 12.40 - 2020.03.19 12.40.sqlite opened successfully
  #| cid name        type     notnull dflt_value pk
  -+-----------------------------------------------
  1|   0 SYMBOL      CHAR(10)       0             0 
  2|   1 TIME        INT            1             0 
  3|   2 BID         REAL           0             0 
  4|   3 ASK         REAL           0             0 
  5|   4 LAST        REAL           0             0 
  6|   5 VOLUME      INT            0             0 
  7|   6 TIME_MSC    INT            0             0 
  8|   7 VOLUME_REAL REAL           0             0 
  Table TICKS: added 268061 ticks in 797 ms
  Database: EURUSD 2020.03.18 12.40 - 2020.03.19 12.40.sqlite created and closed
  OnCalculateCorrelation=0.87 2020.03.19 13:00:  EURUSD vs GBPUSD  PERIOD_M30 
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br></div></div><p>另见</p> <p>DatabasePrepare、DatabaseReset、 DatabaseRead、DatabaseBindArray</p> <h2 id="_30-11-databasebindarray"><a href="#_30-11-databasebindarray" class="header-anchor">#</a> 30.11 DatabaseBindArray</h2> <p>将数组设置为参数值。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">DatabaseBind</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>  request<span class="token punctuation">,</span>      <span class="token comment">// DatabasePrepare中创建的请求句柄</span>
   <span class="token keyword">int</span>  index<span class="token punctuation">,</span>        <span class="token comment">// 请求中的参数索引</span>
   T<span class="token operator">&amp;</span>   array<span class="token punctuation">[</span><span class="token punctuation">]</span>       <span class="token comment">// 数组设为参数值</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>request</p> <p>[in] DatabasePrepare()中创建的请求句柄。</p> <p>index</p> <p>[in]  应该为请求中的参数索引设置一个值。编号从0开始。</p> <p>array[]</p> <p>[in]  要设置为请求参数值的数组。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INVALID_PARAMETER (4003)              – 不支持类型；<br>
ERR_ARRAY_BAD_SIZE (4011)                    - 数组大小（以字节为单位）超过INT_MAX；<br>
ERR_DATABASE_INVALID_HANDLE (5121)  - 无效数据库句柄；<br>
ERR_DATABASE_NOT_READY (5128)    -<br> 目前无法使用该函数发出请求（请求正被执行或已经完成，应该调用DatabaseReset）。<br></p> <p>注意</p> <p>该函数在SQL请求包含&quot;?&quot;或&quot;?N&quot;参数化值的情况下被使用，这里N表示参数索引（从1开始）。同时，DatabaseBindArray()中的参数索引从0开始。</p> <p>例如：
<code>INSERT INTO table VALUES (?,?,?)</code></p> <p>该函数可以在DatabasePrepare()中创建参数化请求或使用DatabaseReset()重置请求之后立即调用。</p> <p>将该函数与DatabaseReset()一起使用，可以根据需要使用不同的参数值来多次执行请求。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| 脚本程序起始函数                                                   |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- 打开用于选择带有DAT扩展名的文件的对话框</span>
   string selected_files<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FileSelectDialog</span><span class="token punctuation">(</span><span class="token string">&quot;Select files to download&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                       <span class="token string">&quot;Data files (*.dat)|*.dat|All files (*.*)|*.*&quot;</span><span class="token punctuation">,</span>
                       FSD_ALLOW_MULTISELECT<span class="token punctuation">,</span> selected_files<span class="token punctuation">,</span> <span class="token string">&quot;tester.dat&quot;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Files not selected. Exit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 获取文件大小</span>
   ulong filesize<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> filehandle<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> files<span class="token operator">=</span><span class="token function">ArraySize</span><span class="token punctuation">(</span>selected_files<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>filesize<span class="token punctuation">,</span> files<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">ZeroMemory</span><span class="token punctuation">(</span>filesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>filehandle<span class="token punctuation">,</span> files<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">double</span> total_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>files<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      filehandle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">FileOpen</span><span class="token punctuation">(</span>selected_files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> FILE_READ<span class="token operator">|</span>FILE_BIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>filehandle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span>INVALID_HANDLE<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         filesize<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">FileSize</span><span class="token punctuation">(</span>filehandle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//PrintFormat(&quot;%d, %s handle=%d %d bytes&quot;, i, selected_files[i], filehandle[i], filesize[i]);</span>
         total_size<span class="token operator">+=</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>filesize<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 检查常规文件大小</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>total_size<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Total files size is 0. Exit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 在常规程序端文件夹中创建或打开数据库</span>
   string filename<span class="token operator">=</span><span class="token string">&quot;dat_files.sqlite&quot;</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> db<span class="token operator">=</span><span class="token function">DatabaseOpen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> DATABASE_OPEN_READWRITE <span class="token operator">|</span> DATABASE_OPEN_CREATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>db<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; open failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Database: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; opened successfully&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 如果FILES表格已存在，请将其删除</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabaseTableExists</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;FILES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- 删除表格</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;DROP TABLE FILES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to drop table FILES with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 创建FILES表格</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;CREATE TABLE FILES(&quot;</span>
                       <span class="token string">&quot;NAME           TEXT NOT NULL,&quot;</span>
                       <span class="token string">&quot;SIZE           INT  NOT NULL,&quot;</span>
                       <span class="token string">&quot;PERCENT_SIZE   REAL NOT NULL,&quot;</span>
                       <span class="token string">&quot;DATA           BLOB NOT NULL);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: failed to create table FILES with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 显示FILES表格中所有字段列表</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabasePrint</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;PRAGMA TABLE_INFO(FILES)&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabasePrint(\&quot;PRAGMA TABLE_INFO(FILES)\&quot;) failed, error code=%d at line %d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 创建参数化请求，将文件添加到FILES表格中</span>
   string sql<span class="token operator">=</span><span class="token string">&quot;INSERT INTO FILES (NAME,SIZE,PERCENT_SIZE,DATA)&quot;</span>
              <span class="token string">&quot; VALUES (?1,?2,?3,?4);&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 请求参数</span>
   <span class="token keyword">int</span> request<span class="token operator">=</span><span class="token function">DatabasePrepare</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabasePrepare() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;SQL request: &quot;</span><span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 检查所有文件并将其添加到FILES表格中</span>
   <span class="token keyword">bool</span> request_error<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token function">DatabaseTransactionBegin</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
   uint size<span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>files<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>filehandle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span>INVALID_HANDLE<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token keyword">char</span> data<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
         size<span class="token operator">=</span><span class="token function">FileReadArray</span><span class="token punctuation">(</span>filehandle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>size<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;FileReadArray(%s) failed with code %d&quot;</span><span class="token punctuation">,</span> selected_files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
 
         count<span class="token operator">++</span><span class="token punctuation">;</span>
         <span class="token comment">//--- 在将文件添加到表格之前设置参数值</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> selected_files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed at line %d with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed at line %d with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100.</span><span class="token operator">/</span>total_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed at line %d with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseBindArray</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseBind() failed at line %d with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token comment">//--- 执行插入条目的请求并检查错误</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseRead</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span>ERR_DATABASE_NO_MORE_DATA<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseRead() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token keyword">else</span>
            <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%d. %s: %d bytes&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> selected_files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//--- 在下一次参数更新之前重置请求</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseReset</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseReset() failed with code=%d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request_error<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 交易事务状态</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request_error<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Table FILES: failed to add %d files&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseTransactionRollback</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
     <span class="token punctuation">{</span>
      <span class="token function">DatabaseTransactionCommit</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Table FILES: added %d files&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 关闭数据库文件并告知</span>
   <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Database: %s created and closed&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br></div></div><p>另见</p> <p>DatabasePrepare、DatabaseReset、 DatabaseRead、DatabaseBind</p> <h2 id="_30-12-databaseread"><a href="#_30-12-databaseread" class="header-anchor">#</a> 30.12 DatabaseRead</h2> <p>作为请求结果，移到下一个条目。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">DatabaseRead</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>  request      <span class="token comment">//在DatabasePrepare中接收的请求句柄</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>request</p> <p>[in]  在DatabasePrepare()中接收的请求句柄。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INVALID_PARAMETER (4003)               –  没有指定表格名称（空字符串或NULL）；<br>
ERR_WRONG_STRING_PARAMETER (5040)  – 将请求转换为UTF-8字符串时出现错误；<br>
ERR_DATABASE_INTERNAL (5120)              – 内部数据库错误；<br>
ERR_DATABASE_INVALID_HANDLE (5121)    – 内部数据库句柄；<br>
ERR_DATABASE_EXECUTE (5124)                –  请求执行错误；<br>
ERR_DATABASE_NO_MORE_DATA (5126)    – 不存在表格（没有错误，正常完成）。<br></p> <p>另见</p> <p>DatabasePrepare, DatabaseReadBind</p> <h2 id="_30-13-databasereadbind"><a href="#_30-13-databasereadbind" class="header-anchor">#</a> 30.13 DatabaseReadBind</h2> <p>移动到下一条记录，并从中将数据读入结构。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">DatabaseReadBind</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>    request<span class="token punctuation">,</span>           <span class="token comment">//DatabasePrepare中创建的请求句柄</span>
   <span class="token keyword">void</span><span class="token operator">&amp;</span>  struct_object      <span class="token comment">//对读取记录结构的引用</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数</p> <p>request</p> <p>[in] DatabasePrepare()中创建的请求句柄。</p> <p>struct_object</p> <p>[out]  要读入当前记录中数据的结构的引用。该结构应该只有数值类型和/或字符串（不允许数组）作为成员，并且不能是衍生体。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INVALID_PARAMETER (4003)               –  没有指定表格名称（空字符串或NULL）；<br>
ERR_WRONG_STRING_PARAMETER (5040)  – 将请求转换为UTF-8字符串时出现错误；<br>
ERR_DATABASE_INTERNAL (5120)              – 内部数据库错误；<br>
ERR_DATABASE_INVALID_HANDLE (5121)    – 内部数据库句柄；<br>
ERR_DATABASE_EXECUTE (5124)                –  请求执行错误；<br>
ERR_DATABASE_NO_MORE_DATA (5126)    – 不存在表格（没有错误，正常完成）。<br></p> <p>注意</p> <p>struct_object结构中的字段数不应超过DatabaseColumnsCount()。如果struct_object结构中的字段数小于记录中的字段数，则执行部分读取。使用相应的DatabaseColumnText()、 DatabaseColumnInteger()等函数可以明确获取剩余的数据。</p> <p>示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">Person</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">int</span>               id<span class="token punctuation">;</span>
   string            name<span class="token punctuation">;</span>
   <span class="token keyword">int</span>               age<span class="token punctuation">;</span>
   string            address<span class="token punctuation">;</span>
   <span class="token keyword">double</span>            salary<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Script program start function                                    |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">int</span> db<span class="token punctuation">;</span>
   string filename<span class="token operator">=</span><span class="token string">&quot;company.sqlite&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//--- open</span>
   db<span class="token operator">=</span><span class="token function">DatabaseOpen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> DATABASE_OPEN_READWRITE <span class="token operator">|</span> DATABASE_OPEN_CREATE <span class="token operator">|</span>DATABASE_OPEN_COMMON<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>db<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; open failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- if the table COMPANY exists then drop the table</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DatabaseTableExists</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;COMPANY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- delete the table</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;DROP TABLE COMPANY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to drop table COMPANY with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- create table</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;CREATE TABLE COMPANY(&quot;</span>
                       <span class="token string">&quot;ID INT PRIMARY KEY     NOT NULL,&quot;</span>
                       <span class="token string">&quot;NAME           TEXT    NOT NULL,&quot;</span>
                       <span class="token string">&quot;AGE            INT     NOT NULL,&quot;</span>
                       <span class="token string">&quot;ADDRESS        CHAR(50),&quot;</span>
                       <span class="token string">&quot;SALARY         REAL );&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; create table failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- insert data</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY) VALUES (1, 'Paul', 32, 'California', 25000.00 ); &quot;</span>
                       <span class="token string">&quot;INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY) VALUES (2, 'Allen', 25, 'Texas', 15000.00 ); &quot;</span>
                       <span class="token string">&quot;INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY) VALUES (3, 'Teddy', 23, 'Norway', 20000.00 );&quot;</span>
                       <span class="token string">&quot;INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY) VALUES (4, 'Mark', 25, 'Rich-Mond ', 65000.00 );&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; insert failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- prepare the request</span>
   <span class="token keyword">int</span> request<span class="token operator">=</span><span class="token function">DatabasePrepare</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;SELECT * FROM COMPANY WHERE SALARY&gt;15000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; request failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- print records</span>
   Person person<span class="token punctuation">;</span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Persons with salary &gt; 15000:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token function">DatabaseReadBind</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token function">Print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">&quot;:  &quot;</span><span class="token punctuation">,</span> person<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> person<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> person<span class="token punctuation">.</span>age<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> person<span class="token punctuation">.</span>address<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> person<span class="token punctuation">.</span>salary<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- delete request after use</span>
   <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Some statistics:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- prepare new request about total salary</span>
   request<span class="token operator">=</span><span class="token function">DatabasePrepare</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;SELECT SUM(SALARY) FROM COMPANY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; request failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">DatabaseRead</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token keyword">double</span> total_salary<span class="token punctuation">;</span>
      <span class="token function">DatabaseColumnDouble</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> total_salary<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Total salary=&quot;</span><span class="token punctuation">,</span> total_salary<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- delete request after use</span>
   <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- prepare new request about average salary</span>
   request<span class="token operator">=</span><span class="token function">DatabasePrepare</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;SELECT AVG(SALARY) FROM COMPANY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; request failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">DatabaseRead</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token keyword">double</span> aver_salary<span class="token punctuation">;</span>
      <span class="token function">DatabaseColumnDouble</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> aver_salary<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Average salary=&quot;</span><span class="token punctuation">,</span> aver_salary<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- delete request after use</span>
   <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- close database</span>
   <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+-------------------------------------------------------------------</span>
<span class="token comment">/*
Output:
Persons with salary &gt; 15000:
0:  1 Paul 32 California 25000.0
1:  3 Teddy 23 Norway 20000.0
2:  4 Mark 25 Rich-Mond  65000.0
Some statistics:
Total salary=125000.0
Average salary=31250.0
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br></div></div><p>另见</p> <p>DatabasePrepare，DatabaseRead</p> <h2 id="_30-14-databasefinalize"><a href="#_30-14-databasefinalize" class="header-anchor">#</a> 30.14 DatabaseFinalize</h2> <p>移除在DatabasePrepare()中创建的请求参数。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">void</span>  <span class="token function">DatabaseFinalize</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>  request      <span class="token comment">//在DatabasePrepare中接收的请求句柄</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>database</p> <p>[in]  在DatabasePrepare()中接收的请求句柄。</p> <p>返回值</p> <p>无。</p> <p>注意</p> <p>如果句柄无效，函数设置ERR_DATABASE_INVALID_HANDLE错误。您可以使用GetLastError()检查错误。</p> <h2 id="_30-15-databasetransactionbegin"><a href="#_30-15-databasetransactionbegin" class="header-anchor">#</a> 30.15 DatabaseTransactionBegin</h2> <p>开始事务执行。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">bool</span>  <span class="token function">DatabaseTransactionBegin</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>  database      <span class="token comment">// 在DatabaseOpen中接收的数据库句柄</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>database</p> <p>[in]  在DatabaseOpen()中接收的数据库句柄。</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INTERNAL_ERROR (4001)                   –  重要运行时错误；<br>
ERR_INVALID_PARAMETER (4003)              –  sql参数包含空字符串；<br>
ERR_NOT_ENOUGH_MEMORY (4004)          –  内存不足；<br>
ERR_WRONG_STRING_PARAMETER (5040)  – 将请求转换为UTF-8字符串时出现错误；<br>
ERR_DATABASE_INTERNAL (5120)              – 内部数据库错误；<br>
ERR_DATABASE_INVALID_HANDLE (5121)   – 无效数据库句柄；<br>
ERR_DATABASE_EXECUTE (5124)               –  请求执行错误。<br></p> <p>注意
DatabaseTransactionBegin()函数应该在事务执行之前调用。任何事务都应该以调用DatabaseTransactionBegin()开始，以调用DatabaseTransactionCommit()结束。</p> <p>示例:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Script program start function                                    |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- create the file name</span>
   string filename<span class="token operator">=</span><span class="token function">AccountInfoString</span><span class="token punctuation">(</span>ACCOUNT_SERVER<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span><span class="token function">AccountInfoInteger</span><span class="token punctuation">(</span>ACCOUNT_LOGIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;.sqlite&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//--- open/create the database in the common terminal folder</span>
   <span class="token keyword">int</span> db<span class="token operator">=</span><span class="token function">DatabaseOpen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> DATABASE_OPEN_READWRITE <span class="token operator">|</span> DATABASE_OPEN_CREATE <span class="token operator">|</span> DATABASE_OPEN_COMMON<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>db<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: &quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token string">&quot; open failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- if the DEALS table already exists, delete it</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DeleteTable</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;DEALS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- create the DEALS table</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CreateTableDeals</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//---  request the entire trading history</span>
   datetime from_date<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
   datetime to_date<span class="token operator">=</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- request the history of deals in the specified interval</span>
   <span class="token function">HistorySelect</span><span class="token punctuation">(</span>from_date<span class="token punctuation">,</span> to_date<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> deals_total<span class="token operator">=</span><span class="token function">HistoryDealsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Deals in the trading history: %d &quot;</span><span class="token punctuation">,</span> deals_total<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- measure the transaction execution speed using DatabaseTransactionBegin/DatabaseTransactionCommit</span>
   ulong start<span class="token operator">=</span><span class="token function">GetMicrosecondCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">bool</span> fast_transactions<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token function">InsertDeals</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> fast_transactions<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">double</span> fast_transactions_time<span class="token operator">=</span><span class="token keyword">double</span><span class="token punctuation">(</span><span class="token function">GetMicrosecondCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">;</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Transations WITH    DatabaseTransactionBegin/DatabaseTransactionCommit: time=%.1f milliseconds&quot;</span><span class="token punctuation">,</span> fast_transactions_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- delete the DEALS table, and then create it again</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DeleteTable</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;DEALS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- create a new DEALS table</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CreateTableDeals</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- test again, this time without using DatabaseTransactionBegin/DatabaseTransactionCommit</span>
   fast_transactions<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
   start<span class="token operator">=</span><span class="token function">GetMicrosecondCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">InsertDeals</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> fast_transactions<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">double</span> slow_transactions_time<span class="token operator">=</span><span class="token keyword">double</span><span class="token punctuation">(</span><span class="token function">GetMicrosecondCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">;</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Transations WITHOUT DatabaseTransactionBegin/DatabaseTransactionCommit: time=%.1f milliseconds&quot;</span><span class="token punctuation">,</span> slow_transactions_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- report gain in time</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Use of DatabaseTransactionBegin/DatabaseTransactionCommit provided acceleration by %.1f times&quot;</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">(</span>slow_transactions_time<span class="token punctuation">)</span><span class="token operator">/</span>fast_transactions_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- close the database</span>
   <span class="token function">DatabaseClose</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">/*
Results:
   Deals in the trading history: 2737
   Transations WITH    DatabaseTransactionBegin/DatabaseTransactionCommit: time=48.5 milliseconds
   Transations WITHOUT DatabaseTransactionBegin/DatabaseTransactionCommit: time=25818.9 milliseconds
   Use of DatabaseTransactionBegin/DatabaseTransactionCommit provided acceleration by 532.8 times
*/</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Deletes a table with the specified name from the database        |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">DeleteTable</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">,</span> string table_name<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;DROP TABLE IF EXISTS &quot;</span><span class="token operator">+</span>table_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to drop table with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- the table has been successfully deleted</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Creates the DEALS table                                          |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">CreateTableDeals</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- check if the table exists</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseTableExists</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;DEALS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//--- create the table</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> <span class="token string">&quot;CREATE TABLE DEALS(&quot;</span>
                          <span class="token string">&quot;ID          INT KEY NOT NULL,&quot;</span>
                          <span class="token string">&quot;ORDER_ID    INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;POSITION_ID INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;TIME        INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;TYPE        INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;ENTRY       INT     NOT NULL,&quot;</span>
                          <span class="token string">&quot;SYMBOL      CHAR(10),&quot;</span>
                          <span class="token string">&quot;VOLUME      REAL,&quot;</span>
                          <span class="token string">&quot;PRICE       REAL,&quot;</span>
                          <span class="token string">&quot;PROFIT      REAL,&quot;</span>
                          <span class="token string">&quot;SWAP        REAL,&quot;</span>
                          <span class="token string">&quot;COMMISSION  REAL,&quot;</span>
                          <span class="token string">&quot;MAGIC       INT,&quot;</span>
                          <span class="token string">&quot;REASON      INT );&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;DB: create the table DEALS failed with code &quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">//--- the table has been successfully created</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| Adds deals to the database table                                 |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">bool</span> <span class="token function">InsertDeals</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">,</span> <span class="token keyword">bool</span> begintransaction<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- Auxiliary variables</span>
   ulong    deal_ticket<span class="token punctuation">;</span>         <span class="token comment">// deal ticket</span>
   <span class="token keyword">long</span>     order_ticket<span class="token punctuation">;</span>        <span class="token comment">// the ticket of the order by which the deal was executed</span>
   <span class="token keyword">long</span>     position_ticket<span class="token punctuation">;</span>     <span class="token comment">// ID of the position to which the deal belongs</span>
   datetime time<span class="token punctuation">;</span>                <span class="token comment">// deal execution time</span>
   <span class="token keyword">long</span>     type <span class="token punctuation">;</span>               <span class="token comment">// deal type</span>
   <span class="token keyword">long</span>     entry <span class="token punctuation">;</span>              <span class="token comment">// deal direction</span>
   string   symbol<span class="token punctuation">;</span>              <span class="token comment">// the symbol fro which the deal was executed</span>
   <span class="token keyword">double</span>   volume<span class="token punctuation">;</span>              <span class="token comment">// operation volume</span>
   <span class="token keyword">double</span>   price<span class="token punctuation">;</span>               <span class="token comment">// price</span>
   <span class="token keyword">double</span>   profit<span class="token punctuation">;</span>              <span class="token comment">// financial result</span>
   <span class="token keyword">double</span>   swap<span class="token punctuation">;</span>                <span class="token comment">// swap</span>
   <span class="token keyword">double</span>   commission<span class="token punctuation">;</span>          <span class="token comment">// commission</span>
   <span class="token keyword">long</span>     magic<span class="token punctuation">;</span>               <span class="token comment">// Magic number</span>
   <span class="token keyword">long</span>     reason<span class="token punctuation">;</span>              <span class="token comment">// deal execution reason or source</span>
<span class="token comment">//--- go through all deals and add to the database</span>
   <span class="token keyword">bool</span> failed<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> deals<span class="token operator">=</span><span class="token function">HistoryDealsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- if fast transaction performance method is used</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>begintransaction<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">// --- lock the database before executing transactions</span>
      <span class="token function">DatabaseTransactionBegin</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>deals<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      deal_ticket<span class="token operator">=</span>    <span class="token function">HistoryDealGetTicket</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      order_ticket<span class="token operator">=</span>   <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_ORDER<span class="token punctuation">)</span><span class="token punctuation">;</span>
      position_ticket<span class="token operator">=</span><span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_POSITION_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      time<span class="token operator">=</span> <span class="token punctuation">(</span>datetime<span class="token punctuation">)</span><span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
      type<span class="token operator">=</span>           <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      entry<span class="token operator">=</span>          <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_ENTRY<span class="token punctuation">)</span><span class="token punctuation">;</span>
      symbol<span class="token operator">=</span>         <span class="token function">HistoryDealGetString</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_SYMBOL<span class="token punctuation">)</span><span class="token punctuation">;</span>
      volume<span class="token operator">=</span>         <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_VOLUME<span class="token punctuation">)</span><span class="token punctuation">;</span>
      price<span class="token operator">=</span>          <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_PRICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      profit<span class="token operator">=</span>         <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_PROFIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
      swap<span class="token operator">=</span>           <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_SWAP<span class="token punctuation">)</span><span class="token punctuation">;</span>
      commission<span class="token operator">=</span>     <span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_COMMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
      magic<span class="token operator">=</span>          <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_MAGIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
      reason<span class="token operator">=</span>         <span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>deal_ticket<span class="token punctuation">,</span> DEAL_REASON<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//--- add each deal using the following request</span>
      string request_text<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;INSERT INTO DEALS (ID,ORDER_ID,POSITION_ID,TIME,TYPE,ENTRY,SYMBOL,VOLUME,PRICE,PROFIT,SWAP,COMMISSION,MAGIC,REASON)&quot;</span>
                                       <span class="token string">&quot;VALUES (%d, %d, %d, %d, %d, %d, '%s', %G, %G, %G, %G, %G, %d, %d)&quot;</span><span class="token punctuation">,</span>
                                       deal_ticket<span class="token punctuation">,</span> order_ticket<span class="token punctuation">,</span> position_ticket<span class="token punctuation">,</span> time<span class="token punctuation">,</span> type<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> symbol<span class="token punctuation">,</span> volume<span class="token punctuation">,</span> price<span class="token punctuation">,</span> profit<span class="token punctuation">,</span> swap<span class="token punctuation">,</span> commission<span class="token punctuation">,</span> magic<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DatabaseExecute</span><span class="token punctuation">(</span>database<span class="token punctuation">,</span> request_text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: failed to insert deal #%dwith code %d&quot;</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> deal_ticket<span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;i=%d: deal #%d  %s&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> deal_ticket<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span><span class="token punctuation">;</span>
         failed<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- check for transaction execution errors</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- if fast transaction performance method is used</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>begintransaction<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token comment">//--- roll back all transactions and unlock the database</span>
         <span class="token function">DatabaseTransactionRollback</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;%s: DatabaseExecute() failed with code &quot;</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- if fast transaction performance method is used</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>begintransaction<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- all transactions have been performed successfully - record changes and unlock the database</span>
      <span class="token function">DatabaseTransactionCommit</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- successful completion</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br></div></div><p>另见</p> <p>DatabaseExecute、 DatabasePrepare、 DatabaseTransactionCommit、 DatabaseTransactionRollback</p> <h2 id="_30-16-databasetransactioncommit"><a href="#_30-16-databasetransactioncommit" class="header-anchor">#</a> 30.16 DatabaseTransactionCommit</h2> <p>完成事务执行。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">bool</span>  <span class="token function">DatabaseTransactionCommit</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>  database      <span class="token comment">// 在DatabaseOpen中接收的数据库句柄</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>database</p> <p>[in]  在DatabaseOpen()中接收的数据库句柄。</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INTERNAL_ERROR (4001)                   –  重要运行时错误；<br>
ERR_INVALID_PARAMETER (4003)              –  sql参数包含空字符串；<br>
ERR_NOT_ENOUGH_MEMORY (4004)          –  内存不足；<br>
ERR_WRONG_STRING_PARAMETER (5040)  – 将请求转换为UTF-8字符串时出现错误；<br>
ERR_DATABASE_INTERNAL (5120)              – 内部数据库错误；<br>
ERR_DATABASE_INVALID_HANDLE (5121)   – 无效数据库句柄；<br>
ERR_DATABASE_EXECUTE (5124)               –  请求执行错误。<br></p> <p>注意</p> <p>DatabaseTransactionCommit()函数完成调用DatabaseBeginTransaction()函数后执行的所有事务。任何事务都应该以调用DatabaseTransactionBegin()开始，以调用DatabaseTransactionCommit()结束。</p> <h2 id="_30-17-databasetransactionrollback"><a href="#_30-17-databasetransactionrollback" class="header-anchor">#</a> 30.17 DatabaseTransactionRollback</h2> <p>回滚事务。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">DatabaseTransactionRollback</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>  database      <span class="token comment">// 在DatabaseOpen中接收的数据库句柄</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>database</p> <p>[in]  在DatabaseOpen()中接收的数据库句柄。</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_INTERNAL_ERROR (4001)                    –  重要运行时错误；<br>
ERR_INVALID_PARAMETER (4003)               –  sql参数包含空字符串；<br>
ERR_NOT_ENOUGH_MEMORY (4004)           –  内存不足；<br>
ERR_WRONG_STRING_PARAMETER (5040)  – 将请求转换为UTF-8字符串时出现错误；<br>
ERR_DATABASE_INTERNAL (5120)              – 内部数据库错误；<br>
ERR_DATABASE_INVALID_HANDLE (5121)    – 内部数据库句柄；<br>
ERR_DATABASE_EXECUTE (5124)                –  请求执行错误；<br></p> <p>注意</p> <p>DatabaseTransactionRollback()调用取消调用DatabaseTransactionBegin()函数后执行的所有事务。在执行事务发生错误时，需要DatabaseTransactionRollback()函数回滚数据库中的更改。</p> <p>另见</p> <p>DatabaseExecute、 DatabasePrepare、 DatabaseTransactionBegin、 DatabaseTransactionCommit</p> <h2 id="_30-18-databasecolumnscount"><a href="#_30-18-databasecolumnscount" class="header-anchor">#</a> 30.18 DatabaseColumnsCount</h2> <p>获取请求中的字段数。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">DatabaseColumnsCount</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>  request      <span class="token comment">//在DatabasePrepare中接收的请求句柄</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数</p> <p>request</p> <p>[in]  在DatabasePrepare()中接收的请求句柄。</p> <p>返回值</p> <p>字段数量，错误情况下为-1。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_DATABASE_INVALID_HANDLE (5121) - 无效请求句柄。
注意</p> <p>不需要调用DatabaseRead()函数来获取在DatabasePrepare()中创建的请求的字段数。对于其余的DatabaseColumnXXX()函数，应该初步调用DatabaseRead()。</p> <p>另见</p> <p>DatabasePrepare、DatabaseFinalize、 DatabaseClose</p> <h2 id="_30-19-databasecolumnname"><a href="#_30-19-databasecolumnname" class="header-anchor">#</a> 30.19 DatabaseColumnName</h2> <p>按索引获取字段名。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">DatabaseColumnName</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>      request<span class="token punctuation">,</span>     <span class="token comment">// 在DatabasePrepare中接收的请求句柄</span>
   <span class="token keyword">int</span>      column<span class="token punctuation">,</span>      <span class="token comment">// 请求中的字段索引</span>
   string<span class="token operator">&amp;</span>  name         <span class="token comment">//用于接收字段名的变量的引用</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>request</p> <p>[in]  在DatabasePrepare()中接收的请求句柄。</p> <p>column</p> <p>[in]  请求中的字段索引。字段编号从零开始，不能超过 DatabaseColumnsCount() - 1。</p> <p>name</p> <p>[out]  用于编写字段名的变量。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_DATABASE_INVALID_HANDLE (5121) – 无效请求句柄；
ERR_DATABASE_NO_MORE_DATA (5126)  – 'column'索引超过DatabaseColumnsCount() -1。
注意</p> <p>只有在为'request（请求）'初步发出至少一个DatabaseRead()调用时，才能获取该值。</p> <p>另见</p> <p>DatabasePrepare、DatabaseColumnsCount、 DatabaseColumnType</p> <h2 id="_30-20-databasecolumntype"><a href="#_30-20-databasecolumntype" class="header-anchor">#</a> 30.20 DatabaseColumnType</h2> <p>按索引获取字段类型。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>ENUM_DATABASE_FIELD_TYPE  <span class="token function">DatabaseColumnType</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>  request<span class="token punctuation">,</span>     <span class="token comment">// 在DatabasePrepare中接收的请求句柄</span>
   <span class="token keyword">int</span>  column       <span class="token comment">//请求中的字段索引</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数</p> <p>request</p> <p>[in]  在DatabasePrepare()中接收的请求句柄。</p> <p>column</p> <p>[in]  请求中的字段索引。字段编号从零开始，不能超过 DatabaseColumnsCount() - 1。</p> <p>返回值</p> <p>从ENUM_DATABASE_FIELD_TYPE枚举返回字段类型。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_DATABASE_INVALID_HANDLE (5121) – 无效请求句柄；<br>
ERR_DATABASE_NO_MORE_DATA (5126)  –  'column'索引超过DatabaseColumnsCount() -1.</p> <p>注意</p> <p>只有在为'request（请求）'初步发出至少一个DatabaseRead()调用时，才能获取该值。</p> <p><strong>ENUM_DATABASE_FIELD_TYPE</strong></p> <table><thead><tr><th>ID</th> <th>描述</th></tr></thead> <tbody><tr><td>DATABASE_FIELD_TYPE_INVALID</td> <td>获取类型错误，可使用int GetLastError()获取错误代码</td></tr> <tr><td>DATABASE_FIELD_TYPE_INTEGER</td> <td>整型</td></tr> <tr><td>DATABASE_FIELD_TYPE_FLOAT</td> <td>真实型</td></tr> <tr><td>DATABASE_FIELD_TYPE_TEXT</td> <td>字符串类型</td></tr> <tr><td>DATABASE_FIELD_TYPE_BLOB</td> <td>二进制类型</td></tr> <tr><td>DATABASE_FIELD_TYPE_NULL</td> <td>特殊NULL类型</td></tr></tbody></table> <p>另见</p> <p>DatabasePrepare、DatabaseColumnsCount、 DatabaseColumnName</p> <h2 id="_30-21-databasecolumnsize"><a href="#_30-21-databasecolumnsize" class="header-anchor">#</a> 30.21 DatabaseColumnSize</h2> <p>获取字段大小（以字节为单位）。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">DatabaseColumnSize</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>  request<span class="token punctuation">,</span>     <span class="token comment">// 在DatabasePrepare中接收的请求句柄</span>
   <span class="token keyword">int</span>  column       <span class="token comment">//请求中的字段索引</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数</p> <p>request</p> <p>[in]  在DatabasePrepare()中接收的请求句柄。</p> <p>column</p> <p>[in]  请求中的字段索引。字段编号从零开始，不能超过 DatabaseColumnsCount() - 1。</p> <p>返回值</p> <p>如果成功，返回字段大小（以字节为单位），否则为-1。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_DATABASE_INVALID_HANDLE (5121) – 无效请求句柄；<br>
ERR_DATABASE_NO_MORE_DATA (5126)  – 'column'索引超过DatabaseColumnsCount() -1。</p> <p>注意</p> <p>只有在为'request（请求）'初步发出至少一个DatabaseRead()调用时，才能获取该值。</p> <p>另见</p> <p>DatabasePrepare、DatabaseColumnBlob、 DatabaseColumnsCount、 DatabaseColumnName、DatabaseColumnType</p> <h2 id="_30-22-databasecolumntext"><a href="#_30-22-databasecolumntext" class="header-anchor">#</a> 30.22 DatabaseColumnText</h2> <p>从当前记录中获取作为字符串的字段值。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">DatabaseColumnText</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>      request<span class="token punctuation">,</span>     <span class="token comment">// 在DatabasePrepare中接收的请求句柄</span>
   <span class="token keyword">int</span>      column<span class="token punctuation">,</span>      <span class="token comment">// 请求中的字段索引</span>
   string<span class="token operator">&amp;</span>  value        <span class="token comment">//用于接收值的变量的引用</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>request</p> <p>[in]  在DatabasePrepare()中接收的请求句柄。</p> <p>column</p> <p>[in]  请求中的字段索引。字段编号从零开始，不能超过 DatabaseColumnsCount() - 1。</p> <p>value</p> <p>[out]  用于编写字段值的变量的引用。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_DATABASE_INVALID_HANDLE (5121) – 无效请求句柄；<br>
ERR_DATABASE_NO_MORE_DATA (5126)  – 'column'索引超过DatabaseColumnsCount() -1。
注意</p> <p>只有在为'request（请求）'初步发出至少一个DatabaseRead()调用时，才能获取该值。</p> <p>若要从下一个记录读取该值，请初步调用DatabaseRead()。</p> <p>另见</p> <p>DatabasePrepare、DatabaseColumnsCount、 DatabaseColumnType、DatabaseColumnName</p> <h2 id="_30-23-databasecolumninteger"><a href="#_30-23-databasecolumninteger" class="header-anchor">#</a> 30.23 DatabaseColumnInteger</h2> <p>从当前记录中获取int类型的值。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">DatabaseColumnInteger</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>   request<span class="token punctuation">,</span>     <span class="token comment">// 在DatabasePrepare中接收的请求句柄</span>
   <span class="token keyword">int</span>   column<span class="token punctuation">,</span>      <span class="token comment">// 请求中的字段索引</span>
   <span class="token keyword">int</span><span class="token operator">&amp;</span>  value        <span class="token comment">// 用于接收值的变量的引用</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>request</p> <p>[in]  在DatabasePrepare()中接收的请求句柄。</p> <p>column</p> <p>[in]  请求中的字段索引。字段编号从零开始，不能超过 DatabaseColumnsCount() - 1。</p> <p>value</p> <p>[out]  用于编写字段值的变量的引用。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_DATABASE_INVALID_HANDLE (5121) – 无效请求句柄；<br>
ERR_DATABASE_NO_MORE_DATA (5126)  – 'column'索引超过DatabaseColumnsCount() -1。</p> <p>注意</p> <p>只有在为'request（请求）'初步发出至少一个DatabaseRead()调用时，才能获取该值。</p> <p>若要从下一个记录读取该值，请初步调用DatabaseRead()。</p> <p>另见</p> <p>DatabasePrepare、DatabaseColumnsCount、 DatabaseColumnType、DatabaseColumnName</p> <h2 id="_30-24-databasecolumnlong"><a href="#_30-24-databasecolumnlong" class="header-anchor">#</a> 30.24 DatabaseColumnLong</h2> <p>从当前记录中获取long类型的值。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">DatabaseColumnLong</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>    request<span class="token punctuation">,</span>     <span class="token comment">// 在DatabasePrepare中接收的请求句柄</span>
   <span class="token keyword">int</span>    column<span class="token punctuation">,</span>      <span class="token comment">// 请求中的字段索引</span>
   <span class="token keyword">long</span><span class="token operator">&amp;</span>  value        <span class="token comment">//用于接收值的变量的引用</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>request</p> <p>[in]  在DatabasePrepare()中接收的请求句柄。</p> <p>column</p> <p>[in]  请求中的字段索引。字段编号从零开始，不能超过 DatabaseColumnsCount() - 1。</p> <p>value</p> <p>[out]  用于编写字段值的变量的引用。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_DATABASE_INVALID_HANDLE (5121) – 无效请求句柄；
ERR_DATABASE_NO_MORE_DATA (5126)  – 'column'索引超过DatabaseColumnsCount() -1。
注意</p> <p>只有在为'request（请求）'初步发出至少一个DatabaseRead()调用时，才能获取该值。</p> <p>若要从下一个记录读取该值，请初步调用DatabaseRead()。</p> <p>另见</p> <p>DatabasePrepare、DatabaseColumnsCount、 DatabaseColumnType、DatabaseColumnName</p> <h2 id="_30-25-databasecolumndouble"><a href="#_30-25-databasecolumndouble" class="header-anchor">#</a> 30.25 DatabaseColumnDouble</h2> <p>从当前记录中获取double类型的值。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">DatabaseColumnDouble</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>      request<span class="token punctuation">,</span>     <span class="token comment">// 在DatabasePrepare中接收的请求句柄</span>
   <span class="token keyword">int</span>      column<span class="token punctuation">,</span>      <span class="token comment">// 请求中的字段索引</span>
   <span class="token keyword">double</span><span class="token operator">&amp;</span>  value        <span class="token comment">// 用于接收值的变量的引用</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>request</p> <p>[in]  在DatabasePrepare()中接收的请求句柄。</p> <p>column</p> <p>[in]  请求中的字段索引。字段编号从零开始，不能超过 DatabaseColumnsCount() - 1。</p> <p>value</p> <p>[out]  用于编写字段值的变量的引用。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_DATABASE_INVALID_HANDLE (5121) – 无效请求句柄；
ERR_DATABASE_NO_MORE_DATA (5126)  – 'column'索引超过DatabaseColumnsCount() -1。
注意</p> <p>只有在为'request（请求）'初步发出至少一个DatabaseRead()调用时，才能获取该值。</p> <p>若要从下一个记录读取该值，请初步调用DatabaseRead()。</p> <p>另见</p> <p>DatabasePrepare、DatabaseColumnsCount、 DatabaseColumnType、DatabaseColumnName</p> <h2 id="_30-26-databasecolumnblob"><a href="#_30-26-databasecolumnblob" class="header-anchor">#</a> 30.26 DatabaseColumnBlob</h2> <p>从当前记录中获取作为数组的字段值。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">DatabaseColumnBlob</span><span class="token punctuation">(</span>
   <span class="token keyword">int</span>    request<span class="token punctuation">,</span>     <span class="token comment">// 在DatabasePrepare中接收的请求句柄</span>
   <span class="token keyword">int</span>    column<span class="token punctuation">,</span>      <span class="token comment">// 请求中的字段索引</span>
   <span class="token keyword">void</span><span class="token operator">&amp;</span>  data<span class="token punctuation">[</span><span class="token punctuation">]</span>       <span class="token comment">// 用于接收值的变量的引用</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>request</p> <p>[in]  在DatabasePrepare()中接收的请求句柄。</p> <p>column</p> <p>[in]  请求中的字段索引。字段编号从零开始，不能超过 DatabaseColumnsCount() - 1。</p> <p>data[]</p> <p>[out]  用于编写字段值的数组的引用。</p> <p>返回值</p> <p>如果成功返回true，否则返回false。要获得错误代码，请使用GetLastError()，可能回应：</p> <p>ERR_DATABASE_INVALID_HANDLE (5121) – 无效请求句柄；
ERR_DATABASE_NO_MORE_DATA (5126)  – 'column'索引超过DatabaseColumnsCount() -1。
注意</p> <p>只有在为'request（请求）'初步发出至少一个DatabaseRead()调用时，才能获取该值。</p> <p>若要从下一个记录读取该值，请初步调用DatabaseRead()。</p> <p>另见</p> <p>DatabasePrepare、DatabaseColumnSize、 DatabaseColumnsCount、 DatabaseColumnType、DatabaseColumnName</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mql5yao/Chapter/twentynine.html" class="prev">
        29 第二十九章 使用OpenCL工作
      </a></span> <span class="next"><a href="/mql5yao/Chapter/thirtyone.html">
        31 第三十一章 使用DirectX
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/mql5yao/assets/js/app.33d9106b.js" defer></script><script src="/mql5yao/assets/js/3.64586e1a.js" defer></script><script src="/mql5yao/assets/js/37.c903bf3b.js" defer></script>
  </body>
</html>
