<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>智能交易*姚 文档站</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/mql5yao/favicon.ico">
    <meta name="description" content="这是智能交易的文档站点。">
    <meta name="keywords" content="MQL,EA,智能交易,自动交易,量化,编程,培训">
    
    <link rel="preload" href="/mql5yao/assets/css/0.styles.c167a2d0.css" as="style"><link rel="preload" href="/mql5yao/assets/js/app.33d9106b.js" as="script"><link rel="preload" href="/mql5yao/assets/js/3.64586e1a.js" as="script"><link rel="preload" href="/mql5yao/assets/js/7.b1ec5472.js" as="script"><link rel="prefetch" href="/mql5yao/assets/js/10.f243be4a.js"><link rel="prefetch" href="/mql5yao/assets/js/11.e4fc3b61.js"><link rel="prefetch" href="/mql5yao/assets/js/12.d2b71f90.js"><link rel="prefetch" href="/mql5yao/assets/js/13.d47c9e61.js"><link rel="prefetch" href="/mql5yao/assets/js/14.59ded2e6.js"><link rel="prefetch" href="/mql5yao/assets/js/15.f2836d3d.js"><link rel="prefetch" href="/mql5yao/assets/js/16.fc4e3f11.js"><link rel="prefetch" href="/mql5yao/assets/js/17.069370d9.js"><link rel="prefetch" href="/mql5yao/assets/js/18.e47908ca.js"><link rel="prefetch" href="/mql5yao/assets/js/19.4e8a369f.js"><link rel="prefetch" href="/mql5yao/assets/js/2.7a050c47.js"><link rel="prefetch" href="/mql5yao/assets/js/20.37e31658.js"><link rel="prefetch" href="/mql5yao/assets/js/21.30dc9524.js"><link rel="prefetch" href="/mql5yao/assets/js/22.bb650486.js"><link rel="prefetch" href="/mql5yao/assets/js/23.84e246fd.js"><link rel="prefetch" href="/mql5yao/assets/js/24.3b441f03.js"><link rel="prefetch" href="/mql5yao/assets/js/25.3ceb7172.js"><link rel="prefetch" href="/mql5yao/assets/js/26.ba703a82.js"><link rel="prefetch" href="/mql5yao/assets/js/27.c0597566.js"><link rel="prefetch" href="/mql5yao/assets/js/28.50413136.js"><link rel="prefetch" href="/mql5yao/assets/js/29.04da6b07.js"><link rel="prefetch" href="/mql5yao/assets/js/30.c8071067.js"><link rel="prefetch" href="/mql5yao/assets/js/31.baace808.js"><link rel="prefetch" href="/mql5yao/assets/js/32.d399c058.js"><link rel="prefetch" href="/mql5yao/assets/js/33.9b2114b8.js"><link rel="prefetch" href="/mql5yao/assets/js/34.d6f49f42.js"><link rel="prefetch" href="/mql5yao/assets/js/35.3620d83f.js"><link rel="prefetch" href="/mql5yao/assets/js/36.e26f547b.js"><link rel="prefetch" href="/mql5yao/assets/js/37.c903bf3b.js"><link rel="prefetch" href="/mql5yao/assets/js/38.2f6e699d.js"><link rel="prefetch" href="/mql5yao/assets/js/39.aca9c106.js"><link rel="prefetch" href="/mql5yao/assets/js/4.21ff370e.js"><link rel="prefetch" href="/mql5yao/assets/js/40.3eb74932.js"><link rel="prefetch" href="/mql5yao/assets/js/41.4f244c9a.js"><link rel="prefetch" href="/mql5yao/assets/js/42.892231ce.js"><link rel="prefetch" href="/mql5yao/assets/js/43.3f173f86.js"><link rel="prefetch" href="/mql5yao/assets/js/44.4e79ffd4.js"><link rel="prefetch" href="/mql5yao/assets/js/45.9e7cd13e.js"><link rel="prefetch" href="/mql5yao/assets/js/46.240ea5cd.js"><link rel="prefetch" href="/mql5yao/assets/js/47.bc498cbd.js"><link rel="prefetch" href="/mql5yao/assets/js/48.752c3ae0.js"><link rel="prefetch" href="/mql5yao/assets/js/5.47d44717.js"><link rel="prefetch" href="/mql5yao/assets/js/6.ee422b91.js"><link rel="prefetch" href="/mql5yao/assets/js/8.036d68c0.js"><link rel="prefetch" href="/mql5yao/assets/js/9.4c2d0d8b.js">
    <link rel="stylesheet" href="/mql5yao/assets/css/0.styles.c167a2d0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mql5yao/" class="home-link router-link-active"><img src="/mql5yao/logo.png" alt="智能交易*姚 文档站" class="logo"> <span class="site-name can-hide">智能交易*姚 文档站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mql5yao/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mql5yao/Chapter/start.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/mql5yao/Cutleeks/" class="nav-link">
  割韭菜XX招
</a></div><div class="nav-item"><a href="/mql5yao/support/" class="nav-link">
  支持本站
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mql5yao/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mql5yao/Chapter/start.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/mql5yao/Cutleeks/" class="nav-link">
  割韭菜XX招
</a></div><div class="nav-item"><a href="/mql5yao/support/" class="nav-link">
  支持本站
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MQL5线上手册</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mql5yao/Chapter/start.html" class="sidebar-link">MQL5 参考</a></li><li><a href="/mql5yao/Chapter/one.html" class="sidebar-link">01 第一章 语言基础</a></li><li><a href="/mql5yao/Chapter/two.html" class="sidebar-link">02 第二章 标准常量，列举和架构</a></li><li><a href="/mql5yao/Chapter/three.html" class="sidebar-link">03 第三章 MQL5程序</a></li><li><a href="/mql5yao/Chapter/four.html" class="sidebar-link">04 第四章 预定义变量</a></li><li><a href="/mql5yao/Chapter/five.html" class="sidebar-link">05 第五章 普通函数</a></li><li><a href="/mql5yao/Chapter/six.html" class="sidebar-link">06 第六章 数组函数</a></li><li><a href="/mql5yao/Chapter/add1.html" class="sidebar-link">07 第add1章 矩阵和向量方法</a></li><li><a href="/mql5yao/Chapter/seven.html" class="sidebar-link">07 第七章 函数转换</a></li><li><a href="/mql5yao/Chapter/eight.html" class="sidebar-link">08 第八章 数学函数</a></li><li><a href="/mql5yao/Chapter/nine.html" class="sidebar-link">09 第九章 字符串函数</a></li><li><a href="/mql5yao/Chapter/ten.html" class="sidebar-link">10 第十章 日期和时间</a></li><li><a href="/mql5yao/Chapter/eleven.html" class="sidebar-link">11 第十一章 账户信息</a></li><li><a href="/mql5yao/Chapter/twelve.html" class="sidebar-link">12 第十二章 检测</a></li><li><a href="/mql5yao/Chapter/thirteen.html" class="sidebar-link">13 第十三章 事件处理</a></li><li><a href="/mql5yao/Chapter/fourteen.html" class="sidebar-link">14 第十四章 市场信息</a></li><li><a href="/mql5yao/Chapter/fifteen.html" class="sidebar-link">15 第十五章 经济日历函数</a></li><li><a href="/mql5yao/Chapter/sixteen.html" aria-current="page" class="active sidebar-link">16 第十六章 时间序列和指标访问</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-1-数组、缓冲器-和-时间序列-中索引编号的方向" class="sidebar-link">16.1 数组、缓冲器 和 时间序列 中索引编号的方向</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-2-组织数据存储" class="sidebar-link">16.2 组织数据存储</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-3-seriesinfointeger" class="sidebar-link">16.3 SeriesInfoInteger</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-4-bars" class="sidebar-link">16.4 Bars</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-5-barscalculated" class="sidebar-link">16.5 BarsCalculated</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-6-indicatorcreate" class="sidebar-link">16.6 IndicatorCreate</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-7-indicatorparameters" class="sidebar-link">16.7 IndicatorParameters</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-8-indicatorrelease" class="sidebar-link">16.8 IndicatorRelease</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-9-copybuffer" class="sidebar-link">16.9 CopyBuffer</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-10-copyrates" class="sidebar-link">16.10 CopyRates</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-11-copytime" class="sidebar-link">16.11 CopyTime</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-12-copyopen" class="sidebar-link">16.12 CopyOpen</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-13-copyhigh" class="sidebar-link">16.13 CopyHigh</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-14-copylow" class="sidebar-link">16.14 CopyLow</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-15-copyclose" class="sidebar-link">16.15 CopyClose</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-16-copytickvolume" class="sidebar-link">16.16 CopyTickVolume</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-17-copyrealvolumn" class="sidebar-link">16.17 CopyRealVolumn</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-18-copyspread" class="sidebar-link">16.18 CopySpread</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-19-copyticks" class="sidebar-link">16.19 CopyTicks</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-20-copyticksrange" class="sidebar-link">16.20 CopyTicksRange</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-21-ibars" class="sidebar-link">16.21 iBars</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-22-ibarshift" class="sidebar-link">16.22 iBarShift</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-23-iclose" class="sidebar-link">16.23 iClose</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-24-ihigh" class="sidebar-link">16.24 iHigh</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-25-ihighest" class="sidebar-link">16.25 iHighest</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-26-ilow" class="sidebar-link">16.26 iLow</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-27-ilowest" class="sidebar-link">16.27 iLowest</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-28-iopen" class="sidebar-link">16.28 iOpen</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-29-itime" class="sidebar-link">16.29 iTime</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-30-itickvolume" class="sidebar-link">16.30 iTickVolume</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-31-irealvolume" class="sidebar-link">16.31 iRealVolume</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-32-ivolume" class="sidebar-link">16.32 iVolume</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/sixteen.html#_16-33-ispread" class="sidebar-link">16.33 iSpread</a></li></ul></li><li><a href="/mql5yao/Chapter/seventeen.html" class="sidebar-link">17 第十七章 自定义交易品种</a></li><li><a href="/mql5yao/Chapter/eighteen.html" class="sidebar-link">18 第十八章 图表操作</a></li><li><a href="/mql5yao/Chapter/ninteen.html" class="sidebar-link">19 第十九章 交易函数</a></li><li><a href="/mql5yao/Chapter/twenty.html" class="sidebar-link">20 第二十章 交易信号</a></li><li><a href="/mql5yao/Chapter/twentyone.html" class="sidebar-link">21 第二十一章 网络函数</a></li><li><a href="/mql5yao/Chapter/twentytwo.html" class="sidebar-link">22 第二十二章 程序端全局变量</a></li><li><a href="/mql5yao/Chapter/twentythree.html" class="sidebar-link">23 第二十三章 文件函数</a></li><li><a href="/mql5yao/Chapter/twentyfour.html" class="sidebar-link">24 第二十四章 自定义指标</a></li><li><a href="/mql5yao/Chapter/twentyfive.html" class="sidebar-link">25 第二十五章 物件函数</a></li><li><a href="/mql5yao/Chapter/twentysix.html" class="sidebar-link">26 第二十六章 技术指标</a></li><li><a href="/mql5yao/Chapter/twentyseven.html" class="sidebar-link">27 第二十七章 处理优化结果</a></li><li><a href="/mql5yao/Chapter/twentyeight.html" class="sidebar-link">28 第二十八章 工作事件</a></li><li><a href="/mql5yao/Chapter/twentynine.html" class="sidebar-link">29 第二十九章 使用OpenCL工作</a></li><li><a href="/mql5yao/Chapter/thirty.html" class="sidebar-link">30 第三十章 使用数据库</a></li><li><a href="/mql5yao/Chapter/thirtyone.html" class="sidebar-link">31 第三十一章 使用DirectX</a></li><li><a href="/mql5yao/Chapter/thirtytwo.html" class="sidebar-link">32 第三十二章 集成</a></li><li><a href="/mql5yao/Chapter/add2.html" class="sidebar-link">32 第add2章 ONNX模型</a></li><li><a href="/mql5yao/Chapter/thirtythree.html" class="sidebar-link">33 第三十三章 标准程序库</a></li><li><a href="/mql5yao/Chapter/AppendixI.html" class="sidebar-link">34 附录一 来自MQL4</a></li><li><a href="/mql5yao/Chapter/AppendixII.html" class="sidebar-link">35 附录二 MQL5 函数列表</a></li><li><a href="/mql5yao/Chapter/AppendixIII.html" class="sidebar-link">36 附录三 MQL5常量列表</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2> 第十六章 访问时间序列和指标数据</h2> <p>这些函数用于处理 时间序列 和 指标。时间序列 与通常的数据数组不同，——时间序列 的元素索引是反向排序的——意即从数组的 末尾 开始索引编号(从最近的数据到最早的数据)。为了复制 时间序列 的值和指标数据，建议只使用动态数组，因为复制函数旨在分配接收值的数组所需的大小。</p> <p>这个规则有一个重要的例外：如果 时间序列 和 指标 值需要经常复制，例如在Expert Advisor中每次调用OnTick() 或 在指标中每次调用OnCalculate()时，在这种情况下，应该使用静态分配的数组更好，因为动态数组的内存分配操作需要额外的时间，这在测试和优化期间会有效果。</p> <p>在使用访问 时间序列 和 指标 值的函数时，应考虑索引方向。 在“数组，缓冲区和时间序列”部分中，对 索引方向 进行了介绍。</p> <p>指标 和 时间序列 数据的访问应用不考虑要求数据是否准备完好（也就是所谓的 异步访问），这对于自定义指标的计算来说非常重要，因此，如果没有数据，函数 Copy...() 类型会立即返回错误值。然而，当形成EA交易和脚本的访问时，接收数据的尝试会短暂停歇，只是为时序列要求的指标计算值的下载提供必要的时间。</p> <p>无论所请求的数据是否准备就绪(即所谓的异步访问)，都可以访问 指标 和 时间序列数据。 这对于 自定义指标 的计算非常重要，所以如果没有数据，Copy ...() 类型的函数会立即返回错误。但是，从(原英文版有拼写错误form 应该为 from )EA程序 和 脚本进行访问时，需要稍稍暂停一些接收数据的尝试，以便为下载所需的 时间序列 或计算指标值提供一些必要的时间。</p> <p><img src="/mql5yao/assets/img/thi31.c7b70a6a.png" alt="avatar"></p> <p>组织数据访问 部分描述了在MetaTrader 5客户端中接收，存储和请求价格数据的细节。
访问历史报价数据，可以从数组的末尾开始执行。物理上，最新的数据总是写在数组的末尾，但是数组末尾的索引编号总是为 0。时间序列 数组中的0索引表示当前K线柱的数据，即对应于此时间框架内未完成的时间阶段的K线柱。</p> <p>时间框架即是一个时间段，在其中形成的K线柱。在MT5中有21个预定义的标准时间框架。</p> <table><thead><tr><th>函数</th> <th>功能</th></tr></thead> <tbody><tr><td>SeriesInfoInteger</td> <td>返回有关历史数据状态的信息</td></tr> <tr><td>Bars</td> <td>返回指定 交易品种 和 时间周期 的历史数据的的K线柱数量</td></tr> <tr><td>BarsCalculated</td> <td>返回指标缓冲区中计算数据的数量 或 (数据尚未计算)出错时返回 -1</td></tr> <tr><td>IndicatorCreate</td> <td>返回由MqlParam类型参数数组创建的指定 技术指标 的句柄</td></tr> <tr><td>IndicatorParameters</td> <td>基于指定的句柄，返回指标的 输入参数 的数量，以及参数的值和类型</td></tr> <tr><td>IndicatorRelease</td> <td>如果没有其他人使用，移除指标句柄并释放该指标的计算模块。</td></tr> <tr><td>CopyBuffer</td> <td>从指定指标获得特定缓冲区数据到数组中。</td></tr> <tr><td>CopyRates</td> <td>将指定 交易品种 的比率结构的历史数据和周期放在数组中</td></tr> <tr><td>CopyTime</td> <td>将指定 交易品种 的K线柱开盘时间的历史数据和周期放在数组中</td></tr> <tr><td>CopyOpen</td> <td>将指定 交易品种 的K线柱开盘价格的历史数据和周期放在数组中</td></tr> <tr><td>CopyHigh</td> <td>将指定 交易品种 的K线柱最高价的历史数据和周期放在数组中</td></tr> <tr><td>CopyLow</td> <td>将指定 交易品种 的K线柱最低价的历史数据和周期放在数组中</td></tr> <tr><td>CopyClose</td> <td>将指定 交易品种 的K线柱收盘价的历史数据和周期放在数组中</td></tr> <tr><td>CopyTickVolume</td> <td>指定 交易品种 的报价数量的历史数据和周期放在数组中</td></tr> <tr><td>CopyRealVolume</td> <td>指定 交易品种 的交易量的历史数据和周期放在数组中</td></tr> <tr><td>CopySpread</td> <td>指定 交易品种 的点差历史数据和周期放在数组中</td></tr> <tr><td>CopyTicks</td> <td>在MqlTick格式中获取到的报价数据写入到 ticks_array 数组中。</td></tr> <tr><td>CopyTicksRange</td> <td>指定日期范围以MqlTick格式接收的报价数据写入到ticks_array数组中</td></tr></tbody></table> <p>尽管通过使用ArraySetAsSeries()函数可以在数组中设置对 时间序列 中元素的访问权限，但应该记住数组元素在物理上是以同一顺序存储的 —— 只是索引方向不同。为了演示这个事实，我们来举个例子：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>   datetime TimeAsSeries<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如访问 时间序列 一样设置数组访问 </span>
   <span class="token function">ArraySetAsSeries</span><span class="token punctuation">(</span>TimeAsSeries<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span> copied<span class="token operator">=</span><span class="token function">CopyTime</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span>TimeAsSeries<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>copied<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;The copy operation of the open time values for last 10 bars has failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;TimeCurrent =&quot;</span><span class="token punctuation">,</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;ArraySize(Time) =&quot;</span><span class="token punctuation">,</span><span class="token function">ArraySize</span><span class="token punctuation">(</span>TimeAsSeries<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span> size<span class="token operator">=</span><span class="token function">ArraySize</span><span class="token punctuation">(</span>TimeAsSeries<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>size<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;TimeAsSeries[&quot;</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">&quot;] =&quot;</span><span class="token punctuation">,</span>TimeAsSeries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
   datetime ArrayNotSeries<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token function">ArraySetAsSeries</span><span class="token punctuation">(</span>ArrayNotSeries<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   copied<span class="token operator">=</span><span class="token function">CopyTime</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span>ArrayNotSeries<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>copied<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;The copy operation of the open time values for last 10 bars has failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span>    
   size<span class="token operator">=</span><span class="token function">ArraySize</span><span class="token punctuation">(</span>ArrayNotSeries<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">--</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;ArrayNotSeries[&quot;</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">&quot;] =&quot;</span><span class="token punctuation">,</span>ArrayNotSeries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>因此，我们将得到这样的输出:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>TimeCurrent <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">23</span> 
<span class="token function">ArraySize</span><span class="token punctuation">(</span>Time<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">10</span> 
TimeAsSeries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
TimeAsSeries<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
TimeAsSeries<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
TimeAsSeries<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
TimeAsSeries<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
TimeAsSeries<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
TimeAsSeries<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
TimeAsSeries<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">07</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
TimeAsSeries<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">06</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
TimeAsSeries<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">05</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
  
ArrayNotSeries<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
ArrayNotSeries<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
ArrayNotSeries<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
ArrayNotSeries<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
ArrayNotSeries<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
ArrayNotSeries<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
ArrayNotSeries<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
ArrayNotSeries<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">07</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
ArrayNotSeries<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">06</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> 
ArrayNotSeries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2009.06</span><span class="token punctuation">.</span><span class="token number">11</span> <span class="token number">05</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>从结果中可以看到，时间序列 数组增加的索引，索引减少的时间值，也就是说，从当前移到过去，对于普通数组ArrayNotSeries来说，结果是不同的——一旦索引增加，从过去移动到当前。</p> <p>正如我们从输出中看到的那样，随着 时间序列 数组索引编号的递增，对应的时间值是递减，即我们从现在移到过去。对于 通用数组 ArrayNotSeries，结果是不同的 —— 随着索引编号的递增，我们从过去移到现在。</p> <p>相关参考</p> <p>数组动态 ， ArrayGetAsSeries ， ArraySetAsSeries ， 数据系列</p> <h2 id="_16-1-数组、缓冲器-和-时间序列-中索引编号的方向"><a href="#_16-1-数组、缓冲器-和-时间序列-中索引编号的方向" class="header-anchor">#</a> 16.1 数组、缓冲器 和 时间序列 中索引编号的方向</h2> <p>所有 数组 和 指标缓冲区 的默认索引编号方向都是从左至右的，第一元素的索引等于0，因此，数组 或 指标缓冲区的第一元素默认从最左边的0开始，而最后一个元素在最右边。</p> <p>指标缓冲区是 双精度类型 动态数组，由客户端进行管理，因此它总是对应于被指标计算的K线柱的数量。一个普通的双精度类型动态数组可以使用 SetIndexBuffer() 函数分派绑定到一个指标缓冲区。指标缓冲区不需要使用函数ArrayResize()来设置它们的大小——这将由终端的执行系统完成。</p> <p>时间序列 是颠倒搜索的数组，例如，时间序列的第一个元素在最右边，最后一个元素在最左边。时间序列是用来存储历史价格数据并包括时间信息，我们可以看见时间序列最右边是最新的数据，而最左边是最旧的数据。</p> <p>因此，索引编号为0的 时间序列 数组元素包含关于一个 交易品种 的最新报价的信息。如果 时间序列 包含 日线图表的数据，那么当前尚未完成的K线数据位于索引0的位置，而索引1的位置包含了昨天的报价数据。</p> <p>改变索引方向</p> <p>函数ArraySetAsSeries()允许改变访问动态数组元素的方法;存储在计算机内存中的数据的物理顺序并没有改变。这个函数只是简单地改变了处理数组元素的方法，所以当使用函数ArrayCopy()将一个数组复制到另一个数组时，接收方数组的内容不依赖于源数组中的索引方向。</p> <p>对于静态分布的数组，不能更改索引的方向。即使将 静态数组 作为参数传递给ArraySetAsSeries()函数，尝试更改该函数内的索引方向也不会产生任何效果。</p> <p>对于指标缓冲区来说，像普通数组一样，索引方向向后设置（像时序列），例如，关于指标缓冲区的零位置代表类似指标缓冲区的的最后值，也相当于指标最新字节的值。因此，指标的实际字节位置并未改变。</p> <p>指标缓冲区,像普通数组一样索引方向也可以设置为向后的(如 时间序列),也就是说，在指标缓冲区中的索引 0 的位置对应的是指示缓冲区的最后一个报价的值，而这将对应于最新的K线柱上的指标的值。不过，指标K线柱的物理位置将保持不变。</p> <p>指标接收价格数据</p> <p>每个自定义指标都必须包含OnCalculate() 函数，用来计算在指标缓冲区中所需的价格数据，之后传递给指标。通过使用函数ArrayGetAsSeries()，可以找到这些传递数组中的索引方向。</p> <p>传递给函数的数组反映价格数据，即这些数组具有 时间序列 的标帜，函数ArrayIsSeries()在检查这些数组时将返回true。但是，在任何情况下，索引方向都应该由函数ArrayGetAsSeries()来检查。</p> <p>为了不依赖于默认值，ArraySetAsSeries()应该无条件地调用您要处理的数组，并设置所需的方向。</p> <p>接收价格数据和指标值</p> <p>在EA交易，指标和脚本中的所有默认检索方向都是从左至右。如果需要，在任何mql5程序中，您都可以请求任何 交易品种 和 时间框架上的 时间序列值，以及在任何 交易品种 和 时间框架上计算的指标值。</p> <p>EA交易，指标和脚本中所有数组的默认索引方向是从左到右的。</p> <p>使用Copy...() 函数完成这些操作：<br>
• CopyBuffer – 复制指标缓冲区到双精度类型数组；<br>
• CopyRates – 复制价格记录到结构 MqlRates类型数组；<br>
• CopyTime – 复制时间值到 日期时间 类型数组；<br>
• CopyOpen – 复制K线柱的开盘价到双精度类型数组；<br>
• CopyHigh – 复制K线柱的最高价到双精度类型数组；<br>
• CopyLow – 复制K线柱最低价到双精度类型数组；<br>
• CopyClose – 复制K线柱收盘价到双精度类型数组；<br>
• CopyTickVolume – 复制跳价的数量到长整型数组；<br>
• CopyRealVolume – 复制成交量到长整型数组；<br>
• CopySpread – 复制点差到整型数组；</p> <p>所有这些函数都以相同方式工作，考虑到CopyBuffer()在示例中包含的原理，暗示在需求数据的索引方向是时序列，0索引位置存储当前未完成字节的数据。为了房屋这些数据，需要复制必要的数据成交量容器数组，例如，数组 buffer。</p> <p>所有这些函数都以类似的方式工作。让我们考虑一下CopyBuffer()的例子中的数据获取机制。 这意味着所请求数据的索引方向是 时间序列 的索引方向，索引为0（零）的位置存储当前尚未完成的K线柱的数据。为了访问这些数据，我们需要将必要的数据量复制到接收数组中，例如，进入数组缓冲区。</p> <p><img src="/mql5yao/assets/img/thi32.04e64708.png" alt=""></p> <p>开始复制时，我们需要指定源数组中的起始位置，从中开始将数据复制到接收数组。如果成功，指定数量的元素将从源数组（从本例中的指标缓冲区）复制到接收数组中。与接收数组中设置的索引值无关，复制总是按照上图所示执行。</p> <p>如果预计价格数据将在具有大量迭代的循环中处理，建议您使用IsStopped()函数检查强制程序终止的事实：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span> copied<span class="token operator">=</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ma_handle<span class="token punctuation">,</span><span class="token comment">// 指标处理 </span>
                      <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">// 指标缓冲区标引 </span>
                      <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">// 复制的开始位置 </span>
                      number<span class="token punctuation">,</span>   <span class="token comment">// 复制值的数量  </span>
                      Buffer    <span class="token comment">// 接收值的数组 </span>
                      <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span><span class="token punctuation">(</span>copied<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span class="token keyword">int</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token keyword">while</span><span class="token punctuation">(</span>k <span class="token operator">&lt;</span> copied <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token comment">//--- 获得k标引的值 </span>
   <span class="token keyword">double</span> value<span class="token operator">=</span>Buffer<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token comment">// ...  </span>
   <span class="token comment">// 使用值 </span>
   k<span class="token operator">++</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>input <span class="token keyword">int</span> per<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// 指数周期 </span>
<span class="token keyword">int</span> ma_handle<span class="token punctuation">;</span>    <span class="token comment">// 指标处理 </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA初始化函数                                                     | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- </span>
   ma_handle<span class="token operator">=</span><span class="token function">iMA</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>per<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>MODE_EMA<span class="token punctuation">,</span>PRICE_CLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA跳价处理函数                                                     | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">double</span> ema<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span> copied<span class="token operator">=</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ma_handle<span class="token punctuation">,</span><span class="token comment">// 指标处理 </span>
                         <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">// 指标缓冲区指数 </span>
                         <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">// 复制的初始位置 </span>
                         <span class="token number">10</span><span class="token punctuation">,</span>       <span class="token comment">// 用于复制的值数 </span>
                         ema       <span class="token comment">// 接收数组的值 </span>
                         <span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>copied<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span class="token comment">// .... 深层代码 </span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>相关参考<br>
组织数据存储</p> <h2 id="_16-2-组织数据存储"><a href="#_16-2-组织数据存储" class="header-anchor">#</a> 16.2 组织数据存储</h2> <p>在本节中，讨论有关获取，存储和请求价格数据(时间序列)的问题。</p> <p>从交易服务器中获得数据</p> <p>在MT5客户端的价格数据执行之前，必须先收到然后经过处理，为了接收数据，要确定MT5交易服务器已经确定连接，数据根据终端要求以微小字节形式接收。</p> <p>在MT5终端中提供报价数据之前，必须先接收并处理它们。要接收数据，必须建立与MT5交易服务器的连接。应终端的请求，来自服务器数据以1分钟K线柱的形式打包接收。</p> <p>服务器数据的关联结构并不取决于请求的发起方式 - 无论用户是在图表导航中操作 或 以MQL5语言的程序方式发起请求。</p> <p>储存媒介数据</p> <p>从服务器接收到的数据将自动解包并保存为HCC中间格式。每个 交易品种 的数据写入一个单独的文件夹：<br>
terminal_directory \ bases \ server_name \ history \ symbol_name。<br>
例如，从MetaQuotes-Demo服务器收到的EURUSD数据将存储在<br>
terminal_directory \ bases \ MetaQuotes-Demo \ history \ EURUSD \</p> <p>数据被写入扩展名为.hcc的文件中。每个文件存储一年的一分钟(M1)图表的K线柱数据。例如，EURUSD文件夹中名为2009.hcc的文件包含2009年 欧元兑美元 的1分钟(M1)图表的K线。这些文件用于准备所有时间范围的价格数据，它们不适用于直接访问。</p> <p>在媒介数据外获得必要的时间架构</p> <p>媒介HCC文件作为 源数据 类型使用，它在HC格式中以建立价格数据的要求来使用的，HC格式的数据是为了快速访问而最大限度地准备的时间序列，它们根据图表或MQL5程序的要求来构建，数据的成交量不能超过 “图表中最多柱数””最大图表数据量”(MT5)(工具--&gt;选项(设定)--图表 标签中)的最大值，数据存储在hc扩展名的文件中以供进一步使用。</p> <p>为了节省资源，只有在必要时才将时间范围内的数据存储并保存在RAM(内存)中。如果不需要长时间调用，它们将从RAM(内存)中释放并保存到文件中。对于每个时间框架，都准备好数据，无论是否有其它时间框架的现成数据。所有时间框架的形成和访问数据规则都是相同的。即，尽管存储在HCC中的单位数据是一分钟(M1)，但HCC数据的可用性并不意味着M1时间框架上的数据与HC在相同数量上的可用性相同。</p> <p>从服务器接收新数据会调用所有时间框架内HC格式的旧价格数据自动更新。它还导致重新计算所有指标，这些指标隐含地将它们用作计算的输入数据。</p> <p>参数“图表中最多柱数””最大图表数据量”(MT5)</p> <p>“图表中最多柱数””最大图表数据量”(MT5)常量限制图表，指标和mql5程序可用的HC格式K线柱数，对于所有可用的时间框架和服务器来说是有效的，首先是为了节约电脑资源。</p> <p>当设置此参数为较大数值时，应该记住，如果可以使用较小的时间框架的深度历史价格数据，则用于存储 时间序列 和 指标缓冲区 的内存可能变为数百兆字节，并且达到客户端程序的RAM(内存)限制( MS Windows的32位应用程序上限是2Gb)。</p> <p>在客户端重启之后，“图表中最多柱数””最大图表数据量”(MT5)的改变开始生效，更改此参数既不会自动提交服务器以获取其他数据，也不会形成额外的 时间序列 K线柱。从服务器请求额外的价格数据，并在考虑到新限制的情况下更新时间序列，以防图表滚动到没有数据的区域 或 由mql5程序请求时数据。</p> <p>从服务器请求的数据量对应于此时间框架所需的K线柱数，并考虑了“图表中最多柱数””最大图表数据量”(MT5)参数。此参数设置的限制并不严格，并且在某些情况下，某个时间范围内的可用K线柱数量可能会比当前参数值稍多一些。</p> <p>数据有效性</p> <p>HCC格式的数据 或 甚至使用HC格式准备的数据，并不表示在图表中显示 或 用于MQL5程序时，这些数据绝对可用。</p> <p>当从mql5程序访问价格数据或指标值时，应该记住它们在特定时刻或从某个时刻开始的可用性不能得到保证。这与以下事实有关：为了节省资源，mql5程序所需的完整数据副本不存储在MetaTrader 5中; 只给出对终端数据库的直接访问。</p> <p>所有时间框架的价格历史记录均由HCC格式的常用数据构建而成，并且任何服务器数据更新都会导致所有时间框架范围内的数据更新以及重新计算指标。由于这种访问数据可能会被关闭，即使这些数据刚刚可用。</p> <p>终端数据和服务器数据的同步性</p> <p>由于mql5程序可以从任何 交易品种 和 时间框架 中调用数据，所以在终端中可能还没有形成必要 时间序列 的数据，或者 必要的价格数据与交易服务器不同步。在这种情况下，很难预测延迟时间。</p> <p>使用“不做任何操作(do-nothing)”循环的算法不是最好的解决方案。在这种情况下唯一的例外是脚本，因为它们没有任何其它的算法选择，因为没有事件处理。对于自定义指标这样的算法，以及任何其他“不做任何操作(do-nothing)”循环，强烈建议不要这样做，因为它们会导致终止所有指标的计算 以及 对交易品种价格数据操作失败。</p> <p>对于EA交易和指标，最好使用事件处理模型。如果在处理OnTick() 或 OnCalculate()事件期间，所需 时间序列 的数据接收失败，您应该退出事件处理程序，并依靠下次调用处理程序时的访问可用性。</p> <p>脚本添加历史的范例</p> <p>让我们考虑一个脚本示例，该脚本执行请求以从交易服务器接收所选交易品种的历史记录。 该脚本用于在选定交易品种的图表中运行; 时间范围并不重要，因为如上所述，价格数据是从交易服务器接收的一分钟(M1)数据，从中构建了任何预定义的时间序列。</p> <p>将有关数据接收的所有操作写入一个单独的函数<br>
CheckLoadHistory(symbol, timeframe, start_date):</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">CheckLoadHistory</span><span class="token punctuation">(</span>string symbol<span class="token punctuation">,</span>ENUM_TIMEFRAMES period<span class="token punctuation">,</span>datetime start_date<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>CheckLoadHistory()函数被设计为通用函数，可以从任何程序(EA交易程序、脚本或指标)调用;因此，它需要三个输入参数:交易品种名称、周期和开始日期，来表明你所需的价格历史开始运行。</p> <p>在请求缺失的历史数据之前，将必要的检查插入函数代码。首先，我们要确保交易品种名称和周期值是正确的:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span><span class="token punctuation">(</span>symbol<span class="token operator">==</span><span class="token constant">NULL</span> <span class="token operator">||</span> symbol<span class="token operator">==</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> symbol<span class="token operator">=</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>period<span class="token operator">==</span>PERIOD_CURRENT<span class="token punctuation">)</span>     period<span class="token operator">=</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后，让我们确保该 交易品种 在 市场报价 窗口中可见。即，当向交易服务器发送请求时，交易品种 的历史数据是可用的。如果 市场报价 中没有这个 交易品种 ，可以使用函数SymbolSelect()添加它。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>SYMBOL_SELECT<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>ERR_MARKET_UNKNOWN_SYMBOL<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">SymbolSelect</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>现在我们应该会收到指定起始日期、周期的货币对的可用的历史数据。也许，传递给CheckLoadHistory()的输入参数 start_date 的值已经有可用的历史数据，这样就不需要向交易服务器发送请求。为了获得当前交易品种周期的第一个日期，可以使用SeriesInfoInteger()函数和SERIES_FIRSTDATE修饰符。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>   <span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">,</span>SERIES_FIRSTDATE<span class="token punctuation">,</span>first_date<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>first_date <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> first_date <span class="token operator">&lt;=</span> start_date<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>下一个重要的检查是检查调用函数的程序的类型。注意，不要与指标同时发送 时间序列 的更新请求。在与指标相同的交易品种周期上请求数据是不可取的，这是由于在指标操作的同一线程中执行历史数据更新，出现死锁的可能性很高。要检查这一点，请使用函数MQL5InfoInteger() 同时使用 MQL5_PROGRAM_TYPE修饰符。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MQL5InfoInteger</span><span class="token punctuation">(</span>MQL5_PROGRAM_TYPE<span class="token punctuation">)</span><span class="token operator">==</span>PROGRAM_INDICATOR <span class="token operator">&amp;&amp;</span> <span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>period <span class="token operator">&amp;&amp;</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>symbol<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果所有的检查都成功地通过了，那么在没有引用交易服务器的情况下进行最后一次尝试。首先让我们看看开始日期，在HCC格式中有哪些一分钟(M1)数据可用。使用函数SeriesInfoInteger()并使用 SERIES_TERMINAL_FIRSTDATE修饰符来请求该值，并再次将其与start_date参数的值进行比较。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>PERIOD_M1<span class="token punctuation">,</span>SERIES_TERMINAL_FIRSTDATE<span class="token punctuation">,</span>first_date<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- 有建立时间序列的加载数据</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>first_date <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token comment">//--- 强制创建时间序列</span>
         <span class="token function">CopyTime</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">,</span>first_date<span class="token operator">+</span><span class="token function">PeriodSeconds</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>times<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//--- 检测日期</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">,</span>SERIES_FIRSTDATE<span class="token punctuation">,</span>first_date<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>first_date <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> first_date <span class="token operator">&lt;=</span> start_date<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>如果在所有检查之后，执行线程仍然位于CheckLoadHistory()函数的主体中，这意味着有必要从交易服务器请求缺失的报价数据。首先，使用TerminalInfoInteger()函数返回“图表中最多柱数””最大图表数据量”(MT5)的值:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span> max_bars<span class="token operator">=</span><span class="token function">TerminalInfoInteger</span><span class="token punctuation">(</span>TERMINAL_MAXBARS<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>需要阻止额外调回数据，在服务器中找回字符历史的第一个日期（忽略周期），使用已知函数SeriesInfoInteger() 的修饰语 SERIES_SERVER_FIRSTDATE 。</p> <p>我们需要它来防止请求额外的数据。然后使用函数SeriesInfoInteger()并使用SERIES_SERVER_FIRSTDATE修饰符，查找交易服务器上已知的交易品种历史数据中的第一个日期(无论周期)。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>   datetime first_server_date<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>PERIOD_M1<span class="token punctuation">,</span>SERIES_SERVER_FIRSTDATE<span class="token punctuation">,</span>first_server_date<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>由于请求是一个异步操作，所以在循环中调用函数Sleep(),只有5毫秒的延迟，直到first_server_date变量接收到一个值，或者循环执行被一个用户终止(Isstop()在这种情况下返回true)。让我们指定开始日期的正确值，从该值开始，我们从交易服务器请求价格数据。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>   <span class="token keyword">if</span><span class="token punctuation">(</span>first_server_date <span class="token operator">&gt;</span> start_date<span class="token punctuation">)</span> start_date<span class="token operator">=</span>first_server_date<span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>first_date <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> first_date<span class="token operator">&lt;</span>first_server_date<span class="token punctuation">)</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Warning: first server date &quot;</span><span class="token punctuation">,</span>first_server_date<span class="token punctuation">,</span><span class="token string">&quot; for &quot;</span><span class="token punctuation">,</span> 
symbol<span class="token punctuation">,</span><span class="token string">&quot; does not match to first series date &quot;</span><span class="token punctuation">,</span>first_date<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果服务器的开始日期first_server_date低于HCC格式符号的开始日期first_date，则相应的文字消息将在会输出到日志中。</p> <p>现在我们准备向交易服务器请求缺失的历史价格数据。以循环的形式发出请求，并开始填充它的主体:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//1. 等候如同HHC一样重新建立时间序列与中间历史记录的同步化</span>
      <span class="token comment">//2. 接收这个时间序列的当前n个柱数</span>
      <span class="token comment">//    如果K线柱的数量已 大于 图表中允许的最大柱数量，可以退出，工作结束</span>
      <span class="token comment">//3. 获得重建时间序列开始日期的初始日期并且与开始日期相比较</span>
      <span class="token comment">//    如果初始日期 低于 开始日期，则退出，工作结束</span>
      <span class="token comment">//4. 从服务器请求历史记录的新部分-从最近有效标有'bars'的柱中启动的100个K线柱 </span>
     <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>前三点是用已知的方法实现的。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- 1.等待直到 时间序列 重建程序结束</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">,</span>SERIES_SYNCHRONIZED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//--- 2.请求多少K线柱</span>
      <span class="token keyword">int</span> bars<span class="token operator">=</span><span class="token function">Bars</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>bars<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span> 
         <span class="token comment">//--- 超过图表中所画的K线柱，退出</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>bars<span class="token operator">&gt;=</span>max_bars<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 3. 返回 时间序列 的当前开始日期</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">,</span>SERIES_FIRSTDATE<span class="token punctuation">,</span>first_date<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token comment">// 开始日期早于要求日期，任务完成</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>first_date <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> first_date<span class="token operator">&lt;=</span>start_date<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//4. 从服务器请求历史记录的新部分-从最近有效标有'bars'的柱中启动的100根K线柱</span>
     <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>剩下第四步 —— 请求索取历史数据。我们不能直接引用服务器，但是如果HCC格式的历史记录不够的话，任何复制功能都会自动启动发送到服务器的请求。由于first_date变量中第一个开始日期的时间是评估请求执行程度的简单而自然的标准，因此最简单的方法是使用CopyTime()函数。</p> <p>当调用从 时间序列 中复制任何数据的函数时，应该注意，start参数(开始条数，从哪个价格数据开始)必须始终位于可用的终端历史记录中。如果只有100根K线柱，那么从索引500开始复制300根K线柱就没有意义了。这样的请求将被理解为一个错误，不会被处理，即不会从交易服务器加载任何附加的历史记录。</p> <p>这就是为什么我们要以100为一组从K线柱索引开始复制K线柱的原因。这将使交易服务器顺利地加载缺失的历史记录。实际上，将加载比请求的100根K线柱多一点的内存，而服务器将发送过大的历史记录。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code> <span class="token keyword">int</span> copied<span class="token operator">=</span><span class="token function">CopyTime</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">,</span>bars<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span>times<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在复制操作之后，我们应该分析复制的元素的数量。如果尝试失败，则复制的值将等于null, fail_cnt计数器的值将增加1。在尝试100次失败后，函数的操作将被停止。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span> fail_cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">int</span> copied<span class="token operator">=</span><span class="token function">CopyTime</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">,</span>bars<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span>times<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>copied<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- 检测数据</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>times<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span>start_date<span class="token punctuation">)</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 复制值更小，准备完毕</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>bars<span class="token operator">+</span>copied<span class="token operator">&gt;=</span>max_bars<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 柱多于图表中所画的柱，准备完毕</span>
      fail_cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- 成功的话失败尝试少于100</span>
      fail_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>fail_cnt<span class="token operator">&gt;=</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>因此，不仅在执行的每个时刻正确地处理当前情况，而且返回终止代码，这些代码可以在调用CheckLoadHistory()函数之后进行处理，以获取更多信息。例如,这种方式:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span> res<span class="token operator">=</span><span class="token function">CheckLoadHistory</span><span class="token punctuation">(</span>InpLoadedSymbol<span class="token punctuation">,</span>InpLoadedPeriod<span class="token punctuation">,</span>InpStartDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">switch</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown symbol &quot;</span><span class="token punctuation">,</span>InpLoadedSymbol<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">2</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;More requested bars than can be drawn in the chart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">3</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Execution stopped by user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">4</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Indicator mustn't load its own data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">5</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Loading failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                     <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span>  <span class="token number">0</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;All data loaded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span>  <span class="token number">1</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Already available data in timeseries are enough&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span>  <span class="token number">2</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Timeseries is built from available terminal data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Execution result undefined&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>该函数的完整代码可以在脚本的示例中找到，该脚本通过处理请求的结果显示对任何数据的访问的正确组织。</p> <p>示例代码:</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                              TestLoadHistory.mq5 | </span>
<span class="token comment">//|                        Copyright 2009, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                              https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;2009, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.02&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">script_show_inputs </span></span>
<span class="token comment">//--- 输入参量 </span>
input string          InpLoadedSymbol<span class="token operator">=</span><span class="token string">&quot;NZDUSD&quot;</span><span class="token punctuation">;</span>   <span class="token comment">// 被加载的交易品种 </span>
input ENUM_TIMEFRAMES InpLoadedPeriod<span class="token operator">=</span>PERIOD_H1<span class="token punctuation">;</span>  <span class="token comment">// 被加载的周期 </span>
input datetime        InpStartDate<span class="token operator">=</span>D<span class="token char">'2006.01.01'</span><span class="token punctuation">;</span> <span class="token comment">// 开始日期 </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 脚本程序启动函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Start load&quot;</span><span class="token punctuation">,</span>InpLoadedSymbol<span class="token operator">+</span><span class="token string">&quot;,&quot;</span><span class="token operator">+</span><span class="token function">GetPeriodName</span><span class="token punctuation">(</span>InpLoadedPeriod<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;from&quot;</span><span class="token punctuation">,</span>InpStartDate<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token function">CheckLoadHistory</span><span class="token punctuation">(</span>InpLoadedSymbol<span class="token punctuation">,</span>InpLoadedPeriod<span class="token punctuation">,</span>InpStartDate<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">switch</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown symbol &quot;</span><span class="token punctuation">,</span>InpLoadedSymbol<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">2</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Requested bars more than max bars in chart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">3</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Program was stopped&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">4</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Indicator shouldn't load its own data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">5</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Load failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span>  <span class="token number">0</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Loaded OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                  <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span>  <span class="token number">1</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Loaded previously&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span>  <span class="token number">2</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Loaded previously and built&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">default</span> <span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown result&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- </span>
   datetime first_date<span class="token punctuation">;</span> 
   <span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span>InpLoadedSymbol<span class="token punctuation">,</span>InpLoadedPeriod<span class="token punctuation">,</span>SERIES_FIRSTDATE<span class="token punctuation">,</span>first_date<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span> bars<span class="token operator">=</span><span class="token function">Bars</span><span class="token punctuation">(</span>InpLoadedSymbol<span class="token punctuation">,</span>InpLoadedPeriod<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;First date &quot;</span><span class="token punctuation">,</span>first_date<span class="token punctuation">,</span><span class="token string">&quot; - &quot;</span><span class="token punctuation">,</span>bars<span class="token punctuation">,</span><span class="token string">&quot; bars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">CheckLoadHistory</span><span class="token punctuation">(</span>string symbol<span class="token punctuation">,</span>ENUM_TIMEFRAMES period<span class="token punctuation">,</span>datetime start_date<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   datetime first_date<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   datetime times<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 检测交易品种 &amp; 周期 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>symbol<span class="token operator">==</span><span class="token constant">NULL</span> <span class="token operator">||</span> symbol<span class="token operator">==</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> symbol<span class="token operator">=</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>period<span class="token operator">==</span>PERIOD_CURRENT<span class="token punctuation">)</span>     period<span class="token operator">=</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 检测市场报价是否选定了交易品种 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>SYMBOL_SELECT<span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>ERR_MARKET_UNKNOWN_SYMBOL<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token function">SymbolSelect</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 检测数据是否存在 </span>
   <span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">,</span>SERIES_FIRSTDATE<span class="token punctuation">,</span>first_date<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>first_date <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> first_date <span class="token operator">&lt;=</span> start_date<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果是指标的话不需要加载自己的数据 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MQL5InfoInteger</span><span class="token punctuation">(</span>MQL5_PROGRAM_TYPE<span class="token punctuation">)</span><span class="token operator">==</span>PROGRAM_INDICATOR <span class="token operator">&amp;&amp;</span> <span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>period <span class="token operator">&amp;&amp;</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>symbol<span class="token punctuation">)</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 第二尝试 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>PERIOD_M1<span class="token punctuation">,</span>SERIES_TERMINAL_FIRSTDATE<span class="token punctuation">,</span>first_date<span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 有建立时间序列加载的数据 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>first_date<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token comment">//--- 强制创建时间序列 </span>
         <span class="token function">CopyTime</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">,</span>first_date<span class="token operator">+</span><span class="token function">PeriodSeconds</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>times<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 检测日期 </span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">,</span>SERIES_FIRSTDATE<span class="token punctuation">,</span>first_date<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span>first_date <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> first_date <span class="token operator">&lt;=</span> start_date<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 图表中来自程序端选项的最大柱 </span>
   <span class="token keyword">int</span> max_bars<span class="token operator">=</span><span class="token function">TerminalInfoInteger</span><span class="token punctuation">(</span>TERMINAL_MAXBARS<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 加载交易品种历史记录信息 </span>
   datetime first_server_date<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>PERIOD_M1<span class="token punctuation">,</span>SERIES_SERVER_FIRSTDATE<span class="token punctuation">,</span>first_server_date<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
      <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 为加载确定开始日期 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>first_server_date <span class="token operator">&gt;</span> start_date<span class="token punctuation">)</span> start_date<span class="token operator">=</span>first_server_date<span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>first_date <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> first_date <span class="token operator">&lt;</span> first_server_date<span class="token punctuation">)</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Warning: first server date &quot;</span><span class="token punctuation">,</span>first_server_date<span class="token punctuation">,</span><span class="token string">&quot; for &quot;</span><span class="token punctuation">,</span>symbol<span class="token punctuation">,</span> 
            <span class="token string">&quot; does not match to first series date &quot;</span><span class="token punctuation">,</span>first_date<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 逐步地加载数据 </span>
   <span class="token keyword">int</span> fail_cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 等待建立时间序列 </span>
      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">,</span>SERIES_SYNCHRONIZED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
         <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 要求建成的柱 </span>
      <span class="token keyword">int</span> bars<span class="token operator">=</span><span class="token function">Bars</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span>bars<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span>bars <span class="token operator">&gt;=</span> max_bars<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 请求初始日期 </span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">,</span>SERIES_FIRSTDATE<span class="token punctuation">,</span>first_date<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span>first_date <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> first_date <span class="token operator">&lt;=</span> start_date<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      <span class="token comment">//--- 复制部分强制数据加载 </span>
      <span class="token keyword">int</span> copied<span class="token operator">=</span><span class="token function">CopyTime</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>period<span class="token punctuation">,</span>bars<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span>times<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span>copied<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token comment">//--- 数据检测 </span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>times<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span>start_date<span class="token punctuation">)</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span>bars<span class="token operator">+</span>copied <span class="token operator">&gt;=</span> max_bars<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         fail_cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      <span class="token keyword">else</span> 
        <span class="token punctuation">{</span> 
         <span class="token comment">//--- 失败尝试少于100 </span>
         fail_cnt<span class="token operator">++</span><span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span>fail_cnt<span class="token operator">&gt;=</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 停止 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 返回该周期的字符串值                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
string <span class="token function">GetPeriodName</span><span class="token punctuation">(</span>ENUM_TIMEFRAMES period<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>period<span class="token operator">==</span>PERIOD_CURRENT<span class="token punctuation">)</span> period<span class="token operator">=</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">switch</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">case</span> PERIOD_M1<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;M1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_M2<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;M2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_M3<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;M3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_M4<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;M4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_M5<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;M5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_M6<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;M6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_M10<span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;M10&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_M12<span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;M12&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_M15<span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;M15&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_M20<span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;M20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_M30<span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;M30&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_H1<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;H1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_H2<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;H2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_H3<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;H3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_H4<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;H4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_H6<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;H6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_H8<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;H8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_H12<span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;H12&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_D1<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;Daily&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_W1<span class="token operator">:</span>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;Weekly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> PERIOD_MN1<span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;Monthly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;unknown period&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br></div></div><h2 id="_16-3-seriesinfointeger"><a href="#_16-3-seriesinfointeger" class="header-anchor">#</a> 16.3 SeriesInfoInteger</h2> <p>返回有关历史数据状态的信息。这个函数有2个变体。</p> <ol><li>直接返回属性值</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">long</span>  <span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span> 
   string                     symbol_name<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES            timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   ENUM_SERIES_INFO_INTEGER   prop_id<span class="token punctuation">,</span>         <span class="token comment">// 属性标识符 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li>返回true或false，取决于函数运行的结果。</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span> 
   string                     symbol_name<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES            timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   ENUM_SERIES_INFO_INTEGER   prop_id<span class="token punctuation">,</span>         <span class="token comment">// 属性ID </span>
   <span class="token keyword">long</span><span class="token operator">&amp;</span>                      long_var         <span class="token comment">// 用于获得属性信息的变量 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数
symbol_name</p> <p>[in] 交易品种名称。</p> <p>timeframe</p> <p>[in] 周期。</p> <p>prop_id</p> <p>[in] 请求属性的标识符，取值范围为ENUM_SERIES_INFO_INTEGER枚举值之一。</p> <p>long_var</p> <p>[out] 用于保存请求属性值的变量。</p> <p>返回值
第一种情况，返回一个长整型数值。</p> <p>对于第二种情况，如果指定的属性可用 且 其值已放入long_var变量中，则返回true，否则返回false。有关错误的更多详细信息，请调用GetLastError()。</p> <p>示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 打印输出当前交易品种时间周期图表上的K线柱总数</span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Total number of bars for the symbol-period at this moment = &quot;</span><span class="token punctuation">,</span> 
         <span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SERIES_BARS_COUNT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 打印输出当前交易品种时间周期图表上K线柱开始的时间  </span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;The first date for the symbol-period at this moment = &quot;</span><span class="token punctuation">,</span> 
         <span class="token punctuation">(</span>datetime<span class="token punctuation">)</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SERIES_FIRSTDATE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 打印输出当前交易品种时间周期历史图表上K线柱开始的时间   </span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;The first date in the history for the symbol-period on the server = &quot;</span><span class="token punctuation">,</span> 
         <span class="token punctuation">(</span>datetime<span class="token punctuation">)</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SERIES_SERVER_FIRSTDATE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 交易品种历史数据同步   </span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Symbol data are synchronized = &quot;</span><span class="token punctuation">,</span> 
         <span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token punctuation">)</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SERIES_SYNCHRONIZED<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="_16-4-bars"><a href="#_16-4-bars" class="header-anchor">#</a> 16.4 Bars</h2> <p>返回指定交易品种 和 周期的历史数据K线柱数量。这个函数有2个变体。</p> <ol><li>请求所有历史数据K线柱数量</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">Bars</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe        <span class="token comment">// 周期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="2"><li>请求指定时间间隔内的历史数据K线柱数量</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">Bars</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>      <span class="token comment">// 开始 日期和时间 </span>
   datetime         stop_time        <span class="token comment">// 结束 日期和时间 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数
symbol_name</p> <p>[in] 交易品种名称。</p> <p>timeframe</p> <p>[in] 周期。</p> <p>start_time</p> <p>[in] 指定时间间隔的开始时间。</p> <p>stop_time</p> <p>[in] 指定时间间隔的结束时间。</p> <p>返回值
如果定义了start_time和stop_time参数，则该函数返回指定时间间隔内的K线柱数量，否则返回K线柱数量的总数。</p> <p>注意
如果在Bars()函数调用时客户端中没有形成具有指定参数的 时间序列 的数据，或者在函数调用期间 时间序列 的数据未与交易服务器同步，则函数返回 0 值。</p> <p>当请求指定时间间隔内的K线柱数量，只考虑时间间隔内开盘时间的K线柱。例如，如果当前是星期六，并且请求就是W1周期的K线柱数量，开始时间为 start_time=last_tuesday ，结束时间为 stop_time=last_friday。因为在W1时间框架范围的开盘时间始终为星期日，并且在指定间隔内W1图表上没有一根单独的K线柱，所以函数将返回0。</p> <p>请求所有历史K线柱数量的示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>   <span class="token keyword">int</span> bars<span class="token operator">=</span><span class="token function">Bars</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>bars<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Number of bars in the terminal history for the symbol-period at the moment = &quot;</span><span class="token punctuation">,</span>bars<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当前客户端交易品种周期图表中历史K线柱的数量 =</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">else</span>  <span class="token comment">//无有效柱</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- 交易品种数据不能和服务器数据同步</span>
      <span class="token keyword">bool</span> synchronized<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token comment">//--- 循环计数器</span>
      <span class="token keyword">int</span> attempts<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">// 进行5次尝试等候同步进行</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span>attempts<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SERIES_SYNCHRONIZED<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
            <span class="token comment">//--- 同步化完成，退出</span>
            synchronized<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
         <span class="token comment">//--- 增加计数器</span>
         attempts<span class="token operator">++</span><span class="token punctuation">;</span>
         <span class="token comment">//--- 等候10毫秒直至嵌套反复</span>
         <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//--- 同步化后退出循环</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>synchronized<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Number of bars in the terminal history for the symbol-period at the moment = &quot;</span><span class="token punctuation">,</span>bars<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当前客户端交易品种周期图表中历史K线柱的数量</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;The first date in the terminal history for the symbol-period at the moment = &quot;</span><span class="token punctuation">,</span>
               <span class="token punctuation">(</span>datetime<span class="token punctuation">)</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SERIES_FIRSTDATE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 在客户端中该交易品种的历史数据中的第一根K线柱的日期时间</span>
          <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;The first date in the history for the symbol on the server = &quot;</span><span class="token punctuation">,</span>
   <span class="token punctuation">(</span>datetime<span class="token punctuation">)</span><span class="token function">SeriesInfoInteger</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SERIES_SERVER_FIRSTDATE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 在服务器上的该交易品种的历史数据中的第一根K线柱的日期时间</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//--- 不发生数据同步</span>
      <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get number of bars for &quot;</span><span class="token punctuation">,</span>_Symbol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>  <span class="token comment">// 获取K线柱数量失败</span>
     <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>请求指定时间间隔内K线柱数量的示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>   <span class="token keyword">int</span> n<span class="token punctuation">;</span> 
   datetime date1 <span class="token operator">=</span> D<span class="token char">'2016.09.02 23:55'</span><span class="token punctuation">;</span> <span class="token comment">// 星期五 </span>
   datetime date2 <span class="token operator">=</span> D<span class="token char">'2016.09.05 00:00'</span><span class="token punctuation">;</span> <span class="token comment">// 星期一 </span>
   datetime date3 <span class="token operator">=</span> D<span class="token char">'2016.09.08 00:00'</span><span class="token punctuation">;</span> <span class="token comment">// 星期四 </span>
   <span class="token comment">//--- </span>
   n<span class="token operator">=</span><span class="token function">Bars</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>PERIOD_H1<span class="token punctuation">,</span>D<span class="token char">'2016.09.02 02:05'</span><span class="token punctuation">,</span>D<span class="token char">'2016.09.02 10:55'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Number of bars: &quot;</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出：&quot;柱形图数：8&quot;，计算中考虑H2柱形图，而非H11柱形图 </span>
   n<span class="token operator">=</span><span class="token function">Bars</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>PERIOD_D1<span class="token punctuation">,</span>date1<span class="token punctuation">,</span>date2<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Number of bars: &quot;</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出：&quot;柱形图数：1&quot;，由于D1图表上有一根单独的K线柱(星期一)，开盘时间在指定的时间间隔内 </span>
   n<span class="token operator">=</span><span class="token function">Bars</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>PERIOD_W1<span class="token punctuation">,</span>date2<span class="token punctuation">,</span>date3<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Number of bars: &quot;</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出：&quot;柱形图数：0&quot;，由于W1图表上没有一根K线柱的开盘时间在指定的时间间隔内</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_16-5-barscalculated"><a href="#_16-5-barscalculated" class="header-anchor">#</a> 16.5 BarsCalculated</h2> <p>返回指定指标的计算数据的数量。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">BarsCalculated</span><span class="token punctuation">(</span> 
   <span class="token keyword">int</span>       indicator_handle<span class="token punctuation">,</span>     <span class="token comment">// 指标处理 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数<br>
indicator_handle</p> <p>[in] 指标的句柄，通过相应的指标函数返回。</p> <p>返回值<br>
在指标缓冲区返回计算数据的数量 或者 发生错误时返回 -1(数据不能进行计算)。</p> <p>注意<br>
当需要在其创建后立即获取指标数据(指标句柄可用)时，该函数非常有用。
示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token keyword">double</span> Ups<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置整理数组的 时间序列 </span>
   <span class="token function">ArraySetAsSeries</span><span class="token punctuation">(</span>Ups<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 为分形指标创建处理程序 </span>
   <span class="token keyword">int</span> FractalsHandle<span class="token operator">=</span><span class="token function">iFractals</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 复制指标值 </span>
   <span class="token keyword">int</span> i<span class="token punctuation">,</span>copied<span class="token operator">=</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>FractalsHandle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">,</span>Ups<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>copied<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>FractalsHandle<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span> 
         <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      copied<span class="token operator">=</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>FractalsHandle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">,</span>Ups<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span>copied<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy upper fractals. Error = &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
         <span class="token string">&quot;i = &quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token string">&quot;    copied = &quot;</span><span class="token punctuation">,</span>copied<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">return</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
       <span class="token keyword">else</span> 
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Upper fractals copied&quot;</span><span class="token punctuation">,</span> 
         <span class="token string">&quot;i = &quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token string">&quot;    copied = &quot;</span><span class="token punctuation">,</span>copied<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Upper fractals copied. ArraySize = &quot;</span><span class="token punctuation">,</span><span class="token function">ArraySize</span><span class="token punctuation">(</span>Ups<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h2 id="_16-6-indicatorcreate"><a href="#_16-6-indicatorcreate" class="header-anchor">#</a> 16.6 IndicatorCreate</h2> <p>该函数返回基于MqlParam类型参数数组创建的指定技术指标的句柄。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">IndicatorCreate</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>                            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  period<span class="token punctuation">,</span>                            <span class="token comment">// 时间表 </span>
   ENUM_INDICATOR   indicator_type<span class="token punctuation">,</span>                    <span class="token comment">// ENUM_INDICATOR枚举的指标类型之一 </span>
   <span class="token keyword">int</span>              parameters_cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>                  <span class="token comment">// 参数编号 </span>
   <span class="token keyword">const</span> MqlParam<span class="token operator">&amp;</span>  parameters_array<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">,</span>           <span class="token comment">// 参量数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数
symbol</p> <p>[in] 交易品种名称，指标的计算数据，NULL 表示当前交易品种。</p> <p>period</p> <p>[in] 时间周期，取值范围是 ENUM_TIMEFRAMES 枚举值之一，0 代表当前时间框架。</p> <p>indicator_type</p> <p>[in] 指标类型，取值范围是 ENUM_INDICATOR 枚举值之一。</p> <p>parameters_cnt</p> <p>[in] 在parameters_array []数组中传递的参数数量。 数组元素具有特殊的结构类型MqlParam。 默认情况下，0表示不传递参数。如果您指定了 非零 数量的参数，则参数parameters_array是强制性的。您可以传递的参数数量不得超过256个。</p> <p>parameters_array[]=NULL</p> <p>[in] MqlParam 类型数组，元素包括类型和每个技术指标 输入参数 的类型值。</p> <p>返回值
返回指定技术指标的句柄，如果失败，则返回INVALID_HANDLE。</p> <p>注意
如果创建了IND_CUSTOM类型(自定义指标)的指标句柄，则输入参数array_array的第一个元素的类型字段必须具有ENUM_DATATYPE枚举的TYPE_STRING值，并且第一个元素的string_value字段必须包含自定义指标的名称。自定义指标必须进行编译(具有EX5扩展名的文件)，并位于客户端MQL5 / Indicators目录中或子目录中。</p> <p>如果通过常量字符串设置相应的参数，那么需要测试的指标会自动从iCustom()函数的调用中定义。对于所有其他情况(使用IndicatorCreate()函数或在设置指标名称的参数中使用非常量字符串)，则属性 #property tester_indicator是必需的：</p> <p>#property tester_indicator &quot;indicator_name.ex5&quot;
如果调用的自定义指标，是第一种版本格式，则可以另外指示传递输入参数时将计算哪些数据的最后一个参数。如果没有明确指定“应用于”参数，则默认计算基于PRICE_CLOSE值。</p> <p>示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   MqlParam params<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span>      h_MA<span class="token punctuation">,</span>h_MACD<span class="token punctuation">;</span> 
<span class="token comment">//--- 创建 iMA(&quot;EURUSD&quot;,PERIOD_M15,8,0,MODE_EMA,PRICE_CLOSE); </span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置 ma_period </span>
   params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type         <span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
   params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置 ma_shift </span>
   params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type         <span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
   params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置 ma_method </span>
   params<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type         <span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
   params<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>MODE_EMA<span class="token punctuation">;</span> 
<span class="token comment">//--- 数组 applied_price </span>
   params<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type         <span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
   params<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span> 
<span class="token comment">//--- 创建 MA </span>
   h_MA<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span><span class="token string">&quot;EURUSD&quot;</span><span class="token punctuation">,</span>PERIOD_M15<span class="token punctuation">,</span>IND_MA<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 创建 iMACD(&quot;EURUSD&quot;,PERIOD_M15,12,26,9,h_MA); </span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置快速 ma_period </span>
   params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type         <span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
   params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置慢速 ma_period </span>
   params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type         <span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
   params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 为不同性设置平滑周期 </span>
   params<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type         <span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
   params<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置指标处理程序为 applied_price </span>
   params<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type         <span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
   params<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>h_MA<span class="token punctuation">;</span> 
<span class="token comment">//--- 创建基于移动平均数的MACD  </span>
   h_MACD<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span><span class="token string">&quot;EURUSD&quot;</span><span class="token punctuation">,</span>PERIOD_M15<span class="token punctuation">,</span>IND_MACD<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 使用指标 </span>
<span class="token comment">//--- . . . </span>
<span class="token comment">//--- 发布指标 (首先 h_MACD) </span>
   <span class="token function">IndicatorRelease</span><span class="token punctuation">(</span>h_MACD<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorRelease</span><span class="token punctuation">(</span>h_MA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h2 id="_16-7-indicatorparameters"><a href="#_16-7-indicatorparameters" class="header-anchor">#</a> 16.7 IndicatorParameters</h2> <p>根据指定的指标句柄，返回指标的输入参数数量，以及参数的值和类型。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">IndicatorParameters</span><span class="token punctuation">(</span> 
   <span class="token keyword">int</span>               indicator_handle<span class="token punctuation">,</span>     <span class="token comment">// 指标处理 </span>
   ENUM_INDICATOR<span class="token operator">&amp;</span>   indicator_type<span class="token punctuation">,</span>       <span class="token comment">// 接收指标类型的变量 </span>
   MqlParam<span class="token operator">&amp;</span>         parameters<span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token comment">// 接收参数的数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数
indicator_handle</p> <p>[in] 指标的句柄，您需要知道其计算参数的数量。</p> <p>indicator_type</p> <p>[out] 接收指标类型的变量一个变量，取值范围是ENUM_INDICATOR枚举类型之一，指标类型将写入其中。</p> <p>parameters[]</p> <p>[out] 接收MqlParam类型值的动态数组，在这里写入指标参数列表。数组大小通过IndicatorParameters()函数返回。</p> <p>返回值
指定指标句柄的输入参数数量。如果错误则返回-1。要了解有关错误的更多信息，请访问GetLastError()函数。</p> <p>例：(此例仅适用于 MT5 客户端)</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 脚本程序起始函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
  
<span class="token comment">//--- 图表上的窗口数量（至少有一个窗口始终存在） </span>
   <span class="token keyword">int</span> windows<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">ChartGetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_WINDOWS_TOTAL<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 检查图表窗口 </span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> w<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>w<span class="token operator">&lt;</span>windows<span class="token punctuation">;</span>w<span class="token operator">++</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 该窗口/子窗口的指标数量 </span>
      <span class="token keyword">int</span> total<span class="token operator">=</span><span class="token function">ChartIndicatorsTotal</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 从窗口获取所有指标 </span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>total<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token comment">//--- 获得指标的缩略名称 </span>
         string name<span class="token operator">=</span><span class="token function">ChartIndicatorName</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>w<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 获得指标句柄 </span>
         <span class="token keyword">int</span> handle<span class="token operator">=</span><span class="token function">ChartIndicatorGet</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>w<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 添加到日志 </span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Window=%d,  indicator #%d,  handle=%d&quot;</span><span class="token punctuation">,</span>w<span class="token punctuation">,</span>i<span class="token punctuation">,</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- </span>
         MqlParam parameters<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
         ENUM_INDICATOR indicator_type<span class="token punctuation">;</span> 
         <span class="token keyword">int</span> params<span class="token operator">=</span><span class="token function">IndicatorParameters</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span>indicator_type<span class="token punctuation">,</span>parameters<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 信息的标头 </span>
         string par_info<span class="token operator">=</span><span class="token string">&quot;Short name &quot;</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">&quot;, type &quot;</span> 
                         <span class="token operator">+</span><span class="token function">EnumToString</span><span class="token punctuation">(</span><span class="token function">ENUM_INDICATOR</span><span class="token punctuation">(</span>indicator_type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\r\n&quot;</span><span class="token punctuation">;</span> 
         <span class="token comment">//---  </span>
         <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> p<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>p<span class="token operator">&lt;</span>params<span class="token punctuation">;</span>p<span class="token operator">++</span><span class="token punctuation">)</span> 
           <span class="token punctuation">{</span> 
            par_info<span class="token operator">+=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;parameter %d: type=%s, long_value=%d, double_value=%G,string_value=%s\r\n&quot;</span><span class="token punctuation">,</span> 
                                   p<span class="token punctuation">,</span> 
                                   <span class="token function">EnumToString</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ENUM_DATATYPE<span class="token punctuation">)</span>parameters<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                                   parameters<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token punctuation">,</span> 
                                   parameters<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>double_value<span class="token punctuation">,</span> 
                                   parameters<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>string_value 
                                   <span class="token punctuation">)</span><span class="token punctuation">;</span> 
           <span class="token punctuation">}</span> 
         <span class="token function">Print</span><span class="token punctuation">(</span>par_info<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      <span class="token comment">//--- 完成窗口的所有指标 </span>
     <span class="token punctuation">}</span> 
<span class="token comment">//---     </span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h2 id="_16-8-indicatorrelease"><a href="#_16-8-indicatorrelease" class="header-anchor">#</a> 16.8 IndicatorRelease</h2> <p>如果没有其他人使用，该函数将删除指标器句柄并释放指标的计算块。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span>  <span class="token function">IndicatorRelease</span><span class="token punctuation">(</span> 
   <span class="token keyword">int</span>       indicator_handle     <span class="token comment">// 指标处理 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>返回值
如果成功返回TRUE，否则返回FALSE。</p> <p>注意
该函数允许删除指标句柄(如果不再需要)，从而节省内存。句柄会被立即移除，计算块会在一段时间内被删除(如果它不再被调用)。</p> <p>当在策略测试器中工作时，不会执行IndicatorRelease()函数。</p> <p>示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                        Test_IndicatorRelease.mq5 | </span>
<span class="token comment">//|                        Copyright 2010, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;2010, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token comment">//--- 输入参量 </span>
input <span class="token keyword">int</span>                MA_Period<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">;</span> 
input <span class="token keyword">int</span>                MA_shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
input ENUM_MA_METHOD     MA_smooth<span class="token operator">=</span>MODE_SMA<span class="token punctuation">;</span> 
input ENUM_APPLIED_PRICE price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储指标处理程序 </span>
<span class="token keyword">int</span> MA_handle<span class="token operator">=</span>INVALID_HANDLE<span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA初始化函数                                                      | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   MA_handle<span class="token operator">=</span><span class="token function">iMA</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>MA_Period<span class="token punctuation">,</span>MA_shift<span class="token punctuation">,</span>MA_smooth<span class="token punctuation">,</span>PRICE_CLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 删除全局变量 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">GlobalVariableCheck</span><span class="token punctuation">(</span><span class="token string">&quot;MA_value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
      <span class="token function">GlobalVariableDel</span><span class="token punctuation">(</span><span class="token string">&quot;MA_value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA订单号函数                                                      | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 如果全局变量值不存在 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GlobalVariableCheck</span><span class="token punctuation">(</span><span class="token string">&quot;MA_value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 在最近2柱获得指标值 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>MA_handle<span class="token operator">!=</span>INVALID_HANDLE<span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token comment">//--- 指标值的动态数组 </span>
         <span class="token keyword">double</span> values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>MA_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">2</span> <span class="token operator">&amp;&amp;</span> values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">!=</span>EMPTY_VALUE<span class="token punctuation">)</span> 
           <span class="token punctuation">{</span> 
            <span class="token comment">//--- 记住倒数第二柱的全局变量值 </span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">GlobalVariableSet</span><span class="token punctuation">(</span><span class="token string">&quot;MA_value&quot;</span><span class="token punctuation">,</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
              <span class="token punctuation">{</span> 
               <span class="token comment">//--- 释放指标处理程序 </span>
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IndicatorRelease</span><span class="token punctuation">(</span>MA_handle<span class="token punctuation">)</span><span class="token punctuation">)</span> 
                  <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;IndicatorRelease() failed. Error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
               <span class="token keyword">else</span> MA_handle<span class="token operator">=</span>INVALID_HANDLE<span class="token punctuation">;</span> 
              <span class="token punctuation">}</span> 
            <span class="token keyword">else</span> 
               <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;GlobalVariableSet failed. Error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
           <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- </span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h2 id="_16-9-copybuffer"><a href="#_16-9-copybuffer" class="header-anchor">#</a> 16.9 CopyBuffer</h2> <p>获取必要数量的某个指标的指定缓冲区的数据。</p> <p><img src="/mql5yao/assets/img/thi33.04e64708.png" alt="">
copyBuffer</p> <p>从开始位置开始计数复制数据(具有索引buffer_num的指标缓冲区)的元素从当前到过去，即，开始位置0表示当前K线柱(当前K线柱的指标值)。</p> <p>在复制未知数量的数据时，建议使用动态数组作为buffer[]接收缓冲区，因为CopyBuffer()函数会尝试将接收数组的大小分配给复制数据的大小。如果指标缓冲区(通过SetIndexBufer()函数预先分配用于存储指标值的数组)用作buffer[]接收数组，则允许进行部分复制。可以在标准客户端安装包中的Awesome_Oscillator.mql5自定义指标中找到一个示例。</p> <p>如果您需要将指标值的部分副本复制到另一个数组(非指标缓冲区)，则应使用中间数组，并将所需的数量复制到该数组中。之后，将所需数量值的元素明细复制到接收数组的所需位置。</p> <p>如果您知道需要复制的数据量，最好对静态分配的缓冲区执行操作，以防止分配过多的内存。</p> <p>无论目标数组的属性是什么，即标帜 - as_series = true或as_series = false。数据都将被复制，因为便最旧的元素将位于为数组分配的物理内存的开始位置。此函数有3种变体。</p> <ol><li>按开始位置和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyBuffer</span><span class="token punctuation">(</span> 
   <span class="token keyword">int</span>       indicator_handle<span class="token punctuation">,</span>     <span class="token comment">// 指标处理 </span>
   <span class="token keyword">int</span>       buffer_num<span class="token punctuation">,</span>           <span class="token comment">// 指标缓冲区数 </span>
   <span class="token keyword">int</span>       start_pos<span class="token punctuation">,</span>            <span class="token comment">// 启动位置 </span>
   <span class="token keyword">int</span>       count<span class="token punctuation">,</span>                <span class="token comment">// 复制总额 </span>
   <span class="token keyword">double</span>    buffer<span class="token punctuation">[</span><span class="token punctuation">]</span>              <span class="token comment">// 复制的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>按开始日期和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyBuffer</span><span class="token punctuation">(</span> 
   <span class="token keyword">int</span>       indicator_handle<span class="token punctuation">,</span>     <span class="token comment">// 指标处理 </span>
   <span class="token keyword">int</span>       buffer_num<span class="token punctuation">,</span>           <span class="token comment">// 指标缓冲区数 </span>
   datetime  start_time<span class="token punctuation">,</span>           <span class="token comment">// 启动日期和时间 </span>
   <span class="token keyword">int</span>       count<span class="token punctuation">,</span>                <span class="token comment">// 复制总额 </span>
   <span class="token keyword">double</span>    buffer<span class="token punctuation">[</span><span class="token punctuation">]</span>              <span class="token comment">// 复制的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>按所需时间间隔的开始和结束日期进行调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyBuffer</span><span class="token punctuation">(</span> 
   <span class="token keyword">int</span>       indicator_handle<span class="token punctuation">,</span>     <span class="token comment">// 指标处理 </span>
   <span class="token keyword">int</span>       buffer_num<span class="token punctuation">,</span>           <span class="token comment">// 指标缓冲区数 </span>
   datetime  start_time<span class="token punctuation">,</span>           <span class="token comment">// 启动日期和时间 </span>
   datetime  stop_time<span class="token punctuation">,</span>            <span class="token comment">// 结束日期和时间 </span>
   <span class="token keyword">double</span>    buffer<span class="token punctuation">[</span><span class="token punctuation">]</span>              <span class="token comment">// 复制的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数
indicator_handle</p> <p>[in] 指标句柄，由相应的指标函数返回。</p> <p>buffer_num</p> <p>[in] 指标缓冲区数量。</p> <p>start_pos</p> <p>[in] 开始复制元素的索引位置。</p> <p>count</p> <p>[in] 复制数据元素的数量。</p> <p>start_time</p> <p>[in] K线柱的时间，对应要复制的第一个元素。</p> <p>stop_time</p> <p>[in] K线柱的时间，对应要复制的最后一个元素。</p> <p>buffer[]</p> <p>[out] 双精度 类型数组。</p> <p>返回值
返回复制数据的数量 或 发生错误时返回 -1。</p> <p>注意
当从指标中请求数据时，如果请求的 时间序列 尚未建立 或 需要从服务器下载，函数将立即返回 -1，但随后，将启动 下载/构建 过程。</p> <p>从EA交易程序 或 脚本请求数据时，如果终端在本地没有这些数据，则将启动从服务器下载数据，或者如果数据可以从本地历史数据构建，但所需的 时间序列 仍未准备好。该函数将返回在 超时 到期之前准备就绪的数据量。但是历史下载会继续，在下一个类似要求函数中会返回更多数据。</p> <p>示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                              TestCopyBuffer3.mq5 | </span>
<span class="token comment">//|                        Copyright 2009, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;2009, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//---- 图 MA </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;MA&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 输入参量 </span>
input <span class="token keyword">bool</span>               AsSeries<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> 
input <span class="token keyword">int</span>                period<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">;</span> 
input ENUM_MA_METHOD     smootMode<span class="token operator">=</span>MODE_EMA<span class="token punctuation">;</span> 
input ENUM_APPLIED_PRICE price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span> 
input <span class="token keyword">int</span>                shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>                   MABuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">int</span>                      ma_handle<span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 指标缓冲区绘图 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>MABuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Parameter AsSeries = &quot;</span><span class="token punctuation">,</span>AsSeries<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Indicator buffer after SetIndexBuffer() is a timeseries = &quot;</span><span class="token punctuation">,</span> 
         <span class="token function">ArrayGetAsSeries</span><span class="token punctuation">(</span>MABuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置短小的指标名称 </span>
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span><span class="token string">&quot;MA(&quot;</span><span class="token operator">+</span>period<span class="token operator">+</span><span class="token string">&quot;)&quot;</span><span class="token operator">+</span>AsSeries<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置 AsSeries(依据输入参量) </span>
   <span class="token function">ArraySetAsSeries</span><span class="token punctuation">(</span>MABuffer<span class="token punctuation">,</span>AsSeries<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Indicator buffer after ArraySetAsSeries(MABuffer,true); is a timeseries = &quot;</span><span class="token punctuation">,</span> 
         <span class="token function">ArrayGetAsSeries</span><span class="token punctuation">(</span>MABuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
   ma_handle<span class="token operator">=</span><span class="token function">iMA</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>period<span class="token punctuation">,</span>shift<span class="token punctuation">,</span>smootMode<span class="token punctuation">,</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标重复函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 检测是否计算了所有数据 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>ma_handle<span class="token punctuation">)</span><span class="token operator">&lt;</span>rates_total<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 不复制所有数据 </span>
   <span class="token keyword">int</span> to_copy<span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">&gt;</span>rates_total <span class="token operator">||</span> prev_calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      to_copy<span class="token operator">=</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">;</span> 
      <span class="token comment">//--- 常常复制最后的值 </span>
      to_copy<span class="token operator">++</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 复制 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ma_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>to_copy<span class="token punctuation">,</span>MABuffer<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 为下次调用返回prev_calculated值 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>上面的例子说明了如何使用同一 交易品种/周期 中指标的另一个指标缓冲区的值填充指标缓冲区。</p> <p>请参阅对象绑定方法一节中有关历史请求数据的详细示例。该部分提供的脚本显示了如何获取最近1000根K线柱上的指标iFractals的值以及如何显示图表上的最近的10个上下分形箭头。对于缺少数据并且通常使用以下样式绘制的所有指标都可以使用类似的技术：<br>
• DRAW_SECTION,<br>
• DRAW_ARROW,<br>
• DRAW_ZIGZAG,<br>
• DRAW_COLOR_SECTION,<br>
• DRAW_COLOR_ARROW,<br>
• DRAW_COLOR_ZIGZAG.</p> <p>相关参考<br>
自定义指标属性 ， SetIndexBuffer</p> <h2 id="_16-10-copyrates"><a href="#_16-10-copyrates" class="header-anchor">#</a> 16.10 CopyRates</h2> <p>将指定交易品种、周期和数量的MqlRates结构的历史数据获取到rates_array数组中。复制数据的元素顺序是从现在到过去，即，从当前位置开始，0表示当前的K线柱。</p> <p><img src="/mql5yao/assets/img/thi34.7da4b09a.png" alt="">
CopyRates</p> <p>当复制的元素数量未知时，建议使用动态数组作为目标数组，因为如果请求的数据数量小于(或大于)目标数组的长度，函数将尝试重新分配内存，以便完全适应数据请求的要求。</p> <p>如果您知道需要复制的数据量，最好对静态分配的缓冲区执行操作，以防止分配过多的内存。</p> <p>无论目标数组的属性是什么，即标帜 - as_series = true或as_series = false。数据都将被复制，因为便最旧的元素将位于为数组分配的物理内存的开始位置。此函数有3种变体。</p> <ol><li>按开始位置和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyRates</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>       <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>         <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              start_pos<span class="token punctuation">,</span>         <span class="token comment">// 启动位置 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>             <span class="token comment">// 复制数据计算 </span>
   MqlRates         rates_array<span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// 复制目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>按开始日期和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyRates</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>       <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>         <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>        <span class="token comment">// 开始日期和时间 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>             <span class="token comment">// 复制数据计算 </span>
   MqlRates         rates_array<span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// 复制目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>按所需时间间隔的开始和结束日期进行调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyRates</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>       <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>         <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>        <span class="token comment">// 开始日期和时间 </span>
   datetime         stop_time<span class="token punctuation">,</span>         <span class="token comment">// 结束日期和时间 </span>
   MqlRates         rates_array<span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// 复制目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数
symbol_name</p> <p>[in] 交易品种名称。</p> <p>timeframe</p> <p>[in] 时间周期(框架)。</p> <p>start_time</p> <p>[in] K线柱的时间，对应要复制的第一个元素。</p> <p>start_pos</p> <p>[in] 开始复制元素的索引位置。</p> <p>count</p> <p>[in] 复制的元素数量。</p> <p>stop_time</p> <p>[in] K线柱的时间，对应要复制的最后一个元素。</p> <p>rates_array[]</p> <p>[out] MqlRates 类型数组</p> <p>返回值
返回复制数据的数量 或 发生错误时返回 -1。</p> <p>注意
如果请求数据的整个时间间隔超出服务器上的可用数据，则函数返回 -1。如果在TERMINAL_MAXBARS(图表中最多柱数”最大图表数据量”(MT5))之外请求数据，函数也将返回 -1。</p> <p>当从指标请求数据时，如果所请求的 时间序列 尚未构建，或者需要从服务器上下载，该函数将立即返回 -1，但随后，将启动 下载/构建 过程。</p> <p>从EA交易程序 或 脚本请求数据时，如果终端在本地没有这些数据，则将启动从服务器下载数据，或者如果数据可以从本地历史数据构建，但所需的 时间序列 仍未准备好。该函数将返回在 超时 到期之前准备就绪的数据量。但是历史下载会继续，在下一个类似要求函数中会返回更多数据。</p> <p>当用 2. 按开始日期和所需元素的数量调用 时，只返回日期小于(更早) 或 等于指定日期的数据。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>当用 3. 按所需时间间隔的开始和结束日期进行调用 时，将只返回来自此间隔内的数据。间隔被设置并且最小单位为秒。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>因此，如果当前日期是星期六，那么在尝试复制指定时间间隔为 start_time = Last_Tuesday和stop_time=Last_Friday的周(W1)时间框架上的数据时，函数将返回0，因为周(W1)时间框架上的开盘时间总是周日，但一根星期的K线柱不属于指定的时间间隔内的数据。</p> <p>如果需要返回与当前未完成的(正在跳动的)K线柱对应的值，可以使用第一种调用形式指定start_pos = 0和count = 1。</p> <p>示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- </span>
   MqlRates rates<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token function">ArraySetAsSeries</span><span class="token punctuation">(</span>rates<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span> copied<span class="token operator">=</span><span class="token function">CopyRates</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span>rates<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>copied<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Bars copied: &quot;</span><span class="token operator">+</span>copied<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      string format<span class="token operator">=</span><span class="token string">&quot;open = %G, high = %G, low = %G, close = %G, volume = %d&quot;</span><span class="token punctuation">;</span> 
      string out<span class="token punctuation">;</span> 
      <span class="token keyword">int</span> size<span class="token operator">=</span><span class="token function">fmin</span><span class="token punctuation">(</span>copied<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i size<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         out<span class="token operator">=</span>i<span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>rates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         out<span class="token operator">=</span>out<span class="token operator">+</span><span class="token string">&quot; &quot;</span><span class="token operator">+</span><span class="token function">StringFormat</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> 
                                  rates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>open<span class="token punctuation">,</span> 
                                  rates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>high<span class="token punctuation">,</span> 
                                  rates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>low<span class="token punctuation">,</span> 
                                  rates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>close<span class="token punctuation">,</span> 
                                  rates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tick_volume<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token function">Print</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get history data for the symbol &quot;</span><span class="token punctuation">,</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>请参阅对象绑定方法一节中有关历史请求数据的详细示例。该部分提供的脚本显示了如何获取最近1000根K线柱上的指标iFractals的值以及如何显示图表上的最近的10个上下分形箭头。对于缺少数据并且通常使用以下样式绘制的所有指标都可以使用类似的技术：
• DRAW_SECTION,
• DRAW_ARROW,
• DRAW_ZIGZAG,
• DRAW_COLOR_SECTION,
• DRAW_COLOR_ARROW,
• DRAW_COLOR_ZIGZAG.</p> <p>相关参考
结构和类 ， 时间到字符串 ， 字符串格式</p> <h2 id="_16-11-copytime"><a href="#_16-11-copytime" class="header-anchor">#</a> 16.11 CopyTime</h2> <p>将指定交易品种、周期和数量的 开盘时间 数据获取到time_array数组中。复制数据的元素顺序是从现在到过去，即，从当前位置开始，0表示当前的K线柱。</p> <p><img src="/mql5yao/assets/img/thi35.7da4b09a.png" alt=""></p> <p>CopyTime</p> <p>当复制的元素数量未知时，建议使用动态数组作为目标数组，因为如果请求的数据数量小于(或大于)目标数组的长度，函数将尝试重新分配内存，以便完全适应数据请求的要求。</p> <p>如果您知道需要复制的数据量，最好对静态分配的缓冲区执行操作，以防止分配过多的内存。</p> <p>无论目标数组的属性是什么，即标帜 - as_series = true或as_series = false。数据都将被复制，因为便最旧的元素将位于为数组分配的物理内存的开始位置。此函数有3种变体。</p> <ol><li>按开始位置和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyTime</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              start_pos<span class="token punctuation">,</span>       <span class="token comment">// 开始复制元素的索引位置 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>           <span class="token comment">// 复制的数据元素数量 </span>
   datetime         time_array<span class="token punctuation">[</span><span class="token punctuation">]</span>     <span class="token comment">// 复制开盘时间的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>按开始日期和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyTime</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>      <span class="token comment">// 启动日期和时间 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>           <span class="token comment">// 复制的数据计算 </span>
   datetime         time_array<span class="token punctuation">[</span><span class="token punctuation">]</span>     <span class="token comment">// 复制开仓时间的目标数组   </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>按所需时间间隔的开始和结束日期进行调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyTime</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>      <span class="token comment">// 启动日期和时间 </span>
   datetime         stop_time<span class="token punctuation">,</span>       <span class="token comment">// 结束日期和时间 </span>
   datetime         time_array<span class="token punctuation">[</span><span class="token punctuation">]</span>     <span class="token comment">// 复制开仓时间的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数
symbol_name</p> <p>[in] 交易品种名称。</p> <p>timeframe</p> <p>[in] 时间周期(框架)。</p> <p>start_pos</p> <p>[in] 开始复制元素的索引位置。</p> <p>count</p> <p>[in] 复制的元素数量。</p> <p>start_time</p> <p>[in] K线柱的时间，对应要复制的第一个元素。</p> <p>stop_time</p> <p>[in] K线柱的时间，对应要复制的最后一个元素。</p> <p>time_array[]</p> <p>[out] 日期时间 类型的数组</p> <p>返回值
返回复制数据的数量 或 发生错误时返回 -1。</p> <p>注意
如果请求数据的整个时间间隔超出服务器上的可用数据，则函数返回 -1。如果在TERMINAL_MAXBARS(图表中最多柱数”最大图表数据量”(MT5))之外请求数据，函数也将返回 -1。</p> <p>当从指标请求数据时，如果所请求的 时间序列 尚未构建，或者需要从服务器上下载，该函数将立即返回 -1，但随后，将启动 下载/构建 过程。</p> <p>从EA交易程序 或 脚本请求数据时，如果终端在本地没有这些数据，则将启动从服务器下载数据，或者如果数据可以从本地历史数据构建，但所需的 时间序列 仍未准备好。该函数将返回在 超时 到期之前准备就绪的数据量。但是历史下载会继续，在下一个类似要求函数中会返回更多数据。</p> <p>当用 2. 按开始日期和所需元素的数量调用 时，只返回日期小于(更早) 或 等于指定日期的数据。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>当用 3. 按所需时间间隔的开始和结束日期进行调用 时，将只返回来自此间隔内的数据。间隔被设置并且最小单位为秒。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>因此，如果当前日期是星期六，那么在尝试复制指定时间间隔为 start_time = Last_Tuesday和stop_time=Last_Friday的周(W1)时间框架上的数据时，函数将返回0，因为周(W1)时间框架上的开盘时间总是周日，但一根星期的K线柱不属于指定的时间间隔内的数据。</p> <p>如果需要返回与当前未完成的(正在跳动的)K线柱对应的值，可以使用第一种调用形式指定start_pos = 0和count = 1。</p> <p>请参阅对象绑定方法一节中有关历史请求数据的详细示例。该部分提供的脚本显示了如何获取最近1000根K线柱上的指标iFractals的值以及如何显示图表上的最近的10个上下分形箭头。对于缺少数据并且通常使用以下样式绘制的所有指标都可以使用类似的技术：</p> <p>• DRAW_SECTION, • DRAW_ARROW, • DRAW_ZIGZAG, • DRAW_COLOR_SECTION, • DRAW_COLOR_ARROW, • DRAW_COLOR_ZIGZAG.</p> <h2 id="_16-12-copyopen"><a href="#_16-12-copyopen" class="header-anchor">#</a> 16.12 CopyOpen</h2> <p>将指定交易品种、周期和数量的 开盘价格 数据获取到open_array数组中。复制数据的元素顺序是从现在到过去，即，从当前位置开始，0表示当前的K线柱。</p> <p><img src="/mql5yao/assets/img/thi34.7da4b09a.png" alt=""></p> <p>CopyOpen</p> <p>当复制的元素数量未知时，建议使用动态数组作为目标数组，因为如果请求的数据数量小于(或大于)目标数组的长度，函数将尝试重新分配内存，以便完全适应数据请求的要求。</p> <p>如果您知道需要复制的数据量，最好对静态分配的缓冲区执行操作，以防止分配过多的内存。</p> <p>无论目标数组的属性是什么，即标帜 - as_series = true或as_series = false。数据都将被复制，因为便最旧的元素将位于为数组分配的物理内存的开始位置。此函数有3种变体。</p> <ol><li>按开始位置和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyOpen</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              start_pos<span class="token punctuation">,</span>       <span class="token comment">// 启动位置 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>           <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">double</span>           open_array<span class="token punctuation">[</span><span class="token punctuation">]</span>     <span class="token comment">// 复制开仓时间的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>按开始日期和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyOpen</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>      <span class="token comment">// 启动日期和时间 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>           <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">double</span>           open_array<span class="token punctuation">[</span><span class="token punctuation">]</span>     <span class="token comment">// 用于开盘柱的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>按所需时间间隔的开始和结束日期进行调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyOpen</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>      <span class="token comment">// 启动日期和时间 </span>
   datetime         stop_time<span class="token punctuation">,</span>       <span class="token comment">// 结束日期和时间 </span>
   <span class="token keyword">double</span>           open_array<span class="token punctuation">[</span><span class="token punctuation">]</span>     <span class="token comment">// 用于开盘柱的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数
symbol_name</p> <p>[in] 交易品种名称。</p> <p>timeframe</p> <p>[in] 时间周期(框架)。</p> <p>start_pos</p> <p>[in] 开始复制元素的索引位置。</p> <p>count</p> <p>[in] 复制的元素数量。</p> <p>start_time</p> <p>[in] K线柱的时间，对应要复制的第一个元素。</p> <p>stop_time</p> <p>[in] K线柱的时间，对应要复制的最后一个元素。</p> <p>open_array[]</p> <p>[out] 双精度 类型数组</p> <p>返回值
返回复制数据的数量 或 发生错误时返回 -1。</p> <p>注意
如果请求数据的整个时间间隔超出服务器上的可用数据，则函数返回 -1。如果在TERMINAL_MAXBARS(图表中最多柱数”最大图表数据量”(MT5))之外请求数据，函数也将返回 -1。</p> <p>当从指标请求数据时，如果所请求的 时间序列 尚未构建，或者需要从服务器上下载，该函数将立即返回 -1，但随后，将启动 下载/构建 过程。</p> <p>从EA交易程序 或 脚本请求数据时，如果终端在本地没有这些数据，则将启动从服务器下载数据，或者如果数据可以从本地历史数据构建，但所需的 时间序列 仍未准备好。该函数将返回在 超时 到期之前准备就绪的数据量。但是历史下载会继续，在下一个类似要求函数中会返回更多数据。</p> <p>当用 2. 按开始日期和所需元素的数量调用 时，只返回日期小于(更早) 或 等于指定日期的数据。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>当用 3. 按所需时间间隔的开始和结束日期进行调用 时，将只返回来自此间隔内的数据。间隔被设置并且最小单位为秒。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>因此，如果当前日期是星期六，那么在尝试复制指定时间间隔为 start_time = Last_Tuesday和stop_time=Last_Friday的周(W1)时间框架上的数据时，函数将返回0，因为周(W1)时间框架上的开盘时间总是周日，但一根星期的K线柱不属于指定的时间间隔内的数据。</p> <p>如果需要返回与当前未完成的(正在跳动的)K线柱对应的值，可以使用第一种调用形式指定start_pos = 0和count = 1。</p> <p>请参阅对象绑定方法一节中有关历史请求数据的详细示例。该部分提供的脚本显示了如何获取最近1000根K线柱上的指标iFractals的值以及如何显示图表上的最近的10个上下分形箭头。对于缺少数据并且通常使用以下样式绘制的所有指标都可以使用类似的技术：</p> <p>• DRAW_SECTION,<br>
• DRAW_ARROW,<br>
• DRAW_ZIGZAG,<br>
• DRAW_COLOR_SECTION,<br>
• DRAW_COLOR_ARROW,<br>
• DRAW_COLOR_ZIGZAG.</p> <h2 id="_16-13-copyhigh"><a href="#_16-13-copyhigh" class="header-anchor">#</a> 16.13 CopyHigh</h2> <p>将指定交易品种、周期和数量的 最高价 数据获取到high_array数组中。复制数据的元素顺序是从现在到过去，即，从当前位置开始，0表示当前的K线柱。</p> <p><img src="/mql5yao/assets/img/thi34.7da4b09a.png" alt=""></p> <p>当复制的元素数量未知时，建议使用动态数组作为目标数组，因为如果请求的数据数量小于(或大于)目标数组的长度，函数将尝试重新分配内存，以便完全适应数据请求的要求。</p> <p>如果您知道需要复制的数据量，最好对静态分配的缓冲区执行操作，以防止分配过多的内存。</p> <p>无论目标数组的属性是什么，即标帜 - as_series = true或as_series = false。数据都将被复制，因为便最旧的元素将位于为数组分配的物理内存的开始位置。此函数有3种变体。</p> <ol><li>按开始位置和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyHigh</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>      <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              start_pos<span class="token punctuation">,</span>        <span class="token comment">// 启动位置 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>            <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">double</span>           high_array<span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// 复制的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>按开始日期和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyHigh</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>      <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>       <span class="token comment">// 启动日期和时间 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>            <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">double</span>           high_array<span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// 复制的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>按所需时间间隔的开始和结束日期进行调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyHigh</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>      <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>       <span class="token comment">// 启动日期和时间 </span>
   datetime         stop_time<span class="token punctuation">,</span>        <span class="token comment">// 结束日期和时间 </span>
   <span class="token keyword">double</span>           high_array<span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// 复制的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数
symbol_name</p> <p>[in] 交易品种名称。</p> <p>timeframe</p> <p>[in] 时间周期(框架)。</p> <p>start_pos</p> <p>[in] 开始复制元素的索引位置。</p> <p>count</p> <p>[in] 复制的元素数量。</p> <p>start_time</p> <p>[in] K线柱的时间，对应要复制的第一个元素。</p> <p>stop_time</p> <p>[in] K线柱的时间，对应要复制的最后一个元素。</p> <p>open_array[]</p> <p>[out] 双精度 类型数组</p> <p>返回值
返回复制数据的数量 或 发生错误时返回 -1。</p> <p>注意
如果请求数据的整个时间间隔超出服务器上的可用数据，则函数返回 -1。如果在TERMINAL_MAXBARS(图表中最多柱数”最大图表数据量”(MT5))之外请求数据，函数也将返回 -1。</p> <p>当从指标请求数据时，如果所请求的 时间序列 尚未构建，或者需要从服务器上下载，该函数将立即返回 -1，但随后，将启动 下载/构建 过程。</p> <p>从EA交易程序 或 脚本请求数据时，如果终端在本地没有这些数据，则将启动从服务器下载数据，或者如果数据可以从本地历史数据构建，但所需的 时间序列 仍未准备好。该函数将返回在 超时 到期之前准备就绪的数据量。但是历史下载会继续，在下一个类似要求函数中会返回更多数据。</p> <p>当用 2. 按开始日期和所需元素的数量调用 时，只返回日期小于(更早) 或 等于指定日期的数据。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>当用 3. 按所需时间间隔的开始和结束日期进行调用 时，将只返回来自此间隔内的数据。间隔被设置并且最小单位为秒。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>因此，如果当前日期是星期六，那么在尝试复制指定时间间隔为 start_time = Last_Tuesday和stop_time=Last_Friday的周(W1)时间框架上的数据时，函数将返回0，因为周(W1)时间框架上的开盘时间总是周日，但一根星期的K线柱不属于指定的时间间隔内的数据。</p> <p>如果需要返回与当前未完成的(正在跳动的)K线柱对应的值，可以使用第一种调用形式指定start_pos = 0和count = 1。</p> <p>示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;2009, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;An example for output of the High[i] and Low[i]&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;for a random chosen bars&quot;</span> </span>
  
<span class="token keyword">double</span> High<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>Low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 为指定柱指数获得低价                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">double</span> <span class="token function">iLow</span><span class="token punctuation">(</span>string symbol<span class="token punctuation">,</span>ENUM_TIMEFRAMES timeframe<span class="token punctuation">,</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token keyword">double</span> low<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   <span class="token function">ArraySetAsSeries</span><span class="token punctuation">(</span>Low<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span> copied<span class="token operator">=</span><span class="token function">CopyLow</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>timeframe<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token function">Bars</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>timeframe<span class="token punctuation">)</span><span class="token punctuation">,</span>Low<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>copied <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> index<span class="token operator">&lt;</span>copied<span class="token punctuation">)</span> low<span class="token operator">=</span>Low<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">return</span><span class="token punctuation">(</span>low<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 为指定柱指数获得高价                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">double</span> <span class="token function">iHigh</span><span class="token punctuation">(</span>string symbol<span class="token punctuation">,</span>ENUM_TIMEFRAMES timeframe<span class="token punctuation">,</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token keyword">double</span> high<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   <span class="token function">ArraySetAsSeries</span><span class="token punctuation">(</span>High<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span> copied<span class="token operator">=</span><span class="token function">CopyHigh</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>timeframe<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token function">Bars</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>timeframe<span class="token punctuation">)</span><span class="token punctuation">,</span>High<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>copied <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> index<span class="token operator">&lt;</span>copied<span class="token punctuation">)</span> high<span class="token operator">=</span>High<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">return</span><span class="token punctuation">(</span>high<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 专家订单号函数                                                     | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 每个订单号为带有指数的柱输出高低值， </span>
<span class="token comment">//--- 等同第二订单号 </span>
   datetime t<span class="token operator">=</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span> sec<span class="token operator">=</span>t<span class="token operator">%</span><span class="token number">60</span><span class="token punctuation">;</span> 
   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;High[%d] = %G  Low[%d] = %G&quot;</span><span class="token punctuation">,</span> 
          sec<span class="token punctuation">,</span><span class="token function">iHigh</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>sec<span class="token punctuation">)</span><span class="token punctuation">,</span> 
          sec<span class="token punctuation">,</span><span class="token function">iLow</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>sec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>请参阅对象绑定方法一节中有关历史请求数据的详细示例。该部分提供的脚本显示了如何获取最近1000根K线柱上的指标iFractals的值以及如何显示图表上的最近的10个上下分形箭头。对于缺少数据并且通常使用以下样式绘制的所有指标都可以使用类似的技术：
• DRAW_SECTION,<br>
• DRAW_ARROW,<br>
• DRAW_ZIGZAG,<br>
• DRAW_COLOR_SECTION,<br>
• DRAW_COLOR_ARROW,<br>
• DRAW_COLOR_ZIGZAG.</p> <h2 id="_16-14-copylow"><a href="#_16-14-copylow" class="header-anchor">#</a> 16.14 CopyLow</h2> <p>将指定交易品种、周期和数量的 最低价 数据获取到low_array数组中。复制数据的元素顺序是从现在到过去，即，从当前位置开始，0表示当前的K线柱。</p> <p><img src="/mql5yao/assets/img/thi34.7da4b09a.png" alt=""></p> <p>当复制的元素数量未知时，建议使用动态数组作为目标数组，因为如果请求的数据数量小于(或大于)目标数组的长度，函数将尝试重新分配内存，以便完全适应数据请求的要求。</p> <p>如果您知道需要复制的数据量，最好对静态分配的缓冲区执行操作，以防止分配过多的内存。</p> <p>无论目标数组的属性是什么，即标帜 - as_series = true或as_series = false。数据都将被复制，因为便最旧的元素将位于为数组分配的物理内存的开始位置。此函数有3种变体。</p> <ol><li>按开始位置和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyLow</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              start_pos<span class="token punctuation">,</span>       <span class="token comment">// 启动位置 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>           <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">double</span>           low_array<span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// 复制的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>按开始日期和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyLow</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>      <span class="token comment">// 启动日期和时间 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>           <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">double</span>           low_array<span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// 复制的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>按所需时间间隔的开始和结束日期进行调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyLow</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>      <span class="token comment">// 启动日期和时间 </span>
   datetime         stop_time<span class="token punctuation">,</span>       <span class="token comment">// 结束日期和时间 </span>
   <span class="token keyword">double</span>           low_array<span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// 复制的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数
symbol_name</p> <p>[in] 交易品种名称。</p> <p>timeframe</p> <p>[in] 时间周期(框架)。</p> <p>start_pos</p> <p>[in] 开始复制元素的索引位置。</p> <p>count</p> <p>[in] 复制的元素数量。</p> <p>start_time</p> <p>[in] K线柱的时间，对应要复制的第一个元素。</p> <p>stop_time</p> <p>[in] K线柱的时间，对应要复制的最后一个元素。</p> <p>open_array[]</p> <p>[out] 双精度 类型数组</p> <p>返回值
返回复制数据的数量 或 发生错误时返回 -1。</p> <p>注意
如果请求数据的整个时间间隔超出服务器上的可用数据，则函数返回 -1。如果在TERMINAL_MAXBARS(图表中最多柱数”最大图表数据量”(MT5))之外请求数据，函数也将返回 -1。</p> <p>当从指标请求数据时，如果所请求的 时间序列 尚未构建，或者需要从服务器上下载，该函数将立即返回 -1，但随后，将启动 下载/构建 过程。</p> <p>从EA交易程序 或 脚本请求数据时，如果终端在本地没有这些数据，则将启动从服务器下载数据，或者如果数据可以从本地历史数据构建，但所需的 时间序列 仍未准备好。该函数将返回在 超时 到期之前准备就绪的数据量。但是历史下载会继续，在下一个类似要求函数中会返回更多数据。</p> <p>当用 2. 按开始日期和所需元素的数量调用 时，只返回日期小于(更早) 或 等于指定日期的数据。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>当用 3. 按所需时间间隔的开始和结束日期进行调用 时，将只返回来自此间隔内的数据。间隔被设置并且最小单位为秒。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>因此，如果当前日期是星期六，那么在尝试复制指定时间间隔为 start_time = Last_Tuesday和stop_time=Last_Friday的周(W1)时间框架上的数据时，函数将返回0，因为周(W1)时间框架上的开盘时间总是周日，但一根星期的K线柱不属于指定的时间间隔内的数据。</p> <p>如果需要返回与当前未完成的(正在跳动的)K线柱对应的值，可以使用第一种调用形式指定start_pos = 0和count = 1。</p> <p>请参阅对象绑定方法一节中有关历史请求数据的详细示例。该部分提供的脚本显示了如何获取最近1000根K线柱上的指标iFractals的值以及如何显示图表上的最近的10个上下分形箭头。对于缺少数据并且通常使用以下样式绘制的所有指标都可以使用类似的技术：
• DRAW_SECTION,<br>
• DRAW_ARROW,<br>
• DRAW_ZIGZAG,<br>
• DRAW_COLOR_SECTION,<br>
• DRAW_COLOR_ARROW,<br>
• DRAW_COLOR_ZIGZAG.</p> <p>相关参考
复制最高价(CopyHigh)</p> <h2 id="_16-15-copyclose"><a href="#_16-15-copyclose" class="header-anchor">#</a> 16.15 CopyClose</h2> <p>将指定交易品种、周期和数量的 收盘价格 数据获取到close_array数组中。复制数据的元素顺序是从现在到过去，即，从当前位置开始，0表示当前的K线柱。</p> <p><img src="/mql5yao/assets/img/thi34.7da4b09a.png" alt=""></p> <p>当复制的元素数量未知时，建议使用动态数组作为目标数组，因为如果请求的数据数量小于(或大于)目标数组的长度，函数将尝试重新分配内存，以便完全适应数据请求的要求。</p> <p>如果您知道需要复制的数据量，最好对静态分配的缓冲区执行操作，以防止分配过多的内存。</p> <p>无论目标数组的属性是什么，即标帜 - as_series = true或as_series = false。数据都将被复制，因为便最旧的元素将位于为数组分配的物理内存的开始位置。此函数有3种变体。</p> <ol><li>按开始位置和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyClose</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>       <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>         <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              start_pos<span class="token punctuation">,</span>         <span class="token comment">// 启动位置 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>             <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">double</span>           close_array<span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// 复制的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>按开始日期和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyClose</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>       <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>         <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>        <span class="token comment">// 启动日期和时间 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>             <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">double</span>           close_array<span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// 复制的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>按所需时间间隔的开始和结束日期进行调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyClose</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>       <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>         <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>        <span class="token comment">// 启动日期和时间 </span>
   datetime         stop_time<span class="token punctuation">,</span>         <span class="token comment">// 结束日期和时间 </span>
   <span class="token keyword">double</span>           close_array<span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// 复制的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数
symbol_name</p> <p>[in] 交易品种名称。</p> <p>timeframe</p> <p>[in] 时间周期(框架)。</p> <p>start_pos</p> <p>[in] 开始复制元素的索引位置。</p> <p>count</p> <p>[in] 复制的元素数量。</p> <p>start_time</p> <p>[in] K线柱的时间，对应要复制的第一个元素。</p> <p>stop_time</p> <p>[in] K线柱的时间，对应要复制的最后一个元素。</p> <p>open_array[]</p> <p>[out] 双精度 类型数组</p> <p>返回值
返回复制数据的数量 或 发生错误时返回 -1。</p> <p>注意
如果请求数据的整个时间间隔超出服务器上的可用数据，则函数返回 -1。如果在TERMINAL_MAXBARS(图表中最多柱数”最大图表数据量”(MT5))之外请求数据，函数也将返回 -1。</p> <p>当从指标请求数据时，如果所请求的 时间序列 尚未构建，或者需要从服务器上下载，该函数将立即返回 -1，但随后，将启动 下载/构建 过程。</p> <p>从EA交易程序 或 脚本请求数据时，如果终端在本地没有这些数据，则将启动从服务器下载数据，或者如果数据可以从本地历史数据构建，但所需的 时间序列 仍未准备好。该函数将返回在 超时 到期之前准备就绪的数据量。但是历史下载会继续，在下一个类似要求函数中会返回更多数据。</p> <p>当用 2. 按开始日期和所需元素的数量调用 时，只返回日期小于(更早) 或 等于指定日期的数据。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>当用 3. 按所需时间间隔的开始和结束日期进行调用 时，将只返回来自此间隔内的数据。间隔被设置并且最小单位为秒。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>因此，如果当前日期是星期六，那么在尝试复制指定时间间隔为 start_time = Last_Tuesday和stop_time=Last_Friday的周(W1)时间框架上的数据时，函数将返回0，因为周(W1)时间框架上的开盘时间总是周日，但一根星期的K线柱不属于指定的时间间隔内的数据。</p> <p>如果需要返回与当前未完成的(正在跳动的)K线柱对应的值，可以使用第一种调用形式指定start_pos = 0和count = 1。</p> <p>请参阅对象绑定方法一节中有关历史请求数据的详细示例。该部分提供的脚本显示了如何获取最近1000根K线柱上的指标iFractals的值以及如何显示图表上的最近的10个上下分形箭头。对于缺少数据并且通常使用以下样式绘制的所有指标都可以使用类似的技术：
• DRAW_SECTION,<br>
• DRAW_ARROW,<br>
• DRAW_ZIGZAG,<br>
• DRAW_COLOR_SECTION,<br>
• DRAW_COLOR_ARROW,<br>
• DRAW_COLOR_ZIGZAG.</p> <h2 id="_16-16-copytickvolume"><a href="#_16-16-copytickvolume" class="header-anchor">#</a> 16.16 CopyTickVolume</h2> <p>将指定交易品种、周期和数量的 报价数据 数据获取到volume_array数组中。复制数据的元素顺序是从现在到过去，即，从当前位置开始，0表示当前的K线柱。</p> <p><img src="/mql5yao/assets/img/thi34.7da4b09a.png" alt=""></p> <p>当复制的元素数量未知时，建议使用动态数组作为目标数组，因为如果请求的数据数量小于(或大于)目标数组的长度，函数将尝试重新分配内存，以便完全适应数据请求的要求。</p> <p>如果您知道需要复制的数据量，最好对静态分配的缓冲区执行操作，以防止分配过多的内存。</p> <p>无论目标数组的属性是什么，即标帜 - as_series = true或as_series = false。数据都将被复制，因为便最旧的元素将位于为数组分配的物理内存的开始位置。此函数有3种变体。</p> <ol><li>按开始位置和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyTickVolume</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>      <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              start_pos<span class="token punctuation">,</span>        <span class="token comment">// 启动位置 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>            <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">long</span>             volume_array<span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment">// 订单号交易量的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>按开始日期和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyTickVolume</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>      <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>       <span class="token comment">// 启动日期和时间 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>            <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">long</span>             volume_array<span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment">// 订单号交易量的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>按所需时间间隔的开始和结束日期进行调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyTickVolume</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>      <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>       <span class="token comment">// 开始日期和时间 </span>
   datetime         stop_time<span class="token punctuation">,</span>        <span class="token comment">// 结束日期和时间 </span>
   <span class="token keyword">long</span>             volume_array<span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment">// 订单号交易量的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数</p> <p>symbol_name</p> <p>[in] 交易品种名称。</p> <p>timeframe</p> <p>[in] 时间周期(框架)。</p> <p>start_pos</p> <p>[in] 开始复制元素的索引位置。</p> <p>count</p> <p>[in] 复制的元素数量。</p> <p>start_time</p> <p>[in] K线柱的时间，对应要复制的第一个元素。</p> <p>stop_time</p> <p>[in] K线柱的时间，对应要复制的最后一个元素。</p> <p>open_array[]</p> <p>[out] 长整型数组</p> <p>返回值
返回复制数据的数量 或 发生错误时返回 -1。</p> <p>注意</p> <p>如果请求数据的整个时间间隔超出服务器上的可用数据，则函数返回 -1。如果在TERMINAL_MAXBARS(图表中最多柱数”最大图表数据量”(MT5))之外请求数据，函数也将返回 -1。</p> <p>当从指标请求数据时，如果所请求的 时间序列 尚未构建，或者需要从服务器上下载，该函数将立即返回 -1，但随后，将启动 下载/构建 过程。</p> <p>从EA交易程序 或 脚本请求数据时，如果终端在本地没有这些数据，则将启动从服务器下载数据，或者如果数据可以从本地历史数据构建，但所需的 时间序列 仍未准备好。该函数将返回在 超时 到期之前准备就绪的数据量。但是历史下载会继续，在下一个类似要求函数中会返回更多数据。</p> <p>当用 2. 按开始日期和所需元素的数量调用 时，只返回日期小于(更早) 或 等于指定日期的数据。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>当用 3. 按所需时间间隔的开始和结束日期进行调用 时，将只返回来自此间隔内的数据。间隔被设置并且最小单位为秒。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>因此，如果当前日期是星期六，那么在尝试复制指定时间间隔为 start_time = Last_Tuesday和stop_time=Last_Friday的周(W1)时间框架上的数据时，函数将返回0，因为周(W1)时间框架上的开盘时间总是周日，但一根星期的K线柱不属于指定的时间间隔内的数据。</p> <p>如果需要返回与当前未完成的(正在跳动的)K线柱对应的值，可以使用第一种调用形式指定start_pos = 0和count = 1。
示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//---- 订单号交易量图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;TickVolume&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_HISTOGRAM </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  C</span><span class="token char">'143,188,139'</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 输入参量 </span>
input <span class="token keyword">int</span>      bars<span class="token operator">=</span><span class="token number">3000</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         TickVolumeBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 指标缓冲区绘图 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>TickVolumeBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetInteger</span><span class="token punctuation">(</span>INDICATOR_DIGITS<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标重复函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">long</span> timeseries<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token function">ArraySetAsSeries</span><span class="token punctuation">(</span>timeseries<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">int</span> prices<span class="token operator">=</span><span class="token function">CopyTickVolume</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>bars<span class="token punctuation">,</span>timeseries<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rates_total<span class="token operator">-</span>prices<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> TickVolumeBuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">;</span>  
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>prices<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> TickVolumeBuffer<span class="token punctuation">[</span>rates_total<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token operator">=</span>timeseries<span class="token punctuation">[</span>prices<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;We have received the following number of TickVolume values: &quot;</span><span class="token operator">+</span>prices<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">long</span> timeseries<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token keyword">int</span> prices<span class="token operator">=</span><span class="token function">CopyTickVolume</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>timeseries<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      TickVolumeBuffer<span class="token punctuation">[</span>rates_total<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>timeseries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
     <span class="token punctuation">}</span>   
<span class="token comment">//--- 为下次调用返回prev_calculated值 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>请参阅对象绑定方法一节中有关历史请求数据的详细示例。该部分提供的脚本显示了如何获取最近1000根K线柱上的指标iFractals的值以及如何显示图表上的最近的10个上下分形箭头。对于缺少数据并且通常使用以下样式绘制的所有指标都可以使用类似的技术：
• DRAW_SECTION,<br>
• DRAW_ARROW,<br>
• DRAW_ZIGZAG,<br>
• DRAW_COLOR_SECTION,<br>
• DRAW_COLOR_ARROW,<br>
• DRAW_COLOR_ZIGZAG.</p> <h2 id="_16-17-copyrealvolumn"><a href="#_16-17-copyrealvolumn" class="header-anchor">#</a> 16.17 CopyRealVolumn</h2> <p>将指定交易品种、周期和数量的 实际成交量 数据获取到 volume_array 数组中。复制数据的元素顺序是从现在到过去，即，从当前位置开始，0表示当前的K线柱。</p> <p><img src="/mql5yao/assets/img/thi34.7da4b09a.png" alt=""></p> <p>当复制的元素数量未知时，建议使用动态数组作为目标数组，因为如果请求的数据数量小于(或大于)目标数组的长度，函数将尝试重新分配内存，以便完全适应数据请求的要求。</p> <p>如果您知道需要复制的数据量，最好对静态分配的缓冲区执行操作，以防止分配过多的内存。</p> <p>无论目标数组的属性是什么，即标帜 - as_series = true或as_series = false。数据都将被复制，因为便最旧的元素将位于为数组分配的物理内存的开始位置。此函数有3种变体。</p> <ol><li>按开始位置和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyRealVolume</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>      <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              start_pos<span class="token punctuation">,</span>        <span class="token comment">// 启动位置 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>            <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">long</span>             volume_array<span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment">// 交易量值的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>按开始日期和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyRealVolume</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>      <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>       <span class="token comment">// 启动日期和时间 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>            <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">long</span>             volume_array<span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment">// 交易量值的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>按所需时间间隔的开始和结束日期进行调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyRealVolume</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>      <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>       <span class="token comment">// 启动日期和时间 </span>
   datetime         stop_time<span class="token punctuation">,</span>        <span class="token comment">// 结束日期和时间 </span>
   <span class="token keyword">long</span>             volume_array<span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment">// 交易量值的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数
symbol_name</p> <p>[in] 交易品种名称。</p> <p>timeframe</p> <p>[in] 时间周期(框架)。</p> <p>start_pos</p> <p>[in] 开始复制元素的索引位置。</p> <p>count</p> <p>[in] 复制的元素数量。</p> <p>start_time</p> <p>[in] K线柱的时间，对应要复制的第一个元素。</p> <p>stop_time</p> <p>[in] K线柱的时间，对应要复制的最后一个元素。</p> <p>open_array[]</p> <p>[out] 长整型数组</p> <p>返回值
返回复制数据的数量 或 发生错误时返回 -1。</p> <p>注意
如果请求数据的整个时间间隔超出服务器上的可用数据，则函数返回 -1。如果在TERMINAL_MAXBARS(图表中最多柱数”最大图表数据量”(MT5))之外请求数据，函数也将返回 -1。</p> <p>当从指标请求数据时，如果所请求的 时间序列 尚未构建，或者需要从服务器上下载，该函数将立即返回 -1，但随后，将启动 下载/构建 过程。</p> <p>从EA交易程序 或 脚本请求数据时，如果终端在本地没有这些数据，则将启动从服务器下载数据，或者如果数据可以从本地历史数据构建，但所需的 时间序列 仍未准备好。该函数将返回在 超时 到期之前准备就绪的数据量。但是历史下载会继续，在下一个类似要求函数中会返回更多数据。</p> <p>当用 2. 按开始日期和所需元素的数量调用 时，只返回日期小于(更早) 或 等于指定日期的数据。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>当用 3. 按所需时间间隔的开始和结束日期进行调用 时，将只返回来自此间隔内的数据。间隔被设置并且最小单位为秒。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>因此，如果当前日期是星期六，那么在尝试复制指定时间间隔为 start_time = Last_Tuesday和stop_time=Last_Friday的周(W1)时间框架上的数据时，函数将返回0，因为周(W1)时间框架上的开盘时间总是周日，但一根星期的K线柱不属于指定的时间间隔内的数据。</p> <p>如果需要返回与当前未完成的(正在跳动的)K线柱对应的值，可以使用第一种调用形式指定start_pos = 0和count = 1。</p> <p>请参阅对象绑定方法一节中有关历史请求数据的详细示例。该部分提供的脚本显示了如何获取最近1000根K线柱上的指标iFractals的值以及如何显示图表上的最近的10个上下分形箭头。对于缺少数据并且通常使用以下样式绘制的所有指标都可以使用类似的技术：</p> <p>• DRAW_SECTION, • DRAW_ARROW, • DRAW_ZIGZAG, • DRAW_COLOR_SECTION, • DRAW_COLOR_ARROW, • DRAW_COLOR_ZIGZAG.</p> <h2 id="_16-18-copyspread"><a href="#_16-18-copyspread" class="header-anchor">#</a> 16.18 CopySpread</h2> <p>将指定交易品种、周期和数量的 点差 数据获取到spread_array数组中。复制数据的元素顺序是从现在到过去，即，从当前位置开始，0表示当前的K线柱。
<img src="/mql5yao/assets/img/thi34.7da4b09a.png" alt=""></p> <p>当复制的元素数量未知时，建议使用动态数组作为目标数组，因为如果请求的数据数量小于(或大于)目标数组的长度，函数将尝试重新分配内存，以便完全适应数据请求的要求。</p> <p>如果您知道需要复制的数据量，最好对静态分配的缓冲区执行操作，以防止分配过多的内存。</p> <p>无论目标数组的属性是什么，即标帜 - as_series = true或as_series = false。数据都将被复制，因为便最旧的元素将位于为数组分配的物理内存的开始位置。此函数有3种变体。</p> <ol><li>按开始位置和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopySpread</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>      <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              start_pos<span class="token punctuation">,</span>        <span class="token comment">// 启动位置 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>            <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">int</span>              spread_array<span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment">// 点差值的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>按开始日期和所需元素的数量调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopySpread</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>      <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>       <span class="token comment">// 启动日期和时间 </span>
   <span class="token keyword">int</span>              count<span class="token punctuation">,</span>            <span class="token comment">// 复制的数据计算 </span>
   <span class="token keyword">int</span>              spread_array<span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment">// 点差值的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>按所需时间间隔的开始和结束日期进行调用</li></ol> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopySpread</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>      <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  timeframe<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   datetime         start_time<span class="token punctuation">,</span>       <span class="token comment">// 启动日期和时间 </span>
   datetime         stop_time<span class="token punctuation">,</span>        <span class="token comment">// 结束日期和时间 </span>
   <span class="token keyword">int</span>              spread_array<span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment">// 点差值的目标数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数
symbol_name</p> <p>[in] 交易品种名称。</p> <p>timeframe</p> <p>[in] 时间周期(框架)。</p> <p>start_pos</p> <p>[in] 开始复制元素的索引位置。</p> <p>count</p> <p>[in] 复制的元素数量。</p> <p>start_time</p> <p>[in] K线柱的时间，对应要复制的第一个元素。</p> <p>stop_time</p> <p>[in] K线柱的时间，对应要复制的最后一个元素。</p> <p>open_array[]</p> <p>[out] 整型数组</p> <p>返回值
返回复制数据的数量 或 发生错误时返回 -1。</p> <p>注意
如果请求数据的整个时间间隔超出服务器上的可用数据，则函数返回 -1。如果在TERMINAL_MAXBARS(图表中最多柱数”最大图表数据量”(MT5))之外请求数据，函数也将返回 -1。</p> <p>当从指标请求数据时，如果所请求的 时间序列 尚未构建，或者需要从服务器上下载，该函数将立即返回 -1，但随后，将启动 下载/构建 过程。</p> <p>从EA交易程序 或 脚本请求数据时，如果终端在本地没有这些数据，则将启动从服务器下载数据，或者如果数据可以从本地历史数据构建，但所需的 时间序列 仍未准备好。该函数将返回在 超时 到期之前准备就绪的数据量。但是历史下载会继续，在下一个类似要求函数中会返回更多数据。</p> <p>当用 2. 按开始日期和所需元素的数量调用 时，只返回日期小于(更早) 或 等于指定日期的数据。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>当用 3. 按所需时间间隔的开始和结束日期进行调用 时，将只返回来自此间隔内的数据。间隔被设置并且最小单位为秒。这意味着，返回值的任何K线柱的打开时间(成交量、点差、指标缓冲区的值、开盘价、最高价、最低价、收盘价以及的开/收盘时间)总是 小于 或 等于 指定的时间。</p> <p>因此，如果当前日期是星期六，那么在尝试复制指定时间间隔为 start_time = Last_Tuesday和stop_time=Last_Friday的周(W1)时间框架上的数据时，函数将返回0，因为周(W1)时间框架上的开盘时间总是周日，但一根星期的K线柱不属于指定的时间间隔内的数据。</p> <p>如果需要返回与当前未完成的(正在跳动的)K线柱对应的值，可以使用第一种调用形式指定start_pos = 0和count = 1。</p> <p>示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//---- 点差图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;Spread&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_HISTOGRAM </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 输入参量 </span>
input <span class="token keyword">int</span>      bars<span class="token operator">=</span><span class="token number">3000</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         SpreadBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 指标缓冲区绘图 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>SpreadBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetInteger</span><span class="token punctuation">(</span>INDICATOR_DIGITS<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标重复函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">int</span> spread_int<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token function">ArraySetAsSeries</span><span class="token punctuation">(</span>spread_int<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">int</span> spreads<span class="token operator">=</span><span class="token function">CopySpread</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>bars<span class="token punctuation">,</span>spread_int<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;We have received the following number of Spread values: &quot;</span><span class="token punctuation">,</span>spreads<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>spreads<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>  
      <span class="token punctuation">{</span> 
      SpreadBuffer<span class="token punctuation">[</span>rates_total<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token operator">=</span>spread_int<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;=</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;spread[&quot;</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">&quot;] = &quot;</span><span class="token punctuation">,</span>spread_int<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">double</span> Ask<span class="token punctuation">,</span>Bid<span class="token punctuation">;</span> 
      Ask<span class="token operator">=</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SYMBOL_ASK<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      Bid<span class="token operator">=</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SYMBOL_BID<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Ask = &quot;</span><span class="token punctuation">,</span>Ask<span class="token punctuation">,</span><span class="token string">&quot;  Bid = &quot;</span><span class="token punctuation">,</span>Bid<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      SpreadBuffer<span class="token punctuation">[</span>rates_total<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span>Ask<span class="token operator">-</span>Bid<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">Point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 为下次调用返回prev_calculated值 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>请参阅对象绑定方法一节中有关历史请求数据的详细示例。该部分提供的脚本显示了如何获取最近1000根K线柱上的指标iFractals的值以及如何显示图表上的最近的10个上下分形箭头。对于缺少数据并且通常使用以下样式绘制的所有指标都可以使用类似的技术：
• DRAW_SECTION,<br>
• DRAW_ARROW,<br>
• DRAW_ZIGZAG,<br>
• DRAW_COLOR_SECTION,<br>
• DRAW_COLOR_ARROW,<br>
• DRAW_COLOR_ZIGZAG.</p> <h2 id="_16-19-copyticks"><a href="#_16-19-copyticks" class="header-anchor">#</a> 16.19 CopyTicks</h2> <p>该函数以 MqlTick 格式接收每次报价数据到ticks_array。 在这种情况下，每次报价从过去一直被索引到现在，也就是说，索引编号为0的报价数据是数组中最早的报价。对于报价分析，请检查flags 字段，该字段显示了每次报价中发生了什么变化。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyTicks</span><span class="token punctuation">(</span> 
   string           symbol_name<span class="token punctuation">,</span>           <span class="token comment">// 交易品种名称 </span>
   MqlTick<span class="token operator">&amp;</span>         ticks_array<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment">// 报价接收数组 </span>
   uint             flags<span class="token operator">=</span>COPY_TICKS_ALL<span class="token punctuation">,</span>  <span class="token comment">// 决定接收报价类型的标记 </span>
   ulong            from<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token comment">// 您想请求报价的日期 </span>
   uint             count<span class="token operator">=</span><span class="token number">0</span>                <span class="token comment">// 您想接收报价的数量 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数</p> <p>symbol_name</p> <p>[in] 交易品种。</p> <p>ticks_array</p> <p>[out] 接收报价的MqlTick 类型的数组。</p> <p>flags</p> <p>[in] 用于定义所请求的报价类型的标志。 COPY_TICKS_INFO ---- Bid 和/或 Ask 价格发生变化的报价; COPY_TICKS_TRADE ---- 最新的报价和成交量变化的报价; COPY_TICKS_ALL ---- 所有报价。 对于任何类型的请求，前一个标记的值都被添加到MqlTick结构的其余字段中。</p> <p>from</p> <p>[in] 您想请求报价的开始日期。从1970.01.01开始以毫秒计算。如果from=0，将返回最近的count 报价。</p> <p>count</p> <p>[in] 请求报价的数量。如果没有指定'from' 和 'count' 参数，所有可用的现有报价（不超过2000）将被写入ticks_array[]。</p> <p>返回值</p> <p>返回复制数据的数量 或 发生错误时返回 -1。</p> <p>注意</p> <p>CopyTicks() 函数允许请求和分析所有接收的报价。第一次调用CopyTicks() 即开始同步硬盘上存储的交易品种的每次报价(tick)数据库。如果本地数据库没有提供所有请求的报价，那么缺失的报价将会自动从交易服务器下载。从CopyTicks()指定的 from 开始日期直到当前时刻的报价将会同步。在那之后，该交易品种接收到的所有报价都将被添加到报价(tick)数据库中，从而使其保持同步状态。</p> <p>如果没有指定from 和 count 参数，所有可用的现有报价(不超过2000)将被写入ticks_array[]。flags 参数允许指定所需报价的类型。</p> <p>COPY_TICKS_INFO —— 返回 Bid 和/或 Ask 发生变化的报价。其它字段的数据也将被添加。例如，如果只有卖价(Bid)改变，买价(Ask) 和 交易量(Volume) 字段将填入最近获得的值。若要找出实际变化的内容，请分析具有TICK_FLAG_BID和/或TICK_FLAG_ASK值的flags字段。如果报价中 Bid 和/或 Ask 有 零0值，那么标记会显示这些数据已经更改(flags=TICK_FLAG_BID|TICK_FLAG_ASK)，这意味着订单簿 (市场深度) 为空。换句话说，没有买入(buy)和卖出(sell)订单。</p> <p>COPY_TICKS_TRADE —— 返回最新的报价 和 交易量变化 的报价。其它字段的数据也将被添加，例如最近得到的 卖价(Bid) 和 买价(Ask) 将在适当字段指明。若要找出实际变化的内容，请分析具有TICK_FLAG_LAST 和 TICK_FLAG_VOLUME值的flags 字段。</p> <p>COPY_TICKS_ALL —— 返回任何变化的所有报价。未改变的字段将会填入最近获得的值。</p> <p>调用COPY_TICKS_ALL标记的CopyTicks() 立即返回请求间隔内的全部报价，而其它模式的调用则需要一定的时间来处理和选择报价，因此它们不提供显著的速度优势。</p> <p>请求报价时 (包含 COPY_TICKS_INFO 和/或 COPY_TICKS_TRADE)，每个报价都包括直至报价时间为止的完整的价格信息(卖价(Bid) , 买价(Ask),最新价 和 交易量)。该功能主要用于更轻松的分析每次报价时的交易状态，所以不需要请求深度历史报价和搜索其它字段的值。</p> <p>在指标中，CopyTicks() 函数返回结果：从指标调用时，CopyTick()立即返回交易品种的所有可用报价，并且如果可用数据不足时，将启动同步报价(tick)数据库。一个交易品种的所有指标都在一个公共线程中运行，因此指标不会等候同步完成。同步之后，CopyTicks() 将在下一次调用期间返回所有的请求报价。在指标中，每次报价到达后都会调用一次OnCalculate() 函数。</p> <p>在EA交易和脚本中,CopyTicks()可以等候45秒来等待处理的结果：不同于指标，每个EA交易和脚本都在独立的线程中运行，因此可以等待45秒，直到同步完成。如果所需的报价数在此期间同步失败，那么CopyTicks() 将通过timeout返回可用的报价并将继续同步。EA交易中的OnTick() 并不是每个报价处理程序，它仅通知EA交易有关市场中的变化。如果产生大量变化：程序端可以同时做出几个报价，但是OnTick() 将只能调用一次来通知EA最新市场状态。</p> <p>数据返回速度: 对于每个 金融工具(交易品种),客户端可以快速访问存储在缓存中的4,096个最新的报价(具有运行市场深度的 交易品种 有65,536个报价)。如果当前交易会话的请求报价超出了缓存，Copytick()则会调用存储在客户端内存中的报价。这些请求需要更多的执行时间。最慢的请求就是那些其他日期的请求报价，因为在这种情况下从磁盘读取数据。</p> <p>例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2016, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">script_show_inputs </span></span>
<span class="token comment">//--- Requesting 100 million ticks to be sure we receive the entire tick history </span>
input <span class="token keyword">int</span>      getticks<span class="token operator">=</span><span class="token number">100000000</span><span class="token punctuation">;</span> <span class="token comment">// The number of required ticks </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| Script program start function                                    | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//---   </span>
   <span class="token keyword">int</span>     attempts<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">// Count of attempts </span>
   <span class="token keyword">bool</span>    success<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// The flag of a successful copying of ticks </span>
   MqlTick tick_array<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// Tick receiving array </span>
   MqlTick lasttick<span class="token punctuation">;</span>       <span class="token comment">// To receive last tick data </span>
   <span class="token function">SymbolInfoTick</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>lasttick<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- Make 3 attempts to receive ticks </span>
   <span class="token keyword">while</span><span class="token punctuation">(</span>attempts<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- Measuring start time before receiving the ticks </span>
      uint start<span class="token operator">=</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- Requesting the tick history since 1970.01.01 00:00.001 (parameter from=1 ms) </span>
      <span class="token keyword">int</span> received<span class="token operator">=</span><span class="token function">CopyTicks</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>tick_array<span class="token punctuation">,</span>COPY_TICKS_ALL<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>getticks<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span>received<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token comment">//--- Showing information about the number of ticks and spent time </span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: received %d ticks in %d ms&quot;</span><span class="token punctuation">,</span>_Symbol<span class="token punctuation">,</span>received<span class="token punctuation">,</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- If the tick history is synchronized, the error code is equal to zero </span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
           <span class="token punctuation">{</span> 
            success<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span> 
           <span class="token punctuation">}</span> 
         <span class="token keyword">else</span> 
            <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Ticks are not synchronized yet, %d ticks received for %d ms. Error=%d&quot;</span><span class="token punctuation">,</span> 
            _Symbol<span class="token punctuation">,</span>received<span class="token punctuation">,</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">,</span>_LastError<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      <span class="token comment">//--- Counting attempts </span>
      attempts<span class="token operator">++</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- A one-second pause to wait for the end of synchronization of the tick database </span>
      <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- Receiving the requested ticks from the beginning of the tick history failed in three attempts </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Error! Failed to receive %d ticks of %s in three attempts&quot;</span><span class="token punctuation">,</span>getticks<span class="token punctuation">,</span>_Symbol<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">int</span> ticks<span class="token operator">=</span><span class="token function">ArraySize</span><span class="token punctuation">(</span>tick_array<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- Showing the time of the first tick in the array </span>
   datetime firstticktime<span class="token operator">=</span>tick_array<span class="token punctuation">[</span>ticks<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>time<span class="token punctuation">;</span> 
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Last tick time = %s.%03I64u&quot;</span><span class="token punctuation">,</span> 
               <span class="token function">TimeToString</span><span class="token punctuation">(</span>firstticktime<span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_MINUTES<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span>tick_array<span class="token punctuation">[</span>ticks<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>time_msc<span class="token operator">%</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- выведем время последнего тика в массиве </span>
   datetime lastticktime<span class="token operator">=</span>tick_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>time<span class="token punctuation">;</span> 
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;First tick time = %s.%03I64u&quot;</span><span class="token punctuation">,</span> 
               <span class="token function">TimeToString</span><span class="token punctuation">(</span>lastticktime<span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_MINUTES<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span>tick_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>time_msc<span class="token operator">%</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
<span class="token comment">//---                                                            </span>
   MqlDateTime today<span class="token punctuation">;</span> 
   datetime current_time<span class="token operator">=</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          
   <span class="token function">TimeToStruct</span><span class="token punctuation">(</span>current_time<span class="token punctuation">,</span>today<span class="token punctuation">)</span><span class="token punctuation">;</span>                             
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;current_time=%s&quot;</span><span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>current_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
   today<span class="token punctuation">.</span>hour<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   today<span class="token punctuation">.</span>min<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   today<span class="token punctuation">.</span>sec<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   datetime startday<span class="token operator">=</span><span class="token function">StructToTime</span><span class="token punctuation">(</span>today<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   datetime endday<span class="token operator">=</span>startday<span class="token operator">+</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ticks<span class="token operator">=</span><span class="token function">CopyTicksRange</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>tick_array<span class="token punctuation">,</span>COPY_TICKS_ALL<span class="token punctuation">,</span>startday<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">,</span>endday<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;CopyTicksRange(%s,tick_array,COPY_TICKS_ALL,%s,%s) failed, error %d&quot;</span><span class="token punctuation">,</span>        
                  _Symbol<span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>startday<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>endday<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           
      <span class="token keyword">return</span><span class="token punctuation">;</span>                                                                                   
     <span class="token punctuation">}</span> 
   ticks<span class="token operator">=</span><span class="token function">MathMax</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span>ticks<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- Showing the first 100 ticks of the last day </span>
   <span class="token keyword">int</span> counter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>ticks<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      datetime time<span class="token operator">=</span>tick_array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>time<span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>time<span class="token operator">&gt;=</span>startday<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>time<span class="token operator">&lt;</span>endday<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> counter<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         counter<span class="token operator">++</span><span class="token punctuation">;</span> 
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%d. %s&quot;</span><span class="token punctuation">,</span>counter<span class="token punctuation">,</span><span class="token function">GetTickDescription</span><span class="token punctuation">(</span>tick_array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- Showing the first 100 deals of the last day </span>
   counter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>ticks<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      datetime time<span class="token operator">=</span>tick_array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>time<span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>time<span class="token operator">&gt;=</span>startday<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>time<span class="token operator">&lt;</span>endday<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> counter<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tick_array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> TICK_FLAG_BUY<span class="token punctuation">)</span><span class="token operator">==</span>TICK_FLAG_BUY<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tick_array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> TICK_FLAG_SELL<span class="token punctuation">)</span><span class="token operator">==</span>TICK_FLAG_SELL<span class="token punctuation">)</span><span class="token punctuation">)</span> 
           <span class="token punctuation">{</span> 
            counter<span class="token operator">++</span><span class="token punctuation">;</span> 
            <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%d. %s&quot;</span><span class="token punctuation">,</span>counter<span class="token punctuation">,</span><span class="token function">GetTickDescription</span><span class="token punctuation">(</span>tick_array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
           <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| Returns the string description of a tick                         | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
string <span class="token function">GetTickDescription</span><span class="token punctuation">(</span>MqlTick <span class="token operator">&amp;</span>tick<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   string desc<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s.%03d &quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span>tick<span class="token punctuation">.</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span>tick<span class="token punctuation">.</span>time_msc<span class="token operator">%</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- Checking flags </span>
   <span class="token keyword">bool</span> buy_tick<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tick<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>tick_FLAG_BUY<span class="token punctuation">)</span><span class="token operator">==</span>TICK_FLAG_BUY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">bool</span> sell_tick<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tick<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>tick_FLAG_SELL<span class="token punctuation">)</span><span class="token operator">==</span>TICK_FLAG_SELL<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">bool</span> ask_tick<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tick<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>tick_FLAG_ASK<span class="token punctuation">)</span><span class="token operator">==</span>TICK_FLAG_ASK<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">bool</span> bid_tick<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tick<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>tick_FLAG_BID<span class="token punctuation">)</span><span class="token operator">==</span>TICK_FLAG_BID<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">bool</span> last_tick<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tick<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>tick_FLAG_LAST<span class="token punctuation">)</span><span class="token operator">==</span>TICK_FLAG_LAST<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">bool</span> volume_tick<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tick<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>tick_FLAG_VOLUME<span class="token punctuation">)</span><span class="token operator">==</span>TICK_FLAG_VOLUME<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- Checking trading flags in a tick first </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>buy_tick <span class="token operator">||</span> sell_tick<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- Forming an output for the trading tick </span>
      desc<span class="token operator">=</span>desc<span class="token operator">+</span><span class="token punctuation">(</span>buy_tick<span class="token operator">?</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Buy Tick: Last=%G Volume=%d &quot;</span><span class="token punctuation">,</span>tick<span class="token punctuation">.</span>last<span class="token punctuation">,</span>tick<span class="token punctuation">.</span>volume<span class="token punctuation">)</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      desc<span class="token operator">=</span>desc<span class="token operator">+</span><span class="token punctuation">(</span>sell_tick<span class="token operator">?</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Sell Tick: Last=%G Volume=%d &quot;</span><span class="token punctuation">,</span>tick<span class="token punctuation">.</span>last<span class="token punctuation">,</span>tick<span class="token punctuation">.</span>volume<span class="token punctuation">)</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      desc<span class="token operator">=</span>desc<span class="token operator">+</span><span class="token punctuation">(</span>ask_tick<span class="token operator">?</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Ask=%G &quot;</span><span class="token punctuation">,</span>tick<span class="token punctuation">.</span>ask<span class="token punctuation">)</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      desc<span class="token operator">=</span>desc<span class="token operator">+</span><span class="token punctuation">(</span>bid_tick<span class="token operator">?</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Bid=%G &quot;</span><span class="token punctuation">,</span>tick<span class="token punctuation">.</span>ask<span class="token punctuation">)</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      desc<span class="token operator">=</span>desc<span class="token operator">+</span><span class="token string">&quot;(Trade tick)&quot;</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- Form a different output for an info tick </span>
      desc<span class="token operator">=</span>desc<span class="token operator">+</span><span class="token punctuation">(</span>ask_tick<span class="token operator">?</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Ask=%G &quot;</span><span class="token punctuation">,</span>tick<span class="token punctuation">.</span>ask<span class="token punctuation">)</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      desc<span class="token operator">=</span>desc<span class="token operator">+</span><span class="token punctuation">(</span>bid_tick<span class="token operator">?</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Bid=%G &quot;</span><span class="token punctuation">,</span>tick<span class="token punctuation">.</span>ask<span class="token punctuation">)</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      desc<span class="token operator">=</span>desc<span class="token operator">+</span><span class="token punctuation">(</span>last_tick<span class="token operator">?</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Last=%G &quot;</span><span class="token punctuation">,</span>tick<span class="token punctuation">.</span>last<span class="token punctuation">)</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      desc<span class="token operator">=</span>desc<span class="token operator">+</span><span class="token punctuation">(</span>volume_tick<span class="token operator">?</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Volume=%d &quot;</span><span class="token punctuation">,</span>tick<span class="token punctuation">.</span>volume<span class="token punctuation">)</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      desc<span class="token operator">=</span>desc<span class="token operator">+</span><span class="token string">&quot;(Info tick)&quot;</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- Returning tick description </span>
   <span class="token keyword">return</span> desc<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">/* Example of the output 
Si-12.16: received 11048387 ticks in 4937 ms 
Last tick time = 2016.09.26 18:32:59.775  
First tick time = 2015.06.18 09:45:01.000  
1.  2016.09.26 09:45.249 Ask=65370 Bid=65370 (Info tick) 
2.  2016.09.26 09:47.420 Ask=65370 Bid=65370 (Info tick) 
3.  2016.09.26 09:50.893 Ask=65370 Bid=65370 (Info tick) 
4.  2016.09.26 09:51.827 Ask=65370 Bid=65370 (Info tick) 
5.  2016.09.26 09:53.810 Ask=65370 Bid=65370 (Info tick) 
6.  2016.09.26 09:54.491 Ask=65370 Bid=65370 (Info tick) 
7.  2016.09.26 09:55.913 Ask=65370 Bid=65370 (Info tick) 
8.  2016.09.26 09:59.350 Ask=65370 Bid=65370 (Info tick) 
9.  2016.09.26 09:59.678 Bid=65370 (Info tick) 
10. 2016.09.26 10:00.000 Sell Tick: Last=65367 Volume=3 (Trade tick) 
11. 2016.09.26 10:00.000 Sell Tick: Last=65335 Volume=45 (Trade tick) 
12. 2016.09.26 10:00.000 Sell Tick: Last=65334 Volume=95 (Trade tick) 
13. 2016.09.26 10:00.191 Sell Tick: Last=65319 Volume=1 (Trade tick) 
14. 2016.09.26 10:00.191 Sell Tick: Last=65317 Volume=1 (Trade tick) 
15. 2016.09.26 10:00.191 Sell Tick: Last=65316 Volume=1 (Trade tick) 
16. 2016.09.26 10:00.191 Sell Tick: Last=65316 Volume=10 (Trade tick) 
17. 2016.09.26 10:00.191 Sell Tick: Last=65315 Volume=5 (Trade tick) 
18. 2016.09.26 10:00.191 Sell Tick: Last=65313 Volume=3 (Trade tick) 
19. 2016.09.26 10:00.191 Sell Tick: Last=65307 Volume=25 (Trade tick) 
20. 2016.09.26 10:00.191 Sell Tick: Last=65304 Volume=1 (Trade tick) 
21. 2016.09.26 10:00.191 Sell Tick: Last=65301 Volume=1 (Trade tick) 
22. 2016.09.26 10:00.191 Sell Tick: Last=65301 Volume=10 (Trade tick) 
23. 2016.09.26 10:00.191 Sell Tick: Last=65300 Volume=5 (Trade tick) 
24. 2016.09.26 10:00.191 Sell Tick: Last=65300 Volume=1 (Trade tick) 
25. 2016.09.26 10:00.191 Sell Tick: Last=65300 Volume=6 (Trade tick) 
26. 2016.09.26 10:00.191 Sell Tick: Last=65299 Volume=1 (Trade tick) 
27. 2016.09.26 10:00.191 Bid=65370 (Info tick) 
28. 2016.09.26 10:00.232 Ask=65297 (Info tick) 
29. 2016.09.26 10:00.276 Sell Tick: Last=65291 Volume=31 (Trade tick) 
30. 2016.09.26 10:00.276 Sell Tick: Last=65290 Volume=1 (Trade tick) 
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br></div></div><p>相关参考
SymbolInfoTick，当前价格的结构，OnTick()</p> <h2 id="_16-20-copyticksrange"><a href="#_16-20-copyticksrange" class="header-anchor">#</a> 16.20 CopyTicksRange</h2> <p>该函数可以在指定日期范围内以MqlTick格式接收报价到ticks_array数组。在这种情况下，每次报价从过去一直被索引到现在，也就是说，索引编号为0的报价数据是数组中最早的报价。对于报价分析，请检查flags 字段，该字段显示了每次报价中发生了什么变化。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">CopyTicksRange</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string     symbol_name<span class="token punctuation">,</span>           <span class="token comment">//交易品种名称 </span>
   MqlTick<span class="token operator">&amp;</span>         ticks_array<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment">// 报价接收数组 </span>
   uint             flags<span class="token operator">=</span>COPY_TICKS_ALL<span class="token punctuation">,</span>  <span class="token comment">// 定义接收报价类型的标记 </span>
   ulong            from_msc<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment">// 请求报价开始的日期 </span>
   ulong            to_msc<span class="token operator">=</span><span class="token number">0</span>               <span class="token comment">// 请求报价截至日期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数
symbol_name</p> <p>[in] 交易品种。</p> <p>ticks_array</p> <p>[out] MqlTick 接收报价的静态或动态数组。如果静态数组不能保存来自请求间隔内的全部报价，则会尽可能多的接收报价量。在这种情况下，该函数生成ERR_HISTORY_SMALL_BUFFER (4407)错误。</p> <p>flags</p> <p>[in] 用于定义所请求的报价类型的标志。 COPY_TICKS_INFO ---- Bid 和/或 Ask 价格发生变化的报价; COPY_TICKS_TRADE ---- 最新的报价和成交量变化的报价; COPY_TICKS_ALL ---- 所有报价。 对于任何类型的请求，前一个标记的值都被添加到MqlTick结构的其余字段中。</p> <p>from_msc</p> <p>[in] 您想请求报价的开始日期。从1970.01.01开始以毫秒计算。如果没有指定from_msc 参数，则从历史记录中最初的报价开始。报价时间 &gt;= from_msc 已发送。</p> <p>to_msc</p> <p>[in] 您想请求报价的结束日期。从1970.01.01开始，以毫秒计算。报价时间 &lt;= to_msc 已发送。如果没有指定to_msc 参数，则发送截至到历史记录结束的报价。</p> <p>返回值
成功复制的报价数量 或 错误时返回 -1。GetLastError()可能返回以下错误：
• ERR_HISTORY_TIMEOUT —— 报价同步等待时间到达上限，函数已发送具有的全部报价。
• ERR_HISTORY_SMALL_BUFFER —— 静态缓冲区过小。只有数组可存储的数量已经发送。
• ERR_NOT_ENOUGH_MEMORY —— 接收指定范围的历史记录到动态报价数组的内存不足。无法为报价数组分配足够的内存。</p> <p>注意
CopyTicksRange()函数用于严格的从一个指定范围请求报价，例如，从历史的某一天。与此同时，CopyTicks()还可以仅指定开始日期，例如 —— 接收月初至当前时间的全部报价。</p> <p>相关参考
SymbolInfoTick，当前价格结构，OnTick，CopyTicks</p> <h2 id="_16-21-ibars"><a href="#_16-21-ibars" class="header-anchor">#</a> 16.21 iBars</h2> <p>返回可用于历史记录的相应交易品种和周期的柱形图的数量。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iBars</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string           symbol<span class="token punctuation">,</span>          <span class="token comment">// 交易品种 </span>
   ENUM_TIMEFRAMES        timeframe        <span class="token comment">// 周期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数</p> <p>交易品种</p> <p>[in] 金融工具的交易品种名称。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。0 表示当前图表周期。</p> <p>返回值</p> <p>可用于历史记录的对应交易品种和周期的柱形图的数量，最多不超过平台设置中“图表最大柱形图”可允许的参数。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Bar count on the 'EURUSD,H1' is &quot;</span><span class="token punctuation">,</span><span class="token function">iBars</span><span class="token punctuation">(</span><span class="token string">&quot;EURUSD&quot;</span><span class="token punctuation">,</span>PERIOD_H1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>另见
Bars</p> <h2 id="_16-22-ibarshift"><a href="#_16-22-ibarshift" class="header-anchor">#</a> 16.22 iBarShift</h2> <p>根据时间搜索柱形图。这个函数返回与指定时间对应的柱形图指数。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iBarShift</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string        symbol<span class="token punctuation">,</span>          <span class="token comment">// 交易品种 </span>
   ENUM_TIMEFRAMES     timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   datetime            time<span class="token punctuation">,</span>            <span class="token comment">// 时间 </span>
   <span class="token keyword">bool</span>                exact<span class="token operator">=</span><span class="token boolean">false</span>      <span class="token comment">// 模式 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数
交易品种</p> <p>[in] 金融工具的交易品种名称。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。PERIOD_CURRENT 表示当前图表周期。</p> <p>时间
[in] 要搜索的时间值。</p> <p>exact=false</p> <p>[in] 返回值，如果指定时间的柱形图没有找到。如果exact=false，iBarShift返回最近柱形图的指数，其开仓时间小于指定时间（time_open&lt;time）。如果这个柱形图没有找到（没有指定时间之前的历史记录），那么该函数返回 -1。如果exact=true，iBarShift不会搜索最近的柱形图而是立即返回 -1。</p> <p>返回值
与指定时间对应的柱形图指数。如果与指定时间对应的柱形图没有找到（历史记录中有一个空白），那么函数返回 -1或最近柱形图的指数（取决于'exact'参数）。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 脚本程序起始函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 日期为星期日 </span>
   datetime time<span class="token operator">=</span>D<span class="token char">'2002.04.25 12:00'</span><span class="token punctuation">;</span> 
   string symbol<span class="token operator">=</span><span class="token string">&quot;GBPUSD&quot;</span><span class="token punctuation">;</span> 
   ENUM_TIMEFRAMES tf<span class="token operator">=</span>PERIOD_H1<span class="token punctuation">;</span> 
   <span class="token keyword">bool</span> exact<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果在指定时间没有柱形图，那么iBarShift将返回最近柱形图的指数。 </span>
   <span class="token keyword">int</span> bar_index<span class="token operator">=</span><span class="token function">iBarShift</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>tf<span class="token punctuation">,</span>time<span class="token punctuation">,</span>exact<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 调用iBarShift()之后，检查错误代码 </span>
   <span class="token keyword">int</span> error<span class="token operator">=</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>error<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iBarShift(): GetLastError=%d - The requested date %s &quot;</span><span class="token operator">+</span> 
                  <span class="token string">&quot;for %s %s is not found in the available history&quot;</span><span class="token punctuation">,</span> 
                  error<span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span>symbol<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- iBarShift()函数被成功执行，返回结果exact=false </span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;1. %s %s %s(%s): bar index is %d (exact=%s)&quot;</span><span class="token punctuation">,</span> 
               symbol<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span> 
               <span class="token function">DayOfWeek</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span>bar_index<span class="token punctuation">,</span><span class="token function">string</span><span class="token punctuation">(</span>exact<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   datetime bar_time<span class="token operator">=</span><span class="token function">iTime</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>tf<span class="token punctuation">,</span>bar_index<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Time of bar #%d is %s (%s)&quot;</span><span class="token punctuation">,</span> 
               bar_index<span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>bar_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">DayOfWeek</span><span class="token punctuation">(</span>bar_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 请求指定时间的柱形图指数；如果没有柱形图则将返回-1 </span>
   exact<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> 
   bar_index<span class="token operator">=</span><span class="token function">iBarShift</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>tf<span class="token punctuation">,</span>time<span class="token punctuation">,</span>exact<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- iBarShift()函数被成功执行，返回结果exact=true </span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;2. %s %s %s (%s):bar index is %d (exact=%s)&quot;</span><span class="token punctuation">,</span> 
               symbol<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span> 
               <span class="token punctuation">,</span><span class="token function">DayOfWeek</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span>bar_index<span class="token punctuation">,</span><span class="token function">string</span><span class="token punctuation">(</span>exact<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 返回一周的每日名称                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
string <span class="token function">DayOfWeek</span><span class="token punctuation">(</span><span class="token keyword">const</span> datetime time<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   MqlDateTime dt<span class="token punctuation">;</span> 
   string day<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
   <span class="token function">TimeToStruct</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>dt<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">switch</span><span class="token punctuation">(</span>dt<span class="token punctuation">.</span>day_of_week<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>SUNDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>MONDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>TUESDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>WEDNESDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>THURSDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span> day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>FRIDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">default</span><span class="token operator">:</span>day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>SATURDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">return</span> day<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">/* Execution result 
   1. GBPUSD PERIOD_H1 2018.06.10 12:00(SUNDAY): bar index is 64 (exact=false) 
   Time of bar #64 is 2018.06.08 23:00 (FRIDAY) 
   2. GBPUSD PERIOD_H1 2018.06.10 12:00 (SUNDAY):bar index is -1 (exact=true) 
*/</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><h2 id="_16-23-iclose"><a href="#_16-23-iclose" class="header-anchor">#</a> 16.23 iClose</h2> <p>返回对应的图表上柱形图的收盘价（通过'shift'参数表示）。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">double</span>  <span class="token function">iClose</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string        symbol<span class="token punctuation">,</span>          <span class="token comment">// 交易品种 </span>
   ENUM_TIMEFRAMES     timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 shift            <span class="token comment">// 转移 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>交易品种</p> <p>[in] 金融工具的交易品种名称。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。0表示当前图表周期。</p> <p>shift</p> <p>[in] 来自时间序列返回值的指数（相对于当前柱形图的指定柱形图数量的向后偏移）。</p> <p>返回值</p> <p>对应的图表上柱形图的收盘价（通过'shift'参数表示）或者错误情况下为0。错误详情，请调用GetLastError()函数。</p> <p>注意</p> <p>这个函数始终返回实际数据。为此，它对每次调用期间指定交易品种/周期的时间序列执行请求。这意味着如果第一次函数调用时没有准备好的数据，则可能需要一些时间来准备结果。</p> <p>这个函数不会存储之前的调用结果，也没有快速返回值的本地缓存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>input <span class="token keyword">int</span> shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 函数-事件处理程序&quot;tick&quot;                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   datetime time  <span class="token operator">=</span> <span class="token function">iTime</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   open  <span class="token operator">=</span> <span class="token function">iOpen</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   high  <span class="token operator">=</span> <span class="token function">iHigh</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   low   <span class="token operator">=</span> <span class="token function">iLow</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   close <span class="token operator">=</span> <span class="token function">iClose</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>PERIOD_CURRENT<span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">long</span>     volume<span class="token operator">=</span> <span class="token function">iVolume</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span>      bars  <span class="token operator">=</span> <span class="token function">iBars</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Time: &quot;</span>  <span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Open: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>open<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;High: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>high<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Low: &quot;</span>   <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Close: &quot;</span> <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>close<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Volume: &quot;</span><span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Bars: &quot;</span>  <span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>bars<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span> 
           <span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>另见
CopyClose, CopyRates</p> <h2 id="_16-24-ihigh"><a href="#_16-24-ihigh" class="header-anchor">#</a> 16.24 iHigh</h2> <p>返回对应的图表上柱形图的最高价（通过'shift'参数表示）。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">double</span>  <span class="token function">iHigh</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string        symbol<span class="token punctuation">,</span>          <span class="token comment">// 交易品种 </span>
   ENUM_TIMEFRAMES     timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 shift            <span class="token comment">// 转移 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>交易品种</p> <p>[in] 金融工具的交易品种名称。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。0表示当前图表周期。</p> <p>shift</p> <p>[in] 来自时间序列返回值的指数（相对于当前柱形图的指定柱形图数量的向后偏移）。</p> <p>返回值</p> <p>对应的图表上柱形图的最高价（通过'shift'参数表示）或者错误情况下为0。错误详情，请调用GetLastError()函数。</p> <p>注意</p> <p>这个函数始终返回实际数据。为此，它对每次调用期间指定交易品种/周期的时间序列执行请求。这意味着如果第一次函数调用时没有准备好的数据，则可能需要一些时间来准备结果。</p> <p>这个函数不会存储之前的调用结果，也没有快速返回值的本地缓存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>input <span class="token keyword">int</span> shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 函数-事件处理程序&quot;tick&quot;                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   datetime time  <span class="token operator">=</span> <span class="token function">iTime</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   open  <span class="token operator">=</span> <span class="token function">iOpen</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   high  <span class="token operator">=</span> <span class="token function">iHigh</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   low   <span class="token operator">=</span> <span class="token function">iLow</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   close <span class="token operator">=</span> <span class="token function">iClose</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>PERIOD_CURRENT<span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">long</span>     volume<span class="token operator">=</span> <span class="token function">iVolume</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span>      bars  <span class="token operator">=</span> <span class="token function">iBars</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Time: &quot;</span>  <span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Open: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>open<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;High: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>high<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Low: &quot;</span>   <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Close: &quot;</span> <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>close<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Volume: &quot;</span><span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Bars: &quot;</span>  <span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>bars<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span> 
           <span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>另见
CopyHigh, CopyRates</p> <h2 id="_16-25-ihighest"><a href="#_16-25-ihighest" class="header-anchor">#</a> 16.25 iHighest</h2> <p>返回在对应图表上找到的最高值的指数（相对于当前柱形图的转移）。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iHighest</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string        symbol<span class="token punctuation">,</span>              <span class="token comment">// 交易品种 </span>
   ENUM_TIMEFRAMES     timeframe<span class="token punctuation">,</span>           <span class="token comment">// 周期 </span>
   ENUM_SERIESMODE     type<span class="token punctuation">,</span>                <span class="token comment">// 时间序列标识符 </span>
   <span class="token keyword">int</span>                 count<span class="token operator">=</span>WHOLE_ARRAY<span class="token punctuation">,</span>   <span class="token comment">// 元素数量 </span>
   <span class="token keyword">int</span>                 start<span class="token operator">=</span><span class="token number">0</span>              <span class="token comment">// 指数 </span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数</p> <p>交易品种</p> <p>[in] 将要执行搜索的交易品种。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。0表示当前图表周期。</p> <p>类型</p> <p>[in] 将要执行搜索的时间序列标识符。可以等于ENUM_SERIESMODE的任何值。</p> <p>ount=WHOLE_ARRAY</p> <p>[in] 时间序列中的元素数量（从当前柱形图向指数递增的方向），搜索应在其中执行。</p> <p>start=0</p> <p>[in] 初始柱形图的指数（相对于当前柱形图的转移），从这里开始搜索最高的值。忽略负值并用0零代替。</p> <p>返回值</p> <p>在对应图表上找到的最高值的指数（相对于当前柱形图的转移）或者错误情况下为0。错误详情，请调用GetLastError()函数。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">double</span> val<span class="token punctuation">;</span> 
<span class="token comment">//--- 在20个连续柱形图中计算最高收盘值 </span>
<span class="token comment">//--- 从指数4到指数23，在当前时间表 </span>
   <span class="token keyword">int</span> val_index<span class="token operator">=</span><span class="token function">iHighest</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>MODE_CLOSE<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>val_index<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  
      val<span class="token operator">=</span>High<span class="token punctuation">[</span>val_index<span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span>  
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iHighest() call error. Error code=%d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>参数</p> <p>交易品种</p> <p>[in] 将要执行搜索的交易品种。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。0表示当前图表周期。</p> <p>类型</p> <p>[in] 将要执行搜索的时间序列标识符。可以等于ENUM_SERIESMODE的任何值。</p> <p>count=WHOLE_ARRAY</p> <p>[in] 时间序列中的元素数量（从当前柱形图向指数递增的方向），搜索应在其中执行。</p> <p>start=0</p> <p>[in] 初始柱形图的指数（相对于当前柱形图的转移），从这里开始搜索最高的值。忽略负值并用0零代替。</p> <p>返回值</p> <p>在对应图表上找到的最高值的指数（相对于当前柱形图的转移）或者错误情况下为0。错误详情，请调用GetLastError()函数。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>   <span class="token keyword">double</span> val<span class="token punctuation">;</span> 
<span class="token comment">//--- 在20个连续柱形图中计算最高收盘值 </span>
<span class="token comment">//--- 从指数4到指数23，在当前时间表 </span>
   <span class="token keyword">int</span> val_index<span class="token operator">=</span><span class="token function">iHighest</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>MODE_CLOSE<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>val_index<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  
      val<span class="token operator">=</span>High<span class="token punctuation">[</span>val_index<span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span>  
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iHighest() call error. Error code=%d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_16-26-ilow"><a href="#_16-26-ilow" class="header-anchor">#</a> 16.26 iLow</h2> <p>返回对应的图表上柱形图的最低价（通过'shift'参数表示）。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">double</span>  <span class="token function">iLow</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string        symbol<span class="token punctuation">,</span>          <span class="token comment">// 交易品种 </span>
   ENUM_TIMEFRAMES     timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 shift            <span class="token comment">// 转移 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>交易品种</p> <p>[in] 金融工具的交易品种名称。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。0表示当前图表周期。</p> <p>shift</p> <p>[in] 来自时间序列返回值的指数（相对于当前柱形图的指定柱形图数量的向后偏移）。</p> <p>返回值</p> <p>对应的图表上柱形图的最低价（通过'shift'参数表示）或者错误情况下为0。错误详情，请调用GetLastError()函数。</p> <p>注意</p> <p>这个函数始终返回实际数据。为此，它对每次调用期间指定交易品种/周期的时间序列执行请求。这意味着如果第一次函数调用时没有准备好的数据，则可能需要一些时间来准备结果。</p> <p>这个函数不会存储之前的调用结果，也没有快速返回值的本地缓存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>input <span class="token keyword">int</span> shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 函数-事件处理程序&quot;tick&quot;                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   datetime time  <span class="token operator">=</span> <span class="token function">iTime</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   open  <span class="token operator">=</span> <span class="token function">iOpen</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   high  <span class="token operator">=</span> <span class="token function">iHigh</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   low   <span class="token operator">=</span> <span class="token function">iLow</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   close <span class="token operator">=</span> <span class="token function">iClose</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>PERIOD_CURRENT<span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">long</span>     volume<span class="token operator">=</span> <span class="token function">iVolume</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span>      bars  <span class="token operator">=</span> <span class="token function">iBars</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Time: &quot;</span>  <span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Open: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>open<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;High: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>high<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Low: &quot;</span>   <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Close: &quot;</span> <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>close<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Volume: &quot;</span><span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Bars: &quot;</span>  <span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>bars<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span> 
           <span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>另见
CopyLow, CopyRates</p> <h2 id="_16-27-ilowest"><a href="#_16-27-ilowest" class="header-anchor">#</a> 16.27 iLowest</h2> <p>返回在对应图表上找到的最小值的指数（相对于当前柱形图的转移）。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iLowest</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string        symbol<span class="token punctuation">,</span>              <span class="token comment">// 交易品种 </span>
   ENUM_TIMEFRAMES     timeframe<span class="token punctuation">,</span>           <span class="token comment">// 周期 </span>
   ENUM_SERIESMODE     type<span class="token punctuation">,</span>                <span class="token comment">// 时间序列标识符 </span>
   <span class="token keyword">int</span>                 count<span class="token operator">=</span>WHOLE_ARRAY<span class="token punctuation">,</span>   <span class="token comment">// 元素数量 </span>
   <span class="token keyword">int</span>                 start<span class="token operator">=</span><span class="token number">0</span>              <span class="token comment">// 指数 </span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数</p> <p>交易品种</p> <p>[in] 将要执行搜索的交易品种。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。0表示当前图表周期。</p> <p>类型</p> <p>[in] 将要执行搜索的时间序列标识符。可以等于ENUM_SERIESMODE的任何值。</p> <p>count=WHOLE_ARRAY</p> <p>[in] 时间序列中的元素数量（从当前柱形图向指数递增的方向），搜索应在其中执行。</p> <p>start=0</p> <p>[in] 初始柱形图的指数（相对于当前柱形图的转移），从这里开始搜索最低的值。忽略负值并用0零代替。</p> <p>返回值</p> <p>在对应图表上找到的最低值的指数（相对于当前柱形图的转移）或者错误情况下为0。错误详情，请调用GetLastError()函数。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>   <span class="token keyword">double</span> val<span class="token punctuation">;</span> 
<span class="token comment">//--- 在15个连续柱形图中搜索真实交易量的最低值的柱形图 </span>
<span class="token comment">//--- 从指数10到指数24，在当前时间表 </span>
   <span class="token keyword">int</span> val_index<span class="token operator">=</span><span class="token function">iLowest</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>MODE_REAL_VOLUME<span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>val_index<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  
      val<span class="token operator">=</span>Low<span class="token punctuation">[</span>val_index<span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span>  
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iLowest() call error. Error code=%d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_16-28-iopen"><a href="#_16-28-iopen" class="header-anchor">#</a> 16.28 iOpen</h2> <p>返回对应的图表上柱形图的开盘价（通过'shift'参数表示）。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">double</span>  <span class="token function">iOpen</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string        symbol<span class="token punctuation">,</span>          <span class="token comment">// 交易品种 </span>
   ENUM_TIMEFRAMES     timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 shift            <span class="token comment">// 转移 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>交易品种</p> <p>[in] 金融工具的交易品种名称。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。0表示当前图表周期。</p> <p>shift</p> <p>[in] 来自时间序列返回值的指数（相对于当前柱形图的指定柱形图数量的向后偏移）。</p> <p>返回值</p> <p>对应的图表上柱形图的开盘价（通过'shift'参数表示）或者错误情况下为0。错误详情，请调用GetLastError()函数。</p> <p>注意</p> <p>这个函数始终返回实际数据。为此，它对每次调用期间指定交易品种/周期的时间序列执行请求。这意味着如果第一次函数调用时没有准备好的数据，则可能需要一些时间来准备结果。</p> <p>这个函数不会存储之前的调用结果，也没有快速返回值的本地缓存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>input <span class="token keyword">int</span> shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 函数-事件处理程序&quot;tick&quot;                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   datetime time  <span class="token operator">=</span> <span class="token function">iTime</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   open  <span class="token operator">=</span> <span class="token function">iOpen</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   high  <span class="token operator">=</span> <span class="token function">iHigh</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   low   <span class="token operator">=</span> <span class="token function">iLow</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   close <span class="token operator">=</span> <span class="token function">iClose</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>PERIOD_CURRENT<span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">long</span>     volume<span class="token operator">=</span> <span class="token function">iVolume</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span>      bars  <span class="token operator">=</span> <span class="token function">iBars</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Time: &quot;</span>  <span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Open: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>open<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;High: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>high<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Low: &quot;</span>   <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Close: &quot;</span> <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>close<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Volume: &quot;</span><span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Bars: &quot;</span>  <span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>bars<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span> 
           <span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>另见
CopyOpen, CopyRates</p> <h2 id="_16-29-itime"><a href="#_16-29-itime" class="header-anchor">#</a> 16.29 iTime</h2> <p>返回对应的图表上柱形图的开盘时间（通过'shift'参数表示）。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>datetime  <span class="token function">iTime</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string        symbol<span class="token punctuation">,</span>          <span class="token comment">// 交易品种 </span>
   ENUM_TIMEFRAMES     timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 shift            <span class="token comment">// 转移 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>交易品种</p> <p>[in] 金融工具的交易品种名称。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。0表示当前图表周期。</p> <p>shift</p> <p>[in] 来自时间序列返回值的指数（相对于当前柱形图的指定柱形图数量的向后偏移）。</p> <p>返回值</p> <p>对应的图表上柱形图的开盘时间（通过'shift'参数表示）或者错误情况下为0。错误详情，请调用GetLastError()函数。</p> <p>注意</p> <p>这个函数始终返回实际数据。为此，它对每次调用期间指定交易品种/周期的时间序列执行请求。这意味着如果第一次函数调用时没有准备好的数据，则可能需要一些时间来准备结果。</p> <p>这个函数不会存储之前的调用结果，也没有快速返回值的本地缓存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 脚本程序起始函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 日期为星期日 </span>
   datetime time<span class="token operator">=</span>D<span class="token char">'2018.06.10 12:00'</span><span class="token punctuation">;</span> 
   string symbol<span class="token operator">=</span><span class="token string">&quot;GBPUSD&quot;</span><span class="token punctuation">;</span> 
   ENUM_TIMEFRAMES tf<span class="token operator">=</span>PERIOD_H1<span class="token punctuation">;</span> 
   <span class="token keyword">bool</span> exact<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在指定时间没有柱形图，那么iBarShift将返回最近柱形图的指数 </span>
   <span class="token keyword">int</span> bar_index<span class="token operator">=</span><span class="token function">iBarShift</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>tf<span class="token punctuation">,</span>time<span class="token punctuation">,</span>exact<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;1. %s %s %s(%s): bar index is %d (exact=%s)&quot;</span><span class="token punctuation">,</span> 
               symbol<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">DayOfWeek</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span>bar_index<span class="token punctuation">,</span><span class="token function">string</span><span class="token punctuation">(</span>exact<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   datetime bar_time<span class="token operator">=</span><span class="token function">iTime</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>tf<span class="token punctuation">,</span>bar_index<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Time of bar #%d is %s (%s)&quot;</span><span class="token punctuation">,</span> 
               bar_index<span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>bar_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">DayOfWeek</span><span class="token punctuation">(</span>bar_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//PrintFormat(iTime(symbol,tf,bar_index)); </span>
<span class="token comment">//--- 请求指定时间的柱形图指数；但如果没有柱形图则将返回-1 </span>
   exact<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> 
   bar_index<span class="token operator">=</span><span class="token function">iBarShift</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>tf<span class="token punctuation">,</span>time<span class="token punctuation">,</span>exact<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;2. %s %s %s (%s):bar index is %d (exact=%s)&quot;</span><span class="token punctuation">,</span> 
               symbol<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">DayOfWeek</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span>bar_index<span class="token punctuation">,</span><span class="token function">string</span><span class="token punctuation">(</span>exact<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 返回一周的每日名称                         | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
string <span class="token function">DayOfWeek</span><span class="token punctuation">(</span><span class="token keyword">const</span> datetime time<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   MqlDateTime dt<span class="token punctuation">;</span> 
   string day<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
   <span class="token function">TimeToStruct</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>dt<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">switch</span><span class="token punctuation">(</span>dt<span class="token punctuation">.</span>day_of_week<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>SUNDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>MONDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>TUESDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>WEDNESDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>THURSDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span> day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>FRIDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span>    
      <span class="token keyword">default</span><span class="token operator">:</span>day<span class="token operator">=</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>SATURDAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">return</span> day<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">/* The result: 
   1. GBPUSD PERIOD_H1 2018.06.10 12:00(SUNDAY): bar index is 64 (exact=false) 
   Time of bar #64 is 2018.06.08 23:00 (FRIDAY) 
   2. GBPUSD PERIOD_H1 2018.06.10 12:00 (SUNDAY):bar index is -1 (exact=true) 
*/</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>另见
CopyTime, CopyRates</p> <h2 id="_16-30-itickvolume"><a href="#_16-30-itickvolume" class="header-anchor">#</a> 16.30 iTickVolume</h2> <p>返回对应的图表上柱形图的报价量（通过'shift'参数表示）。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">long</span>  <span class="token function">iTickVolume</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string        symbol<span class="token punctuation">,</span>          <span class="token comment">// 交易品种 </span>
   ENUM_TIMEFRAMES     timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 shift            <span class="token comment">// 转移 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>易品种</p> <p>[in] 金融工具的交易品种名称。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。0表示当前图表周期。</p> <p>shift</p> <p>[in] 来自时间序列返回值的指数（相对于当前柱形图的指定柱形图数量的向后偏移）。</p> <p>返回值</p> <p>对应的图表上柱形图的报价量（通过'shift'参数表示）或者错误情况下为0。错误详情，请调用GetLastError()函数。</p> <p>注意</p> <p>这个函数始终返回实际数据。为此，它对每次调用期间指定交易品种/周期的时间序列执行请求。这意味着如果第一次函数调用时没有准备好的数据，则可能需要一些时间来准备结果。</p> <p>这个函数不会存储之前的调用结果，也没有快速返回值的本地缓存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>input <span class="token keyword">int</span> shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 函数-事件处理程序&quot;tick&quot;                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   datetime time  <span class="token operator">=</span> <span class="token function">iTime</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   open  <span class="token operator">=</span> <span class="token function">iOpen</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   high  <span class="token operator">=</span> <span class="token function">iHigh</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   low   <span class="token operator">=</span> <span class="token function">iLow</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   close <span class="token operator">=</span> <span class="token function">iClose</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>PERIOD_CURRENT<span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">long</span>     volume<span class="token operator">=</span> <span class="token function">iVolume</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span>      bars  <span class="token operator">=</span> <span class="token function">iBars</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Time: &quot;</span>  <span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Open: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>open<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;High: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>high<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Low: &quot;</span>   <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Close: &quot;</span> <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>close<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Volume: &quot;</span><span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Bars: &quot;</span>  <span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>bars<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span> 
           <span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>另见
CopyTickVolume, CopyRates</p> <h2 id="_16-31-irealvolume"><a href="#_16-31-irealvolume" class="header-anchor">#</a> 16.31 iRealVolume</h2> <p>返回对应的图表上柱形图的报价量（通过'shift'参数表示）。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">long</span>  <span class="token function">iVolume</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string        symbol<span class="token punctuation">,</span>          <span class="token comment">// 交易品种 </span>
   ENUM_TIMEFRAMES     timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 shift            <span class="token comment">// 转移 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>交易品种</p> <p>[in] 金融工具的交易品种名称。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。0表示当前图表周期。</p> <p>shift</p> <p>[in] 来自时间序列返回值的指数（相对于当前柱形图的指定柱形图数量的向后偏移）。</p> <p>返回值</p> <p>对应的图表上柱形图的报价量（通过'shift'参数表示）或者错误情况下为0。错误详情，请调用GetLastError()函数。</p> <p>注意</p> <p>这个函数始终返回实际数据。为此，它对每次调用期间指定交易品种/周期的时间序列执行请求。这意味着如果第一次函数调用时没有准备好的数据，则可能需要一些时间来准备结果。</p> <p>这个函数不会存储之前的调用结果，也没有快速返回值的本地缓存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>input <span class="token keyword">int</span> shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 函数-事件处理程序&quot;tick&quot;                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   datetime time  <span class="token operator">=</span> <span class="token function">iTime</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   open  <span class="token operator">=</span> <span class="token function">iOpen</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   high  <span class="token operator">=</span> <span class="token function">iHigh</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   low   <span class="token operator">=</span> <span class="token function">iLow</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   close <span class="token operator">=</span> <span class="token function">iClose</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>PERIOD_CURRENT<span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">long</span>     volume<span class="token operator">=</span> <span class="token function">iVolume</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span>      bars  <span class="token operator">=</span> <span class="token function">iBars</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Time: &quot;</span>  <span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Open: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>open<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;High: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>high<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Low: &quot;</span>   <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Close: &quot;</span> <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>close<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Volume: &quot;</span><span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Bars: &quot;</span>  <span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>bars<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span> 
           <span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>另见
CopyTickVolume, CopyRates</p> <h2 id="_16-32-ivolume"><a href="#_16-32-ivolume" class="header-anchor">#</a> 16.32 iVolume</h2> <p>返回对应的图表上柱形图的报价量（通过'shift'参数表示）。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">long</span>  <span class="token function">iVolume</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string        symbol<span class="token punctuation">,</span>          <span class="token comment">// 交易品种 </span>
   ENUM_TIMEFRAMES     timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 shift            <span class="token comment">// 转移 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>交易品种</p> <p>[in] 金融工具的交易品种名称。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。0表示当前图表周期。</p> <p>shift</p> <p>[in] 来自时间序列返回值的指数（相对于当前柱形图的指定柱形图数量的向后偏移）。</p> <p>返回值</p> <p>对应的图表上柱形图的报价量（通过'shift'参数表示）或者错误情况下为0。错误详情，请调用GetLastError()函数。</p> <p>注意</p> <p>这个函数始终返回实际数据。为此，它对每次调用期间指定交易品种/周期的时间序列执行请求。这意味着如果第一次函数调用时没有准备好的数据，则可能需要一些时间来准备结果。</p> <p>这个函数不会存储之前的调用结果，也没有快速返回值的本地缓存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>input <span class="token keyword">int</span> shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 函数-事件处理程序&quot;tick&quot;                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   datetime time  <span class="token operator">=</span> <span class="token function">iTime</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   open  <span class="token operator">=</span> <span class="token function">iOpen</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   high  <span class="token operator">=</span> <span class="token function">iHigh</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   low   <span class="token operator">=</span> <span class="token function">iLow</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   close <span class="token operator">=</span> <span class="token function">iClose</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>PERIOD_CURRENT<span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">long</span>     volume<span class="token operator">=</span> <span class="token function">iVolume</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span>      bars  <span class="token operator">=</span> <span class="token function">iBars</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Time: &quot;</span>  <span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Open: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>open<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;High: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>high<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Low: &quot;</span>   <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Close: &quot;</span> <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>close<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Volume: &quot;</span><span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Bars: &quot;</span>  <span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>bars<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span> 
           <span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>另见
CopyTickVolume, CopyRates</p> <h2 id="_16-33-ispread"><a href="#_16-33-ispread" class="header-anchor">#</a> 16.33 iSpread</h2> <p>返回对应的图表上柱形图的点差值（通过'shift'参数表示）。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">long</span>  <span class="token function">iSpread</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string        symbol<span class="token punctuation">,</span>          <span class="token comment">// 交易品种 </span>
   ENUM_TIMEFRAMES     timeframe<span class="token punctuation">,</span>       <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 shift            <span class="token comment">// 转移 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>交易品种</p> <p>[in] 金融工具的交易品种名称。NULL表示当前交易品种。</p> <p>timeframe</p> <p>[in] 周期。它可以是ENUM_TIMEFRAMES其中一个枚举值。0表示当前图表周期。</p> <p>shift</p> <p>[in] 来自时间序列返回值的指数（相对于当前柱形图的指定柱形图数量的向后偏移）。</p> <p>返回值</p> <p>对应的图表上柱形图的点差值（通过'shift'参数表示）或者错误情况下为0。错误详情，请调用GetLastError()函数。</p> <p>注意</p> <p>这个函数始终返回实际数据。为此，它对每次调用期间指定交易品种/周期的时间序列执行请求。这意味着如果第一次函数调用时没有准备好的数据，则可能需要一些时间来准备结果。</p> <p>这个函数不会存储之前的调用结果，也没有快速返回值的本地缓存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>input <span class="token keyword">int</span> shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 函数-事件处理程序&quot;tick&quot;                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   datetime time  <span class="token operator">=</span> <span class="token function">iTime</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   open  <span class="token operator">=</span> <span class="token function">iOpen</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   high  <span class="token operator">=</span> <span class="token function">iHigh</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   low   <span class="token operator">=</span> <span class="token function">iLow</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span>   close <span class="token operator">=</span> <span class="token function">iClose</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>PERIOD_CURRENT<span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">long</span>     volume<span class="token operator">=</span> <span class="token function">iVolume</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span>      bars  <span class="token operator">=</span> <span class="token function">iBars</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span><span class="token function">Period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Time: &quot;</span>  <span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Open: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>open<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;High: &quot;</span>  <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>high<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Low: &quot;</span>   <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Close: &quot;</span> <span class="token punctuation">,</span><span class="token function">DoubleToString</span><span class="token punctuation">(</span>close<span class="token punctuation">,</span><span class="token function">Digits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Volume: &quot;</span><span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> 
           <span class="token string">&quot;Bars: &quot;</span>  <span class="token punctuation">,</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>bars<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span> 
           <span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>另见
CopySpread, CopyRates</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mql5yao/Chapter/fifteen.html" class="prev">
        15 第十五章 经济日历函数
      </a></span> <span class="next"><a href="/mql5yao/Chapter/seventeen.html">
        17 第十七章 自定义交易品种
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/mql5yao/assets/js/app.33d9106b.js" defer></script><script src="/mql5yao/assets/js/3.64586e1a.js" defer></script><script src="/mql5yao/assets/js/7.b1ec5472.js" defer></script>
  </body>
</html>
