<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>智能交易*姚 文档站</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/mql5yao/favicon.ico">
    <meta name="description" content="这是智能交易的文档站点。">
    <meta name="keywords" content="MQL,EA,智能交易,自动交易,量化,编程,培训">
    
    <link rel="preload" href="/mql5yao/assets/css/0.styles.c167a2d0.css" as="style"><link rel="preload" href="/mql5yao/assets/js/app.f23448f4.js" as="script"><link rel="preload" href="/mql5yao/assets/js/3.a8269cb7.js" as="script"><link rel="preload" href="/mql5yao/assets/js/18.49626d28.js" as="script"><link rel="prefetch" href="/mql5yao/assets/js/10.a59489eb.js"><link rel="prefetch" href="/mql5yao/assets/js/11.1fde020f.js"><link rel="prefetch" href="/mql5yao/assets/js/12.a5634cbb.js"><link rel="prefetch" href="/mql5yao/assets/js/13.1e1b93d8.js"><link rel="prefetch" href="/mql5yao/assets/js/14.17d955a5.js"><link rel="prefetch" href="/mql5yao/assets/js/15.429599a3.js"><link rel="prefetch" href="/mql5yao/assets/js/16.bcf982ab.js"><link rel="prefetch" href="/mql5yao/assets/js/17.76fde0dd.js"><link rel="prefetch" href="/mql5yao/assets/js/19.0f21f003.js"><link rel="prefetch" href="/mql5yao/assets/js/2.45a03fa6.js"><link rel="prefetch" href="/mql5yao/assets/js/20.18311061.js"><link rel="prefetch" href="/mql5yao/assets/js/21.63b34e06.js"><link rel="prefetch" href="/mql5yao/assets/js/22.a49527a7.js"><link rel="prefetch" href="/mql5yao/assets/js/23.2584759c.js"><link rel="prefetch" href="/mql5yao/assets/js/24.05b32517.js"><link rel="prefetch" href="/mql5yao/assets/js/25.991ff096.js"><link rel="prefetch" href="/mql5yao/assets/js/26.07e08c10.js"><link rel="prefetch" href="/mql5yao/assets/js/27.11150f9e.js"><link rel="prefetch" href="/mql5yao/assets/js/28.b5c9f3ea.js"><link rel="prefetch" href="/mql5yao/assets/js/29.a1ad142f.js"><link rel="prefetch" href="/mql5yao/assets/js/30.6da01d3d.js"><link rel="prefetch" href="/mql5yao/assets/js/31.28fa5dac.js"><link rel="prefetch" href="/mql5yao/assets/js/32.46aab1c1.js"><link rel="prefetch" href="/mql5yao/assets/js/33.f178c7a3.js"><link rel="prefetch" href="/mql5yao/assets/js/34.cd1eae3b.js"><link rel="prefetch" href="/mql5yao/assets/js/35.ee55e50b.js"><link rel="prefetch" href="/mql5yao/assets/js/36.56370362.js"><link rel="prefetch" href="/mql5yao/assets/js/37.2cc5b283.js"><link rel="prefetch" href="/mql5yao/assets/js/38.c3bba64a.js"><link rel="prefetch" href="/mql5yao/assets/js/39.86103eac.js"><link rel="prefetch" href="/mql5yao/assets/js/4.ffd96de7.js"><link rel="prefetch" href="/mql5yao/assets/js/40.0e36f079.js"><link rel="prefetch" href="/mql5yao/assets/js/41.17bccbf6.js"><link rel="prefetch" href="/mql5yao/assets/js/42.a40ca8ac.js"><link rel="prefetch" href="/mql5yao/assets/js/43.5a883397.js"><link rel="prefetch" href="/mql5yao/assets/js/44.19bdddfe.js"><link rel="prefetch" href="/mql5yao/assets/js/45.dec8257c.js"><link rel="prefetch" href="/mql5yao/assets/js/46.ed29615c.js"><link rel="prefetch" href="/mql5yao/assets/js/47.b6d07db1.js"><link rel="prefetch" href="/mql5yao/assets/js/48.d7ca24ca.js"><link rel="prefetch" href="/mql5yao/assets/js/5.47d44717.js"><link rel="prefetch" href="/mql5yao/assets/js/6.1f5c1ae1.js"><link rel="prefetch" href="/mql5yao/assets/js/7.1a679445.js"><link rel="prefetch" href="/mql5yao/assets/js/8.e80e8a9d.js"><link rel="prefetch" href="/mql5yao/assets/js/9.261aef18.js">
    <link rel="stylesheet" href="/mql5yao/assets/css/0.styles.c167a2d0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mql5yao/" class="home-link router-link-active"><img src="/mql5yao/logo.png" alt="智能交易*姚 文档站" class="logo"> <span class="site-name can-hide">智能交易*姚 文档站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mql5yao/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mql5yao/Chapter/start.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/mql5yao/Cutleeks/" class="nav-link">
  割韭菜XX招
</a></div><div class="nav-item"><a href="/mql5yao/support/" class="nav-link">
  支持本站
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mql5yao/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mql5yao/Chapter/start.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/mql5yao/Cutleeks/" class="nav-link">
  割韭菜XX招
</a></div><div class="nav-item"><a href="/mql5yao/support/" class="nav-link">
  支持本站
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MQL5线上手册</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mql5yao/Chapter/start.html" class="sidebar-link">MQL5 参考</a></li><li><a href="/mql5yao/Chapter/one.html" class="sidebar-link">01 第一章 语言基础</a></li><li><a href="/mql5yao/Chapter/two.html" class="sidebar-link">02 第二章 标准常量，列举和架构</a></li><li><a href="/mql5yao/Chapter/three.html" class="sidebar-link">03 第三章 MQL5程序</a></li><li><a href="/mql5yao/Chapter/four.html" class="sidebar-link">04 第四章 预定义变量</a></li><li><a href="/mql5yao/Chapter/five.html" class="sidebar-link">05 第五章 普通函数</a></li><li><a href="/mql5yao/Chapter/six.html" class="sidebar-link">06 第六章 数组函数</a></li><li><a href="/mql5yao/Chapter/add1.html" class="sidebar-link">07 第add1章 矩阵和向量方法</a></li><li><a href="/mql5yao/Chapter/seven.html" class="sidebar-link">07 第七章 函数转换</a></li><li><a href="/mql5yao/Chapter/eight.html" class="sidebar-link">08 第八章 数学函数</a></li><li><a href="/mql5yao/Chapter/nine.html" class="sidebar-link">09 第九章 字符串函数</a></li><li><a href="/mql5yao/Chapter/ten.html" class="sidebar-link">10 第十章 日期和时间</a></li><li><a href="/mql5yao/Chapter/eleven.html" class="sidebar-link">11 第十一章 账户信息</a></li><li><a href="/mql5yao/Chapter/twelve.html" class="sidebar-link">12 第十二章 检测</a></li><li><a href="/mql5yao/Chapter/thirteen.html" class="sidebar-link">13 第十三章 事件处理</a></li><li><a href="/mql5yao/Chapter/fourteen.html" class="sidebar-link">14 第十四章 市场信息</a></li><li><a href="/mql5yao/Chapter/fifteen.html" class="sidebar-link">15 第十五章 经济日历函数</a></li><li><a href="/mql5yao/Chapter/sixteen.html" class="sidebar-link">16 第十六章 时间序列和指标访问</a></li><li><a href="/mql5yao/Chapter/seventeen.html" class="sidebar-link">17 第十七章 自定义交易品种</a></li><li><a href="/mql5yao/Chapter/eighteen.html" class="sidebar-link">18 第十八章 图表操作</a></li><li><a href="/mql5yao/Chapter/ninteen.html" class="sidebar-link">19 第十九章 交易函数</a></li><li><a href="/mql5yao/Chapter/twenty.html" class="sidebar-link">20 第二十章 交易信号</a></li><li><a href="/mql5yao/Chapter/twentyone.html" class="sidebar-link">21 第二十一章 网络函数</a></li><li><a href="/mql5yao/Chapter/twentytwo.html" class="sidebar-link">22 第二十二章 程序端全局变量</a></li><li><a href="/mql5yao/Chapter/twentythree.html" class="sidebar-link">23 第二十三章 文件函数</a></li><li><a href="/mql5yao/Chapter/twentyfour.html" class="sidebar-link">24 第二十四章 自定义指标</a></li><li><a href="/mql5yao/Chapter/twentyfive.html" class="sidebar-link">25 第二十五章 物件函数</a></li><li><a href="/mql5yao/Chapter/twentysix.html" aria-current="page" class="active sidebar-link">26 第二十六章 技术指标</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-1-iac" class="sidebar-link">26.1 iAC</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-2-iad" class="sidebar-link">26.2 iAD</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-3-iadx" class="sidebar-link">26.3 iADX</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-4-iadxwilder" class="sidebar-link">26.4 iADXWilder</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-5-ialligator" class="sidebar-link">26.5 iAlligator</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-6-iama" class="sidebar-link">26.6 iAMA</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-7-iao" class="sidebar-link">26.7 iAO</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-8-iatr" class="sidebar-link">26.8 iATR</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-9-ibearspower" class="sidebar-link">26.9 iBearsPower</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-10-ibands" class="sidebar-link">26.10 iBands</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-11-ibullspower" class="sidebar-link">26.11 iBullsPower</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-12-icci" class="sidebar-link">26.12 iCCI</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-13-ichaikin" class="sidebar-link">26.13 iChaikin</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-14-icustom" class="sidebar-link">26.14 iCustom</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-15-idema" class="sidebar-link">26.15 iDEMA</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-16-idemarker" class="sidebar-link">26.16 iDeMarker</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-17-ienvelopes" class="sidebar-link">26.17 iEnvelopes</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-18-iforce" class="sidebar-link">26.18 iForce</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-19-ifractals" class="sidebar-link">26.19 iFractals</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-20-iframa" class="sidebar-link">26.20 iFrAMA</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-21-igator" class="sidebar-link">26.21 iGator</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-22-iichimoku" class="sidebar-link">26.22 iIchimoku</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-23-ibwmfi" class="sidebar-link">26.23 iBWMFI</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-24-imomentum" class="sidebar-link">26.24 iMomentum</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-25-imfi" class="sidebar-link">26.25 iMFI</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-26-ima" class="sidebar-link">26.26 iMA</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-27-iosma" class="sidebar-link">26.27 iOsMA</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-28-imacd" class="sidebar-link">26.28 iMACD</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-29-iobv" class="sidebar-link">26.29 iOBV</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-30-isar" class="sidebar-link">26.30 iSAR</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-31-irsi" class="sidebar-link">26.31 iRSI</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-32-irvi" class="sidebar-link">26.32 iRVI</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-33-istddev" class="sidebar-link">26.33 iStdDev</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-34-istochastic" class="sidebar-link">26.34 iStochastic</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-35-itema" class="sidebar-link">26.35 iTEMA</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-36-itrix" class="sidebar-link">26.36 iTriX</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-37-iwpr" class="sidebar-link">26.37 iWPR</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-38-ividya" class="sidebar-link">26.38 iVIDyA</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/twentysix.html#_26-39-ivolumes" class="sidebar-link">26.39 iVolumes</a></li></ul></li><li><a href="/mql5yao/Chapter/twentyseven.html" class="sidebar-link">27 第二十七章 处理优化结果</a></li><li><a href="/mql5yao/Chapter/twentyeight.html" class="sidebar-link">28 第二十八章 工作事件</a></li><li><a href="/mql5yao/Chapter/twentynine.html" class="sidebar-link">29 第二十九章 使用OpenCL工作</a></li><li><a href="/mql5yao/Chapter/thirty.html" class="sidebar-link">30 第三十章 使用数据库</a></li><li><a href="/mql5yao/Chapter/thirtyone.html" class="sidebar-link">31 第三十一章 使用DirectX</a></li><li><a href="/mql5yao/Chapter/thirtytwo.html" class="sidebar-link">32 第三十二章 集成</a></li><li><a href="/mql5yao/Chapter/add2.html" class="sidebar-link">32 第add2章 ONNX模型</a></li><li><a href="/mql5yao/Chapter/thirtythree.html" class="sidebar-link">33 第三十三章 标准程序库</a></li><li><a href="/mql5yao/Chapter/AppendixI.html" class="sidebar-link">34 附录一 来自MQL4</a></li><li><a href="/mql5yao/Chapter/AppendixII.html" class="sidebar-link">35 附录二 MQL5 函数列表</a></li><li><a href="/mql5yao/Chapter/AppendixIII.html" class="sidebar-link">36 附录三 MQL5常量列表</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2> 第二十六章 技术指标</h2> <p>所有函数，如iMA，iAC，iMACD，iIchimoku等，在客户端的全局缓存中创建相应技术指标的副本。如果已存在具有此类参数的指标的副本，则不会创建新副本，并且对现有副本的引用计数器会增加。</p> <p>这些函数返回指标的相应副本的句柄。此外，使用此句柄，您可以接收由相应指标计算的数据。可以使用CopyBuffer()函数将相应的缓冲区数据(技术指标包含其内部缓冲区中的计算数据，可以在1到5之间变化，具体取决于指标)复制到mql5程序中。</p> <p>您无法在创建指标数据后立即参考指标数据，因为指标值的计算需要一些时间，因此最好在OnInit()中创建指标处理。函数iCustom()创建相应的自定义指标，并在成功创建时返回其句柄。自定义指标最多可包含512个指示缓冲区，其内容也可通过CopyBuffer()函数使用获取的句柄获得。</p> <p>使用IndicatorCreate() 函数创建任意技术指标是一种通用的办法，该函数以输入参数的形式接收如下数据：<br>
• 交易品种名称；<br>
• 时间框架；<br>
• 创建的指标类型；<br>
• 指标的输入参数的数量；<br>
• MqlParam类型数组包含所有必要的输入参量。<br></p> <p>使用指标句柄传递到IndicatorRelease()函数，可以删除不使用的指标以便释放计算机内存。</p> <p>注意。在一个MQL5程序中反复调用具有相同参数的指标函数不会导致参考计数器的多次增加; 计数器只会增加一次。但是，建议在函数OnInit() 或 类构造函数 中获取指标句柄，并在其他函数中进一步使用这些句柄。当MQL5程序被取消初始化时，引用计数器减少。</p> <p>所有指标函数都有至少2个参数 —— 交易品种 和 时间周期。交易品种 NULL 值代表当前交易品种，周期0值代表当前时间表。</p> <table><thead><tr><th>函数</th> <th>返回指标处理器</th></tr></thead> <tbody><tr><td>iAC</td> <td>加速震荡指标</td></tr> <tr><td>iAD</td> <td>累积/分配</td></tr> <tr><td>iADX</td> <td>平均定向指数</td></tr> <tr><td>iADXWilder</td> <td>韦尔达平均定向指数</td></tr> <tr><td>iAlligator</td> <td>鳄鱼指标</td></tr> <tr><td>iAMA</td> <td>适合的移动平均数</td></tr> <tr><td>iAO</td> <td>动量震荡指标</td></tr> <tr><td>iATR</td> <td>平均真实区域</td></tr> <tr><td>iBearsPower</td> <td>熊市</td></tr> <tr><td>iBands</td> <td>布林带</td></tr> <tr><td>iBullsPower</td> <td>牛市</td></tr> <tr><td>iCCI</td> <td>商品通道指数</td></tr> <tr><td>iChaikin</td> <td>蔡金摆动指标</td></tr> <tr><td>iCustom</td> <td>自定义指标</td></tr> <tr><td>iDEMA</td> <td>双指数移动平均线</td></tr> <tr><td>iDeMarker</td> <td>指标</td></tr> <tr><td>iEnvelopes</td> <td>轨道线指标</td></tr> <tr><td>iForce</td> <td>强力指数</td></tr> <tr><td>iFractals</td> <td>分形学</td></tr> <tr><td>iFrAMA</td> <td>分形学适合移动平均数</td></tr> <tr><td>iGator</td> <td>鳄鱼振荡器</td></tr> <tr><td>iIchimoku</td> <td>一目均衡图</td></tr> <tr><td>iBWMFI</td> <td>威廉姆斯的市场便利指标</td></tr> <tr><td>iMomentum</td> <td>动量指标</td></tr> <tr><td>iMFI</td> <td>货币流量指标</td></tr> <tr><td>iMA</td> <td>移动平均数</td></tr> <tr><td>iOsMA</td> <td>移动平均振荡指标(MACD柱状图)</td></tr> <tr><td>iMACD</td> <td>移动平均聚散指标</td></tr> <tr><td>iOBV</td> <td>平衡交易量</td></tr> <tr><td>iSAR</td> <td>抛物转向系统</td></tr> <tr><td>iRSI</td> <td>相对强弱指标</td></tr> <tr><td>iRVI</td> <td>相对活力指标</td></tr> <tr><td>iStdDev</td> <td>标准偏差</td></tr> <tr><td>iStochastic</td> <td>随机摆动指标</td></tr> <tr><td>iTEMA</td> <td>三倍指数移动平均数</td></tr> <tr><td>iTriX</td> <td>三倍指数移动平均数振荡指标</td></tr> <tr><td>iWPR</td> <td>威廉指数</td></tr> <tr><td>iVIDyA</td> <td>动态平均数便利指标</td></tr> <tr><td>iVolumes</td> <td>成交量</td></tr></tbody></table> <h2 id="_26-1-iac"><a href="#_26-1-iac" class="header-anchor">#</a> 26.1 iAC</h2> <p>此该函数在客户端的全局缓存中创建 加速振荡(Accelerator Oscillator)指标 并返回其句柄。 它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iAC</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  period      <span class="token comment">// 周期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                     Demo_iAC.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iAC technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">2</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iAC标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iAC&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_COLOR_HISTOGRAM </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrGreen<span class="token punctuation">,</span> clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iAC<span class="token punctuation">,</span>               <span class="token comment">// 使用iAC </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iAC<span class="token punctuation">;</span>          <span class="token comment">// 函数类型  </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>             <span class="token comment">// 交易品种 </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>  <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span> iACBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span> iACColors<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iAC 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在加速震荡指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iACBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>iACColors<span class="token punctuation">,</span>INDICATOR_COLOR_INDEX<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iAC<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iAC</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_AC<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iAC indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示加速震荡指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iAC(%s/%s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iAC 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iAC指标数量值更改 </span>
<span class="token comment">//---或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iACBuffer 数组大于交易品种/周期iAC 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 用来自加速震荡指标的值填充iACBuffer 和 iACColors 数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffer</span><span class="token punctuation">(</span>iACBuffer<span class="token punctuation">,</span>iACColors<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住动量震荡指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iAC 指标的指标缓冲区                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment">// 加速震荡指标值指标缓冲区 </span>
                          <span class="token keyword">double</span> <span class="token operator">&amp;</span>color_indexes<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 颜色缓冲区（用于存储颜色标引） </span>
                          <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>          <span class="token comment">// iAC 指标的处理程序 </span>
                          <span class="token keyword">int</span> amount               <span class="token comment">// 复制值的数量 </span>
                          <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分 iACBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iAC indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 现在复制颜色标引 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>color_indexes<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy color values from the iAC indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br></div></div><h2 id="_26-2-iad"><a href="#_26-2-iad" class="header-anchor">#</a> 26.2 iAD</h2> <p>该函数返回 累积/分布(Accumulation/Distribution) 指标的句柄。 它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iAD</span><span class="token punctuation">(</span> 
   string               symbol<span class="token punctuation">,</span>             <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES      period<span class="token punctuation">,</span>             <span class="token comment">// 周期 </span>
   ENUM_APPLIED_VOLUME  applied_volume      <span class="token comment">// 用于计算的交易量类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>applied_volume</p> <p>[in] 使用的交易量。取值范围是 ENUM_APPLIED_VOLUME 枚举值之一。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                     Demo_iAD.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iAD technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- 标图 iAD </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iAD&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrLightSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iAD<span class="token punctuation">,</span>               <span class="token comment">// 使用iAD </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iAD<span class="token punctuation">;</span>          <span class="token comment">// 函数类型 </span>
input ENUM_APPLIED_VOLUME  volumes<span class="token punctuation">;</span>                <span class="token comment">// 使用的交易量 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>             <span class="token comment">// 交易品种 </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>  <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iADBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储 iAD 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在离散指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iADBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iAD<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iAD</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>volumes<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>volumes<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_AD<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iAD indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示离散指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iAD(%s/%s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iAD 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iAD指标数量值更改 </span>
<span class="token comment">//---或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果 iADBuffer 数组大于交易品种/周期iAD 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 用来自离散指标的值填充iADBuffer数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iADBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住离散指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充 iAD 指标的指标缓冲区                                           | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// 离散指标线的指标缓冲区 </span>
                          <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>    <span class="token comment">// iAD指标的处理程序 </span>
                          <span class="token keyword">int</span> amount         <span class="token comment">// 复制值的数量 </span>
                          <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iADBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iAD indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>   
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br></div></div><h2 id="_26-3-iadx"><a href="#_26-3-iadx" class="header-anchor">#</a> 26.3 iADX</h2> <p>该函数返回 平均方向运动(Average Directional Movement Index)指数 指标的句柄。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iADX</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>         <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  period<span class="token punctuation">,</span>         <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              adx_period      <span class="token comment">// 平均周期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>adx_period</p> <p>[in] 周期计算指数。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>注意</p> <p>缓冲区代码如下： 0 —— MAIN_LINE， 1 —— PLUSDI_LINE， 2 —— MINUSDI_LINE。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                    Demo_iADX.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iADX technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">3</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">3</span> </span></span>
<span class="token comment">//--- 标图 ADX </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;ADX&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrLightSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 标图 DI_plus </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label2  </span><span class="token string">&quot;DI_plus&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type2   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color2  clrYellowGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style2  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width2  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 标图 DI_minus </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label3  </span><span class="token string">&quot;DI_minus&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type3   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color3  clrWheat </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style3  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width3  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iADX<span class="token punctuation">,</span>              <span class="token comment">// 使用iADX </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iADX<span class="token punctuation">;</span>         <span class="token comment">// 函数类型 </span>
input <span class="token keyword">int</span>                  adx_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>          <span class="token comment">// 计算周期 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>             <span class="token comment">// 交易品种 </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>  <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         ADXBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         DI_plusBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         DI_minusBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iADX 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在平均方向移动指数指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>ADXBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>DI_plusBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>DI_minusBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iADX<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iADX</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>adx_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>adx_period<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_ADX<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iADX indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示平均方向移动指数指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iADX(%s/%s period=%d)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span>adx_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化     </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iADX 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果 iADX 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iADXBuffer 数组大于交易品种/周期 iADX 指标的数量值，那么我们不会复制任何内容  </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以平均方向移动指数指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span>ADXBuffer<span class="token punctuation">,</span>DI_plusBuffer<span class="token punctuation">,</span>DI_minusBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住平均方向移动指数指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iADX指标的指标缓冲区                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>adx_values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token comment">// ADX 线的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>DIplus_values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// DI+指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>DIminus_values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// DI- 指标缓冲区 </span>
                           <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>            <span class="token comment">// iADXWilder 指标的处理程序 </span>
                           <span class="token keyword">int</span> amount                 <span class="token comment">// 复制值的数量 </span>
                           <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分 iADXBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>adx_values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iADX indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以1标引指标缓冲区的值填充部分 DI_plusBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>DIplus_values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iADX indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以2标引指标缓冲区的值填充部分 DI_plusBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>DIminus_values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iADX indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br></div></div><h2 id="_26-4-iadxwilder"><a href="#_26-4-iadxwilder" class="header-anchor">#</a> 26.4 iADXWilder</h2> <p>该函数返回 韦尔达平均定向移动指数(Welles Wilder)的句柄。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iADXWilder</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>         <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  period<span class="token punctuation">,</span>         <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              adx_period      <span class="token comment">// 平均周期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>adx_period</p> <p>[in] 周期计算指数。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>注意</p> <p>缓冲区代码如下： 0 - MAIN_LINE， 1 - PLUSDI_LINE， 2 - MINUSDI_LINE。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                   iADXWilder.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iADXWilder technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">3</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">3</span> </span></span>
<span class="token comment">//--- 标图 ADX </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;ADX&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrLightSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 标图 DI_plus </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label2  </span><span class="token string">&quot;DI_plus&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type2   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color2  clrYellowGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style2  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width2  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 标图 DI_minus </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label3  </span><span class="token string">&quot;DI_minus&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type3   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color3  clrWheat </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style3  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width3  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iADXWilder<span class="token punctuation">,</span>        <span class="token comment">// 使用iADXWilder </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iADXWilder<span class="token punctuation">;</span>   <span class="token comment">// 函数类型  </span>
input <span class="token keyword">int</span>                  adx_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>          <span class="token comment">// 计算周期 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>             <span class="token comment">// 交易品种 </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>  <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         ADXBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         DI_plusBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         DI_minusBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iADXWilder 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在平均方向移动指数Welles Wilder指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>ADXBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>DI_plusBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>DI_minusBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iADXWilder<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iADXWilder</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>adx_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>adx_period<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_ADXW<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iADXWilder indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示平均方向移动指数Welles Wilder指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iADXWilder(%s/%s period=%d)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span>adx_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化     </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从 iADXWilder 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果 iADXWilder 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果 iADXBuffer 数组大于交易品种/周期 iADXWilder 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以平均方向移动指数Welles Wilder指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span>ADXBuffer<span class="token punctuation">,</span>DI_plusBuffer<span class="token punctuation">,</span>DI_minusBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住平均方向移动指数指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iADXWilder 指标的指标缓冲区                                     | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>adx_values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token comment">// ADX 线的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>DIplus_values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// DI+指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>DIminus_values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// DI- 指标缓冲区 </span>
                           <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>            <span class="token comment">// iADXWilder 指标的处理程序 </span>
                           <span class="token keyword">int</span> amount                 <span class="token comment">// 复制值的数量 </span>
                           <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分 iADXBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>adx_values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iADXWilder indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以1标引指标缓冲区的值填充部分 DI_plusBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>DIplus_values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iADXWilder indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以2标引指标缓冲区的值填充部分 DI_plusBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>DIminus_values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iADXWilder indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br></div></div><h2 id="_26-5-ialligator"><a href="#_26-5-ialligator" class="header-anchor">#</a> 26.5 iAlligator</h2> <p>该函数返回 鳄鱼(Alligator)指标的句柄。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iAlligator</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 jaw_period<span class="token punctuation">,</span>        <span class="token comment">// 咽喉计算周期 </span>
   <span class="token keyword">int</span>                 jaw_shift<span class="token punctuation">,</span>         <span class="token comment">// 咽喉平移 </span>
   <span class="token keyword">int</span>                 teeth_period<span class="token punctuation">,</span>      <span class="token comment">// 牙齿计算周期 </span>
   <span class="token keyword">int</span>                 teeth_shift<span class="token punctuation">,</span>       <span class="token comment">// 牙齿平移 </span>
   <span class="token keyword">int</span>                 lips_period<span class="token punctuation">,</span>       <span class="token comment">// 唇部计算周期 </span>
   <span class="token keyword">int</span>                 lips_shift<span class="token punctuation">,</span>        <span class="token comment">// 唇部平移 </span>
   ENUM_MA_METHOD      ma_method<span class="token punctuation">,</span>         <span class="token comment">// 平滑类型 </span>
   ENUM_APPLIED_PRICE  applied_price      <span class="token comment">// 价格或者处理器类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>jaw_period</p> <p>[in] 蓝线的平均周期(鳄鱼颌骨)</p> <p>jaw_shift</p> <p>[in] 关于价格图表的蓝线平移转换。</p> <p>teeth_period</p> <p>[in] 红线的平均周期(鳄鱼牙)。</p> <p>teeth_shift</p> <p>[in] 关于价格图表的红线平移转换。</p> <p>lips_period</p> <p>[in] 绿线的平均周期 (鳄鱼唇部)。</p> <p>lips_shift</p> <p>[in] 关于价格图表的绿线平移转换。</p> <p>ma_method</p> <p>[in] 求平均值的方式，取值范围是 ENUM_MA_METHOD 枚举值之一。</p> <p>applied_price</p> <p>[in] 使用价格。取值范围是 ENUM_APPLIED_PRICE 枚举值之一 或 另外的指标句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>注意</p> <p>缓冲区代码如下： 0 - GATORJAW_LINE， 1 - GATORTEETH_LINE， 2 - GATORLIPS_LINE。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                              Demo_iAlligator.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iAlligator technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All the other parameters are similar to the standard Alligator.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_chart_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">3</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">3</span> </span></span>
<span class="token comment">//--- 标图咽喉 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;Jaws&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrBlue </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 标图牙齿 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label2  </span><span class="token string">&quot;Teeth&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type2   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color2  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style2  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width2  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 标图唇部 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label3  </span><span class="token string">&quot;Lips&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type3   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color3  clrLime </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style3  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width3  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iAlligator<span class="token punctuation">,</span>        <span class="token comment">// 使用iAlligator </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iAlligator<span class="token punctuation">;</span>   <span class="token comment">// 函数类型  </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>             <span class="token comment">// 交易品种 </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>  <span class="token comment">// 时间帧 </span>
input <span class="token keyword">int</span>                  jaw_period<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">;</span>          <span class="token comment">// 咽喉线周期 </span>
input <span class="token keyword">int</span>                  jaw_shift<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>            <span class="token comment">// 咽喉线移动 </span>
input <span class="token keyword">int</span>                  teeth_period<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>         <span class="token comment">// 牙齿线周期 </span>
input <span class="token keyword">int</span>                  teeth_shift<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>          <span class="token comment">// 牙齿线移动 </span>
input <span class="token keyword">int</span>                  lips_period<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>          <span class="token comment">// 唇部线周期 </span>
input <span class="token keyword">int</span>                  lips_shift<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>           <span class="token comment">// 唇部线移动 </span>
input ENUM_MA_METHOD       MA_method<span class="token operator">=</span>MODE_SMMA<span class="token punctuation">;</span>    <span class="token comment">// 鳄鱼平均线的方法 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_MEDIAN<span class="token punctuation">;</span><span class="token comment">// 用于计算鳄鱼的价格类型 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         JawsBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         TeethBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         LipsBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储 iAlligator 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在鳄鱼指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>JawsBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>TeethBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>LipsBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置每条线的移动 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>jaw_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>teeth_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>lips_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iAlligator<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iAlligator</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>jaw_period<span class="token punctuation">,</span>jaw_shift<span class="token punctuation">,</span>teeth_period<span class="token punctuation">,</span> 
                        teeth_shift<span class="token punctuation">,</span>lips_period<span class="token punctuation">,</span>lips_shift<span class="token punctuation">,</span>MA_method<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
     <span class="token comment">//--- 鳄鱼线的周期和移动 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>jaw_period<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>jaw_shift<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>teeth_period<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>teeth_shift<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>lips_period<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>lips_shift<span class="token punctuation">;</span> 
<span class="token comment">//--- 平滑类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>MA_method<span class="token punctuation">;</span> 
<span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
<span class="token comment">//--- 创建处理程序 </span>
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_ALLIGATOR<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iAlligator indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示鳄鱼指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iAlligator(%s/%s, %d,%d,%d,%d,%d,%d)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           jaw_period<span class="token punctuation">,</span>jaw_shift<span class="token punctuation">,</span>teeth_period<span class="token punctuation">,</span>teeth_shift<span class="token punctuation">,</span>lips_period<span class="token punctuation">,</span>lips_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化     </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从 iAlligator 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iAlligator指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果JawsBuffer 数组大于交易品种/周期 iAlligator 指标的数量值，那么我们不会复制任何内容  </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以鳄鱼指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span>JawsBuffer<span class="token punctuation">,</span>jaw_shift<span class="token punctuation">,</span>TeethBuffer<span class="token punctuation">,</span>teeth_shift<span class="token punctuation">,</span>LipsBuffer<span class="token punctuation">,</span>lips_shift<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住鳄鱼指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>   
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充 iAlligator指标的指标缓冲区                                     | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>jaws_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 咽喉线的指标缓冲区 </span>
                           <span class="token keyword">int</span> j_shift<span class="token punctuation">,</span>            <span class="token comment">// 咽喉线移动 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>teeth_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 牙齿线的指标缓冲区  </span>
                           <span class="token keyword">int</span> t_shift<span class="token punctuation">,</span>            <span class="token comment">// 牙齿线移动 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>lips_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 唇部线的指标缓冲区 </span>
                           <span class="token keyword">int</span> l_shift<span class="token punctuation">,</span>            <span class="token comment">// 唇部线移动 </span>
                           <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>         <span class="token comment">// iAlligator 指标的处理程序 </span>
                           <span class="token keyword">int</span> amount              <span class="token comment">// 复制值的数量 </span>
                           <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分JawsBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span>j_shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>jaws_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iAlligator indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以1标引指标缓冲区的值填充部分TeethBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span>t_shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>teeth_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iAlligator indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以2标引指标缓冲区的值填充部分 LipsBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">-</span>l_shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>lips_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iAlligator indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>   
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br></div></div><h2 id="_26-6-iama"><a href="#_26-6-iama" class="header-anchor">#</a> 26.6 iAMA</h2> <p>该函数返回 自适应移动平均线(Adaptive Moving Average) 指标的句柄。 它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iAMA</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>             <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>             <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 ama_period<span class="token punctuation">,</span>         <span class="token comment">//  AMA平均周期 </span>
   <span class="token keyword">int</span>                 fast_ma_period<span class="token punctuation">,</span>     <span class="token comment">// 快速 MA 周期 </span>
   <span class="token keyword">int</span>                 slow_ma_period<span class="token punctuation">,</span>     <span class="token comment">// 慢速 MA 周期 </span>
   <span class="token keyword">int</span>                 ama_shift<span class="token punctuation">,</span>          <span class="token comment">// 指标平移 </span>
   ENUM_APPLIED_PRICE  applied_price       <span class="token comment">// 价格或者处理器类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 证券交易品种名称，数据用来计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值可以是 ENUM_TIMEFRAMES 值中的一个，0代表当前时间表。</p> <p>ama_period</p> <p>[in] 计算周期，计算效率系数。</p> <p>fast_ma_period</p> <p>[in] 在快速市场为平滑系数计算快速周期。</p> <p>slow_ma_period</p> <p>[in] 在缺乏趋势时为平滑系数计算的慢周期。</p> <p>ama_shift</p> <p>[in] 转换关于价格图表的指标。</p> <p>applied_price</p> <p>[in] 使用价格。取值范围是 ENUM_APPLIED_PRICE 枚举的价格常量 或者 另外指标句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                    Demo_iAMA.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iAMA technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All the other parameters are similar to the standard AMA.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_chart_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- 标图 iAMA </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iAMA&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iAMA<span class="token punctuation">,</span>              <span class="token comment">// 使用iAMA </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iAMA<span class="token punctuation">;</span>          <span class="token comment">// 函数类型  </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>              <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>   <span class="token comment">// 时间帧 </span>
input <span class="token keyword">int</span>                  ama_period<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">;</span>           <span class="token comment">// 计算周期 </span>
input <span class="token keyword">int</span>                  fast_ma_period<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>        <span class="token comment">// 快速MA周期 </span>
input <span class="token keyword">int</span>                  slow_ma_period<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">;</span>       <span class="token comment">// 慢速MA周期 </span>
input <span class="token keyword">int</span>                  ama_shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>             <span class="token comment">// 水平移动 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token punctuation">;</span>           <span class="token comment">// 价格类型 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iAMABuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储 iAMA 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在适当移动平均指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 指标缓冲区映射 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iAMABuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置移动 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>ama_shift<span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iAMA<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iAMA</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ama_period<span class="token punctuation">,</span>fast_ma_period<span class="token punctuation">,</span>slow_ma_period<span class="token punctuation">,</span>ama_shift<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ama_period<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>fast_ma_period<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>slow_ma_period<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ama_shift<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_AMA<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iAMA indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示适当移动平均指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iAMA(%s/%s,%d,%d,%d,d)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span>ama_period<span class="token punctuation">,</span>fast_ma_period<span class="token punctuation">,</span>slow_ma_period<span class="token punctuation">,</span>ama_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化     </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iAMA 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iAMA 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果 iAMABuffer 数组大于交易品种/周期iAMA指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以适应移动平均指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iAMABuffer<span class="token punctuation">,</span>ama_shift<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住适当移动平均指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iAMA指标的指标缓冲区                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>ama_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">//AMA线的指标缓冲区 </span>
                         <span class="token keyword">int</span> a_shift<span class="token punctuation">,</span>           <span class="token comment">// AMA线移动 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>        <span class="token comment">// iAMA 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount             <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分 iAMABuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span>a_shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>ama_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iAMA indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br></div></div><h2 id="_26-7-iao"><a href="#_26-7-iao" class="header-anchor">#</a> 26.7 iAO</h2> <p>该函数返回动量震荡(Awesome Oscillator)指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iAO</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  period      <span class="token comment">// 周期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                     Demo_iAO.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iAO technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">2</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iAO 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iAO&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_COLOR_HISTOGRAM </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrGreen<span class="token punctuation">,</span>clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iAO<span class="token punctuation">,</span>               <span class="token comment">// 使用iAO </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iAO<span class="token punctuation">;</span>          <span class="token comment">// 函数类型  </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>             <span class="token comment">// 交易品种 </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>  <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iAOBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         iAOColors<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储 iAO指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在动量震荡指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iAOBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>iAOColors<span class="token punctuation">,</span>INDICATOR_COLOR_INDEX<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iAO<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iAO</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_AO<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iAO indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示动量震荡指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iAO(%s/%s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从 iAO 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果 iAO 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果 iAOBuffer数组大于交易品种/周期iAO指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 用来自动量震荡指标的值填充iAOBuffer 和 iAOColors数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffer</span><span class="token punctuation">(</span>iAOBuffer<span class="token punctuation">,</span>iAOColors<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住动量震荡指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iAO 指标的指标缓冲区                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment">//动量震荡指标值的指标缓冲区 </span>
                          <span class="token keyword">double</span> <span class="token operator">&amp;</span>color_indexes<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 颜色缓冲区（用于存储颜色标引） </span>
                          <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>          <span class="token comment">// iAO 指标的处理程序 </span>
                          <span class="token keyword">int</span> amount               <span class="token comment">// 复制值的数量 </span>
                          <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//---以0标引指标缓冲区的值填充部分iAOBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iAO indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 现在复制颜色标引 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>color_indexes<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy color values from the iAO indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br></div></div><h2 id="_26-8-iatr"><a href="#_26-8-iatr" class="header-anchor">#</a> 26.8 iATR</h2> <p>该函数返回平均真实区域(Average True Range)指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iATR</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>        <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  period<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              ma_period      <span class="token comment">// 平均周期  </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 指标计算平均周期值。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                    Demo_iATR.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iATR technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- 标图 iATR </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iATR&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrLightSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iATR<span class="token punctuation">,</span><span class="token comment">// 使用 iATR </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input <span class="token keyword">int</span>                  atr_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>          <span class="token comment">// 计算周期 </span>
input Creation             type<span class="token operator">=</span>Call_iATR<span class="token punctuation">;</span>         <span class="token comment">// 函数类型  </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>             <span class="token comment">// 交易品种 </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>  <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iATRBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iAC 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在平均真实区域指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iATRBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iATR<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iATR</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>atr_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>atr_period<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_ATR<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iATR indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示平均真实范围指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iATR(%s/%s, period=%d)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span>atr_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iATR指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果 iATR 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果 iATRBuffer 数组大于交易品种/周期iATR指标的数量值，那么我们不会复制任何内容  </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以平均真实波动范围指标的值填充 iATRBuffer 数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iATRBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住动量震荡指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iATR 指标的指标缓冲区                                           | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// ATR值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>    <span class="token comment">// iATR指标的处理程序 </span>
                         <span class="token keyword">int</span> amount         <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iATRBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iATR indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br></div></div><h2 id="_26-9-ibearspower"><a href="#_26-9-ibearspower" class="header-anchor">#</a> 26.9 iBearsPower</h2> <p>该函数返回 熊市(Bears Power )指标句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iBearsPower</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 ma_period<span class="token punctuation">,</span>         <span class="token comment">// 平均周期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 指标计算平均周期值。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                             Demo_iBearsPower.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iBearsPower technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iBearsPower 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iBearsPower&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_HISTOGRAM </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrSilver </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iBearsPower<span class="token punctuation">,</span>       <span class="token comment">// 使用iBearsPower </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iBearsPower<span class="token punctuation">;</span>  <span class="token comment">// 函数类型  </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">;</span>           <span class="token comment">// 平均移动周期 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>             <span class="token comment">// 交易品种 </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>  <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iBearsPowerBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储 iBearsPower 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在熊市指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iBearsPowerBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iBearsPower<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iBearsPower</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- ma周期       </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_BEARS<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iBearsPower indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示熊市指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iBearsPower(%s/%s, period=%d)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span>ma_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iBearsPower指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iBearsPower 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iBearsPowerBuffer数组大于交易品种/周期 iBearsPower 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以熊市指标的值填充iBearsPowerBuffer 数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iBearsPowerBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住熊市指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充 iBearsPower 指标的指标缓冲区                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 熊市值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>    <span class="token comment">// iBearsPower 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount         <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iBearsPowerBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iBearsPower indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br></div></div><h2 id="_26-10-ibands"><a href="#_26-10-ibands" class="header-anchor">#</a> 26.10 iBands</h2> <p>函数返回 布林带(Bollinger Bands®) 指标的句柄。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iBands</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 bands_period<span class="token punctuation">,</span>      <span class="token comment">// 平均线计算周期 </span>
   <span class="token keyword">int</span>                 bands_shift<span class="token punctuation">,</span>       <span class="token comment">// 指标平移 </span>
   <span class="token keyword">double</span>              deviation<span class="token punctuation">,</span>         <span class="token comment">// 标准差数 </span>
   ENUM_APPLIED_PRICE  applied_price      <span class="token comment">// 价格或处理器类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>bands_period</p> <p>[in] 指标主线的平均周期。</p> <p>bands_shift</p> <p>[in] 相关价格图表的指标转换。</p> <p>deviation</p> <p>[in] 偏离值。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>注意</p> <p>缓冲区代码如下： 0 - BASE_LINE， 1 - UPPER_BAND， 2 - LOWER_BAND。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                  Demo_iBands.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iBands technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_chart_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">3</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">3</span> </span></span>
<span class="token comment">//--- 上标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;Upper&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrMediumSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 下标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label2  </span><span class="token string">&quot;Lower&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type2   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color2  clrMediumSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style2  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width2  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 中间标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label3  </span><span class="token string">&quot;Middle&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type3   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color3  clrMediumSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style3  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width3  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iBands<span class="token punctuation">,</span>            <span class="token comment">// 使用iBands </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iBands<span class="token punctuation">;</span>          <span class="token comment">// 函数的类型  </span>
input <span class="token keyword">int</span>                  bands_period<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>           <span class="token comment">// 平均移动周期 </span>
input <span class="token keyword">int</span>                  bands_shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>             <span class="token comment">// 移动 </span>
input <span class="token keyword">double</span>               deviation<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">;</span>             <span class="token comment">//标准偏差数  </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span> <span class="token comment">// 价格类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         UpperBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         LowerBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         MiddleBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储 iBands 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在布林带指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>UpperBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>LowerBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>MiddleBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置每条线的移动 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>bands_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>bands_shift<span class="token punctuation">)</span><span class="token punctuation">;</span>       
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>bands_shift<span class="token punctuation">)</span><span class="token punctuation">;</span>       
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iBands<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iBands</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>bands_period<span class="token punctuation">,</span>bands_shift<span class="token punctuation">,</span>deviation<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- ma周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>bands_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 移动 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>bands_shift<span class="token punctuation">;</span> 
      <span class="token comment">//--- 标准偏差数 </span>
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_DOUBLE<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>double_value<span class="token operator">=</span>deviation<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_BANDS<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iBands indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示布林带指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iBands(%s/%s, %d,%d,%G,%s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           bands_period<span class="token punctuation">,</span>bands_shift<span class="token punctuation">,</span>deviation<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从 iBands 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果 iBands 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果指标缓冲区的大小大于交易品种/周期iBands 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以布林带指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span>MiddleBuffer<span class="token punctuation">,</span>UpperBuffer<span class="token punctuation">,</span>LowerBuffer<span class="token punctuation">,</span>bands_shift<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住布林带指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iBands指标的指标缓冲区                                          | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>base_values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment">// 布林带中间线的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>upper_values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">// 上边界的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>lower_values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">// 下边界的指标缓冲区 </span>
                           <span class="token keyword">int</span> shift<span class="token punctuation">,</span>                 <span class="token comment">// 移动 </span>
                           <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>            <span class="token comment">// iBands 指标的处理程序 </span>
                           <span class="token keyword">int</span> amount                 <span class="token comment">// 复制值的数量 </span>
                           <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分MiddleBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span>shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>base_values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iBands indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以1标引指标缓冲区的值填充部分UpperBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span>shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>upper_values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iBands indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以2标引指标缓冲区的值填充部分 LowerBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">-</span>shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>lower_values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iBands indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br></div></div><h2 id="_26-11-ibullspower"><a href="#_26-11-ibullspower" class="header-anchor">#</a> 26.11 iBullsPower</h2> <p>函数返回 牛市(Bulls Power )指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iBullsPower</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 ma_period<span class="token punctuation">,</span>         <span class="token comment">// 平均周期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 指标计算平均周期值。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                             Demo_iBullsPower.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iBullsPower technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iBullsPower标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iBullsPower&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_HISTOGRAM </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrSilver </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iBullsPower<span class="token punctuation">,</span>       <span class="token comment">// 使用iBullsPower </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iBullsPower<span class="token punctuation">;</span>  <span class="token comment">// 函数类型  </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">;</span>           <span class="token comment">// 平均移动周期 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>             <span class="token comment">// 交易品种 </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>  <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iBullsPowerBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储 iBullsPower指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在牛市指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iBullsPowerBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iBullsPower<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iBullsPower</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- ma周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_BULLS<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iBullsPower indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示牛市指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iBullsPower(%s/%s, period=%d)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span>ma_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从 iBullsPower 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果 iBullsPower 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iBullsPowerBuffer 数组大于交易品种/周期 iBullsPower 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以牛市指标的值填充iBullsPowerBuffer 数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iBullsPowerBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住牛市指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充 iBullsPower 指标的指标缓冲区                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 牛市值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>    <span class="token comment">// iBullsPower 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount         <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iBullsPowerBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iBullsPower indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br></div></div><h2 id="_26-12-icci"><a href="#_26-12-icci" class="header-anchor">#</a> 26.12 iCCI</h2> <p>函数返回 商品通道指数(Commodity Channel Index)指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iCCI</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 ma_period<span class="token punctuation">,</span>         <span class="token comment">// 平均周期 </span>
   ENUM_APPLIED_PRICE  applied_price      <span class="token comment">// 价格或处理器类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 指标计算平均周期值。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                    Demo_iCCI.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iCCI technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iCCI 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iCCI&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrLightSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 指标窗口的横向水平 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_level1  <span class="token operator">-</span><span class="token number">100.0</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_level2  <span class="token number">100.0</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iCCI<span class="token punctuation">,</span>              <span class="token comment">// 使用iCCI </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iCCI<span class="token punctuation">;</span>               <span class="token comment">// 函数类型 </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>                 <span class="token comment">// 平均移动周期 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_TYPICAL<span class="token punctuation">;</span>  <span class="token comment">// 价格类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                   <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>        <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iCCIBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储 iCCI 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在商品通道指数指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iCCIBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iCCI<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iCCI</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 平均移动周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_CCI<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iCCI indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示布林带® 指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iCCI(%s/%s, %d, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           ma_period<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iCCI 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果 iCCI指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果 iCCIBuffer 数组大于交易品种/周期 iCCI 指标的数量值，那么我们不会复制任何内容  </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以商品通道指数指标的值填充iCCIBuffer数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iCCIBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住商品通道指数指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iCCI指标的指标缓冲区                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 商品通道指数值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>    <span class="token comment">// iCCI 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount         <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iCCIBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iCCI indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br></div></div><h2 id="_26-13-ichaikin"><a href="#_26-13-ichaikin" class="header-anchor">#</a> 26.13 iChaikin</h2> <p>函数返回蔡金摆动指标的处理句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iChaikin</span><span class="token punctuation">(</span> 
   string               symbol<span class="token punctuation">,</span>             <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES      period<span class="token punctuation">,</span>             <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                  fast_ma_period<span class="token punctuation">,</span>     <span class="token comment">// 快速周期 </span>
   <span class="token keyword">int</span>                  slow_ma_period<span class="token punctuation">,</span>     <span class="token comment">// 慢速周期 </span>
   ENUM_MA_METHOD       ma_method<span class="token punctuation">,</span>          <span class="token comment">// 平滑类型 </span>
   ENUM_APPLIED_VOLUME  applied_volume      <span class="token comment">// 交易量类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>fast_ma_period</p> <p>[in] 计算快速平均周期。</p> <p>slow_ma_period</p> <p>[in] 计算慢速平均周期。</p> <p>ma_method</p> <p>[in] 平滑类型。取值范围是 ENUM_MA_METHOD枚举的平均常量之一。</p> <p>applied_volume</p> <p>[in] 使用的交易量。取值范围是 ENUM_APPLIED_VOLUME 枚举常量之一。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                Demo_iChaikin.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iChaikin technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iChaikin标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iChaikin&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrLightSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iChaikin<span class="token punctuation">,</span>          <span class="token comment">// 使用iChaikin </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iChaikin<span class="token punctuation">;</span>           <span class="token comment">// 函数类型  </span>
input <span class="token keyword">int</span>                  fast_ma_period<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>             <span class="token comment">// 快速ma周期 </span>
input <span class="token keyword">int</span>                  slow_ma_period<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>            <span class="token comment">// 慢速ma周期 </span>
input ENUM_MA_METHOD       ma_method<span class="token operator">=</span>MODE_EMA<span class="token punctuation">;</span>           <span class="token comment">// 平滑类型 </span>
input ENUM_APPLIED_VOLUME  applied_volume<span class="token operator">=</span>VOLUME_TICK<span class="token punctuation">;</span>   <span class="token comment">// 交易量类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                   <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>        <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iChaikinBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储 iChaikin 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在蔡金摆动指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iChaikinBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iChaikin<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iChaikin</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>fast_ma_period<span class="token punctuation">,</span>slow_ma_period<span class="token punctuation">,</span>ma_method<span class="token punctuation">,</span>applied_volume<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 快速ma周期  </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>fast_ma_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 慢速ma周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>slow_ma_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 平滑类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_method<span class="token punctuation">;</span> 
      <span class="token comment">//--- 交易量类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_volume<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_CHAIKIN<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iChaikin indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示蔡金摆动指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iChaikin(%s/%s, %d, %d, %s, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           fast_ma_period<span class="token punctuation">,</span>slow_ma_period<span class="token punctuation">,</span> 
                           <span class="token function">EnumToString</span><span class="token punctuation">(</span>ma_method<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_volume<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从 iChaikin 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iChaikin 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果 iChaikinBuffer 数组大于交易品种/周期iChaikin 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以蔡金摆动指标的值填充iChaikinBuffer数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iChaikinBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住蔡金摆动指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充 iChaikin 指标的指标缓冲区                                      | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 蔡金摆动指标值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>    <span class="token comment">// iChaikin 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount         <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//---以0标引指标缓冲区的值填充部分iChaikinBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iChaikin indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br></div></div><h2 id="_26-14-icustom"><a href="#_26-14-icustom" class="header-anchor">#</a> 26.14 iCustom</h2> <p>函数返回指定 自定义指标 的句柄。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iCustom</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  period<span class="token punctuation">,</span>     <span class="token comment">// 周期 </span>
   string           name        <span class="token comment">// 文件夹/自定义指标_名称 </span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                          <span class="token comment">// 指标输入参量列表 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>name</p> <p>[in] 自定义指标的名称，其路径相对于指标的根目录(MQL5 / Indicators /)。如果指标位于子目录中，例如，在MQL5 / Indicators / Examples中，其名称必须指定为：“Examples \ indicator_name”(必须使用 双斜杠 而不是 单斜杠 作为分隔符)。</p> <p>...</p> <p>[in] 自定义指标的 输入参数 列表，用 逗号 分开，类型和参数命令必须匹配，如果没有指定参数，则使用默认值。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>注意</p> <p>自定义指标 必须是已编译的(扩展名为EX5) 并且 位于客户端 或 其子目录的MQL5 / Indicators目录中。</p> <p>如果通过常量字符串设置相应的参数，则需要通过调用iCustom()函数自动定义需要测试的指标。对于所有其它情况(使用IndicatorCreate()函数 或 在设置指标名称的参数中使用非常量字符串)，属性  #property tester_indicator是必需的：</p> <p><code>#property tester_indicator &quot;indicator_name.ex5&quot;</code></p> <p>如果在指标中使用了第一个调用表单，则在自定义指示器启动时，您还可以在其“参数”选项卡中指示要计算的数据。如果未明确选择“应用于”参数，则默认计算基于“收盘价”的值。</p> <p><img src="/mql5yao/assets/img/e28.a20ff036.png" alt="基于“收盘价”"></p> <p>当从MQL5程序中调用自定义指标时，”应用于”(Applied_Price)参数 或者 另外的指标句柄应该最后传递，在所有自定义指标的输入变量之后。</p> <p>相关参考</p> <p>程序属性, 时间序列和指标访问, IndicatorCreate(), IndicatorRelease()</p> <p>示例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//---- 标签图1 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;Label1&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 输入参量 </span>
input <span class="token keyword">int</span> MA_Period<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">;</span> 
input <span class="token keyword">int</span> MA_Shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
input ENUM_MA_METHOD MA_Method<span class="token operator">=</span>MODE_SMA<span class="token punctuation">;</span> 
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         Label1Buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 自定义移动平均数处理程序。mq5自定义指标 </span>
<span class="token keyword">int</span> MA_handle<span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 指标缓冲区绘图 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>Label1Buffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   MA_handle<span class="token operator">=</span><span class="token function">iCustom</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;Examples\\Custom Moving Average&quot;</span><span class="token punctuation">,</span> 
                     MA_Period<span class="token punctuation">,</span> 
                     MA_Shift<span class="token punctuation">,</span> 
                     MA_Method<span class="token punctuation">,</span> 
                     PRICE_CLOSE <span class="token comment">// 使用收盘价 </span>
                     <span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;MA_handle = &quot;</span><span class="token punctuation">,</span>MA_handle<span class="token punctuation">,</span><span class="token string">&quot;  error = &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标重复函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 复制指标自定义移动平均值到指标缓冲区 </span>
   <span class="token keyword">int</span> copy<span class="token operator">=</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>MA_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>rates_total<span class="token punctuation">,</span>Label1Buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;copy = &quot;</span><span class="token punctuation">,</span>copy<span class="token punctuation">,</span><span class="token string">&quot;    rates_total = &quot;</span><span class="token punctuation">,</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果尝试失败-这里报道 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>copy<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;An attempt to get the values if Custom Moving Average has failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 为下次调用返回prev_calculated值 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h2 id="_26-15-idema"><a href="#_26-15-idema" class="header-anchor">#</a> 26.15 iDEMA</h2> <p>该函数返回 双指数移动平均线(Double Exponential Moving Average ) 指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iDEMA</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 ma_period<span class="token punctuation">,</span>         <span class="token comment">// 平均周期 </span>
   <span class="token keyword">int</span>                 ma_shift<span class="token punctuation">,</span>          <span class="token comment">// 平移 </span>
   ENUM_APPLIED_PRICE  applied_price      <span class="token comment">// 价格或者处理器类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 计算平均周期(计算K线柱的数量)。</p> <p>ma_shift</p> <p>[in] 关于价格图表转变的指标。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                   Demo_iDEMA.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iDEMA technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_chart_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iDEMA 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iDEMA&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iDEMA<span class="token punctuation">,</span>             <span class="token comment">// 使用iDEMA </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iDEMA<span class="token punctuation">;</span>           <span class="token comment">// 函数类型  </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>              <span class="token comment">// 平均移动周期 </span>
input <span class="token keyword">int</span>                  ma_shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token comment">// 移动 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span> <span class="token comment">// 价格类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iDEMABuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iDEMA 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在双指数移动平均指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iDEMABuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token comment">//--- 设置移动 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>ma_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iDEMA<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iDEMA</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 平均移动周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 移动 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_shift<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_DEMA<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iDEMA indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示双指数移动平均指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iDEMA(%s/%s, %d, %d, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           ma_period<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从 iDEMA 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iDEMA指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iDEMABuffer 数组大于交易品种/周期 iDEMA 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以双指数移动平均指标的值填充iDEMABuffer数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iDEMABuffer<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住双指数移动平均指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iDEMA指标的指标缓冲区                                           | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 双指数移动平均值的指标缓冲区 </span>
                         <span class="token keyword">int</span> shift<span class="token punctuation">,</span>         <span class="token comment">// 移动 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>    <span class="token comment">// iDEMA指标的处理程序 </span>
                         <span class="token keyword">int</span> amount         <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iDEMABuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span>shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iDEMA indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br></div></div><h2 id="_26-16-idemarker"><a href="#_26-16-idemarker" class="header-anchor">#</a> 26.16 iDeMarker</h2> <p>函数返回DeMarker指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iDeMarker</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>        <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  period<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              ma_period      <span class="token comment">// 平均周期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数
symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 计算平均周期(计算K线柱的数量)。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                               Demo_iDeMarker.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iDeMarker technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iDeMarker 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iDeMarker&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrLightSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 指标窗口的横向水平 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_level1  <span class="token number">0.3</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_level2  <span class="token number">0.7</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iDeMarker<span class="token punctuation">,</span>         <span class="token comment">// 使用iDeMarker </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iDeMarker<span class="token punctuation">;</span>       <span class="token comment">// 函数类型  </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>              <span class="token comment">// 平均移动周期 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iDeMarkerBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iDeMarker指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在DeMarker 指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iDeMarkerBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iDeMarker<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iDeMarker</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 平均移动周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_DEMARKER<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iDeMarker indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示DeMarker 指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iDeMarker(%s/%s, period=%d)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span>ma_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iDeMarker指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iDeMarker 指标数量值更改 </span>
<span class="token comment">//---或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iDeMarkerBuffer数组大于交易品种/周期iDeMarker 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以DeMarker 指标的值填充iDeMarkerBuffer数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iDeMarkerBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住DeMarker 指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iDeMarker 指标的指标缓冲区                                      | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// DeMarker值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>    <span class="token comment">// iDeMarker 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount         <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iDeMarkerBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iDeMarker indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br></div></div><h2 id="_26-17-ienvelopes"><a href="#_26-17-ienvelopes" class="header-anchor">#</a> 26.17 iEnvelopes</h2> <p>函数返回 轨道线(Envelopes) 指标的句柄。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iEnvelopes</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 ma_period<span class="token punctuation">,</span>         <span class="token comment">// 平均线计算周期 </span>
   <span class="token keyword">int</span>                 ma_shift<span class="token punctuation">,</span>          <span class="token comment">// 指标平移 </span>
   ENUM_MA_METHOD      ma_method<span class="token punctuation">,</span>         <span class="token comment">// 平滑类型 </span>
   ENUM_APPLIED_PRICE  applied_price<span class="token punctuation">,</span>     <span class="token comment">// 价格或者处理器类型 </span>
   <span class="token keyword">double</span>              deviation          <span class="token comment">// 中线边界差(百分率) </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 主线平均周期</p> <p>ma_shift</p> <p>[in] 相关价格图表的指标转换。</p> <p>ma_method</p> <p>[in] 平滑类型。取值范围是 ENUM_MA_METHOD 枚举值之一。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>deviation</p> <p>[in] 偏离值(百分比)。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>注释</p> <p>缓冲区代码： 0 - UPPER_LINE，1 - LOWER_LINE。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                              Demo_iEnvelopes.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iEnvelopes technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_chart_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">2</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">2</span> </span></span>
<span class="token comment">//--- 上标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;Upper&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrBlue </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 下标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label2  </span><span class="token string">&quot;Lower&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type2   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color2  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style2  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width2  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iEnvelopes<span class="token punctuation">,</span>        <span class="token comment">// 使用iEnvelopes </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iEnvelopes<span class="token punctuation">;</span>      <span class="token comment">// 函数类型 </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>              <span class="token comment">// 平均移动周期 </span>
input <span class="token keyword">int</span>                  ma_shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token comment">// 移动  </span>
input ENUM_MA_METHOD       ma_method<span class="token operator">=</span>MODE_SMA<span class="token punctuation">;</span>        <span class="token comment">// 平滑类型 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span> <span class="token comment">// 价格类型 </span>
input <span class="token keyword">double</span>               deviation<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">;</span>             <span class="token comment">// 移动平均的边界偏差 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         UpperBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         LowerBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iEnvelopes指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在轨道线指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>UpperBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>LowerBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置每条线的移动 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>ma_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>ma_shift<span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iEnvelopes<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iEnvelopes</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>ma_method<span class="token punctuation">,</span>applied_price<span class="token punctuation">,</span>deviation<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 平均移动周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 移动 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_shift<span class="token punctuation">;</span> 
      <span class="token comment">//--- 平滑类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_method<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_DOUBLE<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>double_value<span class="token operator">=</span>deviation<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_ENVELOPES<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iEnvelopes indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示轨道线指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iEnvelopes(%s/%s, %d, %d, %s,%s, %G)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
   ma_period<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>ma_method<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">,</span>deviation<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iEnvelopes指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iEnvelopes指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果UpperBuffer 数组大于交易品种/周期iEnvelopes 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 用来自轨道线指标的值填充UpperBuffer和LowerBuffer数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span>UpperBuffer<span class="token punctuation">,</span>LowerBuffer<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住轨道线指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iEnvelopes指标的指标缓冲区                                      | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>upper_values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">// 上边界的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>lower_values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">// 下边界的指标缓冲区 </span>
                           <span class="token keyword">int</span> shift<span class="token punctuation">,</span>                 <span class="token comment">// 移动 </span>
                           <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>            <span class="token comment">// 轨道线指标的处理程序 </span>
                           <span class="token keyword">int</span> amount                 <span class="token comment">// 复制值的数量 </span>
                           <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分UpperBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span>shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>upper_values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iEnvelopes indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以1标引指标缓冲区的值填充部分LowerBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span>shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>lower_values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iEnvelopes indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br></div></div><h2 id="_26-18-iforce"><a href="#_26-18-iforce" class="header-anchor">#</a> 26.18 iForce</h2> <p>函数返回 强力指数(Force Index ) 指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iForce</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 ma_period<span class="token punctuation">,</span>         <span class="token comment">// 平均周期 </span>
   ENUM_MA_METHOD      ma_method<span class="token punctuation">,</span>         <span class="token comment">// 平滑类型 </span>
   ENUM_APPLIED_VOLUME applied_volume     <span class="token comment">// 计算的交易量类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 指标计算的平均周期。</p> <p>ma_method</p> <p>[in] 平滑类型。取值范围是 ENUM_MA_METHOD 枚举值之一。</p> <p>applied_volume</p> <p>[in] 使用的交易量。取值范围是 ENUM_APPLIED_VOLUME 枚举值之一。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                  Demo_iForce.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iForce technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- 绘制iForce </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iForce&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrLightSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iForce<span class="token punctuation">,</span>            <span class="token comment">// 使用iForce </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iForce<span class="token punctuation">;</span>             <span class="token comment">// 函数类型 </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">;</span>                 <span class="token comment">// 平均移动周期 </span>
input ENUM_MA_METHOD       ma_method<span class="token operator">=</span>MODE_SMA<span class="token punctuation">;</span>           <span class="token comment">// 平滑类型 </span>
input ENUM_APPLIED_VOLUME  applied_volume<span class="token operator">=</span>VOLUME_TICK<span class="token punctuation">;</span>   <span class="token comment">// 交易量类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                   <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>        <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iForceBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iForce指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在强力指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iForceBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iForce<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iForce</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">,</span>ma_method<span class="token punctuation">,</span>applied_volume<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 平均移动周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 平滑类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_method<span class="token punctuation">;</span> 
      <span class="token comment">//--- 交易量类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_volume<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_FORCE<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iForce indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示强力指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iForce(%s/%s, %d, %s, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           ma_period<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>ma_method<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_volume<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iForce指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iForce指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iForceBuffer 数组大于交易品种/周期iForce 指标的数量值，那么我们不会复制任何内容  </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以强力指标的值填充iForceBuffer数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iForceBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住强力指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iForce指标的指标缓冲区                                          | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 强力指数值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>    <span class="token comment">// iForce指标的处理程序 </span>
                         <span class="token keyword">int</span> amount         <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iForceBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iForce indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br></div></div><h2 id="_26-19-ifractals"><a href="#_26-19-ifractals" class="header-anchor">#</a> 26.19 iFractals</h2> <p>函数返回 分形(Fractals) 指标的句柄。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iFractals</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>     <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  period      <span class="token comment">// 周期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>注意</p> <p>缓冲区代码如下：0 - UPPER_LINE， 1 - LOWER_LINE。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                               Demo_iFractals.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iFractals technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_chart_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_chart_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">2</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">2</span> </span></span>
<span class="token comment">//--- FractalUp 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;FractalUp&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_ARROW </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrBlue </span></span>
<span class="token comment">//--- FractalDown 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label2  </span><span class="token string">&quot;FractalDown&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type2   DRAW_ARROW </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color2  clrRed </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iFractals<span class="token punctuation">,</span>         <span class="token comment">// 使用iFractals </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iFractals<span class="token punctuation">;</span>          <span class="token comment">// 函数类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                   <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>        <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         FractalUpBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         FractalDownBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iFractals指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在分形学指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>FractalUpBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>FractalDownBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 使用来自Wingdings字符集的交易品种为PLOT_ARROW属性设置代码 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_ARROW<span class="token punctuation">,</span><span class="token number">217</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 箭头向上 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>PLOT_ARROW<span class="token punctuation">,</span><span class="token number">218</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 箭头向下 </span>
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iFractals<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iFractals</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_FRACTALS<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iFractals indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示分形学指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iFractals(%s/%s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iFractals指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iFractals指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果FractalUpBuffer数组大于交易品种/周期iFractals指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 用来自分形学指标的值填充FractalUpBuffer和FractalDownBuffer数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span>FractalUpBuffer<span class="token punctuation">,</span>FractalDownBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住分形学指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iFractals指标的指标缓冲区                                       | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>up_arrows<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment">// 向上箭头的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>down_arrows<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token comment">// 向下箭头的指标缓冲区 </span>
                           <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>             <span class="token comment">// iFractals指标的处理程序 </span>
                           <span class="token keyword">int</span> amount                  <span class="token comment">// 复制值的数量 </span>
                           <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分FractalUpBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>up_arrows<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iFractals indicator to the FractalUpBuffer array, error code %d&quot;</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以1标引指标缓冲区的值填充部分FractalDownBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>down_arrows<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iFractals indicator to the FractalDownBuffer array, error code %d&quot;</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br></div></div><h2 id="_26-20-iframa"><a href="#_26-20-iframa" class="header-anchor">#</a> 26.20 iFrAMA</h2> <p>函数返回 分形自适应均线(Fractal Adaptive Moving Average)指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iFrAMA</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 ma_period<span class="token punctuation">,</span>         <span class="token comment">// 平均周期 </span>
   <span class="token keyword">int</span>                 ma_shift<span class="token punctuation">,</span>          <span class="token comment">// 图表平移 </span>
   ENUM_APPLIED_PRICE  applied_price      <span class="token comment">// 价格或者处理器类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 指标计算周期(计算K线柱的数量)。</p> <p>ma_shift</p> <p>[in] 在价格图表中的指标转换。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                  Demo_iFrAMA.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iFrAMA technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_chart_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- 绘制iFrAMA </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iFrAMA&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrBlue </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iFrAMA<span class="token punctuation">,</span>            <span class="token comment">// 使用iFrAMA </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iFrAMA<span class="token punctuation">;</span>             <span class="token comment">// 函数类型 </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>                 <span class="token comment">// 平均移动周期 </span>
input <span class="token keyword">int</span>                  ma_shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                   <span class="token comment">// 移动 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span>    <span class="token comment">// 价格类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                   <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>        <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iFrAMABuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iFrAMA 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在分形学适合移动平均指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iFrAMABuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置移动 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>ma_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iFrAMA<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iFrAMA</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 平均移动周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 移动 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_shift<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_FRAMA<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iFrAMA indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示iFrAMA indicator指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iFrAMA(%s/%s, %d, %d, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           ma_period<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iFrAMA指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iFrAMA指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iFrAMABuffer数组大于交易品种/周期iFrAMA 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以分形学适合移动平均指标的值填充iFrAMABuffer数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iFrAMABuffer<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住分形学适合移动平均指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iFrAMA指标的指标缓冲区                                          | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 分形学适合移动平均值的指标缓冲区 </span>
                         <span class="token keyword">int</span> shift<span class="token punctuation">,</span>         <span class="token comment">// 移动 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>    <span class="token comment">// iFrAMA 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount         <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iFrAMABuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span>shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iFrAMA indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br></div></div><h2 id="_26-21-igator"><a href="#_26-21-igator" class="header-anchor">#</a> 26.21 iGator</h2> <p>函数返回 鳄鱼振荡器(Gator) 指标的句柄。振荡器表示鳄鱼指标蓝线和红线(上升柱状图)的区别以及红线和绿线的区别(下降柱状图)。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iGator</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 jaw_period<span class="token punctuation">,</span>        <span class="token comment">// 咽喉计算周期 </span>
   <span class="token keyword">int</span>                 jaw_shift<span class="token punctuation">,</span>         <span class="token comment">// 咽喉平移 </span>
   <span class="token keyword">int</span>                 teeth_period<span class="token punctuation">,</span>      <span class="token comment">// 牙齿计算周期 </span>
   <span class="token keyword">int</span>                 teeth_shift<span class="token punctuation">,</span>       <span class="token comment">// 牙齿平移 </span>
   <span class="token keyword">int</span>                 lips_period<span class="token punctuation">,</span>       <span class="token comment">// 唇部计算周期 </span>
   <span class="token keyword">int</span>                 lips_shift<span class="token punctuation">,</span>        <span class="token comment">// 唇部平移 </span>
   ENUM_MA_METHOD      ma_method<span class="token punctuation">,</span>         <span class="token comment">// 平滑类型 </span>
   ENUM_APPLIED_PRICE  applied_price      <span class="token comment">// 价格或者处理器类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>jaw_period</p> <p>[in] 蓝线平均周期（鳄鱼颌骨）。</p> <p>jaw_shift</p> <p>[in] 与价格图表有关的蓝线变化。不能直接连接到指标柱状图的视觉变化。</p> <p>teeth_period</p> <p>[in] 红线的平均周期（鳄鱼牙）。</p> <p>teeth_shift</p> <p>[in] 关于价格图表的红线变化。不能直接连接到指标柱状图的视觉变化。</p> <p>lips_period</p> <p>[in] 绿线的平均周期 （鳄鱼唇）。</p> <p>lips_shift</p> <p>[in] 关于价格图表的绿线变化。不能直接连接到指标柱状图的视觉变化。</p> <p>ma_method</p> <p>[in] 平滑类型。取值范围是 ENUM_MA_METHOD 枚举值之一。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>注释</p> <p>缓冲区代码：<br>
0 ---- UPPER_HISTOGRAM，<br>
1 ----上升柱状图的颜色缓冲区，<br>
2 ---- LOWER_HISTOGRAM，<br>
3 ---- 下降柱状图的颜色缓冲区。<br></p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                  Demo_iGator.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iGator technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All other parameters are as in a standard Gator Oscillator.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">4</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">2</span> </span></span>
<span class="token comment">//--- 绘制GatorUp </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;GatorUp&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_COLOR_HISTOGRAM </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrGreen<span class="token punctuation">,</span> clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 绘制GatorDown </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label2  </span><span class="token string">&quot;GatorDown&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type2   DRAW_COLOR_HISTOGRAM </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color2  clrGreen<span class="token punctuation">,</span> clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style2  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width2  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iGator<span class="token punctuation">,</span>            <span class="token comment">// 使用iGator </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iGator<span class="token punctuation">;</span>       <span class="token comment">// 函数类型  </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>             <span class="token comment">// 交易品种 </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>  <span class="token comment">// 时间帧 </span>
input <span class="token keyword">int</span>                  jaw_period<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">;</span>          <span class="token comment">// 咽喉线周期 </span>
input <span class="token keyword">int</span>                  jaw_shift<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>            <span class="token comment">// 咽喉线移动 </span>
input <span class="token keyword">int</span>                  teeth_period<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>         <span class="token comment">// 牙齿线周期 </span>
input <span class="token keyword">int</span>                  teeth_shift<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>          <span class="token comment">// 牙齿线移动 </span>
input <span class="token keyword">int</span>                  lips_period<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>          <span class="token comment">// 唇部线周期 </span>
input <span class="token keyword">int</span>                  lips_shift<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>           <span class="token comment">// 唇部线移动 </span>
input ENUM_MA_METHOD       MA_method<span class="token operator">=</span>MODE_SMMA<span class="token punctuation">;</span>    <span class="token comment">// 鳄鱼平均线的方法 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_MEDIAN<span class="token punctuation">;</span><span class="token comment">// 用于计算鳄鱼的价格类型 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         GatorUpBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         GatorUpColors<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         GatorDownBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         GatorDownColors<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iGator 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 移动上下直方图的值 </span>
<span class="token keyword">int</span> shift<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在加多摆动指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>GatorUpBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>GatorUpColors<span class="token punctuation">,</span>INDICATOR_COLOR_INDEX<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>GatorDownBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>GatorDownColors<span class="token punctuation">,</span>INDICATOR_COLOR_INDEX<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">/* 
  参数中指定的所有移动指的是绘制加多摆动指标基础上的鳄鱼指标！ 
  这就是我们不能移动加多摆动指标本身的原因，但是他们移动鳄鱼线， 
  其值用于计算加多摆动指标！ 
*/</span> 
<span class="token comment">//--- 我们计算上下直方图的移动，这等于咽喉线和牙齿线之间的区别 </span>
   shift<span class="token operator">=</span><span class="token function">MathMin</span><span class="token punctuation">(</span>jaw_shift<span class="token punctuation">,</span>teeth_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 尽管指标包含两个直方图，也使用相同的移动 - 就是实施iGator 指标。 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iGator<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iGator</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>jaw_period<span class="token punctuation">,</span>jaw_shift<span class="token punctuation">,</span>teeth_period<span class="token punctuation">,</span>teeth_shift<span class="token punctuation">,</span> 
                    lips_period<span class="token punctuation">,</span>lips_shift<span class="token punctuation">,</span>MA_method<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 鳄鱼线的周期和移动 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>jaw_period<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>jaw_shift<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>teeth_period<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>teeth_shift<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>lips_period<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>lips_shift<span class="token punctuation">;</span> 
      <span class="token comment">//--- 平滑类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>MA_method<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      <span class="token comment">//--- 创建处理程序 </span>
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_GATOR<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iGator indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示加多摆动指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iGator(%s/%s, %d, %d ,%d, %d, %d, %d)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           jaw_period<span class="token punctuation">,</span>jaw_shift<span class="token punctuation">,</span>teeth_period<span class="token punctuation">,</span>teeth_shift<span class="token punctuation">,</span>lips_period<span class="token punctuation">,</span>lips_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iGator指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iGator指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果GatorUpBuffer数组大于交易品种/周期iGator指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以加多摆动指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span>GatorUpBuffer<span class="token punctuation">,</span>GatorUpColors<span class="token punctuation">,</span>GatorDownBuffer<span class="token punctuation">,</span>GatorDownColors<span class="token punctuation">,</span> 
      shift<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住加多摆动指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充 iGator 指标的指标缓冲区                                        | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>ups_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment">// 向上直方图的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>up_color_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">// 向上直方图价格指数的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>downs_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token comment">// 向下直方图的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>downs_color_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 向下直方图价格指数的指标缓冲区 </span>
                           <span class="token keyword">int</span> u_shift<span class="token punctuation">,</span>                  <span class="token comment">// 上下直方图移动 </span>
                           <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>               <span class="token comment">// iGator 指标的处理程序 </span>
                           <span class="token keyword">int</span> amount                    <span class="token comment">// 复制值的数量 </span>
                           <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分GatorUpBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span>u_shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>ups_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iGator indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以1标引指标缓冲区的值填充部分GatorUpColors 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span>u_shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>up_color_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iGator indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以2标引指标缓冲区的值填充部分GatorDownBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">-</span>u_shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>downs_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iGator indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以3标引指标缓冲区的值填充部分GatorDownColors 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token operator">-</span>u_shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>downs_color_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iGator indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br></div></div><h2 id="_26-22-iichimoku"><a href="#_26-22-iichimoku" class="header-anchor">#</a> 26.22 iIchimoku</h2> <p>函数返回 一目均衡图(Ichimoku Kinko Hyo) 指标的句柄。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iIchimoku</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种类型 </span>
   ENUM_TIMEFRAMES  period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              tenkan_sen<span class="token punctuation">,</span>        <span class="token comment">// Tenkan-sen转换线周期 </span>
   <span class="token keyword">int</span>              kijun_sen<span class="token punctuation">,</span>         <span class="token comment">// Kijun-sen基准线周期 </span>
   <span class="token keyword">int</span>              senkou_span_b      <span class="token comment">// Senkou Span B周期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>tenkan_sen</p> <p>[in] 转换线平均周期。</p> <p>kijun_sen</p> <p>[in] 基准线平均周期。</p> <p>senkou_span_b</p> <p>[in] Senkou Span B 平均周期。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>注释</p> <p>缓冲区代码：0 - TENKANSEN_LINE， 1 - KIJUNSEN_LINE， 2 - SENKOUSPANA_LINE， 3 - SENKOUSPANB_LINE， 4 - CHIKOUSPAN_LINE。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                               Demo_iIchimoku.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iIchimoku technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All other parameters just like in the standard Ichimoku Kinko Hyo.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_chart_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">5</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">4</span> </span></span>
<span class="token comment">//--- Tenkan_sen 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;Tenkan_sen&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- Kijun_sen 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label2  </span><span class="token string">&quot;Kijun_sen&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type2   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color2  clrBlue </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style2  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width2  <span class="token number">1</span> </span></span>
<span class="token comment">//--- Senkou_Span 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label3  </span><span class="token string">&quot;Senkou Span A;Senkou Span B&quot;</span> <span class="token comment">// two fields will be shown in Data Window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type3   DRAW_FILLING </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color3  clrSandyBrown<span class="token punctuation">,</span> clrThistle </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style3  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width3  <span class="token number">1</span> </span></span>
<span class="token comment">//--- Chinkou_Span 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label4  </span><span class="token string">&quot;Chinkou_Span&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type4   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color4  clrLime </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style4  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width4  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iIchimoku<span class="token punctuation">,</span>         <span class="token comment">// 使用iIchimoku </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iIchimoku<span class="token punctuation">;</span>       <span class="token comment">// 函数类型 </span>
input <span class="token keyword">int</span>                  tenkan_sen<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">;</span>              <span class="token comment">// Tenkan-sen周期 </span>
input <span class="token keyword">int</span>                  kijun_sen<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">;</span>              <span class="token comment">// Kijun-sen周期 </span>
input <span class="token keyword">int</span>                  senkou_span_b<span class="token operator">=</span><span class="token number">52</span><span class="token punctuation">;</span>          <span class="token comment">// Senkou Span B周期 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         Tenkan_sen_Buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         Kijun_sen_Buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         Senkou_Span_A_Buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         Senkou_Span_B_Buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         Chinkou_Span_Buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iIchimoku指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在一目均衡图指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>Tenkan_sen_Buffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>Kijun_sen_Buffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>Senkou_Span_A_Buffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>Senkou_Span_B_Buffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>Chinkou_Span_Buffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置未来方向kijun_sen 柱形的Senkou 跨通道的移动 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>kijun_sen<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置无需Chinkou跨线的移动，因为数据跨度 </span>
<span class="token comment">//--- 已经存储在iIchimoku移动 </span>
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iIchimoku<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iIchimoku</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>tenkan_sen<span class="token punctuation">,</span>kijun_sen<span class="token punctuation">,</span>senkou_span_b<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 鳄鱼线的周期和移动 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>tenkan_sen<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>kijun_sen<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>senkou_span_b<span class="token punctuation">;</span> 
      <span class="token comment">//--- 创建处理程序 </span>
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_ICHIMOKU<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iIchimoku indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示一目均衡图指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iIchimoku(%s/%s, %d, %d ,%d)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           tenkan_sen<span class="token punctuation">,</span>kijun_sen<span class="token punctuation">,</span>senkou_span_b<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化     </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iIchimoku指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iIchimoku指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果Tenkan_sen_Buffer数组大于交易品种/周期iIchimoku指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以一目均衡图指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span>Tenkan_sen_Buffer<span class="token punctuation">,</span>Kijun_sen_Buffer<span class="token punctuation">,</span>Senkou_Span_A_Buffer<span class="token punctuation">,</span>Senkou_Span_B_Buffer<span class="token punctuation">,</span>Chinkou_Span_Buffer<span class="token punctuation">,</span> 
      kijun_sen<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住一目均衡图指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充 iIchimoku 指标的指标缓冲区                                     | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>tenkan_sen_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment">// Tenkan-sen线的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>kijun_sen_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token comment">// Kijun_sen线的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>senkou_span_A_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// Senkou Span A 线的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>senkou_span_B_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// Senkou Span B线的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>chinkou_span_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// Chinkou Span线的指标缓冲区 </span>
                           <span class="token keyword">int</span> senkou_span_shift<span class="token punctuation">,</span>           <span class="token comment">// 未来方向Senkou 的跨线移动 </span>
                           <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>                  <span class="token comment">// iIchimoku 指标的处理程序 </span>
                           <span class="token keyword">int</span> amount                       <span class="token comment">// 复制值的数量 </span>
                           <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分Tenkan_sen_Buffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>tenkan_sen_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;1.Failed to copy data from the iIchimoku indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以1标引指标缓冲区的值填充部分Kijun_sen_Buffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>kijun_sen_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;2.Failed to copy data from the iIchimoku indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以2标引指标缓冲区的值填充部分Chinkou_Span_Buffer 数组 </span>
<span class="token comment">//--- 如果senkou_span_shift&gt;0，线根据senkou_span_shift柱形的未来方向移动。 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">-</span>senkou_span_shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>senkou_span_A_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;3.Failed to copy data from the iIchimoku indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以3标引指标缓冲区的值填充部分Senkou_Span_A_Buffer 数组 </span>
<span class="token comment">//--- 如果senkou_span_shift&gt;0，线根据senkou_span_shift柱形的未来方向移动。 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token operator">-</span>senkou_span_shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>senkou_span_B_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;4.Failed to copy data from the iIchimoku indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分Senkou_Span_B_Buffer 数组 </span>
<span class="token comment">//--- 当复制Chinkou Span时，我们无需考虑移动，因为Chinkou数据跨度 </span>
<span class="token comment">//--- 已经存储在iIchimoku移动   </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>chinkou_span_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;5.Failed to copy data from the iIchimoku indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br></div></div><h2 id="_26-23-ibwmfi"><a href="#_26-23-ibwmfi" class="header-anchor">#</a> 26.23 iBWMFI</h2> <p>函数返回 市场促进指数(Market Facilitation Index) 指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iBWMFI</span><span class="token punctuation">(</span> 
   string               symbol<span class="token punctuation">,</span>             <span class="token comment">// 交易品种类型 </span>
   ENUM_TIMEFRAMES      period<span class="token punctuation">,</span>             <span class="token comment">// 周期 </span>
   ENUM_APPLIED_VOLUME  applied_volume      <span class="token comment">// 计算的交易量类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>applied_volume</p> <p>[in] 使用的交易量。取值范围是 ENUM_APPLIED_VOLUME 枚举的常量之一。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                  Demo_iBWMFI.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iBWMFI technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">2</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iBWMFI 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iBWMFI&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_COLOR_HISTOGRAM </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrLime<span class="token punctuation">,</span>clrSaddleBrown<span class="token punctuation">,</span>clrBlue<span class="token punctuation">,</span>clrPink </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iBWMFI<span class="token punctuation">,</span>            <span class="token comment">// 使用iBWMFI </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iBWMFI<span class="token punctuation">;</span>          <span class="token comment">// 函数类型 </span>
input ENUM_APPLIED_VOLUME  applied_volume<span class="token operator">=</span>VOLUME_TICK<span class="token punctuation">;</span><span class="token comment">// 交易量类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iBWMFIBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         iBWMFIColors<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储 iBWMFI 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在市场便利指数比尔 威廉姆斯指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iBWMFIBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>iBWMFIColors<span class="token punctuation">,</span>INDICATOR_COLOR_INDEX<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iBWMFI<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iBWMFI</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>applied_volume<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 交易量类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_volume<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_BWMFI<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iBWMFI indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示市场便利指数比尔 威廉姆斯指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iBWMFI(%s/%s, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           <span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_volume<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从 iBWMFI 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iBWMFI指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iBWMFIBuffer 数组大于交易品种/周期 iBWMFI 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以市场便利指数比尔 威廉姆斯指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span>iBWMFIBuffer<span class="token punctuation">,</span>iBWMFIColors<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住市场便利指数比尔 威廉姆斯指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iBWMFI 指标的指标缓冲区                                         | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">// 直方图值的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>colors<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">// 直方图颜色的指标缓冲区 </span>
                           <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>      <span class="token comment">// iBWMFI 指标的处理程序 </span>
                           <span class="token keyword">int</span> amount           <span class="token comment">// 复制值的数量 </span>
                           <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iBWMFIBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iBWMFI indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//---以1标引指标缓冲区的值填充部分 iBWMFIColors 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>colors<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iBWMFI indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br></div></div><h2 id="_26-24-imomentum"><a href="#_26-24-imomentum" class="header-anchor">#</a> 26.24 iMomentum</h2> <p>函数返回 动量(Momentum) 指标句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iMomentum</span><span class="token punctuation">(</span> 
   string               symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES      period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                  mom_period<span class="token punctuation">,</span>        <span class="token comment">// 平均周期 </span>
   ENUM_APPLIED_PRICE   applied_price      <span class="token comment">// 价格或者处理器类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>mom_period</p> <p>[in] 计算价格变化的平均周期（计算K线柱的数量）。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                               Demo_iMomentum.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iMomentum technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All the other parameters are similar to the standard Momentum.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- 标图iMomentum </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iMomentum&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrDodgerBlue </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iMomentum<span class="token punctuation">,</span>         <span class="token comment">// 使用iMomentum </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iMomentum<span class="token punctuation">;</span>       <span class="token comment">// 函数类型  </span>
input <span class="token keyword">int</span>                  mom_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>             <span class="token comment">// 动量周期 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span> <span class="token comment">// 价格类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iMomentumBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储 iMomentum 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在动量指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iMomentumBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iMomentum<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iMomentum</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>mom_period<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>mom_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_MOMENTUM<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iMomentum indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示动量指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iMomentum(%s/%s, %d, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           mom_period<span class="token punctuation">,</span> <span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iMomentum指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果 iMomentum指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iMomentumBuffer数组大于交易品种/周期iMomentum指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以动量指标的值填充iMomentumBuffer数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iMomentumBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住动量指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充 iMomentum指标的指标缓冲区                                      | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 动量值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>    <span class="token comment">// iMomentum 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount         <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iMomentumBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iMomentum indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br></div></div><h2 id="_26-25-imfi"><a href="#_26-25-imfi" class="header-anchor">#</a> 26.25 iMFI</h2> <p>函数返回资金流向(Money Flow Index )指标的句柄。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iMFI</span><span class="token punctuation">(</span> 
   string               symbol<span class="token punctuation">,</span>             <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES      period<span class="token punctuation">,</span>             <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                  ma_period<span class="token punctuation">,</span>          <span class="token comment">// 平均周期 </span>
   ENUM_APPLIED_VOLUME  applied_volume      <span class="token comment">// 计算的交易量类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 计算的平均周期（计算的K线柱数量）。</p> <p>applied_volume</p> <p>[in] 使用的交易量。取值范围是 ENUM_APPLIED_VOLUME 枚举的常量之一。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                    Demo_iMFI.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iMFI technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All the other parameters are similar to the standard Money Flow Index.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iMFI标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iMFI&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrDodgerBlue </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 指标窗口的横向水平 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_level1  <span class="token number">20</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_level2  <span class="token number">80</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iMFI<span class="token punctuation">,</span>              <span class="token comment">// 使用iMFI </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iMFI<span class="token punctuation">;</span>               <span class="token comment">// 函数类型 </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>                 <span class="token comment">// 周期 </span>
input ENUM_APPLIED_VOLUME  applied_volume<span class="token operator">=</span>VOLUME_TICK<span class="token punctuation">;</span>   <span class="token comment">// 交易量类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                   <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>        <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iMFIBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iMFI指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在资金流向指数指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iMFIBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种   </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iMFI<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iMFI</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">,</span>applied_volume<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 交易量类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_volume<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_MFI<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iMFI indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示资金流向指数指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iMFI(%s/%s, %d, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           ma_period<span class="token punctuation">,</span> <span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_volume<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iMFI 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iMFI 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iMFIBuffer 数组大于交易品种/周期 iMFI 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以资金流向指数指标的值填充iMFIBuffer数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iMFIBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住资金流向指数指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充 iMFI 指标的指标缓冲区                                          | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 资金流向指数值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>    <span class="token comment">// iMFI 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount         <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分 iMFIBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iMFI indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br></div></div><h2 id="_26-26-ima"><a href="#_26-26-ima" class="header-anchor">#</a> 26.26 iMA</h2> <p>函数返回 移动平均线(Moving Average) 的指标句柄。只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iMA</span><span class="token punctuation">(</span> 
   string               symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES      period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                  ma_period<span class="token punctuation">,</span>         <span class="token comment">// 平均周期 </span>
   <span class="token keyword">int</span>                  ma_shift<span class="token punctuation">,</span>          <span class="token comment">// 平移 </span>
   ENUM_MA_METHOD       ma_method<span class="token punctuation">,</span>         <span class="token comment">// 平滑类型 </span>
   ENUM_APPLIED_PRICE   applied_price      <span class="token comment">// 价格或者处理程序类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 计算移动平均数的平均周期。</p> <p>ma_shift</p> <p>[in] 与价格图表有关的指标变化。</p> <p>ma_method</p> <p>[in] 平滑类型。取值范围是 ENUM_MA_METHOD 枚举值之一。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                     Demo_iMA.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iMA technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All other parameters like in the standard Moving Average.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_chart_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iMA 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iMA&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iMA<span class="token punctuation">,</span>               <span class="token comment">// 使用iMA </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iMA<span class="token punctuation">;</span>                <span class="token comment">// 函数类型 </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>                 <span class="token comment">// ma周期 </span>
input <span class="token keyword">int</span>                  ma_shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                   <span class="token comment">// 移动 </span>
input ENUM_MA_METHOD       ma_method<span class="token operator">=</span>MODE_SMA<span class="token punctuation">;</span>           <span class="token comment">// 平滑类型 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span>    <span class="token comment">// 价格类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                   <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>        <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iMABuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iMA指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在移动平均指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iMABuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置移动 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>ma_shift<span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">//--- 定义绘制指标的交易品种   </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iMA<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iMA</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>ma_method<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构 </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 移动 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_shift<span class="token punctuation">;</span> 
      <span class="token comment">//--- 平滑类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_method<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_MA<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iMA indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示移动平均指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iMA(%s/%s, %d, %d, %s, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           ma_period<span class="token punctuation">,</span> ma_shift<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>ma_method<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iMA指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iMA 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iMABuffer数组大于交易品种/周期iMA指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以适合移动平均指标的值填充iMABuffer 数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iMABuffer<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住移动平均指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充MA指标的指标缓冲区                                              | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>values<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// 移动平均值的指标缓冲区 </span>
                         <span class="token keyword">int</span> shift<span class="token punctuation">,</span>          <span class="token comment">// 移动 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>     <span class="token comment">// iMA指标的处理程序 </span>
                         <span class="token keyword">int</span> amount          <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iMABuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span>shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iMA indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>     
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br></div></div><h2 id="_26-27-iosma"><a href="#_26-27-iosma" class="header-anchor">#</a> 26.27 iOsMA</h2> <p>该函数返回“振荡器移动平均线(Moving Average of Oscillator)”指标的句柄。 OsMA振荡器显示MACD值与其信号线之间的差异。 它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iOsMA</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>              <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>              <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 fast_ema_period<span class="token punctuation">,</span>     <span class="token comment">// 快速移动平均数周期 </span>
   <span class="token keyword">int</span>                 slow_ema_period<span class="token punctuation">,</span>     <span class="token comment">// 慢速移动平均数周期 </span>
   <span class="token keyword">int</span>                 signal_period<span class="token punctuation">,</span>       <span class="token comment">// 不同点的平均周期 </span>
   ENUM_APPLIED_PRICE  applied_price        <span class="token comment">// 价格或者处理器的类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>fast_ema_period</p> <p>[in] 快速移动平均数计算周期。</p> <p>slow_ema_period</p> <p>[in] 慢速移动平均数计算周期。</p> <p>signal_period</p> <p>[in] 信号线计算平均周期。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>注意</p> <p>在一些系统中该振荡器也被认为是MACD柱状图。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                   Demo_iOsMA.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iOsMA technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All the other parameters are similar to the standard Moving Average of Oscillator.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iOsMA 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iOsMA&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_HISTOGRAM </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrSilver </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iOsMA<span class="token punctuation">,</span>             <span class="token comment">// 使用iOsMA </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iOsMA<span class="token punctuation">;</span>           <span class="token comment">// 函数类型  </span>
input <span class="token keyword">int</span>                  fast_ema_period<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">;</span>        <span class="token comment">// 快速ma周期 </span>
input <span class="token keyword">int</span>                  slow_ema_period<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">;</span>        <span class="token comment">// 慢速ma周期 </span>
input <span class="token keyword">int</span>                  signal_period<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">;</span>           <span class="token comment">// 平均差异周期 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span> <span class="token comment">// 价格类型  </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iOsMABuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储 iAMA 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在移动平均指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iOsMABuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iOsMA<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iOsMA</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>fast_ema_period<span class="token punctuation">,</span>slow_ema_period<span class="token punctuation">,</span>signal_period<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构    </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 快速ma周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>fast_ema_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 慢速ma周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>slow_ema_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 快速慢速移动平均差异的周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>signal_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_OSMA<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create a handle of iOsMA for the pair %s/%s, error code is %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示移动平均震荡指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iOsMA(%s/%s,%d,%d,%d,%s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           fast_ema_period<span class="token punctuation">,</span>slow_ema_period<span class="token punctuation">,</span>signal_period<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化     </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iOsMA 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iOsMA 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iOsMABuffer 数组大于交易品种/周期iOsMA指标的数量值，那么我们不会复制任何内容  </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以iOsMA 指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iOsMABuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住移动平均震荡指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iOsMA 指标的指标缓冲区                                          | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>ama_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// OsMA 值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>        <span class="token comment">// iOsMA 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount             <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iOsMABuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>ama_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iOsMA indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br></div></div><h2 id="_26-28-imacd"><a href="#_26-28-imacd" class="header-anchor">#</a> 26.28 iMACD</h2> <p>该函数返回 指数平滑均线离散(Moving Averages Convergence / Divergence)指标的句柄。 在OsMA称为MACD直方图的系统中，该指标显示为两条曲线。在客户端中，指数平滑均线离散 看起来像柱状图。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iMACD</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>              <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>              <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 fast_ema_period<span class="token punctuation">,</span>     <span class="token comment">// 快速移动平均数周期 </span>
   <span class="token keyword">int</span>                 slow_ema_period<span class="token punctuation">,</span>     <span class="token comment">// 慢速移动平均数周期 </span>
   <span class="token keyword">int</span>                 signal_period<span class="token punctuation">,</span>       <span class="token comment">// 不同点的平均周期 </span>
   ENUM_APPLIED_PRICE  applied_price        <span class="token comment">// 价格或者处理器的类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>fast_ema_period</p> <p>[in] 快速移动平均数计算周期。</p> <p>slow_ema_period</p> <p>[in] 慢速移动平均数计算周期。</p> <p>signal_period</p> <p>[in] 信号线计算周期。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>注意</p> <p>缓冲区代码如下： 0 - MAIN_LINE， 1 - SIGNAL_LINE。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                   Demo_iMACD.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iMACD technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All other parameters like in the standard MACD.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">2</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">2</span> </span></span>
<span class="token comment">//--- MACD 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;MACD&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_HISTOGRAM </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrSilver </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 信号标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label2  </span><span class="token string">&quot;Signal&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type2   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color2  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style2  STYLE_DOT </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width2  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iMACD<span class="token punctuation">,</span>             <span class="token comment">// 使用iMACD </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iMACD<span class="token punctuation">;</span>           <span class="token comment">// 函数类型 </span>
input <span class="token keyword">int</span>                  fast_ema_period<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">;</span>        <span class="token comment">// 快速ma周期 </span>
input <span class="token keyword">int</span>                  slow_ema_period<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">;</span>        <span class="token comment">// 慢速ma周期 </span>
input <span class="token keyword">int</span>                  signal_period<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">;</span>           <span class="token comment">// 平均差异周期 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span> <span class="token comment">// 价格类型  </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         MACDBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         SignalBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iMACD 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在移动平均聚/散指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>MACDBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>SignalBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iMACD<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iMACD</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>fast_ema_period<span class="token punctuation">,</span>slow_ema_period<span class="token punctuation">,</span>signal_period<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构    </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 快速ma周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>fast_ema_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 慢速ma周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>slow_ema_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 快速慢速移动平均差异的周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>signal_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_MACD<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iMACD indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示移动平均聚/散指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iMACD(%s/%s,%d,%d,%d,%s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           fast_ema_period<span class="token punctuation">,</span>slow_ema_period<span class="token punctuation">,</span>signal_period<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从 iMACD 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果 iMACD 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果 MACDBuffer数组大于交易品种/周期iMACD指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以iMACD指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span>MACDBuffer<span class="token punctuation">,</span>SignalBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住移动平均聚/散指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iMACD 指标的指标缓冲区                                          | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>macd_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">// MACD值的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>signal_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// MACD 信号线的指标缓冲区 </span>
                           <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>           <span class="token comment">// iMACD 指标的处理程序 </span>
                           <span class="token keyword">int</span> amount                <span class="token comment">// 复制值的数量 </span>
                           <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iMACDBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>macd_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iMACD indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  
<span class="token comment">//--- 以1标引指标缓冲区的值填充部分SignalBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>signal_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iMACD indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br></div></div><h2 id="_26-29-iobv"><a href="#_26-29-iobv" class="header-anchor">#</a> 26.29 iOBV</h2> <p>函数返回 平衡交易量(On Balance Volume) 指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iOBV</span><span class="token punctuation">(</span> 
   string                symbol<span class="token punctuation">,</span>             <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES       period<span class="token punctuation">,</span>             <span class="token comment">// 周期 </span>
   ENUM_APPLIED_VOLUME   applied_volume      <span class="token comment">// 计算的交易量类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>applied_volume</p> <p>[in] 使用的交易量。取值范围是 ENUM_APPLIED_VOLUME 枚举的常量之一。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                    Demo_iOBV.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iOBV technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//---  iOBV </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iOBV&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrLightSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iOBV <span class="token punctuation">,</span>             <span class="token comment">// 使用iOBV </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iOBV<span class="token punctuation">;</span>               <span class="token comment">// 函数类型  </span>
input ENUM_APPLIED_VOLUME  applied_volume<span class="token operator">=</span>VOLUME_TICK<span class="token punctuation">;</span>   <span class="token comment">// 交易量类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                   <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>        <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iOBVBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iOBV指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在平衡交易量指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iOBVBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iOBV<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iOBV</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>applied_volume<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构    </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 交易量类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_volume<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_OBV<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iOBV indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示平衡交易量指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iOBV(%s/%s, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           <span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_volume<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iOBV 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iOBV 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iOBVBuffer 数组大于交易品种/周期iOBV 指标的数量值，那么我们不会复制任何内容  </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以iOBV 指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iOBVBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住平衡交易量指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iOBV指标的指标缓冲区                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>obv_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// OBV 值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>        <span class="token comment">// iOBV 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount             <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iOBVBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>obv_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iOBV indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br></div></div><h2 id="_26-30-isar"><a href="#_26-30-isar" class="header-anchor">#</a> 26.30 iSAR</h2> <p>函数返回 抛物转向系统(Parabolic Stop and Reverse system)指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iSAR</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>      <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  period<span class="token punctuation">,</span>      <span class="token comment">// 周期 </span>
   <span class="token keyword">double</span>           step<span class="token punctuation">,</span>        <span class="token comment">// 逐步增加 </span>
   <span class="token keyword">double</span>           maximum      <span class="token comment">// 最大止损水平 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>step</p> <p>[in] 停止水平增量，通常是0.02。</p> <p>maximum</p> <p>[in] 最大停止水平，通常是0.2。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                    Demo_iSAR.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iSAR technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All the other parameters are similar to the standard Parabolic Stop and Reverse.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_chart_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- 绘制iSAR </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iSAR&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_ARROW </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrBlue </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iSAR<span class="token punctuation">,</span>              <span class="token comment">// 使用iSAR </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iSAR<span class="token punctuation">;</span>               <span class="token comment">// 函数类型  </span>
input <span class="token keyword">double</span>               step<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">;</span>                    <span class="token comment">// 步骤 - 停止拖拽的加速因素 </span>
input <span class="token keyword">double</span>               maximum<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">;</span>                  <span class="token comment">// 步骤的最大值 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                   <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>        <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iSARBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iSAR 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在抛物线转向指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iSARBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 从Wingdings字符集为PLOT_ARROW属性设置图表展示的交易品种代码 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_ARROW<span class="token punctuation">,</span><span class="token number">159</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iSAR<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iSAR</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>step<span class="token punctuation">,</span>maximum<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构    </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 步骤值 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_DOUBLE<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>double_value<span class="token operator">=</span>step<span class="token punctuation">;</span> 
      <span class="token comment">//--- 可以用于计算的步骤值的限制 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_DOUBLE<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>double_value<span class="token operator">=</span>maximum<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_SAR<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iSAR indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示抛物线转向指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iSAR(%s/%s, %G, %G)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           step<span class="token punctuation">,</span>maximum<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iSAR指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iSAR 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iSARBuffer数组大于交易品种/周期iSAR 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以iSAR 指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iSARBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住抛物线转向指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iSAR 指标的指标缓冲区                                           | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>sar_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 抛物线转向值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>        <span class="token comment">// iSAR 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount             <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iSARBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>sar_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iSAR indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>    
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br></div></div><h2 id="_26-31-irsi"><a href="#_26-31-irsi" class="header-anchor">#</a> 26.31 iRSI</h2> <p>函数返回 相对强度指数 指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iRSI</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种类型 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 ma_period<span class="token punctuation">,</span>         <span class="token comment">// 平均周期 </span>
   ENUM_APPLIED_PRICE  applied_price      <span class="token comment">// 价格或者处理器类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] RSI计算平均周期。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                    Demo_iRSI.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iRSI technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All the other parameters are similar to the standard Relative Strength Index.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- 绘制iRSI </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iRSI&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrDodgerBlue </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 在指标窗口显示值的限制 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_maximum <span class="token number">100</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_minimum <span class="token number">0</span> </span></span>
<span class="token comment">//--- 指标窗口的横向水平 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_level1  <span class="token number">70.0</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_level2  <span class="token number">30.0</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iRSI<span class="token punctuation">,</span>              <span class="token comment">// 使用iRSI </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iRSI<span class="token punctuation">;</span>               <span class="token comment">// 函数类型  </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>                 <span class="token comment">// 平均移动周期 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span>    <span class="token comment">// 价格类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                   <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>        <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iRSIBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iRSI指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在相对强度指数指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iRSIBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iRSI<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iRSI</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构    </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 平均移动周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 可以用于计算的步骤值的限制 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_RSI<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iRSI indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示相对强度指数指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iRSI(%s/%s, %d, %d)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           ma_period<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iRSI 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果 iRSI 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iRSIBuffer 数组大于交易品种/周期iRSI指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以iRSI指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iRSIBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住相对强度指数指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iRSI 指标的指标缓冲区                                           | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>rsi_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 相对强度指数值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>        <span class="token comment">// iRSI 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount             <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//---以0标引指标缓冲区的值填充部分iRSIBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>rsi_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iRSI indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>     
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br></div></div><h2 id="_26-32-irvi"><a href="#_26-32-irvi" class="header-anchor">#</a> 26.32 iRVI</h2> <p>函数返回 相对活力指数(Relative Vigor Index )指标的句柄处理器。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iRVI</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>        <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  period<span class="token punctuation">,</span>        <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              ma_period      <span class="token comment">// 平均周期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] RVI 计算平均周期。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>注意</p> <p>缓冲区代码如下： 0 - MAIN_LINE，1 - SIGNAL_LINE。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                    Demo_iRVI.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iRVI technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All the other parameters are similar to the standard Relative Vigor Index.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">2</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">2</span> </span></span>
<span class="token comment">//--- RVI 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;RVI&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 信号标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label2  </span><span class="token string">&quot;Signal&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type2   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color2  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style2  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width2  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iRVI<span class="token punctuation">,</span>              <span class="token comment">// 使用iRVI </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iRVI<span class="token punctuation">;</span>               <span class="token comment">// 函数类型  </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>                 <span class="token comment">// 计算周期 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                   <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>        <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         RVIBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         SignalBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iRVI指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在相对活力指数指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>RVIBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>SignalBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iRVI<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iRVI</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构    </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 计算周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_RVI<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iRVI indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示相对活力指数指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iRVI(%s/%s, %d, %d)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span>ma_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iRVI 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iRVI指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果RVIBuffer数组大于交易品种/周期iRVI 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以iRVI 指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>RVIBuffer<span class="token punctuation">,</span>SignalBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住相对活力指数指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充 iRVI 指标的指标缓冲区                                          | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>rvi_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment">// 相对活力指数值的指标缓冲区 </span>
                         <span class="token keyword">double</span> <span class="token operator">&amp;</span>signal_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 信号线的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>           <span class="token comment">// iRVI指标的处理程序 </span>
                         <span class="token keyword">int</span> amount                <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iRVIBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>rvi_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iRVI indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以1标引指标缓冲区的值填充部分SignalBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>signal_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iRVI indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br></div></div><h2 id="_26-33-istddev"><a href="#_26-33-istddev" class="header-anchor">#</a> 26.33 iStdDev</h2> <p>函数返回 标准偏差(Standard Deviation) 指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iStdDev</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 ma_period<span class="token punctuation">,</span>         <span class="token comment">// 平均周期 </span>
   <span class="token keyword">int</span>                 ma_shift<span class="token punctuation">,</span>          <span class="token comment">// 平移 </span>
   ENUM_MA_METHOD      ma_method<span class="token punctuation">,</span>         <span class="token comment">// 平滑类型 </span>
   ENUM_APPLIED_PRICE  applied_price      <span class="token comment">// 价格或者处理器类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 指标计算平均周期。</p> <p>ma_shift</p> <p>[in] 与价格图表有关的指标变化。</p> <p>ma_method</p> <p>[in] 平均类型。可以使 ENUM_MA_METHOD 中任意值。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                 Demo_iStdDev.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iStdDev technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All the other parameters are similar to the normal Standard Deviation.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iStdDev 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iStdDev&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrMediumSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iStdDev<span class="token punctuation">,</span>           <span class="token comment">// 使用iStdDev </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iStdDev<span class="token punctuation">;</span>         <span class="token comment">// 函数类型  </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>              <span class="token comment">// 平均周期 </span>
input <span class="token keyword">int</span>                  ma_shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token comment">// 移动 </span>
input ENUM_MA_METHOD       ma_method<span class="token operator">=</span>MODE_SMA<span class="token punctuation">;</span>        <span class="token comment">// 平滑类型 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span> <span class="token comment">// 价格类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iStdDevBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储 iStdDev 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在标准偏差指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iStdDevBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置移动 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>ma_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iStdDev<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iStdDev</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>ma_method<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构    </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 移动 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_shift<span class="token punctuation">;</span> 
      <span class="token comment">//--- 平滑类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_method<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_STDDEV<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iStdDev indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示标准偏差指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iStdDev(%s/%s, %d, %d, %s, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           ma_period<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>ma_method<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iStdDev指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iStdDev指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果 iStdDevBuffer 数组大于交易品种/周期iStdDev 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以标准偏差指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iStdDevBuffer<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住标准偏差指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iStdDev指标的指标缓冲区                                         | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>std_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 标准偏差线的指标缓冲区 </span>
                         <span class="token keyword">int</span> std_shift<span class="token punctuation">,</span>         <span class="token comment">// 标准偏差线的移动 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>        <span class="token comment">// iStdDev 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount             <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iStdDevBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span>std_shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>std_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iStdDev indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br></div></div><h2 id="_26-34-istochastic"><a href="#_26-34-istochastic" class="header-anchor">#</a> 26.34 iStochastic</h2> <p>函数返回 随机摆动(Stochastic Oscillator )指标的句柄。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iStochastic</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>          <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  period<span class="token punctuation">,</span>          <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              Kperiod<span class="token punctuation">,</span>         <span class="token comment">// K线周期 (用于计算的柱数) </span>
   <span class="token keyword">int</span>              Dperiod<span class="token punctuation">,</span>         <span class="token comment">// D线周期 (开始平滑周期) </span>
   <span class="token keyword">int</span>              slowing<span class="token punctuation">,</span>         <span class="token comment">// 最终平滑 </span>
   ENUM_MA_METHOD   ma_method<span class="token punctuation">,</span>       <span class="token comment">// 平滑类型 </span>
   ENUM_STO_PRICE   price_field      <span class="token comment">// 随机计算法 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>Kperiod</p> <p>[in] %K 线计算平均周期（计算柱）。</p> <p>Dperiod</p> <p>[in] %D 线计算平均周期（计算柱）。</p> <p>slowing</p> <p>[in] 减速值。</p> <p>ma_method</p> <p>[in] 平滑类型。取值范围是 ENUM_MA_METHOD 枚举值之一。</p> <p>price_field</p> <p>[in] 计算价格选择参数。取值范围是 ENUM_STO_PRICE 枚举值之一。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>注意</p> <p>缓冲区代码： 0 - MAIN_LINE， 1 - SIGNAL_LINE。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                             Demo_iStochastic.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iStochastic technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All the other parameters are similar to the standard Stochastic Oscillator.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">2</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">2</span> </span></span>
<span class="token comment">//--- 随机标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;Stochastic&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrLightSeaGreen </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 信号标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label2  </span><span class="token string">&quot;Signal&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type2   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color2  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style2  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width2  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 设置指标值的限制 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_minimum <span class="token number">0</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_maximum <span class="token number">100</span> </span></span>
<span class="token comment">//--- 指标窗口的横向水平 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_level1  <span class="token operator">-</span><span class="token number">100.0</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_level2  <span class="token number">100.0</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iStochastic<span class="token punctuation">,</span>       <span class="token comment">// 使用iStochastic </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iStochastic<span class="token punctuation">;</span>     <span class="token comment">// 函数类型 </span>
input <span class="token keyword">int</span>                  Kperiod<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>                 <span class="token comment">// K 线周期 (用于计算的柱数) </span>
input <span class="token keyword">int</span>                  Dperiod<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>                 <span class="token comment">// D 线周期(主要平滑周期) </span>
input <span class="token keyword">int</span>                  slowing<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>                 <span class="token comment">// 最后平滑周期       </span>
input ENUM_MA_METHOD       ma_method<span class="token operator">=</span>MODE_SMA<span class="token punctuation">;</span>        <span class="token comment">// 平滑类型  </span>
input ENUM_STO_PRICE       price_field<span class="token operator">=</span>STO_LOWHIGH<span class="token punctuation">;</span>   <span class="token comment">// 随机计算方法 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         StochasticBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         SignalBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iStochastic指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在随机震荡指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>StochasticBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>SignalBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iStochastic<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iStochastic</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>Kperiod<span class="token punctuation">,</span>Dperiod<span class="token punctuation">,</span>slowing<span class="token punctuation">,</span>ma_method<span class="token punctuation">,</span>price_field<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构    </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 用于计算的K线周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>Kperiod<span class="token punctuation">;</span> 
      <span class="token comment">//--- 用于主要平滑的D线周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>Dperiod<span class="token punctuation">;</span> 
      <span class="token comment">//--- 最后平滑的K线周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>slowing<span class="token punctuation">;</span> 
      <span class="token comment">//--- 平滑类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_method<span class="token punctuation">;</span> 
      <span class="token comment">//--- 随机计算方法 </span>
      pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>price_field<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_STOCHASTIC<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iStochastic indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示随机震荡指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iStochastic(%s/%s, %d, %d, %d, %s, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           Kperiod<span class="token punctuation">,</span>Dperiod<span class="token punctuation">,</span>slowing<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>ma_method<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>price_field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iStochastic指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iStochastic指标数量值更改 </span>
<span class="token comment">//---或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果StochasticBuffer数组大于交易品种/周期iStochastic 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以iStochastic 指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span>StochasticBuffer<span class="token punctuation">,</span>SignalBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住随机震荡指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iStochastic指标的指标缓冲区                                     | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>main_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">// 随机震荡值的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>signal_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 信号线的指标缓冲区 </span>
                           <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>           <span class="token comment">// iStochastic 指标的处理程序 </span>
                           <span class="token keyword">int</span> amount                <span class="token comment">// 复制值的数量 </span>
                           <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分StochasticBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span>MAIN_LINE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>main_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iStochastic indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以1标引指标缓冲区的值填充部分SignalBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span>SIGNAL_LINE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>signal_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iStochastic indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br></div></div><h2 id="_26-35-itema"><a href="#_26-35-itema" class="header-anchor">#</a> 26.35 iTEMA</h2> <p>函数返回 三倍指数均线(Triple Exponential Moving Average) 指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iTEMA</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 ma_period<span class="token punctuation">,</span>         <span class="token comment">// 平均周期 </span>
   <span class="token keyword">int</span>                 ma_shift<span class="token punctuation">,</span>          <span class="token comment">// 指标平移 </span>
   ENUM_APPLIED_PRICE  applied_price      <span class="token comment">// 价格或者处理器类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 计算平均周期（计算K线柱数）。</p> <p>ma_shift</p> <p>[in] 与价格图表相关的指标变化。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                   Demo_iTEMA.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iTEMA technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All the other parameters are similar to the standard Triple Exponential Moving Average.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_chart_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iTEMA 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iTEMA&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iTEMA<span class="token punctuation">,</span>             <span class="token comment">// 使用iTEMA </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iTEMA<span class="token punctuation">;</span>           <span class="token comment">// 函数类型  </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>              <span class="token comment">// 平均周期 </span>
input <span class="token keyword">int</span>                  ma_shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token comment">// 移动 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span> <span class="token comment">// 价格类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iTEMABuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iTEMA 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在三倍指数移动平均指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iTEMABuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置移动 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>ma_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iTEMA<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iTEMA</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构    </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 移动 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_shift<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_TEMA<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iTEMA indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示三倍指数移动平均指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iTEMA(%s/%s, %d, %d, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           ma_period<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iTEMA 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iTEMA 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iTEMABuffer数组大于交易品种/周期iTEMA 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以三倍指数移动平均指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iTEMABuffer<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住三倍指数移动平均指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iTEMA 指标的指标缓冲区                                          | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>tema_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 三倍指数移动平均值的指标缓冲区 </span>
                         <span class="token keyword">int</span> t_shift<span class="token punctuation">,</span>           <span class="token comment">// 线的移动 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>        <span class="token comment">// iTEMA 指标的处理程序 </span>
                         <span class="token keyword">int</span> amount             <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iTEMABuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span>t_shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>tema_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iTEMA indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br></div></div><h2 id="_26-36-itrix"><a href="#_26-36-itrix" class="header-anchor">#</a> 26.36 iTriX</h2> <p>函数返回 三倍指数均线振荡(Triple Exponential Moving Averages Oscillator)指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iTriX</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 ma_period<span class="token punctuation">,</span>         <span class="token comment">// 平均周期 </span>
   ENUM_APPLIED_PRICE  applied_price      <span class="token comment">// 价格或者处理器类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>ma_period</p> <p>[in] 计算平均周期（计算K线柱数）。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                   Demo_iTriX.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iTriX technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iTriX标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iTriX&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iTriX<span class="token punctuation">,</span>             <span class="token comment">// 使用iTriX </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iTriX<span class="token punctuation">;</span>           <span class="token comment">// 函数类型  </span>
input <span class="token keyword">int</span>                  ma_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>              <span class="token comment">// 周期 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span> <span class="token comment">// 价格类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iTriXBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iTriX 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在三倍指数移动平均震荡指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iTriXBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iTriX<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iTriX</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>ma_period<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构    </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span>       
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_TRIX<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iTriX indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示三倍指数移动平均震荡指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iTriX(%s/%s, %d, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                          ma_period<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iTriX指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iTriX指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iTriXBuffer 数组大于交易品种/周期 iTriX 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以三倍指数移动平均震荡指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iTriXBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住三倍指数移动平均震荡指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iTriX 指标的指标缓冲区                                          | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>trix_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 三倍指数移动平均震荡值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>        <span class="token comment">// iTriX指标的处理程序 </span>
                         <span class="token keyword">int</span> amount             <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iTriXBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>trix_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iTriX indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br></div></div><h2 id="_26-37-iwpr"><a href="#_26-37-iwpr" class="header-anchor">#</a> 26.37 iWPR</h2> <p>函数返回 威廉指数(Larry Williams' Percent Range ) 指标。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iWPR</span><span class="token punctuation">(</span> 
   string           symbol<span class="token punctuation">,</span>          <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES  period<span class="token punctuation">,</span>          <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>              calc_period      <span class="token comment">// 平均周期 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>calc_period</p> <p>[in] 指标计算周期（计算K线柱）。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                    Demo_iWPR.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iWPR technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iWPR 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iWPR&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrCyan </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//--- 设置指标值的限制 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_minimum <span class="token operator">-</span><span class="token number">100</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_maximum <span class="token number">0</span> </span></span>
<span class="token comment">//--- 指标窗口的横向水平 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_level1  <span class="token operator">-</span><span class="token number">20.0</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_level2  <span class="token operator">-</span><span class="token number">80.0</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iWPR<span class="token punctuation">,</span>              <span class="token comment">// 使用iWPR </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iWPR<span class="token punctuation">;</span>            <span class="token comment">// 函数类型 </span>
input <span class="token keyword">int</span>                  calc_period<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>            <span class="token comment">// 周期 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iWPRBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iWPR 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在Larry Williams百分比范围指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iWPRBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iWPR<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iWPR</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>calc_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构    </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>calc_period<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_WPR<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iWPR indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示Larry Williams百分比范围指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iWPR(%s/%s, %d)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span>calc_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iWPR指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iWPR 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iWPRBuffer 数组大于交易品种/周期iWPR 指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以威廉姆斯百分比范围指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iWPRBuffer<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住Larry Williams百分比范围指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iWPR指标的指标缓冲区                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>wpr_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 威廉姆斯百分比范围值的指标缓冲区 </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>        <span class="token comment">// iWPR指标的处理程序 </span>
                         <span class="token keyword">int</span> amount             <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//---以0标引指标缓冲区的值填充部分iWPRBuffer数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>wpr_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iWPR indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br></div></div><h2 id="_26-38-ividya"><a href="#_26-38-ividya" class="header-anchor">#</a> 26.38 iVIDyA</h2> <p>函数返回 变量指数动态平均(Variable Index Dynamic Average)指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iVIDyA</span><span class="token punctuation">(</span> 
   string              symbol<span class="token punctuation">,</span>            <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES     period<span class="token punctuation">,</span>            <span class="token comment">// 周期 </span>
   <span class="token keyword">int</span>                 cmo_period<span class="token punctuation">,</span>        <span class="token comment">// Chande 动量指标周期 </span>
   <span class="token keyword">int</span>                 ema_period<span class="token punctuation">,</span>        <span class="token comment">// EMA 平滑周期 </span>
   <span class="token keyword">int</span>                 ma_shift<span class="token punctuation">,</span>          <span class="token comment">// 价格图表平移 </span>
   ENUM_APPLIED_PRICE  applied_price      <span class="token comment">// 价格或者处理器类型 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>period</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>cmo_period</p> <p>[in] 钱德动量摆动指标计算周期（计算K线柱数量）。</p> <p>ema_period</p> <p>[in] 平滑系数计算EMA 周期（计算K线柱数量）。</p> <p>ma_shift</p> <p>[in] 与价格图表相关的指标变化。</p> <p>applied_price</p> <p>[in] 应用价格。取值范围是 ENUM_APPLIED_PRICE 价格常量 或者 另外指标的句柄。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                  Demo_iVIDyA.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iVIDyA technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;All other parameters like in the standard Variable Index Dynamic Average.&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_chart_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iVIDyA 标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iVIDyA&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrBlue </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iVIDyA<span class="token punctuation">,</span>            <span class="token comment">// 使用iVIDyA </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iVIDyA<span class="token punctuation">;</span>          <span class="token comment">// 函数类型 </span>
input <span class="token keyword">int</span>                  cmo_period<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">;</span>             <span class="token comment">// Chande 动量周期 </span>
input <span class="token keyword">int</span>                  ema_period<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">;</span>             <span class="token comment">// 平滑因素周期 </span>
input <span class="token keyword">int</span>                  ma_shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token comment">// 移动 </span>
input ENUM_APPLIED_PRICE   applied_price<span class="token operator">=</span>PRICE_CLOSE<span class="token punctuation">;</span> <span class="token comment">// 价格类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>     <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iVIDyABuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iVIDyA 指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在变量指数动态平均指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iVIDyABuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置移动 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_SHIFT<span class="token punctuation">,</span>ma_shift<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iVIDyA<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iVIDyA</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>cmo_period<span class="token punctuation">,</span>ema_period<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构    </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- Chande 动量周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>cmo_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 平滑因素周期 </span>
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ema_period<span class="token punctuation">;</span> 
      <span class="token comment">//--- 移动 </span>
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>ma_shift<span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_price<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_VIDYA<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iVIDyA indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示变量指数动态平均指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iVIDyA(%s/%s, %d, %d, %d, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                           cmo_period<span class="token punctuation">,</span>ema_period<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iVIDyA 指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iVIDyA 指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iVIDyABuffer数组大于交易品种/周期iVIDyA指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以变量指数动态平均指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArrayFromBuffer 返回 false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span>iVIDyABuffer<span class="token punctuation">,</span>ma_shift<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住变量指数动态平均指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充iVIDyA 指标的指标缓冲区                                         | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArrayFromBuffer</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>vidya_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">// 变量指数动态平均值的指标缓冲区 </span>
                         <span class="token keyword">int</span> v_shift<span class="token punctuation">,</span>           <span class="token comment">// 线的移动  </span>
                         <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>        <span class="token comment">// iVIDyA指标的处理程序 </span>
                         <span class="token keyword">int</span> amount             <span class="token comment">// 复制值的数量 </span>
                         <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iVIDyABuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span>v_shift<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>vidya_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iVIDyA indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br></div></div><h2 id="_26-39-ivolumes"><a href="#_26-39-ivolumes" class="header-anchor">#</a> 26.39 iVolumes</h2> <p>函数返回 交易量 指标的句柄。它只有一个缓冲区。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">iVolumes</span><span class="token punctuation">(</span> 
   string               symbol<span class="token punctuation">,</span>             <span class="token comment">// 交易品种名称 </span>
   ENUM_TIMEFRAMES      period<span class="token punctuation">,</span>             <span class="token comment">// 周期 </span>
   ENUM_APPLIED_VOLUME  applied_volume      <span class="token comment">// 计算的交易量类型 </span>
   <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数</p> <p>symbol</p> <p>[in] 金融产品的交易品种名称，其报价数据应用于计算指标。 NULL 值代表当前交易品种。</p> <p>[in] 周期值的取值范围是 ENUM_TIMEFRAMES 枚举值之一，0代表当前时间表。</p> <p>applied_volume</p> <p>[in] 使用的交易量。取值范围是 ENUM_APPLIED_VOLUME 枚举的常量之一。</p> <p>返回值</p> <p>返回指定技术指标的句柄，如果失败则返回INVALID_HANDLE。使用指标句柄传递到的IndicatorRelease()函数，表示不再使用该指标并且释放计算机内存。</p> <p>例如：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                Demo_iVolumes.mq5 | </span>
<span class="token comment">//|                        Copyright 2011, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2011, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The indicator demonstrates how to obtain data&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;of indicator buffers for the iVolumes technical indicator.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;A symbol and timeframe used for calculation of the indicator,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;are set by the symbol and period parameters.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The method of creation of the handle is set through the 'type' parameter (function type).&quot;</span> </span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">2</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token comment">//--- iVolumes标图 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_label1  </span><span class="token string">&quot;iVolumes&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_COLOR_HISTOGRAM </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  clrGreen<span class="token punctuation">,</span> clrRed </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_style1  STYLE_SOLID </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_width1  <span class="token number">1</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 枚举处理创建方法                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">enum</span> <span class="token class-name">Creation</span> 
  <span class="token punctuation">{</span> 
   Call_iVolumes<span class="token punctuation">,</span>          <span class="token comment">// 使用iVolumes </span>
   Call_IndicatorCreate    <span class="token comment">// 使用IndicatorCreate </span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 输入参数 </span>
input Creation             type<span class="token operator">=</span>Call_iVolumes<span class="token punctuation">;</span>           <span class="token comment">// 函数类型 </span>
input ENUM_APPLIED_VOLUME  applied_volume<span class="token operator">=</span>VOLUME_TICK<span class="token punctuation">;</span>   <span class="token comment">// 交易量类型 </span>
input string               symbol<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">;</span>                   <span class="token comment">// 交易品种  </span>
input ENUM_TIMEFRAMES      period<span class="token operator">=</span>PERIOD_CURRENT<span class="token punctuation">;</span>        <span class="token comment">// 时间帧 </span>
<span class="token comment">//--- 指标缓冲区 </span>
<span class="token keyword">double</span>         iVolumesBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span>         iVolumesColors<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储iVolumes指标处理程序的变量 </span>
<span class="token keyword">int</span>    handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 存储变量 </span>
string name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 图表上的指标名称 </span>
string short_name<span class="token punctuation">;</span> 
<span class="token comment">//--- 我们将在交易量指标中保持值的数量 </span>
<span class="token keyword">int</span>    bars_calculated<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 分配指标缓冲区数组 </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>iVolumesBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>iVolumesColors<span class="token punctuation">,</span>INDICATOR_COLOR_INDEX<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 定义绘制指标的交易品种 </span>
   name<span class="token operator">=</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 删除向左和向右的空格 </span>
   <span class="token function">StringTrimRight</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">StringTrimLeft</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果它返回 'name' 字符串的零长度 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">StringLen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 获得指标附属的图表交易品种 </span>
      name<span class="token operator">=</span>_Symbol<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 创建指标处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>Call_iVolumes<span class="token punctuation">)</span> 
      handle<span class="token operator">=</span><span class="token function">iVolumes</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>applied_volume<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 以指标参数填充结构    </span>
      MqlParam pars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 价格类型 </span>
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token operator">=</span>TYPE_INT<span class="token punctuation">;</span> 
      pars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>integer_value<span class="token operator">=</span>applied_volume<span class="token punctuation">;</span> 
      handle<span class="token operator">=</span><span class="token function">IndicatorCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>period<span class="token punctuation">,</span>IND_VOLUMES<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>pars<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果没有创建处理程序 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 叙述失败和输出错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create handle of the iVolumes indicator for the symbol %s/%s, error code %d&quot;</span><span class="token punctuation">,</span> 
                  name<span class="token punctuation">,</span> 
                  <span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 指标提前停止 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 显示交易量指标计算的交易品种/时间帧 </span>
   short_name<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;iVolumes(%s/%s, %s)&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>applied_volume<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span>short_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 指标正常初始化   </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标迭代函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> datetime <span class="token operator">&amp;</span>time<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>spread<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 从iVolumes指标复制的值数 </span>
   <span class="token keyword">int</span> values_to_copy<span class="token punctuation">;</span> 
<span class="token comment">//--- 确定指标计算的数量值 </span>
   <span class="token keyword">int</span> calculated<span class="token operator">=</span><span class="token function">BarsCalculated</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;BarsCalculated() returned %d, error code %d&quot;</span><span class="token punctuation">,</span>calculated<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果它是指标计算的最初起点或如果iVolumes指标数量值更改 </span>
<span class="token comment">//--- 或如果需要计算两个或多个柱形的指标（这意味着价格历史中有些内容会发生变化） </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prev_calculated<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> calculated<span class="token operator">!=</span>bars_calculated <span class="token operator">||</span> rates_total<span class="token operator">&gt;</span>prev_calculated<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果iVolumesBuffer数组大于交易品种/周期iVolumes指标的数量值，那么我们不会复制任何内容 </span>
      <span class="token comment">//--- 否则，我们复制小于指标缓冲区的大小 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>calculated<span class="token operator">&gt;</span>rates_total<span class="token punctuation">)</span> values_to_copy<span class="token operator">=</span>rates_total<span class="token punctuation">;</span> 
      <span class="token keyword">else</span>                       values_to_copy<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 它意味着这不是初次指标计算，因为 OnCalculate())最近调用 </span>
      <span class="token comment">//--- 为了计算，添加不超过一柱 </span>
      values_to_copy<span class="token operator">=</span><span class="token punctuation">(</span>rates_total<span class="token operator">-</span>prev_calculated<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以iVolumes指标的值填充数组 </span>
<span class="token comment">//--- 如果FillArraysFromBuffer返回false，它表示信息还未准备，退出操作 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span>iVolumesBuffer<span class="token punctuation">,</span>iVolumesColors<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>values_to_copy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 形成信息 </span>
   string comm<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s ==&gt;  Updated value in the indicator %s: %d&quot;</span><span class="token punctuation">,</span> 
                            <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_DATE<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            short_name<span class="token punctuation">,</span> 
                            values_to_copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在图表上展示服务信息 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住交易量指标的数量值 </span>
   bars_calculated<span class="token operator">=</span>calculated<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回prev_calculated值以便下次调用 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 填充 iVolumes 指标的指标缓冲区                                      | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">FillArraysFromBuffers</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>volume_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// 交易量值的指标缓冲区 </span>
                           <span class="token keyword">double</span> <span class="token operator">&amp;</span>color_buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">// 颜色指标缓冲区 </span>
                           <span class="token keyword">int</span> ind_handle<span class="token punctuation">,</span>            <span class="token comment">// iVolumes 指标的处理程序 </span>
                           <span class="token keyword">int</span> amount                 <span class="token comment">// 复制值的数量 </span>
                           <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 重置错误代码 </span>
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 以0标引指标缓冲区的值填充部分iVolumesBuffer 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>volume_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iVolumes indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 以1标引指标缓冲区的值填充部分iVolumesColors 数组 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>ind_handle<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>color_buffer<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 如果复制失败，显示错误代码 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to copy data from the iVolumes indicator, error code %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 退出零结果 - 它表示被认为是不计算的指标 </span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 一切顺利 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 指标去初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 删除指标后清空图表 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mql5yao/Chapter/twentyfive.html" class="prev">
        25 第二十五章 物件函数
      </a></span> <span class="next"><a href="/mql5yao/Chapter/twentyseven.html">
        27 第二十七章 处理优化结果
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/mql5yao/assets/js/app.f23448f4.js" defer></script><script src="/mql5yao/assets/js/3.a8269cb7.js" defer></script><script src="/mql5yao/assets/js/18.49626d28.js" defer></script>
  </body>
</html>
