<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>智能交易*姚 文档站</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/mql5yao/favicon.ico">
    <meta name="description" content="这是智能交易的文档站点。">
    <meta name="keywords" content="MQL,EA,智能交易,自动交易,量化,编程,培训">
    
    <link rel="preload" href="/mql5yao/assets/css/0.styles.7f3ae2a1.css" as="style"><link rel="preload" href="/mql5yao/assets/js/app.8a48e4d1.js" as="script"><link rel="preload" href="/mql5yao/assets/js/2.8ccfeae3.js" as="script"><link rel="preload" href="/mql5yao/assets/js/1.abd3212e.js" as="script"><link rel="preload" href="/mql5yao/assets/js/17.15a8a4c2.js" as="script"><link rel="prefetch" href="/mql5yao/assets/js/10.f43632ba.js"><link rel="prefetch" href="/mql5yao/assets/js/11.1d038644.js"><link rel="prefetch" href="/mql5yao/assets/js/12.e50722f3.js"><link rel="prefetch" href="/mql5yao/assets/js/13.bc6e6556.js"><link rel="prefetch" href="/mql5yao/assets/js/14.5cb8131f.js"><link rel="prefetch" href="/mql5yao/assets/js/15.bc368dfb.js"><link rel="prefetch" href="/mql5yao/assets/js/16.60e872ed.js"><link rel="prefetch" href="/mql5yao/assets/js/18.a3079194.js"><link rel="prefetch" href="/mql5yao/assets/js/19.2e53fae9.js"><link rel="prefetch" href="/mql5yao/assets/js/20.ff88a6ab.js"><link rel="prefetch" href="/mql5yao/assets/js/21.24994246.js"><link rel="prefetch" href="/mql5yao/assets/js/22.5048fb10.js"><link rel="prefetch" href="/mql5yao/assets/js/23.b0f62895.js"><link rel="prefetch" href="/mql5yao/assets/js/24.47212fdf.js"><link rel="prefetch" href="/mql5yao/assets/js/25.31655e4d.js"><link rel="prefetch" href="/mql5yao/assets/js/26.eaeeac1b.js"><link rel="prefetch" href="/mql5yao/assets/js/27.62ad36df.js"><link rel="prefetch" href="/mql5yao/assets/js/28.69609490.js"><link rel="prefetch" href="/mql5yao/assets/js/29.bd4055a1.js"><link rel="prefetch" href="/mql5yao/assets/js/3.0ebc6d24.js"><link rel="prefetch" href="/mql5yao/assets/js/30.f43e33e8.js"><link rel="prefetch" href="/mql5yao/assets/js/31.08aac79a.js"><link rel="prefetch" href="/mql5yao/assets/js/32.e40034cb.js"><link rel="prefetch" href="/mql5yao/assets/js/33.f14c86ef.js"><link rel="prefetch" href="/mql5yao/assets/js/34.35c02b74.js"><link rel="prefetch" href="/mql5yao/assets/js/35.048a5906.js"><link rel="prefetch" href="/mql5yao/assets/js/36.7be7df03.js"><link rel="prefetch" href="/mql5yao/assets/js/37.caf30399.js"><link rel="prefetch" href="/mql5yao/assets/js/38.7081ef66.js"><link rel="prefetch" href="/mql5yao/assets/js/39.8b16de3c.js"><link rel="prefetch" href="/mql5yao/assets/js/4.64cdca5a.js"><link rel="prefetch" href="/mql5yao/assets/js/40.c4bcc68d.js"><link rel="prefetch" href="/mql5yao/assets/js/41.9e814ceb.js"><link rel="prefetch" href="/mql5yao/assets/js/42.626ed300.js"><link rel="prefetch" href="/mql5yao/assets/js/43.9e56dbd2.js"><link rel="prefetch" href="/mql5yao/assets/js/44.b0aa6080.js"><link rel="prefetch" href="/mql5yao/assets/js/45.1ee1c2de.js"><link rel="prefetch" href="/mql5yao/assets/js/46.c7e60312.js"><link rel="prefetch" href="/mql5yao/assets/js/47.294d2506.js"><link rel="prefetch" href="/mql5yao/assets/js/48.9896cb6c.js"><link rel="prefetch" href="/mql5yao/assets/js/49.0b669611.js"><link rel="prefetch" href="/mql5yao/assets/js/5.6e0bc11f.js"><link rel="prefetch" href="/mql5yao/assets/js/50.d4317362.js"><link rel="prefetch" href="/mql5yao/assets/js/51.7cde1a30.js"><link rel="prefetch" href="/mql5yao/assets/js/52.593fbf2b.js"><link rel="prefetch" href="/mql5yao/assets/js/53.47314628.js"><link rel="prefetch" href="/mql5yao/assets/js/54.9177a36c.js"><link rel="prefetch" href="/mql5yao/assets/js/55.890a40de.js"><link rel="prefetch" href="/mql5yao/assets/js/56.950e221a.js"><link rel="prefetch" href="/mql5yao/assets/js/57.42541ac8.js"><link rel="prefetch" href="/mql5yao/assets/js/58.b782ed1e.js"><link rel="prefetch" href="/mql5yao/assets/js/59.0f7a8fa5.js"><link rel="prefetch" href="/mql5yao/assets/js/6.30ab1089.js"><link rel="prefetch" href="/mql5yao/assets/js/60.bb949f49.js"><link rel="prefetch" href="/mql5yao/assets/js/61.fb831bab.js"><link rel="prefetch" href="/mql5yao/assets/js/62.1d11fcd0.js"><link rel="prefetch" href="/mql5yao/assets/js/63.5e21940a.js"><link rel="prefetch" href="/mql5yao/assets/js/7.7481afc6.js"><link rel="prefetch" href="/mql5yao/assets/js/vendors~docsearch.b8e67d2d.js">
    <link rel="stylesheet" href="/mql5yao/assets/css/0.styles.7f3ae2a1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mql5yao/" class="home-link router-link-active"><img src="/mql5yao/logo.png" alt="智能交易*姚 文档站" class="logo"> <span class="site-name can-hide">智能交易*姚 文档站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mql5yao/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mql5yao/Chapter/start.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/mql5yao/Cutleeks/" class="nav-link">
  割韭菜XX招
</a></div><div class="nav-item"><a href="/mql5yao/support/" class="nav-link">
  支持本站
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mql5yao/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mql5yao/Chapter/start.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/mql5yao/Cutleeks/" class="nav-link">
  割韭菜XX招
</a></div><div class="nav-item"><a href="/mql5yao/support/" class="nav-link">
  支持本站
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MQL5线上手册</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mql5yao/Chapter/start.html" class="sidebar-link">MQL5 参考</a></li><li><a href="/mql5yao/Chapter/one.html" class="sidebar-link">01 第一章 语言基础</a></li><li><a href="/mql5yao/Chapter/two.html" class="sidebar-link">02 第二章 标准常量，列举和架构</a></li><li><a href="/mql5yao/Chapter/three.html" class="sidebar-link">03 第三章 MQL5程序</a></li><li><a href="/mql5yao/Chapter/four.html" class="sidebar-link">04 第四章 预定义变量</a></li><li><a href="/mql5yao/Chapter/five.html" class="sidebar-link">05 第五章 普通函数</a></li><li><a href="/mql5yao/Chapter/six.html" class="sidebar-link">06 第六章 数组函数</a></li><li><a href="/mql5yao/Chapter/add1.html" class="sidebar-link">07 第七章 矩阵和向量方法</a></li><li><a href="/mql5yao/Chapter/seven.html" class="sidebar-link">08 第八章 函数转换</a></li><li><a href="/mql5yao/Chapter/eight.html" class="sidebar-link">09 第九章 数学函数</a></li><li><a href="/mql5yao/Chapter/nine.html" class="sidebar-link">10 第十章 字符串函数</a></li><li><a href="/mql5yao/Chapter/ten.html" class="sidebar-link">11 第十一章 日期和时间</a></li><li><a href="/mql5yao/Chapter/eleven.html" class="sidebar-link">12 第十二章 账户信息</a></li><li><a href="/mql5yao/Chapter/twelve.html" class="sidebar-link">13 第十三章 检测</a></li><li><a href="/mql5yao/Chapter/thirteen.html" class="sidebar-link">14 第十四章 事件处理</a></li><li><a href="/mql5yao/Chapter/fourteen.html" class="sidebar-link">15 第十五章 市场信息</a></li><li><a href="/mql5yao/Chapter/fifteen.html" class="sidebar-link">16 第十六章 经济日历函数</a></li><li><a href="/mql5yao/Chapter/sixteen.html" class="sidebar-link">17 第十七章 时间序列和指标访问</a></li><li><a href="/mql5yao/Chapter/seventeen.html" class="sidebar-link">18 第十八章 自定义交易品种</a></li><li><a href="/mql5yao/Chapter/eighteen.html" class="sidebar-link">19 第十九章 图表操作</a></li><li><a href="/mql5yao/Chapter/ninteen.html" class="sidebar-link">20 第二十章 交易函数</a></li><li><a href="/mql5yao/Chapter/twenty.html" class="sidebar-link">21 第廿一章 交易信号</a></li><li><a href="/mql5yao/Chapter/twentyone.html" class="sidebar-link">22 第廿二章 网络函数</a></li><li><a href="/mql5yao/Chapter/twentytwo.html" class="sidebar-link">23 第廿三章 程序端全局变量</a></li><li><a href="/mql5yao/Chapter/twentythree.html" class="sidebar-link">24 第廿四章 文件函数</a></li><li><a href="/mql5yao/Chapter/twentyfour.html" class="sidebar-link">25 第廿五章 自定义指标</a></li><li><a href="/mql5yao/Chapter/twentyfive.html" class="sidebar-link">26 第廿六章 物件函数</a></li><li><a href="/mql5yao/Chapter/twentysix.html" class="sidebar-link">27 第廿七章 技术指标</a></li><li><a href="/mql5yao/Chapter/twentyseven.html" class="sidebar-link">28 第甘八章 处理优化结果</a></li><li><a href="/mql5yao/Chapter/twentyeight.html" class="sidebar-link">29 第廿九章 工作事件</a></li><li><a href="/mql5yao/Chapter/twentynine.html" class="sidebar-link">30 第三十章 使用OpenCL工作</a></li><li><a href="/mql5yao/Chapter/thirty.html" class="sidebar-link">31 第卅一章 使用数据库</a></li><li><a href="/mql5yao/Chapter/thirtyone.html" class="sidebar-link">32 第卅二章 使用DirectX</a></li><li><a href="/mql5yao/Chapter/thirtytwo.html" class="sidebar-link">33 第卅三章 MetaTrader与Python集成的模块</a></li><li><a href="/mql5yao/Chapter/add2.html" aria-current="page" class="active sidebar-link">34 第卅四章 ONNX模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-1-mql5中的onnx支持" class="sidebar-link">34.1  MQL5中的ONNX支持</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-2-format-conversion-格式转换" class="sidebar-link">34.2  Format Conversion（格式转换）</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-3-运行onnx模型时自动转换输入和输出值" class="sidebar-link">34.3  运行ONNX模型时自动转换输入和输出值</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-4-创建模型" class="sidebar-link">34.4  创建模型</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-5-运行模型" class="sidebar-link">34.5  运行模型</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-6-策略测试中的模型验证" class="sidebar-link">34.6  策略测试中的模型验证</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-7-onnxcreate" class="sidebar-link">34.7  OnnxCreate</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-8-onnxcreatefrombuffer" class="sidebar-link">34.8  OnnxCreateFromBuffer</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-9-onnxrelease" class="sidebar-link">34.9  OnnxRelease</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-10-onnxrun" class="sidebar-link">34.10  OnnxRun</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-11-onnxgetinputcount" class="sidebar-link">34.11  OnnxGetInputCount</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-12-onnxgetoutputcount" class="sidebar-link">34.12  OnnxGetOutputCount</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-13-onnxgetinputname" class="sidebar-link">34.13  OnnxGetInputName</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-14-onnxgetoutputname" class="sidebar-link">34.14  OnnxGetOutputName</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-15-onnxgetinputtypeinfo" class="sidebar-link">34.15  OnnxGetInputTypeInfo</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-16-onnxgetoutputtypeinfo" class="sidebar-link">34.16 OnnxGetOutputTypeInfo</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-17-onnxsetinputshape" class="sidebar-link">34.17  OnnxSetInputShape</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-18-onnxsetoutputshape" class="sidebar-link">34.18  OnnxSetOutputShape</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/add2.html#_34-19-数据结构" class="sidebar-link">34.19  数据结构</a></li></ul></li><li><a href="/mql5yao/Chapter/thirtythree.html" class="sidebar-link">35 第卅五章 标准程序库</a></li><li><a href="/mql5yao/Chapter/AppendixI.html" class="sidebar-link">36 附录一 来自MQL4</a></li><li><a href="/mql5yao/Chapter/AppendixII.html" class="sidebar-link">37 附录二 MQL5 函数列表</a></li><li><a href="/mql5yao/Chapter/AppendixIII.html" class="sidebar-link">38 附录三 MQL5常量列表</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2>第卅四章 机器学习中的ONNX模型</h2> <p>ONNX (Open Neural Network Exchange)是机器学习模型的开源格式。这个项目有几个主要优势：</p> <ul><li>ONNX得到Microsoft、Facebook、Amazon等大公司的支持。</li> <li>它的开放格式支持不同机器学习工具包之间的格式转换，而Microsoft（微软） ONNXMLTools允许将模型转换为ONNX格式。</li> <li>如果传递的参数类型与模型不匹配，MQL5会为模型输入和输出提供自动数据类型转换。</li> <li>ONNX模型可以使用各种机器学习工具创建。目前在Caffe2、Microsoft Cognitive Toolkit、MXNet、PyTorch和OpenCV中得到支持。还可以使用其他流行框架和程序库的接口。</li> <li>借助MQL5语言，您可以在交易策略中实施ONNX模型，并将其与MetaTrader 5平台的所有优势结合使用，从而在金融市场中实现高效操作。</li> <li>在为实时交易调整模型之前，您可以在策略测试中根据历史数据测试模型行为，而无需使用第三方工具。</li></ul> <p>MQL5为使用ONNX提供以下函数：</p> <table><thead><tr><th>函数</th> <th>操作</th></tr></thead> <tbody><tr><td>OnnxCreate</td> <td>创建ONNX会话，从 *.onnx文件中加载模型</td></tr> <tr><td>OnnxCreateFromBuffer</td> <td>创建ONNX会话，从数据数组加载模型</td></tr> <tr><td>OnnxRelease</td> <td>关闭ONNX会话</td></tr> <tr><td>OnnxRun</td> <td>运行ONNX模型</td></tr> <tr><td>OnnxGetInputCount</td> <td>获取ONNX模型中的输入数</td></tr> <tr><td>OnnxGetOutputCount</td> <td>获取ONNX模型中的输出数</td></tr> <tr><td>OnnxGetInputName</td> <td>通过索引获取模型输入名称</td></tr> <tr><td>OnnxGetOutputName</td> <td>通过索引获取模型输出名称</td></tr> <tr><td>OnnxGetInputTypeInfo</td> <td>从模型获取输入类型的描述</td></tr> <tr><td>OnnxGetOutputTypeInfo</td> <td>从模型获取输出类型的描述</td></tr> <tr><td>OnnxSetInputShape</td> <td>通过索引设置模型输入数据的形状</td></tr> <tr><td>OnnxSetOutputShape</td> <td>通过索引设置模型输出数据的形状</td></tr></tbody></table> <h2 id="_34-1-mql5中的onnx支持"><a href="#_34-1-mql5中的onnx支持" class="header-anchor">#</a> 34.1  MQL5中的ONNX支持</h2> <p>ONNX是一种用于表示机器学习模型的开放格式构建。该标准定义了一组通用的运算符和通用的文件格式，使开发人员能够使用不同框架、工具、运行时间和编译器的模型。</p> <p>因此，ONNX开放格式允许您在不同的平台和机器学习工具包之间接收和传输机器学习模型。ONNX以MQL5语言实施，使AI开发人员能够在MetaTrader 5平台提供的高性能执行环境中运行创建的模型。</p> <p>MQL5执行速度与C++应用程序的执行速度相当。MQL5和C++标准测试的执行结果证明了这一点。柱形图越低，执行所花费的时间越少（以毫秒为单位），结果越好。测试执行在Windows 10(build 17763) x64、Xeon E5-2630 v4 @ 2.20GHz、内存：65457 Mb。</p> <p>MQL5与MQL4的与C++ 速度比较</p> <p><img src="/mql5yao/assets/img/mql4_vs_mql5_vs_cpp.51697e97.png" alt="fpr-tpr"></p> <p>新异步交易操作和本地ONNX支持为您提供了以前只有少数专业AI开发人员和机构交易者才能获得的新机会。MQL5中的ONNX支持使交易者能够在他们喜欢的开发环境中训练金融市场交易模型，然后以低网络成本、高订单簿更新速度和异步订单提交进行交易。</p> <p>目前，ONNX正在由Microsoft（微软）、Facebook、Amazon（亚马逊）等合作伙伴公司共同开发和维护，为这个开放项目的进一步发展提供了保障。</p> <h2 id="_34-2-format-conversion-格式转换"><a href="#_34-2-format-conversion-格式转换" class="header-anchor">#</a> 34.2  Format Conversion（格式转换）</h2> <p>ONNX是一个开放格式，允许使用来自不同机器学习工具包的模型。许多框架都支持该格式，包括Chainer、 Caffee2和PyTorch。</p> <p>将模型转换为ONNX格式的最受欢迎的工具之一是微软ONNXMLTools。</p> <p>ONNXMLTools安装和使用说明可在 GitHub repo中获得。目前支持以下工具包：</p> <ul><li>Keras (a wrapper of keras2onnx converter)</li> <li>Tensorflow (a wrapper of tf2onnx converter)</li> <li>scikit-learn (a wrapper of skl2onnx converter)</li> <li>Apple Core ML</li> <li>Spark ML (experimental)</li> <li>LightGBM</li> <li>libscm;</li> <li>XGBoost;</li> <li>H2O</li> <li>CatBoost</li></ul> <p>ONNXMLTools可以轻松安装。有关安装细节和模型转换示例，请参阅项目页https://github.com/onnx/onnxmltools#install。</p> <h2 id="_34-3-运行onnx模型时自动转换输入和输出值"><a href="#_34-3-运行onnx模型时自动转换输入和输出值" class="header-anchor">#</a> 34.3  运行ONNX模型时自动转换输入和输出值</h2> <p>MQL5中当前ONNX版本仅支持输入/输出值的张量。张量是包含以下数据类型元素的数据数组：</p> <table><thead><tr><th>ONNX类型</th> <th>对应于MQL5类型</th></tr></thead> <tbody><tr><td>ONNX_DATA_TYPE_BOOL</td> <td>布尔型</td></tr> <tr><td>ONNX_DATA_TYPE_FLOAT</td> <td>浮点型</td></tr> <tr><td>ONNX_DATA_TYPE_UINT8</td> <td>无字符型(uchar)&lt;</td></tr> <tr><td>ONNX_DATA_TYPE_INT8</td> <td>字符型(char)</td></tr> <tr><td>ONNX_DATA_TYPE_UINT16</td> <td>无符短型(ushort)</td></tr> <tr><td>ONNX_DATA_TYPE_INT16</td> <td>短整型(short)</td></tr> <tr><td>ONNX_DATA_TYPE_INT32</td> <td>整型(int)</td></tr> <tr><td>ONNX_DATA_TYPE_INT64</td> <td>长整型(long)</td></tr> <tr><td>ONNX_DATA_TYPE_FLOAT16</td> <td>―</td></tr> <tr><td>ONNX_DATA_TYPE_DOUBLE</td> <td>双精度</td></tr> <tr><td>ONNX_DATA_TYPE_UINT32</td> <td>无符号整型(uint)</td></tr> <tr><td>ONNX_DATA_TYPE_UINT64</td> <td>无符长型(ulong)</td></tr> <tr><td>ONNX_DATA_TYPE_COMPLEX64</td> <td>―</td></tr> <tr><td>ONNX_DATA_TYPE_COMPLEX128</td> <td>复杂型</td></tr> <tr><td>ONNX_DATA_TYPE_BFLOAT16</td> <td>―</td></tr> <tr><td>ONNX_DATA_TYPE_STRING</td> <td>―</td></tr></tbody></table> <p>只有数组、向量和矩阵（我们将它们称为数据）可作为输入/输出值进入ONNX模型。</p> <p>如果参数类型与ONNX模型的参数类型不匹配，并且在没有指定ONNX_NO_CONVERSION标识的情况下调用OnnxRun，将应用自动数据转换。自动转换意味着在运行ONNX模型之前，用户数据将通过相关转换被复制到ONNX张量中。</p> <p>当ONNX模型在没有自动转换的情况下运行时，将使用数据计算模型，而无需任何额外的复制。</p> <p>重要！自动转换不控制过载（截断），因此您应该仔细监控输入到ONNX模型中的数据和数据类型。</p> <p>自动转换支持以下ONNX类型：</p> <ul><li>ONNX_DATA_TYPE_BOOL</li> <li>ONNX_DATA_TYPE_FLOAT</li> <li>ONNX_DATA_TYPE_UINT8</li> <li>ONNX_DATA_TYPE_INT8</li> <li>ONNX_DATA_TYPE_UINT16</li> <li>ONNX_DATA_TYPE_INT16</li> <li>ONNX_DATA_TYPE_INT32</li> <li>ONNX_DATA_TYPE_INT64</li> <li>ONNX_DATA_TYPE_FLOAT16</li> <li>ONNX_DATA_TYPE_DOUBLE</li> <li>ONNX_DATA_TYPE_UINT32</li> <li>ONNX_DATA_TYPE_UINT64</li> <li>ONNX_DATA_TYPE_COMPLEX64</li> <li>ONNX_DATA_TYPE_COMPLEX128</li></ul> <p>不支持的类型：</p> <ul><li>ONNX_DATA_TYPE_BFLOAT16</li> <li>ONNX_DATA_TYPE_STRING</li></ul> <p>张量类型的自动转换规则</p> <p>如果MQL5类型未包含在模型支持的类型列表中，运行ONNX模型将返回ERR_ONNX_NOT_SUPPORTED错误（错误代码5802）。</p> <p>注意：自动转换时，color类型被处理为uint，而datetime被处理为long。</p> <p><strong>输入值的自动转换</strong></p> <table><thead><tr><th>ONNX类型（张量项目类型）</th> <th>自动转换支持的MQL5类型</th></tr></thead> <tbody><tr><td>ONNX_DATA_TYPE_BOOL</td> <td>bool, char, uchar, short, ushort, int, color, uint, datetime, long,  folat, double, complex<br>在转换过程中，通过与0的简单比较来检查Data元素</td></tr> <tr><td>ONNX_DATA_TYPE_FLOAT16</td> <td>float, double</td></tr> <tr><td>ONNX_DATA_TYPE_FLOAT</td> <td>char, uchar, short, ushort, int, color, uint, datetime, long, ulong, float, double</td></tr> <tr><td>ONNX_DATA_TYPE_UINT8</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_INT8</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_UINT16</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_INT16</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_INT32</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_INT64</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_DOUBLE</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_UINT32</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_UINT64</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_COMPLEX64</td> <td>复杂型</td></tr> <tr><td>ONNX_DATA_TYPE_COMPLEX128</td> <td>复杂型</td></tr></tbody></table> <p><strong>输出值的自动转换</strong></p> <table><thead><tr><th>ONNX类型（张量项目类型）</th> <th>自动转换支持的MQL5类型</th></tr></thead> <tbody><tr><td>ONNX_DATA_TYPE_BOOL</td> <td>bool, char, uchar, short, ushort, int, color, uint, datetime, long,  folat, double, complex<br>如果张量元素为零，则Data元素设为0；否则，该值为1</td></tr> <tr><td>ONNX_DATA_TYPE_FLOAT16</td> <td>float, double</td></tr> <tr><td>ONNX_DATA_TYPE_FLOAT</td> <td>char, uchar, short, ushort, int, color, uint, datetime, long, ulong, float, double</td></tr> <tr><td>ONNX_DATA_TYPE_UINT8</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_INT8</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_UINT16</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_INT16</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_INT32</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_INT64</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_DOUBLE</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_UINT32</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_UINT64</td> <td>请见ONNX_DATA_TYPE_FLOAT</td></tr> <tr><td>ONNX_DATA_TYPE_COMPLEX64</td> <td>复杂型</td></tr> <tr><td>ONNX_DATA_TYPE_COMPLEX128</td> <td>复杂型</td></tr></tbody></table> <h2 id="_34-4-创建模型"><a href="#_34-4-创建模型" class="header-anchor">#</a> 34.4  创建模型</h2> <p>有多种方法可以获得ONNX格式的现有模型。受欢迎的ONNX Model Zoo程序库包含针对不同任务类型的几个预训练ONNX模型。这个集合的优势是每个模型的笔记本都包含训练数据集的链接和对描述模型体系结构的原始论文的引用。</p> <p>大部分机器学习框架使用Python。要对Python安装ONNX runtime，请在以下命令中选择一个：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>pip install onnxruntime       # CPU build
pip install onnxruntime-gpu   # GPU build
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>要在Python中调用ONNX runtime，请使用以下命令</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>import onnxruntime
session = onnxruntime.InferenceSession(&quot;path to model&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对于模型输入和输出， 请检查相关模型的文档。您还可以使用可视化工具来查看模型，例如Netron或WinML Dashboard。在ONNX runtime中, 您还可以查询模型的元数据及其输入和输出：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>results = session.run([&quot;output1&quot;, &quot;output2&quot;], {
                      &quot;input1&quot;: indata1, &quot;input2&quot;: indata2})
results = session.run([], {&quot;input1&quot;: indata1, &quot;input2&quot;: indata2})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>您可以使用Python直接在MetaTrader 5程序端或MetaEditor中创建ONNX模型。</p> <p>MetaTrader 5中的Python</p> <p>MetaTrader 5为Python脚本提供了即时可用的支持。若要启用这些操作，程序端开发人员提供了MetaTrader5 Python模块：https://pypi.org/project/MetaTrader5。</p> <p>在MetaEditor集成开发环境中，除了用MQL5创建应用程序外，还可以直接从编辑器中运行Python脚本。为此，请在MetaEditor设置中指定可执行文件的路径：</p> <p><img src="/mql5yao/assets/img/metaeditor__settings.c05c1a3d.png" alt="metaeditor settings"></p> <p>在MetaEditor设置中设置Python可执行文件的路径
如果您的计算机上没有安装Python，请点击“安装”并下载安装文件。</p> <p>您可以在MetaEdtior中创建Python脚本，或者将其上传到程序端的数据文件夹中，并使用F7 (Compile)键立即运行。这将打开MetaTrader 5程序端，脚本在当前图表上运行。来自Python控制板(stdout, stderr)的消息将显示在错误部分。</p> <p>MetaTrader 5中的模型操作
MQL5语言允许您直接在MetaTrader 5程序端中运行ONNX模型。分为三个步骤：</p> <ol><li>在第三方平台（例如 Python）中训练模型。</li> <li>将模型转换为ONNX。</li> <li>使用ONNX函数将ONNX模型加入到EA交易中，并在MetaTrader 5程序端中运行。</li></ol> <p>MQL5中的Python集成允许运行python脚本并在MetaEditor中保存ONNX模型或直接在MetaTrader 5图表上运行。您可以在程序端中根据需要随时使用预先编写的Python脚本来训练模型。该程序库包含用于获取价格数据的现有函数，这些数据可以输入到ONNX模型中：</p> <ul><li>copy_rates_from - 获取从指定日期开始的柱形图</li> <li>copy_rates_from_pos - 获取从指定索引开始的柱形图</li> <li>copy_ticks_range - 获取指定日期范围的柱形图</li> <li>copy_ticks_from - 获取从指定日期开始的报价</li> <li>copy_ticks_range - 获取指定日期范围的报价</li></ul> <p>模型示例 #</p> <p>完整的ONNX模型示例可在公共项目中获得。您应该首先在导航器中通过在MetaEditor设置中指定您的MQL5登录名（区分大小写）激活MQL5存储。</p> <p><img src="/mql5yao/assets/img/activate_storage.d0f8275a.png" alt="activate_storage"></p> <p>激活后，找到ONNX.Price.Prediction项目并通过快捷菜单命令加入。</p> <p><img src="/mql5yao/assets/img/project_join.4303c5dd.png" alt="project join"></p> <p>接下来，从MQL5存储更新项目。</p> <p><img src="/mql5yao/assets/img/update_project.b4c03253.png" alt="update_project"></p> <p>该项目包含一个ONNX模型、两个python脚本、一个用于项目操作的MQL5脚本和一个MQL5项目文件 (ONNX.Price.Prediction.mqproj)。</p> <p><img src="/mql5yao/assets/img/python_script.7a9e4522.png" alt="python_script"></p> <p>您可以使用项目中包含的PricePredictionTraining.py脚本自行创建ONNX模型。为此，您应该首先从命令行安装所需的模块。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>python.exe -m pip install --upgrade pip
python -m pip install --upgrade tensorflow
python -m pip install --upgrade pandas
python -m pip install --upgrade scikit-learn
python -m pip install --upgrade matplotlib
python -m pip install --upgrade tqdm
python -m pip install --upgrade metatrader5
python -m pip install --upgrade onnx==1.12
python -m pip install --upgrade tf2onnx
python -m pip install --upgrade numpy
python -m pip install onnxruntime
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>安装模块后，在MetaEditor中打开PricePredictionTraining.py脚本，并使用编译按键或F7键运行它。</p> <p><img src="/mql5yao/assets/img/python_script_compile_zoom100.2cc1a199.png" alt="python_script_compile"></p> <p>在运行Python脚本之前，请确保MetaTrader 5程序端已连接到具有EURUSD交易品种可用的服务器。例如，连接到MetaQuotes-Demo服务器，并在程序端设置中选中“与Python集成”。</p> <p><img src="/mql5yao/assets/img/terminal_py_integration_check_box.e8013a20.png" alt="terminal_py_integration_check_box"></p> <p>在训练网络时，MetaEditor将打印来自Python脚本的消息，直到训练完成。</p> <p><img src="/mql5yao/assets/img/onnx_model_ready.483529c8.png" alt="onnx_model_ready"></p> <p>当结果为100%时，ONNX模型准备就绪，它被保存到位于</p> <p><code>&lt;terminal data directory&gt;\MQL5\Shared Projects\ONNX.Price.Prediction\Python</code></p> <p>的项目文件夹中。</p> <p>您可以通过运行第二个脚本PricePrediction.py，按 F7来检查生成的模型。</p> <p><img src="/mql5yao/assets/img/prediction_result.7aa59a90.png" alt="prediction result"></p> <h2 id="_34-5-运行模型"><a href="#_34-5-运行模型" class="header-anchor">#</a> 34.5  运行模型</h2> <p>要在MQL5中运行ONNX模型，请完成以下3个步骤：</p> <ol><li>使用OnnxCreate函数从*.onnx文件中加载模型或使用OnnxCreateFromBuffer函数从数组中加载模型。</li> <li>使用OnnxSetInputShape和OnnxSetOutputShape函数指定输入和输出数据形状。</li> <li>使用OnnxRun函数运行模型，并将相关的输入和输出参数传递到这里。</li> <li>当需要时，您可以使用OnnxRelease函数终止模型操作。</li></ol> <p>在创建ONNX模型时，您应该考虑现有的范围和限制，请参阅https://github.com/microsoft/onnxruntime/blob/rel-1.14.0/docs/OperatorKernels.md</p> <p>这类限制的一些示例如下：</p> <table><thead><tr><th>Operation</th> <th>支持的数据类型</th></tr></thead> <tbody><tr><td>ReduceSum</td> <td>tensor(double), tensor(float), tensor(int32), tensor(int64)</td></tr> <tr><td>Mul</td> <td>tensor(bfloat16), tensor(double), tensor(float), tensor(float16), tensor(int32), tensor(int64), tensor(uint32), tensor(uint64)</td></tr></tbody></table> <p>下面是来自公共项目ONNX.Price.Prediction的MQL5代码示例。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>
<span class="token keyword">const</span> <span class="token keyword">long</span>   ExtOutputShape<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 模型输出形状</span>
<span class="token keyword">const</span> <span class="token keyword">long</span>   ExtInputShape <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 模型输入形状</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">resource</span> <span class="token string">&quot;Python/model.onnx&quot;</span> <span class="token expression">as uchar ExtModel<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token comment">// 作为资源的模型</span></span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| 脚本程序起始函数                                                   |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">int</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   matrix rates<span class="token punctuation">;</span>
<span class="token comment">//--- 获取10个柱形图</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rates<span class="token punctuation">.</span><span class="token function">CopyRates</span><span class="token punctuation">(</span><span class="token string">&quot;EURUSD&quot;</span><span class="token punctuation">,</span>PERIOD_H1<span class="token punctuation">,</span>COPY_RATES_OHLC<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 输入一组OHLC向量</span>
   matrix x_norm<span class="token operator">=</span>rates<span class="token punctuation">.</span><span class="token function">Transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   vector m<span class="token operator">=</span>x_norm<span class="token punctuation">.</span><span class="token function">Mean</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               
   vector s<span class="token operator">=</span>x_norm<span class="token punctuation">.</span><span class="token function">Std</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   matrix <span class="token function">mm</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   matrix <span class="token function">ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 填充归一化矩阵</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      mm<span class="token punctuation">.</span><span class="token function">Row</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ms<span class="token punctuation">.</span><span class="token function">Row</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 标准化输入数据</span>
   x_norm<span class="token operator">-=</span>mm<span class="token punctuation">;</span>
   x_norm<span class="token operator">/=</span>ms<span class="token punctuation">;</span>
<span class="token comment">//--- 创建模型</span>
   <span class="token keyword">long</span> handle<span class="token operator">=</span><span class="token function">OnnxCreateFromBuffer</span><span class="token punctuation">(</span>ExtModel<span class="token punctuation">,</span>ONNX_DEBUG_LOGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 指定输入数据形状</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxSetInputShape</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ExtInputShape<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;OnnxSetInputShape failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 指定输出数据形状</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxSetOutputShape</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ExtOutputShape<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;OnnxSetOutputShape failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 将标准化输入数据转换为浮点类型</span>
   matrixf x_normf<span class="token punctuation">;</span>
   x_normf<span class="token punctuation">.</span><span class="token function">Assign</span><span class="token punctuation">(</span>x_norm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 在这里获取模型的输出数据，即价格预测</span>
   vectorf <span class="token function">y_norm</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 运行模型</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxRun</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span>ONNX_DEBUG_LOGS <span class="token operator">|</span> ONNX_NO_CONVERSION<span class="token punctuation">,</span>x_normf<span class="token punctuation">,</span>y_norm<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;OnnxRun failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 将模型的输出值打印到日志中</span>
   <span class="token function">Print</span><span class="token punctuation">(</span>y_norm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 进行反向转换，以获得预测价格</span>
   <span class="token keyword">double</span> y_pred<span class="token operator">=</span>y_norm<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>s<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">+</span>m<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;price predicted:&quot;</span><span class="token punctuation">,</span>y_pred<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 完成操作</span>
   <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>脚本运行示例:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ONNX: Creating and using per session threadpools since use_per_session_threads_ is true
ONNX: Dynamic block base set to 0
ONNX: Initializing session.
ONNX: Adding default CPU execution provider.
ONNX: Total shared scalar initializer count: 0
ONNX: Total fused reshape node count: 0
ONNX: Total shared scalar initializer count: 0
ONNX: Total fused reshape node count: 0
ONNX: Use DeviceBasedPartition as default
ONNX: Saving initialized tensors.
ONNX: Done saving initialized tensors
ONNX: Session successfully initialized.
[0.28188983]
predicted 1.0559258806393044
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>MetaTrader 5 终端为计算选择了最佳执行器 - ONNX Runtime Execution Provider。在本示例中，模型在 CPU 上执行。</p> <p>让我们修改脚本，根据前 10 个条形图的值计算成功预测收盘价的百分比。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">resource</span> <span class="token string">&quot;Python/model.onnx&quot;</span> <span class="token expression">as uchar ExtModel<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token comment">// 作为资源的模型</span></span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TESTS</span> <span class="token expression"><span class="token number">10000</span>  </span><span class="token comment">// number of test datasets</span></span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| 脚本程序起始函数                                                   |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">int</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- 创建模型</span>
   <span class="token keyword">long</span> session_handle<span class="token operator">=</span><span class="token function">OnnxCreateFromBuffer</span><span class="token punctuation">(</span>ExtModel<span class="token punctuation">,</span>ONNX_DEBUG_LOGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>session_handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot create model. Error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 由于没有为模型定义输入张量大小，请明确指定</span>
<span class="token comment">//--- 第一个指数是批量大小，第二个指数是系列大小，第三个指数是系列数（OHLC）</span>
   <span class="token keyword">const</span> <span class="token keyword">long</span> input_shape<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxSetInputShape</span><span class="token punctuation">(</span>session_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>input_shape<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;OnnxSetInputShape error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token comment">//--- 由于没有为模型定义输出张量大小，请明确指定</span>
<span class="token comment">//--- 第一个指数是批量大小，必须匹配输入张量的批量大小</span>
<span class="token comment">//--- 第二个指数是预测价格的数量（ 这里只预测Close）</span>
   <span class="token keyword">const</span> <span class="token keyword">long</span> output_shape<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxSetOutputShape</span><span class="token punctuation">(</span>session_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>output_shape<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;OnnxSetOutputShape error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 运行测试</span>
   vector <span class="token function">closes</span><span class="token punctuation">(</span>TESTS<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 存储验证价格的向量</span>
   vector <span class="token function">predicts</span><span class="token punctuation">(</span>TESTS<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 存储所得预测的向量</span>
   vector <span class="token function">prev_closes</span><span class="token punctuation">(</span>TESTS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 存储之前价格的向量</span>
 
   matrix rates<span class="token punctuation">;</span>              <span class="token comment">// 获得OHLC系列的矩阵</span>
   matrix splitted<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 将系列分为测试和验证的两个子矩阵</span>
   ulong  parts<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token comment">// 划分子矩阵的大小</span>
 
<span class="token comment">//--- 从前一柱形图开始</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span>TESTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//--- 获取11个柱形图</span>
      rates<span class="token punctuation">.</span><span class="token function">CopyRates</span><span class="token punctuation">(</span><span class="token string">&quot;EURUSD&quot;</span><span class="token punctuation">,</span>PERIOD_H1<span class="token punctuation">,</span>COPY_RATES_OHLC<span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//--- 将矩阵分为测试和验证</span>
      rates<span class="token punctuation">.</span><span class="token function">Vsplit</span><span class="token punctuation">(</span>parts<span class="token punctuation">,</span>splitted<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//--- 从验证矩阵得到收盘价</span>
      closes<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>splitted<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//--- 测试系列中的最后收盘价</span>
      prev_closes<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>splitted<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
      <span class="token comment">//--- 提交10个柱形图测试矩阵进行测试</span>
      predicts<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">PricePredictionTest</span><span class="token punctuation">(</span>session_handle<span class="token punctuation">,</span>splitted<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//--- 运行时间错误</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>predicts<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
         <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>session_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 完成操作</span>
   <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>session_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 评估价格移动预测是否正确</span>
   <span class="token keyword">int</span>    right_directions<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
   vector delta_predicts<span class="token operator">=</span>prev_closes<span class="token operator">-</span>predicts<span class="token punctuation">;</span>
   vector delta_actuals<span class="token operator">=</span>prev_closes<span class="token operator">-</span>closes<span class="token punctuation">;</span>
 
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>TESTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>delta_predicts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> delta_actuals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>delta_predicts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> delta_actuals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         right_directions<span class="token operator">++</span><span class="token punctuation">;</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;right direction predictions = %.2f%%&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span>right_directions<span class="token operator">*</span><span class="token number">100.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">double</span><span class="token punctuation">(</span>TESTS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//|  准备数据并运行模型                                                |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">double</span> <span class="token function">PricePredictionTest</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">long</span> session_handle<span class="token punctuation">,</span>matrix<span class="token operator">&amp;</span> rates<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">static</span> matrixf <span class="token function">input_data</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用于转换输入的矩阵</span>
   <span class="token keyword">static</span> vectorf <span class="token function">output_data</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 接收结果的向量</span>
   <span class="token keyword">static</span> matrix <span class="token function">mm</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 水平向量矩阵Mean</span>
   <span class="token keyword">static</span> matrix <span class="token function">ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 水平向量矩阵Std</span>
 
<span class="token comment">//--- 一组OHLC垂直向量必须输入到模型中</span>
   matrix x_norm<span class="token operator">=</span>rates<span class="token punctuation">.</span><span class="token function">Transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 标准价格</span>
   vector m<span class="token operator">=</span>x_norm<span class="token punctuation">.</span><span class="token function">Mean</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   vector s<span class="token operator">=</span>x_norm<span class="token punctuation">.</span><span class="token function">Std</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      mm<span class="token punctuation">.</span><span class="token function">Row</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ms<span class="token punctuation">.</span><span class="token function">Row</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   x_norm<span class="token operator">-=</span>mm<span class="token punctuation">;</span>
   x_norm<span class="token operator">/=</span>ms<span class="token punctuation">;</span>
 
<span class="token comment">//--- 运行模型</span>
   input_data<span class="token punctuation">.</span><span class="token function">Assign</span><span class="token punctuation">(</span>x_norm<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxRun</span><span class="token punctuation">(</span>session_handle<span class="token punctuation">,</span>ONNX_DEBUG_LOGS<span class="token punctuation">,</span>input_data<span class="token punctuation">,</span>output_data<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;OnnxRun error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 将输出值中的价格非标准化</span>
   <span class="token keyword">double</span> y_pred<span class="token operator">=</span>output_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>s<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">+</span>m<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
   <span class="token keyword">return</span><span class="token punctuation">(</span>y_pred<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br></div></div><p>运行脚本：预测准确率约为51%</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>ONNX<span class="token operator">:</span> Creating <span class="token operator">and</span> <span class="token keyword">using</span> per session threadpools since use_per_session_threads_ is <span class="token boolean">true</span>
ONNX<span class="token operator">:</span> Dynamic block base set to <span class="token number">0</span>
ONNX<span class="token operator">:</span> Initializing session<span class="token punctuation">.</span>
ONNX<span class="token operator">:</span> Adding <span class="token keyword">default</span> CPU execution provider<span class="token punctuation">.</span>
ONNX<span class="token operator">:</span> Total shared scalar initializer count<span class="token operator">:</span> <span class="token number">0</span>
ONNX<span class="token operator">:</span> Total fused reshape node count<span class="token operator">:</span> <span class="token number">0</span>
ONNX<span class="token operator">:</span> Total shared scalar initializer count<span class="token operator">:</span> <span class="token number">0</span>
ONNX<span class="token operator">:</span> Total fused reshape node count<span class="token operator">:</span> <span class="token number">0</span>
ONNX<span class="token operator">:</span> Use DeviceBasedPartition as <span class="token keyword">default</span>
ONNX<span class="token operator">:</span> Saving initialized tensors<span class="token punctuation">.</span>
ONNX<span class="token operator">:</span> Done saving initialized tensors
ONNX<span class="token operator">:</span> Session successfully initialized<span class="token punctuation">.</span>
right direction predictions <span class="token operator">=</span> <span class="token number">51.34</span> <span class="token operator">%</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="_34-6-策略测试中的模型验证"><a href="#_34-6-策略测试中的模型验证" class="header-anchor">#</a> 34.6  策略测试中的模型验证</h2> <p>为金融市场操作创建的模型可以在 MetaTrader 5程序端策略测试部分进行验证。这是最快、最方便的选项，无需额外模拟市场环境和交易条件。</p> <p>若要测试模型，需要根据公共项目ONNX.Price.Prediction的代码创建一个EA交易程序。这将需要进行一些编辑。</p> <p>将模型创建移至OnInit函数。onnx会话将在OnDeinit中关闭。将主要模型操作块定位到OnTick处理程序。</p> <p>此外，添加获取前两个柱形图的收盘价，需要与实际收盘价和预测收盘价进行比较。</p> <p>Expert Advisor 代码小且易于阅读。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">const</span> <span class="token keyword">long</span>   ExtInputShape <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 模型输入形状</span>
<span class="token keyword">const</span> <span class="token keyword">long</span>   ExtOutputShape<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 模型输出形状</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">resource</span> <span class="token string">&quot;Python/model.onnx&quot;</span> <span class="token expression">as uchar ExtModel<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="token comment">// 作为资源的模型</span></span>
 
<span class="token keyword">long</span> handle<span class="token punctuation">;</span>         <span class="token comment">// 模型句柄</span>
ulong predictions<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 预测计数器</span>
ulong confirmed<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">// 成功预测计数器</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| EA交易初始化函数                                                   |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- 基本检查</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>_Symbol<span class="token operator">!=</span><span class="token string">&quot;EURUSD&quot;</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Symbol must be EURUSD, testing aborted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>_Period<span class="token operator">!=</span>PERIOD_H1<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Timeframe must be H1, testing aborted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 创建模型</span>
   handle<span class="token operator">=</span><span class="token function">OnnxCreateFromBuffer</span><span class="token punctuation">(</span>ExtModel<span class="token punctuation">,</span>ONNX_DEBUG_LOGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 指定输入数据形状</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxSetInputShape</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ExtInputShape<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;OnnxSetInputShape failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 指定输出数据形状</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxSetOutputShape</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ExtOutputShape<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;OnnxSetOutputShape failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//---</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| EA交易去初始化函数                                                 |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
<span class="token comment">//--- 完成模型操作</span>
   <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 计算和输出预测统计</span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Successfull predictions = %.2f %%&quot;</span><span class="token punctuation">,</span>confirmed<span class="token operator">*</span><span class="token number">100.</span><span class="token operator">/</span><span class="token keyword">double</span><span class="token punctuation">(</span>predictions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| EA报价函数                                                        |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">static</span> datetime open_time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">static</span> <span class="token keyword">double</span> predict<span class="token punctuation">;</span>
<span class="token comment">//--- 检查当前柱形图开盘时间</span>
   datetime time<span class="token operator">=</span><span class="token function">iTime</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>time<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get Time(0), error %d&quot;</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 如果开盘时间没有改变，则退出直至下一次OnTick调用</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>time<span class="token operator">==</span>open_time<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token comment">//--- 获取最后两个已完成柱形图的收盘价</span>
   <span class="token keyword">double</span> close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> recieved<span class="token operator">=</span><span class="token function">CopyClose</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>close<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>recieved<span class="token operator">!=</span><span class="token number">2</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;CopyClose(2 bars) failed, error %d&quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token keyword">double</span> delta_predict<span class="token operator">=</span>predict<span class="token operator">-</span>close<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// predicted price change</span>
   <span class="token keyword">double</span> delta_actual<span class="token operator">=</span>close<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>close<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// actual price change</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>delta_predict<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> delta_actual<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>delta_predict<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> delta_actual<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      confirmed<span class="token operator">++</span><span class="token punctuation">;</span>
 
<span class="token comment">//--- 计算新柱形图上的收盘价，以验证下一个柱形图上的价格</span>
   matrix rates<span class="token punctuation">;</span>
<span class="token comment">//--- 获取10个柱形图</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rates<span class="token punctuation">.</span><span class="token function">CopyRates</span><span class="token punctuation">(</span><span class="token string">&quot;EURUSD&quot;</span><span class="token punctuation">,</span>PERIOD_H1<span class="token punctuation">,</span>COPY_RATES_OHLC<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token comment">//--- 输入一组OHLC向量</span>
   matrix x_norm<span class="token operator">=</span>rates<span class="token punctuation">.</span><span class="token function">Transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   vector m<span class="token operator">=</span>x_norm<span class="token punctuation">.</span><span class="token function">Mean</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   vector s<span class="token operator">=</span>x_norm<span class="token punctuation">.</span><span class="token function">Std</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   matrix <span class="token function">mm</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   matrix <span class="token function">ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 填充归一化矩阵</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      mm<span class="token punctuation">.</span><span class="token function">Row</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ms<span class="token punctuation">.</span><span class="token function">Row</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 标准化输入数据</span>
   x_norm<span class="token operator">-=</span>mm<span class="token punctuation">;</span>
   x_norm<span class="token operator">/=</span>ms<span class="token punctuation">;</span>
<span class="token comment">//--- 将标准化输入数据转换为浮点类型</span>
   matrixf x_normf<span class="token punctuation">;</span>
   x_normf<span class="token punctuation">.</span><span class="token function">Assign</span><span class="token punctuation">(</span>x_norm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 在这里获取模型的输出数据，即价格预测</span>
   vectorf <span class="token function">y_norm</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 运行模型</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxRun</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span>ONNX_DEBUG_LOGS <span class="token operator">|</span> ONNX_NO_CONVERSION<span class="token punctuation">,</span>x_normf<span class="token punctuation">,</span>y_norm<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;OnnxRun failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 进行反向转换，以获得预测价格并在新柱形图上对其验证</span>
   predict<span class="token operator">=</span>y_norm<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>s<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">+</span>m<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   predictions<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">// 增加预测计数器</span>
   <span class="token function">Print</span><span class="token punctuation">(</span>predictions<span class="token punctuation">,</span><span class="token string">&quot;. close prediction = &quot;</span><span class="token punctuation">,</span>predict<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 保存柱形图开盘时间，以检查下一个报价</span>
   open_time<span class="token operator">=</span>time<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br></div></div><p>编译EA交易，并在2022年期间运行测试。使用H1时间周期指定EURUSD，这是训练模型的数据。可以忽略报价建模模式，因为代码检查的是新柱形图的出现。</p> <p><img src="/mql5yao/assets/img/strategytest.fb3000b8.png" alt="回测设置"></p> <p>运行并在测试日志中查看结果。它表明略高于50%的预测在2022年是正确的。</p> <p><img src="/mql5yao/assets/img/onnx_ea_test_result.5084e316.png" alt="测试日志"></p> <p>如果初步模型测试产生令人满意的结果，您可以开始基于此模型编写完整的交易策略。</p> <h2 id="_34-7-onnxcreate"><a href="#_34-7-onnxcreate" class="header-anchor">#</a> 34.7  OnnxCreate</h2> <p>创建ONNX会话，从*.onnx文件中加载一个模型。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>long  OnnxCreate(
   string  filename,  // 文件路径
   uint    flags      //创建模型的标识
   );
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>参数</strong>*</p> <p>filename</p> <p>[in]  Path to the <em>.onnx file of the model 相对于\MQL5\Files\文件夹的到模型</em>.onnx文件的路径。</p> <p>flags</p> <p>[in] ENUM_ONNX_FLAGS中的标识，描述模型创建模式：ONNX_COMMON_FOLDER和ONNX_DEBUG_LOGS。</p> <p><strong>返回值</strong></p> <p>创建会话的句柄，或者出现错误时的INVALID_HANDLE。要获取错误代码，请调用GetLastError函数。</p> <p><strong>注意</strong></p> <p>如果在磁盘上找不到指定的文件，系统将尝试重新打开文件，并在文件名后附加“.onnx”扩展名。</p> <h2 id="_34-8-onnxcreatefrombuffer"><a href="#_34-8-onnxcreatefrombuffer" class="header-anchor">#</a> 34.8  OnnxCreateFromBuffer</h2> <p>创建ONNX会话，从数据数组加载模型。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>long  OnnxCreateFromBuffer(
   const uchar&amp;  buffer[],   // 数组参考
   ulong         flags       // 模型创建标识
   );
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>参数</strong></p> <p>buffer</p> <p>[in] 使用ONNX模型数据的数组。</p> <p>flags</p> <p>[in] ENUM_ONNX_FLAGS中的标识，描述模型创建模式：ONNX_COMMON_FOLDER和ONNX_DEBUG_LOGS。</p> <p><strong>返回值</strong></p> <p>创建会话的句柄，或者出现错误时的INVALID_HANDLE。要获取错误代码，请调用GetLastError函数。</p> <h2 id="_34-9-onnxrelease"><a href="#_34-9-onnxrelease" class="header-anchor">#</a> 34.9  OnnxRelease</h2> <p>关闭ONNX会话。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bool  OnnxRelease(
   long   onnx_handle  //ONNX会话句柄
   );
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>参数</strong></p> <p>onnx_handle</p> <p>[in]  通过OnnxCreate或OnnxCreateFromBuffer创建的ONNX会话对象句柄。</p> <p><strong>返回值</strong></p> <p>如果成功返回true；否则返回false。要获取错误代码，请调用GetLastError函数。</p> <h2 id="_34-10-onnxrun"><a href="#_34-10-onnxrun" class="header-anchor">#</a> 34.10  OnnxRun</h2> <p>运行ONNX模型。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bool  OnnxRun(
   long    onnx_handle,  // ONNX会话句柄
   ulong   flags,        // 描述运行模式的标识
   ...                   // 模型的输入和输出
   );
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>参数</strong></p> <p>onnx_handle</p> <p>[in]  通过OnnxCreate或OnnxCreateFromBuffer创建的ONNX会话对象句柄。</p> <p>flags</p> <p>[in] ENUM_ONNX_FLAGS中的标识，描述运行模式：ONNX_DEBUG_LOGS和ONNX_NO_CONVERSION。</p> <p>...</p> <p>[in] [out]  模型输入和输出。</p> <p>成功返回true，否则返回false。要获取错误代码，请调用GetLastError函数。</p> <p><strong>ENUM_ONNX_FLAGS</strong></p> <table><thead><tr><th>ID</th> <th>描述</th></tr></thead> <tbody><tr><td>ONNX_DEBUG_LOGS</td> <td>输出调试日志</td></tr> <tr><td>ONNX_NO_CONVERSION</td> <td>禁用自动转换，按原样使用用户数据</td></tr> <tr><td>ONNX_COMMON_FOLDER</td> <td>加载Common\Files文件夹的模型文件；该值等于FILE_COMMON标识</td></tr></tbody></table> <p><strong>例如：</strong></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">const</span> <span class="token keyword">long</span>                             ExtOutputShape<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 模型输出形状</span>
<span class="token keyword">const</span> <span class="token keyword">long</span>                             ExtInputShape <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 模型输入形状</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">resource</span> <span class="token string">&quot;Python/model.onnx&quot;</span> <span class="token expression">as uchar ExtModel<span class="token punctuation">[</span><span class="token punctuation">]</span>                   </span><span class="token comment">// 作为资源的模型</span></span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token comment">//| 脚本程序起始函数                                                   |</span>
<span class="token comment">//+------------------------------------------------------------------+</span>
<span class="token keyword">int</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   matrix rates<span class="token punctuation">;</span>
<span class="token comment">//--- 获取10个柱形图</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rates<span class="token punctuation">.</span><span class="token function">CopyRates</span><span class="token punctuation">(</span><span class="token string">&quot;EURUSD&quot;</span><span class="token punctuation">,</span>PERIOD_H1<span class="token punctuation">,</span>COPY_RATES_OHLC<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 输入一组OHLC向量</span>
   matrix x_norm<span class="token operator">=</span>rates<span class="token punctuation">.</span><span class="token function">Transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   vector m<span class="token operator">=</span>x_norm<span class="token punctuation">.</span><span class="token function">Mean</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               
   vector s<span class="token operator">=</span>x_norm<span class="token punctuation">.</span><span class="token function">Std</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   matrix <span class="token function">mm</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   matrix <span class="token function">ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 填充归一化矩阵</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      mm<span class="token punctuation">.</span><span class="token function">Row</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ms<span class="token punctuation">.</span><span class="token function">Row</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 标准化输入数据</span>
   x_norm<span class="token operator">-=</span>mm<span class="token punctuation">;</span>
   x_norm<span class="token operator">/=</span>ms<span class="token punctuation">;</span>
<span class="token comment">//--- 创建模型</span>
   <span class="token keyword">long</span> handle<span class="token operator">=</span><span class="token function">OnnxCreateFromBuffer</span><span class="token punctuation">(</span>ExtModel<span class="token punctuation">,</span>ONNX_DEBUG_LOGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 指定输入数据形状</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxSetInputShape</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ExtInputShape<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;OnnxSetInputShape failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 指定输出数据形状</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxSetOutputShape</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ExtOutputShape<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;OnnxSetOutputShape failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 将标准化输入数据转换为浮点类型</span>
   matrixf x_normf<span class="token punctuation">;</span>
   x_normf<span class="token punctuation">.</span><span class="token function">Assign</span><span class="token punctuation">(</span>x_norm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 在这里获取模型的输出数据，即价格预测</span>
   vectorf <span class="token function">y_norm</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 运行模型</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxRun</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span>ONNX_DEBUG_LOGS <span class="token operator">|</span> ONNX_NO_CONVERSION<span class="token punctuation">,</span>x_normf<span class="token punctuation">,</span>y_norm<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;OnnxRun failed, error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 将模型的输出值打印到日志中</span>
   <span class="token function">Print</span><span class="token punctuation">(</span>y_norm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 进行反向转换，以获得预测价格</span>
   <span class="token keyword">double</span> y_pred<span class="token operator">=</span>y_norm<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>s<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">+</span>m<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;price predicted:&quot;</span><span class="token punctuation">,</span>y_pred<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 已完成操作</span>
   <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>另见</p> <p>OnnxSetInputShape，OnnxSetOutputShape</p> <h2 id="_34-11-onnxgetinputcount"><a href="#_34-11-onnxgetinputcount" class="header-anchor">#</a> 34.11  OnnxGetInputCount</h2> <p>获取ONNX模型中的输入数。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>long  OnnxGetInputCount(
   long   onnx_handle  //ONNX会话句柄
   );
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>参数</strong></p> <p>onnx_handle</p> <p>[in]  通过OnnxCreate或OnnxCreateFromBuffer创建的ONNX会话对象句柄。</p> <p><strong>返回值</strong></p> <p>如果成功，返回输入参数的数量；否则返回-1。要获取错误代码，请调用GetLastError函数。</p> <h2 id="_34-12-onnxgetoutputcount"><a href="#_34-12-onnxgetoutputcount" class="header-anchor">#</a> 34.12  OnnxGetOutputCount</h2> <p>获取 ONNX 模型的输出数。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>long  OnnxGetOutputCount(
   long   onnx_handle  //ONNX会话句柄
   );
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>参数</strong></p> <p>onnx_handle</p> <p>[in]  通过OnnxCreate或OnnxCreateFromBuffer创建的ONNX会话对象句柄。</p> <p><strong>返回值</strong></p> <p>如果成功，返回输出参数的数量；否则返回-1。要获取错误代码，请调用GetLastError函数。</p> <h2 id="_34-13-onnxgetinputname"><a href="#_34-13-onnxgetinputname" class="header-anchor">#</a> 34.13  OnnxGetInputName</h2> <p>通过索引获取模型输入名称</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>string  OnnxGetInputName(
   long   onnx_handle,  // ONNX会话句柄
   long   index         // 参数索引
   );
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>参数</strong></p> <p>onnx_handle</p> <p>[in]  通过OnnxCreate或OnnxCreateFromBuffer创建的ONNX会话对象句柄。</p> <p>index</p> <p>[in]  输入参数的索引，从0开始。</p> <p><strong>返回值</strong></p> <p>如果成功，返回输入参数的名称；否则返回NULL。要获取错误代码，请调用GetLastError函数。</p> <h2 id="_34-14-onnxgetoutputname"><a href="#_34-14-onnxgetoutputname" class="header-anchor">#</a> 34.14  OnnxGetOutputName</h2> <p>通过索引获取模型输出名称。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>string  OnnxGetOutputName(
   long   onnx_handle,  // ONNX会话句柄
   long   index         // 参数索引
   );
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>参数</strong></p> <p>onnx_handle</p> <p>[in]  通过OnnxCreate或OnnxCreateFromBuffer创建的ONNX会话对象句柄。</p> <p>index</p> <p>[in]  输出参数的索引，从0开始。</p> <p><strong>返回值</strong></p> <p>如果成功，返回输出参数的名称；否则返回NULL。要获取错误代码，请调用GetLastError函数。</p> <h2 id="_34-15-onnxgetinputtypeinfo"><a href="#_34-15-onnxgetinputtypeinfo" class="header-anchor">#</a> 34.15  OnnxGetInputTypeInfo</h2> <p>从模型获取输入类型的描述</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bool  OnnxGetInputTypeInfo(
   long           onnx_handle,  // ONNX会话句柄
   long           index,        // 参数索引
   OnnxTypeInfo&amp;  typeinfo      // 参数类型描述
   );
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>参数</strong></p> <p>onnx_handle</p> <p>[in]  通过OnnxCreate或OnnxCreateFromBuffer创建的ONNX会话对象句柄。</p> <p>index</p> <p>[in]  输入参数的索引，从0开始。</p> <p>typeinfo</p> <p>[out]  描述输入参数类型的OnnxTypeInfo结构。</p> <p><strong>返回值</strong></p> <p>如果成功返回true；否则返回false。要获取错误代码，请调用GetLastError函数。</p> <h2 id="_34-16-onnxgetoutputtypeinfo"><a href="#_34-16-onnxgetoutputtypeinfo" class="header-anchor">#</a> 34.16 OnnxGetOutputTypeInfo</h2> <p>从模型获取输出类型的描述。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bool  OnnxGetOutputTypeInfo(
   long           onnx_handle,  // ONNX会话句柄
   long           index,        // 参数索引
   OnnxTypeInfo&amp;  typeinfo      // 参数类型描述
   );
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>参数</strong></p> <p>onnx_handle</p> <p>[in]  通过OnnxCreate或OnnxCreateFromBuffer创建的ONNX会话对象句柄。</p> <p>index</p> <p>[in]  输出参数的索引，从0开始。</p> <p>typeinfo</p> <p>[out]  描述输出参数类型的OnnxTypeInfo结构。</p> <p><strong>返回值</strong></p> <p>如果成功返回true；否则返回false。要获取错误代码，请调用GetLastError函数。</p> <h2 id="_34-17-onnxsetinputshape"><a href="#_34-17-onnxsetinputshape" class="header-anchor">#</a> 34.17  OnnxSetInputShape</h2> <p>通过索引设置模型输入数据的形状。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bool  OnnxSetInputShape(
   long          onnx_handle,  // ONNX会话句柄
   long          input_index,  // 输入参数索引
   const ulong&amp;  shape[]       // 描述输入数据形状的数组
   );
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>参数</strong></p> <p>onnx_handle</p> <p>[in]  通过OnnxCreate或OnnxCreateFromBuffer创建的ONNX会话对象句柄。</p> <p>input_index</p> <p>[in]  输入参数的索引，从0开始。</p> <p>shape</p> <p>[in]  描述模型输入数据形状的数组。</p> <p><strong>返回值</strong></p> <p>如果成功，返回输入参数的名称；否则返回NULL。要获取错误代码，请调用GetLastError函数。</p> <p><strong>例如：</strong>*</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//---- 描述模型输入和输出数据的形状</span>
   <span class="token keyword">const</span> <span class="token keyword">long</span>  ExtOutputShape<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token keyword">const</span> <span class="token keyword">long</span>  ExtInputShape <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//--- 创建模型</span>
   <span class="token keyword">long</span> handle<span class="token operator">=</span><span class="token function">OnnxCreateFromBuffer</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span>ONNX_DEBUG_LOGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 指定输入数据形状</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxSetInputShape</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ExtInputShape<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;failed, OnnxSetInputShape error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 指定输出数据形状</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxSetOutputShape</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ExtOutputShape<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;failed, OnnxSetOutputShape error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>另见</p> <p>OnnxSetOutputShape</p> <h2 id="_34-18-onnxsetoutputshape"><a href="#_34-18-onnxsetoutputshape" class="header-anchor">#</a> 34.18  OnnxSetOutputShape</h2> <p>通过索引设置模型输出数据的形状。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bool  OnnxSetOutputShape(
   long          onnx_handle,   // ONNX会话句柄
   long          output_index,  // 输出参数索引
   const ulong&amp;  shape[]        // 描述输出数据形状的数组
   );
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>参数</strong></p> <p>onnx_handle</p> <p>[in]  通过OnnxCreate或OnnxCreateFromBuffer创建的ONNX会话对象句柄。</p> <p>output_index</p> <p>[in]  输出参数的索引，从0开始。</p> <p>shape</p> <p>[in]  描述模型输出数据形状的数组。</p> <p><strong>返回值</strong></p> <p>如果成功，返回输入参数的名称；否则返回NULL。要获取错误代码，请调用GetLastError函数。</p> <p><strong>例如：</strong></p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//---- 描述模型输入和输出数据的形状</span>
   <span class="token keyword">const</span> <span class="token keyword">long</span>  ExtOutputShape<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token keyword">const</span> <span class="token keyword">long</span>  ExtInputShape <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//--- 创建模型</span>
   <span class="token keyword">long</span> handle<span class="token operator">=</span><span class="token function">OnnxCreateFromBuffer</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span>ONNX_DEBUG_LOGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//--- 指定输入数据形状</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxSetInputShape</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ExtInputShape<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;failed, OnnxSetInputShape error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token comment">//--- 指定输出数据形状</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OnnxSetOutputShape</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ExtOutputShape<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;failed, OnnxSetOutputShape error &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">OnnxRelease</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>另见</p> <p>OnnxSetInputShape</p> <h2 id="_34-19-数据结构"><a href="#_34-19-数据结构" class="header-anchor">#</a> 34.19  数据结构</h2> <p>以下数据结构用于ONNX模型的操作：</p> <p>OnnxTypeInfo #
该结构描述了ONNX模型的输入或输出参数的类型</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>struct OnnxTypeInfo
 {
  ENUM_ONNX_TYPE        type;          // 参数类型
  OnnxTensorTypeInfo    tensor;        // 张量描述
  OnnxMapTypeInfo       map;           // 映射描述
  OnnxSequenceTypeInfo  sequence;      // 序列描述
 };
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>只有张量(ONNX_TYPE_TENSOR)可以作为输入使用。在这种情况下，只有OnnxTypeInfo::tensor字段被填充值，而其他字段（映射和序列）没有定义。</p> <p>三种OnnxTypeInfo类型（ONNX_TYPE_TENSOR、ONNX_TYPE_MAP或ONNX_TYPE_SEQUENCE）中只有一种可以作为输入使用。相对应的子结构(OnnxTypeInfo::tensor、OnnxTypeInfo::map或OnnxTypeInfo::sequence)根据类型来填充。</p> <p>OnnxTensorTypeInfo</p> <p>该结构描述了ONNX模型的输入或输出参数中的张量</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>struct OnnxTensorTypeInfo
 {
  const ENUM_ONNX_DATA_TYPE  data_type;      // 张量中的数据类型
  const long                 dimensions[];   // 张量中的元素数
 };
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>OnnxMapTypeInfo #
该结构描述了ONNX模型的输出参数中获得的映射</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>struct OnnxMapTypeInfo
 {
  const ENUM_ONNX_DATA_TYPE  key_type;      //密钥类型
  const OnnxTypeInfo&amp;        value_type;    // 值类型
 };
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>OnnxSequenceTypeInfo #
该结构描述了ONNX模型的输出参数中获得的序列</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>struct OnnxSequenceTypeInfo
 {
  const OnnxTypeInfo&amp;        value_type;     // 序列中的数据类型
 };
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ENUM_ONNX_TYPE #</p> <p>ENUM_ONNX_TYPE枚举描述了模型参数的类型</p> <table><thead><tr><th>ID</th> <th>描述</th></tr></thead> <tbody><tr><td>ONNX_TYPE_UNKNOWN</td> <td>未知</td></tr> <tr><td>ONNX_TYPE_TENSOR</td> <td>Tensor</td></tr> <tr><td>ONNX_TYPE_SEQUENCE</td> <td>Sequence</td></tr> <tr><td>ONNX_TYPE_MAP</td> <td>Map</td></tr> <tr><td>ONNX_TYPE_OPAQUE</td> <td>Abstract (opaque)</td></tr> <tr><td>ONNX_TYPE_SPARSETENSOR</td> <td>Sparse tensor</td></tr></tbody></table> <p>ENUM_ONNX_DATA_TYPE #</p> <p>ENUM_ONNX_DATA_TYPE枚举描述了所用数据的类型</p> <table><thead><tr><th>ID</th> <th>描述</th></tr></thead> <tbody><tr><td>ONNX_DATA_TYPE_UNDEFINED</td> <td>未定义</td></tr> <tr><td>ONNX_DATA_TYPE_FLOAT</td> <td>浮点型</td></tr> <tr><td>ONNX_DATA_TYPE_INT8</td> <td>8位整型</td></tr> <tr><td>ONNX_DATA_TYPE_UINT16</td> <td>16位无符号整型</td></tr> <tr><td>ONNX_DATA_TYPE_INT16</td> <td>16位整型</td></tr> <tr><td>ONNX_DATA_TYPE_INT32</td> <td>32位整型</td></tr> <tr><td>ONNX_DATA_TYPE_INT64</td> <td>64位整型</td></tr> <tr><td>ONNX_DATA_TYPE_STRING</td> <td>字符串</td></tr> <tr><td>ONNX_DATA_TYPE_BOOL</td> <td>布尔型</td></tr> <tr><td>ONNX_DATA_TYPE_FLOAT16</td> <td>16位浮点型</td></tr> <tr><td>ONNX_DATA_TYPE_DOUBLE</td> <td>双精度</td></tr> <tr><td>ONNX_DATA_TYPE_UINT32</td> <td>32位无符号整型</td></tr> <tr><td>ONNX_DATA_TYPE_UINT64</td> <td>64位无符号整型</td></tr> <tr><td>ONNX_DATA_TYPE_COMPLEX64</td> <td>64位复数</td></tr> <tr><td>ONNX_DATA_TYPE_COMPLEX128</td> <td>128位复数</td></tr> <tr><td>ONNX_DATA_TYPE_BFLOAT16</td> <td>16位bfloat（大脑浮点）</td></tr></tbody></table> <p>ENUM_ONNX_FLAGS #</p> <p>ENUM_ONNX_FLAGS枚举描述了模型运行模式</p> <table><thead><tr><th>ID</th> <th>描述</th></tr></thead> <tbody><tr><td>ONNX_DEBUG_LOGS</td> <td>输出调试日志</td></tr> <tr><td>ONNX_NO_CONVERSION</td> <td>禁用自动转换，按原样使用用户数据</td></tr> <tr><td>ONNX_COMMON_FOLDER</td> <td>加载Common\Files文件夹的模型文件；该值等于FILE_COMMON标识</td></tr></tbody></table> <p>使用ONNX模型时的数组转换
机器学习任务并不总是需要更高的计算精度。为了加快计算速度，一些模型使用较低精度的数据类型，例如Float16甚至Float8。为了允许用户将相关数据输入到模型中，MQL5提供了四个特殊函数，可将标准MQL5类型转换为特殊的FP16和FP8类型。</p> <table><thead><tr><th>函数</th> <th>操作</th></tr></thead> <tbody><tr><td>ArrayToFP16</td> <td>将float或double类型数组复制到给定格式的ushort类型的数组中</td></tr> <tr><td>ArrayToFP8</td> <td>将float或double类型数组复制到给定格式的uchar类型的数组中</td></tr> <tr><td>ArrayFromFP16</td> <td>将ushort类型数组复制到给定格式的float或double类型的数组中</td></tr> <tr><td>ArrayFromFP8</td> <td>将uchar类型数组复制到给定格式的float或double类型的数组中</td></tr></tbody></table> <p>这些数组转换函数使用以下枚举中指定的特殊格式。</p> <p>ENUM_FLOAT16_FORMAT #</p> <p>ENUM_FLOAT16_FORMAT枚举描述了两种FP16类型格式。</p> <table><thead><tr><th>ID</th> <th>描述</th></tr></thead> <tbody><tr><td>FLOAT_FP16</td> <td>标准16位格式，也称为half</td></tr> <tr><td>FLOAT_BFP16</td> <td>特殊的brain float point（大脑浮点）格式</td></tr></tbody></table> <p>这些格式中的每一种都有其优点和局限性。FLOAT16提供更高的精度，但需要更多的存储和计算资源。另一方面，BFLOAT16在数据处理方面提供了更高的性能和效率，但可能不太准确。</p> <p>ENUM_FLOAT8_FORMAT #</p> <p>ENUM_FLOAT8_FORMAT枚举描述了四种FP8类型格式。</p> <p>FP8（8位浮点）是用于表示浮点数的数据类型之一。在FP8中，每个数字由8个数据位表示，通常分为三个部分：符号、指数和尾数。这种格式提供了准确性和存储效率之间的平衡，使其对于需要内存和计算效率的应用程序具有吸引力。</p> <table><thead><tr><th>ID</th> <th>描述</th></tr></thead> <tbody><tr><td>FLOAT_FP8_E4M3FN</td> <td>8位浮点数，4位指数，3位尾数。通常用作系数。</td></tr> <tr><td>FLOAT_FP8_E4M3FNUZ</td> <td>8位浮点数，4位指数，3位尾数。支持NaN，不支持负零和Inf。通常用作系数。</td></tr> <tr><td>FLOAT_FP8_E5M2FN</td> <td>8位浮点数，5位指数，2位尾数。支持NaN和Inf。通常用于渐变。</td></tr> <tr><td>FLOAT_FP8_E5M2FNUZ</td> <td>8位浮点数，5位指数，2位尾数。支持NaN，不支持负零和Inf。也用于渐变。</td></tr></tbody></table> <p>FP8的主要优势之一是其处理大型数据集的效率。通过采用紧凑型数字表示法，FP8减少了内存需求并加速了计算。这对于经常处理大型数据集的机器学习和人工智能应用程序尤其重要。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mql5yao/Chapter/thirtytwo.html" class="prev">
        33 第卅三章 MetaTrader与Python集成的模块
      </a></span> <span class="next"><a href="/mql5yao/Chapter/thirtythree.html">
        35 第卅五章 标准程序库
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/mql5yao/assets/js/app.8a48e4d1.js" defer></script><script src="/mql5yao/assets/js/2.8ccfeae3.js" defer></script><script src="/mql5yao/assets/js/1.abd3212e.js" defer></script><script src="/mql5yao/assets/js/17.15a8a4c2.js" defer></script>
  </body>
</html>
