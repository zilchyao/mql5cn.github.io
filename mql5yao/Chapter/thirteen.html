<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>智能交易*姚 文档站</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/mql5yao/favicon.ico">
    <meta name="description" content="这是智能交易的文档站点。">
    <meta name="keywords" content="MQL,EA,智能交易,自动交易,量化,编程,培训">
    
    <link rel="preload" href="/mql5yao/assets/css/0.styles.c167a2d0.css" as="style"><link rel="preload" href="/mql5yao/assets/js/app.f23448f4.js" as="script"><link rel="preload" href="/mql5yao/assets/js/3.a8269cb7.js" as="script"><link rel="preload" href="/mql5yao/assets/js/35.ee55e50b.js" as="script"><link rel="prefetch" href="/mql5yao/assets/js/10.a59489eb.js"><link rel="prefetch" href="/mql5yao/assets/js/11.1fde020f.js"><link rel="prefetch" href="/mql5yao/assets/js/12.a5634cbb.js"><link rel="prefetch" href="/mql5yao/assets/js/13.1e1b93d8.js"><link rel="prefetch" href="/mql5yao/assets/js/14.17d955a5.js"><link rel="prefetch" href="/mql5yao/assets/js/15.429599a3.js"><link rel="prefetch" href="/mql5yao/assets/js/16.bcf982ab.js"><link rel="prefetch" href="/mql5yao/assets/js/17.76fde0dd.js"><link rel="prefetch" href="/mql5yao/assets/js/18.49626d28.js"><link rel="prefetch" href="/mql5yao/assets/js/19.0f21f003.js"><link rel="prefetch" href="/mql5yao/assets/js/2.45a03fa6.js"><link rel="prefetch" href="/mql5yao/assets/js/20.18311061.js"><link rel="prefetch" href="/mql5yao/assets/js/21.63b34e06.js"><link rel="prefetch" href="/mql5yao/assets/js/22.a49527a7.js"><link rel="prefetch" href="/mql5yao/assets/js/23.2584759c.js"><link rel="prefetch" href="/mql5yao/assets/js/24.05b32517.js"><link rel="prefetch" href="/mql5yao/assets/js/25.991ff096.js"><link rel="prefetch" href="/mql5yao/assets/js/26.07e08c10.js"><link rel="prefetch" href="/mql5yao/assets/js/27.11150f9e.js"><link rel="prefetch" href="/mql5yao/assets/js/28.b5c9f3ea.js"><link rel="prefetch" href="/mql5yao/assets/js/29.a1ad142f.js"><link rel="prefetch" href="/mql5yao/assets/js/30.6da01d3d.js"><link rel="prefetch" href="/mql5yao/assets/js/31.28fa5dac.js"><link rel="prefetch" href="/mql5yao/assets/js/32.46aab1c1.js"><link rel="prefetch" href="/mql5yao/assets/js/33.f178c7a3.js"><link rel="prefetch" href="/mql5yao/assets/js/34.cd1eae3b.js"><link rel="prefetch" href="/mql5yao/assets/js/36.56370362.js"><link rel="prefetch" href="/mql5yao/assets/js/37.2cc5b283.js"><link rel="prefetch" href="/mql5yao/assets/js/38.c3bba64a.js"><link rel="prefetch" href="/mql5yao/assets/js/39.86103eac.js"><link rel="prefetch" href="/mql5yao/assets/js/4.ffd96de7.js"><link rel="prefetch" href="/mql5yao/assets/js/40.0e36f079.js"><link rel="prefetch" href="/mql5yao/assets/js/41.17bccbf6.js"><link rel="prefetch" href="/mql5yao/assets/js/42.a40ca8ac.js"><link rel="prefetch" href="/mql5yao/assets/js/43.5a883397.js"><link rel="prefetch" href="/mql5yao/assets/js/44.19bdddfe.js"><link rel="prefetch" href="/mql5yao/assets/js/45.dec8257c.js"><link rel="prefetch" href="/mql5yao/assets/js/46.ed29615c.js"><link rel="prefetch" href="/mql5yao/assets/js/47.b6d07db1.js"><link rel="prefetch" href="/mql5yao/assets/js/48.d7ca24ca.js"><link rel="prefetch" href="/mql5yao/assets/js/5.47d44717.js"><link rel="prefetch" href="/mql5yao/assets/js/6.1f5c1ae1.js"><link rel="prefetch" href="/mql5yao/assets/js/7.1a679445.js"><link rel="prefetch" href="/mql5yao/assets/js/8.e80e8a9d.js"><link rel="prefetch" href="/mql5yao/assets/js/9.261aef18.js">
    <link rel="stylesheet" href="/mql5yao/assets/css/0.styles.c167a2d0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mql5yao/" class="home-link router-link-active"><img src="/mql5yao/logo.png" alt="智能交易*姚 文档站" class="logo"> <span class="site-name can-hide">智能交易*姚 文档站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mql5yao/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mql5yao/Chapter/start.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/mql5yao/Cutleeks/" class="nav-link">
  割韭菜XX招
</a></div><div class="nav-item"><a href="/mql5yao/support/" class="nav-link">
  支持本站
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mql5yao/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mql5yao/Chapter/start.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/mql5yao/Cutleeks/" class="nav-link">
  割韭菜XX招
</a></div><div class="nav-item"><a href="/mql5yao/support/" class="nav-link">
  支持本站
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MQL5线上手册</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mql5yao/Chapter/start.html" class="sidebar-link">MQL5 参考</a></li><li><a href="/mql5yao/Chapter/one.html" class="sidebar-link">01 第一章 语言基础</a></li><li><a href="/mql5yao/Chapter/two.html" class="sidebar-link">02 第二章 标准常量，列举和架构</a></li><li><a href="/mql5yao/Chapter/three.html" class="sidebar-link">03 第三章 MQL5程序</a></li><li><a href="/mql5yao/Chapter/four.html" class="sidebar-link">04 第四章 预定义变量</a></li><li><a href="/mql5yao/Chapter/five.html" class="sidebar-link">05 第五章 普通函数</a></li><li><a href="/mql5yao/Chapter/six.html" class="sidebar-link">06 第六章 数组函数</a></li><li><a href="/mql5yao/Chapter/add1.html" class="sidebar-link">07 第add1章 矩阵和向量方法</a></li><li><a href="/mql5yao/Chapter/seven.html" class="sidebar-link">07 第七章 函数转换</a></li><li><a href="/mql5yao/Chapter/eight.html" class="sidebar-link">08 第八章 数学函数</a></li><li><a href="/mql5yao/Chapter/nine.html" class="sidebar-link">09 第九章 字符串函数</a></li><li><a href="/mql5yao/Chapter/ten.html" class="sidebar-link">10 第十章 日期和时间</a></li><li><a href="/mql5yao/Chapter/eleven.html" class="sidebar-link">11 第十一章 账户信息</a></li><li><a href="/mql5yao/Chapter/twelve.html" class="sidebar-link">12 第十二章 检测</a></li><li><a href="/mql5yao/Chapter/thirteen.html" aria-current="page" class="active sidebar-link">13 第十三章 事件处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-1-onstart" class="sidebar-link">13.1 OnStart</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-2-oninit" class="sidebar-link">13.2 OnInit</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-3-ondeinit" class="sidebar-link">13.3 OnDeinit</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-4-ontick" class="sidebar-link">13.4 OnTick</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-5-oncalculate" class="sidebar-link">13.5 OnCalculate</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-6-ontimer" class="sidebar-link">13.6 OnTimer</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-7-ontrade" class="sidebar-link">13.7 OnTrade</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-8-ontradetransaction" class="sidebar-link">13.8 OnTradeTransaction</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-9-onbookevent" class="sidebar-link">13.9 OnBookEvent</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-10-onchartevent" class="sidebar-link">13.10 OnChartEvent</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-11-ontester" class="sidebar-link">13.11 OnTester</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-12-ontesterinit" class="sidebar-link">13.12 OnTesterInit</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-13-ontesterdeinit" class="sidebar-link">13.13 OnTesterDeinit</a></li><li class="sidebar-sub-header"><a href="/mql5yao/Chapter/thirteen.html#_13-14-ontesterpass" class="sidebar-link">13.14 OnTesterPass</a></li></ul></li><li><a href="/mql5yao/Chapter/fourteen.html" class="sidebar-link">14 第十四章 市场信息</a></li><li><a href="/mql5yao/Chapter/fifteen.html" class="sidebar-link">15 第十五章 经济日历函数</a></li><li><a href="/mql5yao/Chapter/sixteen.html" class="sidebar-link">16 第十六章 时间序列和指标访问</a></li><li><a href="/mql5yao/Chapter/seventeen.html" class="sidebar-link">17 第十七章 自定义交易品种</a></li><li><a href="/mql5yao/Chapter/eighteen.html" class="sidebar-link">18 第十八章 图表操作</a></li><li><a href="/mql5yao/Chapter/ninteen.html" class="sidebar-link">19 第十九章 交易函数</a></li><li><a href="/mql5yao/Chapter/twenty.html" class="sidebar-link">20 第二十章 交易信号</a></li><li><a href="/mql5yao/Chapter/twentyone.html" class="sidebar-link">21 第二十一章 网络函数</a></li><li><a href="/mql5yao/Chapter/twentytwo.html" class="sidebar-link">22 第二十二章 程序端全局变量</a></li><li><a href="/mql5yao/Chapter/twentythree.html" class="sidebar-link">23 第二十三章 文件函数</a></li><li><a href="/mql5yao/Chapter/twentyfour.html" class="sidebar-link">24 第二十四章 自定义指标</a></li><li><a href="/mql5yao/Chapter/twentyfive.html" class="sidebar-link">25 第二十五章 物件函数</a></li><li><a href="/mql5yao/Chapter/twentysix.html" class="sidebar-link">26 第二十六章 技术指标</a></li><li><a href="/mql5yao/Chapter/twentyseven.html" class="sidebar-link">27 第二十七章 处理优化结果</a></li><li><a href="/mql5yao/Chapter/twentyeight.html" class="sidebar-link">28 第二十八章 工作事件</a></li><li><a href="/mql5yao/Chapter/twentynine.html" class="sidebar-link">29 第二十九章 使用OpenCL工作</a></li><li><a href="/mql5yao/Chapter/thirty.html" class="sidebar-link">30 第三十章 使用数据库</a></li><li><a href="/mql5yao/Chapter/thirtyone.html" class="sidebar-link">31 第三十一章 使用DirectX</a></li><li><a href="/mql5yao/Chapter/thirtytwo.html" class="sidebar-link">32 第三十二章 集成</a></li><li><a href="/mql5yao/Chapter/add2.html" class="sidebar-link">32 第add2章 ONNX模型</a></li><li><a href="/mql5yao/Chapter/thirtythree.html" class="sidebar-link">33 第三十三章 标准程序库</a></li><li><a href="/mql5yao/Chapter/AppendixI.html" class="sidebar-link">34 附录一 来自MQL4</a></li><li><a href="/mql5yao/Chapter/AppendixII.html" class="sidebar-link">35 附录二 MQL5 函数列表</a></li><li><a href="/mql5yao/Chapter/AppendixIII.html" class="sidebar-link">36 附录三 MQL5常量列表</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2>第十三章 事件处理</h2> <p>MQL5语言提供对特定预定义事件的处理。处理这些事件的函数应该在MQL5程序中定义：函数名、返回类型、一组参数（如果有），并且它们的类型应该严格地符合事件处理函数的描述。</p> <p>客户端事件处理程序使用返回和参数类型来识别处理事件的函数。如果某个函数有一些参数或者返回类型与下面的描述不符，那么这样的函数就不可以被用于处理事件。</p> <table><thead><tr><th style="text-align:left;">函数</th> <th style="text-align:left;">功能</th></tr></thead> <tbody><tr><td style="text-align:left;">OnStart</td> <td style="text-align:left;">当Start事件发生时调用这个函数，来执行脚本中设定的操作</td></tr> <tr><td style="text-align:left;">OnInit</td> <td style="text-align:left;">当Init事件发生时在指标和EA中调用这个函数，来初始化启动的MQL5程序</td></tr> <tr><td style="text-align:left;">OnDeinit</td> <td style="text-align:left;">当Deinit事件发生时在指标和EA中调用这个函数，来去初始化启动的MQL5程序</td></tr> <tr><td style="text-align:left;">OnTick</td> <td style="text-align:left;">当NewTick事件发生时在EA中调用这个函数，来处理一个新报价</td></tr> <tr><td style="text-align:left;">OnCalculate</td> <td style="text-align:left;">当Calculate事件发生时在指标中调用这个函数，来处理价格数据的变化</td></tr> <tr><td style="text-align:left;">OnTimer</td> <td style="text-align:left;">当Timer周期性事件在固定时间间隔内由程序端生成期间，在指标和EA中调用这个函数</td></tr> <tr><td style="text-align:left;">OnTrade</td> <td style="text-align:left;">当Trade事件在交易服务器上交易操作结束时生成期间，在EA中调用这个函数</td></tr> <tr><td style="text-align:left;">OnTradeTransaction</td> <td style="text-align:left;">当TradeTransaction事件发生时在EA中调用这个函数，来处理一个交易请求执行结果</td></tr> <tr><td style="text-align:left;">OnBookEvent</td> <td style="text-align:left;">当BookEvent事件发生时在EA中调用这个函数，来处理市场深度中的变化</td></tr> <tr><td style="text-align:left;">OnChartEvent</td> <td style="text-align:left;">当ChartEvent事件发生时在指标和EA中调用这个函数，来处理由用户或者MQL5程序所做的图表更改</td></tr> <tr><td style="text-align:left;">OnTester</td> <td style="text-align:left;">当Tester事件发生时在EA中调用这个函数，以便在对历史数据测试EA之后执行必要的操作</td></tr> <tr><td style="text-align:left;">OnTesterInit</td> <td style="text-align:left;">当TesterInit事件发生时在EA中调用这个函数，以便在策略测试优化之前执行必要的操作</td></tr> <tr><td style="text-align:left;">OnTesterDeinit</td> <td style="text-align:left;">在策略测试EA优化之后，当TesterDeinit事件发生时在EA中调用这个函数。</td></tr> <tr><td style="text-align:left;">OnTesterPass</td> <td style="text-align:left;">当TesterPas事件发生时在EA中调用这个函数，以便在策略测试中处理EA优化期间到达的新数据框架</td></tr></tbody></table> <p>客户端将传入事件发送到相应的打开图表中。此外，事件也可以通过图表（图表事件）或mql5程序（自定义事件）来生成。通过设置CHART_EVENT_OBJECT_CREATE和CHART_EVENT_OBJECT_DELETE图表属性可以启用/禁用生成图形对象创建/删除事件。每个mql5应用程序和图表都有其自己的事件队列，所有新到达的事件也都包括其中。</p> <p>一个程序只从其所运行的图表中获取事件。所有事件都按照它们的接收顺序来处理。如果这个队列已经包括NewTick事件，或者这个事件正在处理阶段，那么新的NewTick事件就不能添加到mql5应用程序队列中。同样，如果ChartEvent已在mql5程序序列或者这种事件正被处理，那么这种类型的新事件都不可放在队列之中。Timer事件处理也以相同的方式进行――如果Timer事件已在队列中或者正被处理中，那么队列中则不设置新的timer事件</p> <p>事件队列具有一定限制但充足的规模，所以对于一个正确的开发程序来说，不可能出现队列溢出的情况。当队列溢出时，新事件会被舍弃，而不会将其设置为队列。</p> <p>强烈建议不要使用无限循环来处理事件。可能的例外就是处理单独的Start事件的脚本。</p> <p>程序库不处理任何事件。</p> <h2 id="_13-1-onstart"><a href="#_13-1-onstart" class="header-anchor">#</a> 13.1 OnStart</h2> <p>当Start事件发生时调用这个函数。这个函数旨在一次性执行脚本中实施的操作。有两种函数类型。</p> <p>返回结果的版本</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>返回值
int类型的值显示在“日志”选项卡中。</p> <p>脚本执行完成之后，在程序端日志中创建了“脚本script_name已移除（结果代码N）”条目。在这里，N是OnStart()函数的返回值。</p> <p>建议使用返回执行结果的OnStart()调用，因为它不仅允许脚本执行，还可以返回错误代码或其他有用的数据来分析脚本执行结果。</p> <p>没有结果返回的版本只为与旧代码兼容而保留。不建议使用</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>  <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意
OnStart()是处理脚本事件的唯一函数。不会有其他事件被发送至脚本。Start事件不被传递到EA和自定义指标。</p> <p>脚本样例：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//--- 用于处理颜色的宏 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">XRGB</span><span class="token expression"><span class="token punctuation">(</span>r<span class="token punctuation">,</span>g<span class="token punctuation">,</span>b<span class="token punctuation">)</span>    <span class="token punctuation">(</span><span class="token number">0xFF000000</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token function">uchar</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token function">uchar</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token function">uchar</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GETRGB</span><span class="token expression"><span class="token punctuation">(</span>clr<span class="token punctuation">)</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span>clr<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xFFFFFF</span><span class="token punctuation">)</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 脚本程序起始函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 设置一个下行的蜡烛图颜色 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Set a downward candle color&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_COLOR_CANDLE_BEAR<span class="token punctuation">,</span><span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 无需等候新报价，立即更新图表 </span>
   <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 暂停1秒，查看所有的变化 </span>
<span class="token comment">//--- 设置一个上行的蜡烛图颜色 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Set an upward candle color&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_COLOR_CANDLE_BULL<span class="token punctuation">,</span><span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">//--- 设置背景颜色 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Set the background color&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_COLOR_BACKGROUND<span class="token punctuation">,</span><span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">//--- 设置买价线的颜色 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Set color of Ask line&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_COLOR_ASK<span class="token punctuation">,</span><span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">//--- 设置卖价线的颜色 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Set color of Bid line&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_COLOR_BID<span class="token punctuation">,</span><span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
<span class="token comment">//--- 设置下行柱形图和下行蜡烛图框架的颜色 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Set color of a downward bar and a downward candle frame&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_COLOR_CHART_DOWN<span class="token punctuation">,</span><span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">//--- 设置图表线和Doji蜡烛图的颜色 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Set color of a chart line and Doji candlesticks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_COLOR_CHART_LINE<span class="token punctuation">,</span><span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">//--- 设置上行柱形图和上行蜡烛图框架的颜色   </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Set color of an upward bar and an upward candle frame&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_COLOR_CHART_UP<span class="token punctuation">,</span><span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">//--- 设置坐标轴、比例和OHLC线的颜色 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Set color of axes, scale and OHLC line&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_COLOR_FOREGROUND<span class="token punctuation">,</span><span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">//--- 设置一个网格颜色 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Set a grid color&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_COLOR_GRID<span class="token punctuation">,</span><span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">//--- 设置最后价格线 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Set Last price color&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_COLOR_LAST<span class="token punctuation">,</span><span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">//--- 设置止损和获利水平的颜色 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Set color of Stop Loss and Take Profit order levels&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_COLOR_STOP_LEVEL<span class="token punctuation">,</span><span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">//--- 设置交易量的颜色和市场进入水平 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;Set color of volumes and market entry levels&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_COLOR_VOLUME<span class="token punctuation">,</span><span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 返回一个随机生成的颜色                                              | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
color <span class="token function">GetRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   color clr<span class="token operator">=</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token function">GETRGB</span><span class="token punctuation">(</span><span class="token function">XRGB</span><span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">return</span> clr<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><p>另见
事件处理函数、程序运行、客户端事件</p> <h2 id="_13-2-oninit"><a href="#_13-2-oninit" class="header-anchor">#</a> 13.2 OnInit</h2> <p>当Init事件发生时在指标和EA中调用这个函数。它被用于初始化运行中的MQL5程序。有两种函数类型。</p> <p>返回结果的版本</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>返回值
int类型值，0意味着成功初始化。</p> <p>建议使用返回执行结果的OnInit()调用，因为它不仅可以程序初始化，还可以在早期程序终止的情况下返回一个错误代码。</p> <p>没有结果返回的版本只为与旧代码兼容而保留。不建议使用</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>  <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意
加载EA或指标之后会立即生成Init事件。不为脚本生成该事件。OnInit()函数被用来初始化MQL5程序。如果OnInit()有一个int类型的返回值，那么非零的返回代码意味着初始化失败，且生成REASON_INITFAILED去初始化原因代码的Deinit事件。</p> <p>void类型的OnInit()函数始终表示初始化成功，且不建议使用。</p> <p>为了优化EA 输入，建议使用来自ENUM_INIT_RETCODE枚举值作为返回代码。 这些值旨在建立优化过程管理，包括选择最合适的测试代理。在启动测试之前，在EA初始化过程中，可以使用TerminalInfoInteger()函数请求关于代理配置和资源（核心数量、空闲内存量等）的数据。根据所获得的数据，您既可以允许使用测试代理，也可以禁止它优化EA。</p> <table><thead><tr><th style="text-align:left;">ID</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">INIT_SUCCEEDED</td> <td style="text-align:left;">初始化成功，EA测试可以继续。<br>这个代码意同零值――测试中的EA初始化成功。</td></tr> <tr><td style="text-align:left;">INIT_FAILED</td> <td style="text-align:left;">初始化失败。由于不可避免的错误，因此继续测试没有意义。<br>例如，不能创建EA操作所需的指标。<br>这个值返回意同返回非零的值――测试中的EA初始化失败。</td></tr> <tr><td style="text-align:left;">INIT_PARAMETERS_INCORRECT</td> <td style="text-align:left;">旨在表示程序员一组不正确的输入参数。在通用的优化表格中，该返回代码的结果字符串以红色突出显示。<br>不执行这组EA输入的测试。代理已准备好接收新任务。<br>当收到该值时，策略测试不将此任务传递到另一个代理重复执行。</td></tr> <tr><td style="text-align:left;">INIT_AGENT_NOT_SUITABLE</td> <td style="text-align:left;">在初始化过程中没有程序执行错误。然而，出于某些原因，代理不适合进行测试。例如，没有足够的RAM，没有OpenCL support等。<br>返回该代码之后，直至这个优化结束，代理才会再接收任务</td></tr></tbody></table> <p>ID</p> <p>描述</p> <p>INIT_SUCCEEDED</p> <p>初始化成功，EA测试可以继续。</p> <p>这个代码意同零值――测试中的EA初始化成功。</p> <p>INIT_FAILED</p> <p>初始化失败。由于不可避免的错误，因此继续测试没有意义。例如，不能创建EA操作所需的指标。</p> <p>这个值返回意同返回非零的值――测试中的EA初始化失败。</p> <p>INIT_PARAMETERS_INCORRECT</p> <p>旨在表示程序员一组不正确的输入参数。在通用的优化表格中，该返回代码的结果字符串以红色突出显示。</p> <p>不执行这组EA输入的测试。代理已准备好接收新任务。 当收到该值时，策略测试不将此任务传递到另一个代理重复执行。</p> <p>INIT_AGENT_NOT_SUITABLE</p> <p>在初始化过程中没有程序执行错误。然而，出于某些原因，代理不适合进行测试。例如，没有足够的RAM，没有OpenCL support等。</p> <p>返回该代码之后，直至这个优化结束，代理才会再接收任务。</p> <p>使用OnInit()在测试中返回INIT_FAILED/INIT_PARAMETERS_INCORRECT有一些再优化EA时需要考虑的特性：</p> <p>OnInit()返回INIT_PARAMETERS_INCORRECT的参数集被认为不适合进行测试，并且在遗传优化期间不用于获取下一个群集。在寻找最佳EA参数时，太多“废弃”参数集可能导致错误的结果。搜索EA假设优化准则函数平滑，在整个输入参数上没有间隙。</p> <p>如果OnInit()返回INIT_FAILED，这意味着测试无法启动，EA从代理内存中卸载。再次加载EA，以使用一组新参数执行下一个传递。与调用TesterStop()相比，启动下一次优化传递需要更多的时间。</p> <p>EA的OnInit()样例函数</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//--- 输入参数 </span>
input <span class="token keyword">int</span>      ma_period<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span> <span class="token comment">//移动平均线周期 </span>
  
<span class="token comment">//--- 在EA中使用的指标句柄 </span>
<span class="token keyword">int</span> indicator_handle<span class="token punctuation">;</span>    
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA交易初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 检查ma_period有效性 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>ma_period<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid ma_period input value: %d&quot;</span><span class="token punctuation">,</span>ma_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span> <span class="token punctuation">(</span>INIT_PARAMETERS_INCORRECT<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 优化过程中 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MQLInfoInteger</span><span class="token punctuation">(</span>MQL_OPTIMIZATION<span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 为代理检查可用的RAM </span>
      <span class="token keyword">int</span> available_memory_mb<span class="token operator">=</span><span class="token function">TerminalInfoInteger</span><span class="token punctuation">(</span>TERMINAL_MEMORY_TOTAL<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span>available_memory_mb<span class="token operator">&lt;</span><span class="token number">2000</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Insufficient memory for the test agent: %d MB&quot;</span><span class="token punctuation">,</span> 
                     available_memory_mb<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">return</span> <span class="token punctuation">(</span>INIT_AGENT_NOT_SUITABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 检查指标 </span>
   indicator_handle<span class="token operator">=</span><span class="token function">iCustom</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">,</span><span class="token string">&quot;My_Indicator&quot;</span><span class="token punctuation">,</span>ma_period<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>indicator_handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to generate My_Indicator handle. Error code %d&quot;</span><span class="token punctuation">,</span> 
                  <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span> <span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- EA初始化成功 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>另见
OnDeinit、事件处理函数、程序运行、客户端事件、变量的初始化、创建和删除对象</p> <h2 id="_13-3-ondeinit"><a href="#_13-3-ondeinit" class="header-anchor">#</a> 13.3 OnDeinit</h2> <p>当Deinit事件发生时在指标和EA中调用这个函数。它被用于去初始化运行中的MQL5程序。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">OnDeinit</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> <span class="token keyword">int</span>  reason         <span class="token comment">//去初始化原因代码 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数
reason</p> <p>[in] 去初始化原因代码。</p> <p>返回值
无返回值</p> <p>注意
在以下情况下，为EA和指标生成Deinit事件：</p> <p>由于mql5程序附加的交易品种或图表周期发生变化而重新初始化之前；</p> <p>由于输入变化而重新初始化之前；</p> <p>卸载mql5程序之前。</p> <p>reason参数可能有以下值：</p> <table><thead><tr><th style="text-align:left;">常量</th> <th>值</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">REASON_PROGRAM</td> <td>0</td> <td style="text-align:left;">EA已停止调用ExpertRemove()函数的工作</td></tr> <tr><td style="text-align:left;">REASON_REMOVE</td> <td>1</td> <td style="text-align:left;">程序从图表移除</td></tr> <tr><td style="text-align:left;">REASON_RECOMPILE</td> <td>2</td> <td style="text-align:left;">程序重新编译</td></tr> <tr><td style="text-align:left;">REASON_CHARTCHANGE</td> <td>3</td> <td style="text-align:left;">交易品种或图表周期被改变</td></tr> <tr><td style="text-align:left;">REASON_CHARTCLOSE</td> <td>4</td> <td style="text-align:left;">图表已关闭</td></tr> <tr><td style="text-align:left;">REASON_PARAMETERS</td> <td>5</td> <td style="text-align:left;">由用户更改的输入参数</td></tr> <tr><td style="text-align:left;">REASON_ACCOUNT</td> <td>6</td> <td style="text-align:left;">由于账户设置的变化，另一个账户已被激活或已被重新连接到交易服务器</td></tr> <tr><td style="text-align:left;">REASON_TEMPLATE</td> <td>7</td> <td style="text-align:left;">应用另一个图表模板</td></tr> <tr><td style="text-align:left;">REASON_INITFAILED</td> <td>8</td> <td style="text-align:left;">OnInit()处理程序返回一个非零值</td></tr> <tr><td style="text-align:left;">REASON_CLOSE</td> <td>9</td> <td style="text-align:left;">程序端已关闭</td></tr></tbody></table> <p>EA去初始化原因代码可通过UninitializeReason()函数接收或者从预定义_UninitReason变量接收。</p> <p>EA的OnInit()和OnDeinit()示例函数</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>input <span class="token keyword">int</span> fake_parameter<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>      <span class="token comment">// 无用的参数 </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA交易初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 获取程序被编译的构建号 </span>
   <span class="token function">Print</span><span class="token punctuation">(</span>__FUNCTION__<span class="token punctuation">,</span><span class="token string">&quot; Build #&quot;</span><span class="token punctuation">,</span>__MQLBUILD__<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在OnInit()中还可以获得重置原因代码 </span>
   <span class="token function">Print</span><span class="token punctuation">(</span>__FUNCTION__<span class="token punctuation">,</span><span class="token string">&quot; Deinitialization reason code can be received during the EA reset&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 获得去初始化原因代码的第一个方式 </span>
   <span class="token function">Print</span><span class="token punctuation">(</span>__FUNCTION__<span class="token punctuation">,</span><span class="token string">&quot; _UninitReason = &quot;</span><span class="token punctuation">,</span><span class="token function">getUninitReasonText</span><span class="token punctuation">(</span>_UninitReason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 获得去初始化原因代码的第二个方式   </span>
   <span class="token function">Print</span><span class="token punctuation">(</span>__FUNCTION__<span class="token punctuation">,</span><span class="token string">&quot; UninitializeReason() = &quot;</span><span class="token punctuation">,</span><span class="token function">getUninitReasonText</span><span class="token punctuation">(</span><span class="token function">UninitializeReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA交易去初始化函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 获得去初始化原因代码的第一个方式 </span>
   <span class="token function">Print</span><span class="token punctuation">(</span>__FUNCTION__<span class="token punctuation">,</span><span class="token string">&quot; Deinitialization reason code = &quot;</span><span class="token punctuation">,</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 获得去初始化原因代码的第二个方式 </span>
   <span class="token function">Print</span><span class="token punctuation">(</span>__FUNCTION__<span class="token punctuation">,</span><span class="token string">&quot; _UninitReason = &quot;</span><span class="token punctuation">,</span><span class="token function">getUninitReasonText</span><span class="token punctuation">(</span>_UninitReason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 获得去初始化原因代码的第三个方式   </span>
   <span class="token function">Print</span><span class="token punctuation">(</span>__FUNCTION__<span class="token punctuation">,</span><span class="token string">&quot; UninitializeReason() = &quot;</span><span class="token punctuation">,</span><span class="token function">getUninitReasonText</span><span class="token punctuation">(</span><span class="token function">UninitializeReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 返回去初始化原因代码的文本描述                                       | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
string <span class="token function">getUninitReasonText</span><span class="token punctuation">(</span><span class="token keyword">int</span> reasonCode<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   string text<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">switch</span><span class="token punctuation">(</span>reasonCode<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">case</span> REASON_ACCOUNT<span class="token operator">:</span> 
         text<span class="token operator">=</span><span class="token string">&quot;Account was changed&quot;</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> REASON_CHARTCHANGE<span class="token operator">:</span> 
         text<span class="token operator">=</span><span class="token string">&quot;Symbol or timeframe was changed&quot;</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> REASON_CHARTCLOSE<span class="token operator">:</span> 
         text<span class="token operator">=</span><span class="token string">&quot;Chart was closed&quot;</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> REASON_PARAMETERS<span class="token operator">:</span> 
         text<span class="token operator">=</span><span class="token string">&quot;Input-parameter was changed&quot;</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> REASON_RECOMPILE<span class="token operator">:</span> 
         text<span class="token operator">=</span><span class="token string">&quot;Program &quot;</span><span class="token operator">+</span><span class="token constant">__FILE__</span><span class="token operator">+</span><span class="token string">&quot; was recompiled&quot;</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> REASON_REMOVE<span class="token operator">:</span> 
         text<span class="token operator">=</span><span class="token string">&quot;Program &quot;</span><span class="token operator">+</span><span class="token constant">__FILE__</span><span class="token operator">+</span><span class="token string">&quot; was removed from chart&quot;</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> REASON_TEMPLATE<span class="token operator">:</span> 
         text<span class="token operator">=</span><span class="token string">&quot;New template was applied to chart&quot;</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">default</span><span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">&quot;Another reason&quot;</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">return</span> text<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>另见
OnInit、 事件处理函数、程序运行、客户端事件、去初始化原因代码、可视范围和变量的生命周期、 创建和删除对象</p> <h2 id="_13-4-ontick"><a href="#_13-4-ontick" class="header-anchor">#</a> 13.4 OnTick</h2> <p>当NewTick事件发生时在EA中调用这个函数，来处理一个新报价。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>  <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>返回值
无返回值</p> <p>注意
NewTick事件只在收到一个新报价时为EA生成，以获得EA所附加的图表的交易品种。在自定义指标或脚本中定义OnTick()函数没有意义，因为没有为其生成NewTick事件。</p> <p>Tick事件只为EA生成，但这并不意味着EA必须包含OnTick()函数的功能，因为除了NewTick以外，还为EA生成Timer、BookEvent和ChartEvent事件。</p> <p>所有事件都按照它们的接收顺序依次处理。如果这个队列已经包括NewTick事件，或者这个事件正在处理阶段，那么新的NewTick事件就不能添加到mql5应用程序队列中。</p> <p>无论是否启用自动交易（自动交易按键），都会生成NewTick事件。禁用自动交易意味着只禁止从EA发送交易请求。EA操作不会停止。</p> <p>通过按下自动交易按键来禁用自动交易并不会中断OnTick()函数的当前执行。</p> <p>在OnTick()函数中，显示整个交易逻辑特性的EA示例</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                                   TradeByATR.mq5 | </span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Sample EA trading in the \&quot;explosive\&quot; candle direction&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;\&quot;Explosive\&quot; candle has the body size exceeding k*ATR&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The \&quot;revers\&quot; parameter reverses the signal direction&quot;</span> </span>
  
input <span class="token keyword">double</span> lots<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">;</span>        <span class="token comment">// 交易量手数 </span>
input <span class="token keyword">double</span> kATR<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>          <span class="token comment">// ATR中的信号蜡烛长度 </span>
input <span class="token keyword">int</span>    ATRperiod<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>    <span class="token comment">// ATR指标周期 </span>
input <span class="token keyword">int</span>    holdbars<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>      <span class="token comment">// 保持持仓的柱形图数量 </span>
input <span class="token keyword">int</span>    slippage<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>     <span class="token comment">// 可允许滑移 </span>
input <span class="token keyword">bool</span>   revers<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment">//反向信号？ </span>
input ulong  EXPERT_MAGIC<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// EA幻数 </span>
<span class="token comment">//--- 用于存储ATR指标句柄 </span>
<span class="token keyword">int</span> atr_handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 在这里，我们将存储ATR最后值和蜡烛体 </span>
<span class="token keyword">double</span> last_atr<span class="token punctuation">,</span>last_body<span class="token punctuation">;</span> 
datetime lastbar_timeopen<span class="token punctuation">;</span> 
<span class="token keyword">double</span> trade_lot<span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA交易初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 初始化全局变量 </span>
   last_atr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   last_body<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置正确的交易量 </span>
   <span class="token keyword">double</span> min_lot<span class="token operator">=</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>SYMBOL_VOLUME_MIN<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   trade_lot<span class="token operator">=</span>lots<span class="token operator">&gt;</span>min_lot<span class="token operator">?</span> lots<span class="token operator">:</span>min_lot<span class="token punctuation">;</span>    
<span class="token comment">//--- 创建ATR指标句柄 </span>
   atr_handle<span class="token operator">=</span><span class="token function">iATR</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">,</span>ATRperiod<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>atr_handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: failed to create iATR, error code %d&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- EA成功初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA交易去初始化函数                                                 | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 通知EA操作结束代码 </span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span><span class="token string">&quot;: Deinitialization reason code = &quot;</span><span class="token punctuation">,</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA报价函数                                                        | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 交易信号 </span>
   <span class="token keyword">static</span> <span class="token keyword">int</span> signal<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// +1表示买入信号， -1 表示卖出信号 </span>
<span class="token comment">//--- 检查和关闭‘holdbars’柱形图之前开仓的旧持仓 </span>
   <span class="token function">ClosePositionsByBars</span><span class="token punctuation">(</span>holdbars<span class="token punctuation">,</span>slippage<span class="token punctuation">,</span>EXPERT_MAGIC<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 检查新柱形图 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNewBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 检查信号是否存在      </span>
      signal<span class="token operator">=</span><span class="token function">CheckSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果持有单边持仓，跳过信号-等候直至关闭 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>signal<span class="token operator">!=</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PositionsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ENUM_ACCOUNT_MARGIN_MODE<span class="token punctuation">)</span><span class="token function">AccountInfoInteger</span><span class="token punctuation">(</span>ACCOUNT_MARGIN_MODE<span class="token punctuation">)</span><span class="token operator">==</span>ACCOUNT_MARGIN_MODE_RETAIL_NETTING<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      signal<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 退出NewTick事件处理程序，并在新柱形图出现之前不要进入市场 </span>
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 对于锁仓账户，每个持仓都是单独持仓和平仓 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>signal<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 买入信号 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>signal<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Buy signal! Revers=%s&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span><span class="token function">string</span><span class="token punctuation">(</span>revers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Buy</span><span class="token punctuation">(</span>trade_lot<span class="token punctuation">,</span>slippage<span class="token punctuation">,</span>EXPERT_MAGIC<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            signal<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      <span class="token comment">//--- 卖出信号 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>signal<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Sell signal! Revers=%s&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span><span class="token function">string</span><span class="token punctuation">(</span>revers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Sell</span><span class="token punctuation">(</span>trade_lot<span class="token punctuation">,</span>slippage<span class="token punctuation">,</span>EXPERT_MAGIC<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            signal<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- OnTick函数结束 </span>
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 检查新的交易信号                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">CheckSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 0 意味着没有信号 </span>
   <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 获得倒数第二个完整柱形图的ATR值（柱形图索引是2） </span>
   <span class="token keyword">double</span> atr_value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>atr_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>atr_value<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      last_atr<span class="token operator">=</span>atr_value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 获得最后关闭的柱形图的MqlRates类型数组数据 </span>
      MqlRates bar<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyRates</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>bar<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token comment">//--- 计算最后完整柱形图的柱体大小 </span>
         last_body<span class="token operator">=</span>bar<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>close<span class="token operator">-</span>bar<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>open<span class="token punctuation">;</span> 
         <span class="token comment">//--- 如果最后柱形图的柱体（索引为1）超过的之前ATR的值（柱形图索引为2），那么会收到一个交易信号 </span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MathAbs</span><span class="token punctuation">(</span>last_body<span class="token punctuation">)</span><span class="token operator">&gt;</span>kATR<span class="token operator">*</span>last_atr<span class="token punctuation">)</span> 
            res<span class="token operator">=</span>last_body<span class="token operator">&gt;</span><span class="token number">0</span><span class="token operator">?</span><span class="token number">1</span><span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 向上蜡烛图的正值 </span>
        <span class="token punctuation">}</span> 
      <span class="token keyword">else</span> 
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Failed to receive the last bar! Error&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Failed to receive ATR indicator value! Error&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果启用了反向交易模式 </span>
   res<span class="token operator">=</span>revers<span class="token operator">?</span><span class="token operator">-</span>res<span class="token operator">:</span>res<span class="token punctuation">;</span>  <span class="token comment">// 在必要时反转信号（返回-1而不是1，反之亦然） </span>
<span class="token comment">//--- 返回一个交易信号值 </span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|  当新柱形图出现时返回'true'                                         | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">isNewBar</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">bool</span> print_log<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token keyword">static</span> datetime bartime<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//存储当前柱形图的开盘时间 </span>
<span class="token comment">//--- 获得零柱的开盘时间 </span>
   datetime currbar_time<span class="token operator">=</span><span class="token function">iTime</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果开盘时间更改，则新柱形图出现 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>bartime<span class="token operator">!=</span>currbar_time<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      bartime<span class="token operator">=</span>currbar_time<span class="token punctuation">;</span> 
      lastbar_timeopen<span class="token operator">=</span>bartime<span class="token punctuation">;</span> 
      <span class="token comment">//--- 在日志中显示新柱形图开盘时间的数据       </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>print_log <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">MQLInfoInteger</span><span class="token punctuation">(</span>MQL_OPTIMIZATION<span class="token punctuation">)</span><span class="token operator">||</span><span class="token function">MQLInfoInteger</span><span class="token punctuation">(</span>MQL_TESTER<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token comment">//--- 显示新柱形图开盘时间的信息 </span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: new bar on %s %s opened at %s&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>_Symbol<span class="token punctuation">,</span> 
                     <span class="token function">StringSubstr</span><span class="token punctuation">(</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>_Period<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                     <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 获取关于最后报价的数据 </span>
         MqlTick last_tick<span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SymbolInfoTick</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>last_tick<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;SymbolInfoTick() failed, error = &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 显示最后报价的时间，精确至毫秒 </span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Last tick was at %s.%03d&quot;</span><span class="token punctuation">,</span> 
                     <span class="token function">TimeToString</span><span class="token punctuation">(</span>last_tick<span class="token punctuation">.</span>time<span class="token punctuation">,</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span>last_tick<span class="token punctuation">.</span>time_msc<span class="token operator">%</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      <span class="token comment">//--- 我们有一个新柱形图 </span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 没有新柱形图 </span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 以指定交易量和市场价买入                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">Buy</span><span class="token punctuation">(</span><span class="token keyword">double</span> volume<span class="token punctuation">,</span>ulong deviation<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>ulong  magicnumber<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 以市场价买入 </span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">MarketOrder</span><span class="token punctuation">(</span>ORDER_TYPE_BUY<span class="token punctuation">,</span>volume<span class="token punctuation">,</span>deviation<span class="token punctuation">,</span>magicnumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 以指定交易量和市场价卖出                                             | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">Sell</span><span class="token punctuation">(</span><span class="token keyword">double</span> volume<span class="token punctuation">,</span>ulong deviation<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>ulong  magicnumber<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 以市场价卖出 </span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">MarketOrder</span><span class="token punctuation">(</span>ORDER_TYPE_SELL<span class="token punctuation">,</span>volume<span class="token punctuation">,</span>deviation<span class="token punctuation">,</span>magicnumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 在柱形图中根据持有时间平仓                                           | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">ClosePositionsByBars</span><span class="token punctuation">(</span><span class="token keyword">int</span> holdtimebars<span class="token punctuation">,</span>ulong deviation<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>ulong  magicnumber<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token keyword">int</span> total<span class="token operator">=</span><span class="token function">PositionsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 持仓数量   </span>
<span class="token comment">//--- 重复持仓 </span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>total<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 持仓参数 </span>
      ulong  position_ticket<span class="token operator">=</span><span class="token function">PositionGetTicket</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                                      <span class="token comment">// 持仓单号 </span>
      string position_symbol<span class="token operator">=</span><span class="token function">PositionGetString</span><span class="token punctuation">(</span>POSITION_SYMBOL<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">//交易品种  </span>
      ulong  magic<span class="token operator">=</span><span class="token function">PositionGetInteger</span><span class="token punctuation">(</span>POSITION_MAGIC<span class="token punctuation">)</span><span class="token punctuation">;</span>                                  <span class="token comment">// 持仓幻数 </span>
      datetime position_open<span class="token operator">=</span><span class="token punctuation">(</span>datetime<span class="token punctuation">)</span><span class="token function">PositionGetInteger</span><span class="token punctuation">(</span>POSITION_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// 持仓开盘时间 </span>
      <span class="token keyword">int</span> bars<span class="token operator">=</span><span class="token function">iBarShift</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>PERIOD_CURRENT<span class="token punctuation">,</span>position_open<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                       <span class="token comment">// 开仓之前有多少柱形图 </span>
  
      <span class="token comment">//--- 如果持仓的生命周期很长，则幻数和交易品种匹配 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>bars <span class="token operator">&gt;</span> holdtimebars <span class="token operator">&amp;&amp;</span> magic<span class="token operator">==</span>magicnumber <span class="token operator">&amp;&amp;</span> position_symbol<span class="token operator">==</span>_Symbol<span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token keyword">int</span>    digits<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>position_symbol<span class="token punctuation">,</span>SYMBOL_DIGITS<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 小数位数 </span>
         <span class="token keyword">double</span> volume<span class="token operator">=</span><span class="token function">PositionGetDouble</span><span class="token punctuation">(</span>POSITION_VOLUME<span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">// 持仓交易量 </span>
         ENUM_POSITION_TYPE type<span class="token operator">=</span><span class="token punctuation">(</span>ENUM_POSITION_TYPE<span class="token punctuation">)</span><span class="token function">PositionGetInteger</span><span class="token punctuation">(</span>POSITION_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 持仓类型 </span>
         string str_type<span class="token operator">=</span><span class="token function">StringSubstr</span><span class="token punctuation">(</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token function">StringToLower</span><span class="token punctuation">(</span>str_type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//纠正消息格式的小写文本案例 </span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Close position #%d %s %s %.2f&quot;</span><span class="token punctuation">,</span> 
                     position_ticket<span class="token punctuation">,</span>position_symbol<span class="token punctuation">,</span>str_type<span class="token punctuation">,</span>volume<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 设置一个订单类型并发送交易请求 </span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>POSITION_TYPE_BUY<span class="token punctuation">)</span> 
            <span class="token function">MarketOrder</span><span class="token punctuation">(</span>ORDER_TYPE_SELL<span class="token punctuation">,</span>volume<span class="token punctuation">,</span>deviation<span class="token punctuation">,</span>magicnumber<span class="token punctuation">,</span>position_ticket<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">else</span> 
            <span class="token function">MarketOrder</span><span class="token punctuation">(</span>ORDER_TYPE_BUY<span class="token punctuation">,</span>volume<span class="token punctuation">,</span>deviation<span class="token punctuation">,</span>magicnumber<span class="token punctuation">,</span>position_ticket<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 准备和发送交易请求                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">MarketOrder</span><span class="token punctuation">(</span>ENUM_ORDER_TYPE type<span class="token punctuation">,</span><span class="token keyword">double</span> volume<span class="token punctuation">,</span>ulong slip<span class="token punctuation">,</span>ulong magicnumber<span class="token punctuation">,</span>ulong pos_ticket<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 声明和初始化结构 </span>
   MqlTradeRequest request<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span> 
   MqlTradeResult  result<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span> price<span class="token operator">=</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SYMBOL_BID<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>ORDER_TYPE_BUY<span class="token punctuation">)</span> 
      price<span class="token operator">=</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SYMBOL_ASK<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 请求参数 </span>
   request<span class="token punctuation">.</span>action   <span class="token operator">=</span>TRADE_ACTION_DEAL<span class="token punctuation">;</span>                     <span class="token comment">// 交易操作类型 </span>
   request<span class="token punctuation">.</span>position <span class="token operator">=</span>pos_ticket<span class="token punctuation">;</span>                            <span class="token comment">// 关闭情况下的持仓单号 </span>
   request<span class="token punctuation">.</span>symbol   <span class="token operator">=</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">// 交易品种 </span>
   request<span class="token punctuation">.</span>volume   <span class="token operator">=</span>volume<span class="token punctuation">;</span>                                <span class="token comment">// 交易量 </span>
   request<span class="token punctuation">.</span>type     <span class="token operator">=</span>type<span class="token punctuation">;</span>                                  <span class="token comment">// 订单类型 </span>
   request<span class="token punctuation">.</span>price    <span class="token operator">=</span>price<span class="token punctuation">;</span>                                 <span class="token comment">// 交易价格 </span>
   request<span class="token punctuation">.</span>deviation<span class="token operator">=</span>slip<span class="token punctuation">;</span>                                  <span class="token comment">// 可允许的价格偏差 </span>
   request<span class="token punctuation">.</span>magic    <span class="token operator">=</span>magicnumber<span class="token punctuation">;</span>                           <span class="token comment">// 订单幻数 </span>
<span class="token comment">//--- 发送请求 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OrderSend</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 显示数据失败 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;OrderSend %s %s %.2f at %.5f error %d&quot;</span><span class="token punctuation">,</span> 
                  request<span class="token punctuation">.</span>symbol<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span>volume<span class="token punctuation">,</span>request<span class="token punctuation">.</span>price<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 通知成功操作 </span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;retcode=%u  deal=%I64u  order=%I64u&quot;</span><span class="token punctuation">,</span>result<span class="token punctuation">.</span>retcode<span class="token punctuation">,</span>result<span class="token punctuation">.</span>deal<span class="token punctuation">,</span>result<span class="token punctuation">.</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br></div></div><p>另见
事件处理函数、程序运行、客户端事件、OnTimer、 OnBookEvent、OnChartEvent</p> <h2 id="_13-5-oncalculate"><a href="#_13-5-oncalculate" class="header-anchor">#</a> 13.5 OnCalculate</h2> <p>当Calculate事件发生时在指标中调用这个函数，来处理价格数据的变化。有两种函数类型。一个指标内只可以使用其中一种。</p> <p>基于数据数组的计算</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">OnCalculate</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> <span class="token keyword">int</span>        rates_total<span class="token punctuation">,</span>       <span class="token comment">// price[]数组大小 </span>
   <span class="token keyword">const</span> <span class="token keyword">int</span>        prev_calculated<span class="token punctuation">,</span>   <span class="token comment">// 在前一个调用中处理过的柱形图数量 </span>
   <span class="token keyword">const</span> <span class="token keyword">int</span>        begin<span class="token punctuation">,</span>             <span class="token comment">//price[]数组中，有意义数据开始的索引编号 </span>
   <span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">&amp;</span>    price<span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token comment">// 计算值数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>基于当前时间周期时间序列的计算</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">OnCalculate</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> <span class="token keyword">int</span>        rates_total<span class="token punctuation">,</span>       <span class="token comment">// 输入时间序列的大小 </span>
   <span class="token keyword">const</span> <span class="token keyword">int</span>        prev_calculated<span class="token punctuation">,</span>   <span class="token comment">// 在前一个调用中处理过的柱形图数量 </span>
   <span class="token keyword">const</span> datetime<span class="token operator">&amp;</span>  time<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token comment">// 时间数组 </span>
   <span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">&amp;</span>    open<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token comment">// 开盘价数组 </span>
   <span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">&amp;</span>    high<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token comment">// 最高价数组 </span>
   <span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">&amp;</span>    low<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment">// 最低价数组 </span>
   <span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">&amp;</span>    close<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>           <span class="token comment">// 收盘价数组 </span>
   <span class="token keyword">const</span> <span class="token keyword">long</span><span class="token operator">&amp;</span>      tick_volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment">// 报价量数组 </span>
   <span class="token keyword">const</span> <span class="token keyword">long</span><span class="token operator">&amp;</span>      volume<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>          <span class="token comment">// 真实交易量数组 </span>
   <span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">&amp;</span>       spread<span class="token punctuation">[</span><span class="token punctuation">]</span>           <span class="token comment">// 点差数组 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>参数
rates_total</p> <p>[in] 可用于指标计算的price[]数组或输入序列的大小。在第二个函数类型中，当参数值对应于图表中柱形图数量时，启动这种函数类型。</p> <p>prev_calculated</p> <p>[in] 包含上一次调用期间OnCalculate()函数的返回值。它的设计旨在跳过自该函数上次启动后没有改变的柱形图。</p> <p>begin</p> <p>[in] price[]数组中，有意义数据开始的索引编号。它允许您跳过缺失或初始数据，因为没有正确的值。</p> <p>price[]</p> <p>[in] 计算值数组。其中一个价格时间序列或计算过的指标缓冲区可以作为price[]数组进行传递。为计算而传递的数据类型可以使用_AppliedTo预定义变量来定义。</p> <p>time{}</p> <p>[in] 柱形图开盘时间值的数组。</p> <p>open[]</p> <p>[in] 开盘价格值的数组。</p> <p>high[]</p> <p>[in] 最高价格值的数组。</p> <p>low[]</p> <p>[in] 最低价格值的数组。</p> <p>close[]</p> <p>[in] 收盘价格值的数组。</p> <p>tick_volume[]</p> <p>[in] 报价量值的数组。</p> <p>volume[]</p> <p>[in] 交易量值的数组。</p> <p>spread[]</p> <p>[in] 柱形图点差值的数组。</p> <p>返回值
int类型值将在下一次函数调用期间作为prev_calculated参数被传递。</p> <p>注意
如果OnCalculate()函数等于零，则没有指标值显示在客户的数据窗口中。 如果价格数据在最后一次调用OnCalculate()函数之后发生了变化（已加载更深层历史记录或已填充历史记录空白），那么程序端本身则将prev_calculated输入参数设为零。</p> <p>若要在time[]、open[]、high[]、low[]、 close[]、tick_volume[]、volume[]和spread[]数组中定义索引方向，请调用ArrayGetAsSeries()函数。为了不依赖于默认值，请为数组调用ArraySetAsSeries()函数来进行处理。</p> <p>当使用第一种函数类型时，在启动指标时用户选择必要的时间序列或指标作为“参数”选项卡中的price[]数据。为此，请在“应用于”字段的下拉列表中指定必要的元素。</p> <p>若要获取其他mql5程序的自定义指标值，则使用iCustom()函数。它返回后续操作的指标句柄。也可以指定所需的price [] 数组或另一个指标的句柄。这个参数应被传递到自定义指标输入变量列表的最后。</p> <p>有必要使用OnCalculate()函数返回值和prev_calculated第二个输入参数之间的连接。当调用函数时，prev_calculated函数包含了上一次调用期间OnCalculate()函数的返回值。这使得为计算自定义指标而实现资源节约算法成为可能，以避免重复计算自上一次启动该函数以来没有改变的柱形图。</p> <p>样例指标</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                           OnCalculate_Sample.mq5 | </span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Sample Momentum indicator calculation&quot;</span> </span>
  
<span class="token comment">//---- 指标设置 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_separate_window </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_buffers <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_plots   <span class="token number">1</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_type1   DRAW_LINE </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">indicator_color1  Blue </span></span>
<span class="token comment">//---- 输入 </span>
input <span class="token keyword">int</span> MomentumPeriod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span> <span class="token comment">// 计算周期 </span>
<span class="token comment">//---- 指标缓存区 </span>
<span class="token keyword">double</span>    MomentumBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 存储计算周期的全局变量 </span>
<span class="token keyword">int</span>       IntPeriod<span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 自定义指标初始化函数                                                | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 检查输入参数 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>MomentumPeriod<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      IntPeriod<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Period parameter has an incorrect value. The following value is to be used for calculations &quot;</span><span class="token punctuation">,</span>IntPeriod<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
      IntPeriod<span class="token operator">=</span>MomentumPeriod<span class="token punctuation">;</span> 
<span class="token comment">//---- 缓冲区   </span>
   <span class="token function">SetIndexBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>MomentumBuffer<span class="token punctuation">,</span>INDICATOR_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//---- 显示在“数据窗口”和子窗口的指标名称 </span>
   <span class="token function">IndicatorSetString</span><span class="token punctuation">(</span>INDICATOR_SHORTNAME<span class="token punctuation">,</span><span class="token string">&quot;Momentum&quot;</span><span class="token operator">+</span><span class="token string">&quot;(&quot;</span><span class="token operator">+</span><span class="token function">string</span><span class="token punctuation">(</span>IntPeriod<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置柱形图绘制的开始索引 </span>
   <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_DRAW_BEGIN<span class="token punctuation">,</span>IntPeriod<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 将0.0设置为未绘制的空值 </span>
   <span class="token function">PlotIndexSetDouble</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_EMPTY_VALUE<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 显示的指标精确性 </span>
   <span class="token function">IndicatorSetInteger</span><span class="token punctuation">(</span>INDICATOR_DIGITS<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|  动量指标计算                                                      | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnCalculate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> rates_total<span class="token punctuation">,</span>     <span class="token comment">// price[] array size  </span>
                <span class="token keyword">const</span> <span class="token keyword">int</span> prev_calculated<span class="token punctuation">,</span> <span class="token comment">// 之前处理的柱形图的数量 </span>
                <span class="token keyword">const</span> <span class="token keyword">int</span> begin<span class="token punctuation">,</span>           <span class="token comment">//重要数据起点  </span>
                <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>price<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>     <span class="token comment">// 值数组处理 </span>
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 初始持仓计算 </span>
   <span class="token keyword">int</span> StartCalcPosition<span class="token operator">=</span><span class="token punctuation">(</span>IntPeriod<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>begin<span class="token punctuation">;</span> 
<span class="token comment">//---- 如果计算数据不足 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>rates_total StartCalcPosition<span class="token punctuation">)</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 以零值推出 - 这个指标没有被计算 </span>
<span class="token comment">//--- 正确绘制开始 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>begin<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
      <span class="token function">PlotIndexSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>PLOT_DRAW_BEGIN<span class="token punctuation">,</span>StartCalcPosition<span class="token operator">+</span><span class="token punctuation">(</span>IntPeriod<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 开始计算，定义开始位置 </span>
   <span class="token keyword">int</span> pos<span class="token operator">=</span>prev_calculated<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>pos StartCalcPosition<span class="token punctuation">)</span> 
      pos<span class="token operator">=</span>begin<span class="token operator">+</span>IntPeriod<span class="token punctuation">;</span> 
<span class="token comment">//--- 主计算循环 </span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>pos<span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rates_total <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> 
      MomentumBuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>price<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span>price<span class="token punctuation">[</span>i<span class="token operator">-</span>IntPeriod<span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- OnCalculate执行完成。返回后续调用的新prev_calculated值 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>rates_total<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><p>另见
ArrayGetAsSeries、ArraySetAsSeries、iCustom、事件处理函数、程序运行、客户端事件、访问时间序列和指标</p> <h2 id="_13-6-ontimer"><a href="#_13-6-ontimer" class="header-anchor">#</a> 13.6 OnTimer</h2> <p>当Timer事件在固定时间间隔内由程序端生成期间，在EA中调用这个函数。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>  <span class="token function">OnTimer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>返回值
无返回值</p> <p>注意
Timer事件是由客户端为EA定期生成，使用EventSetTimer()函数来激活计时器。通常，这个函数在OnInit()函数中调用。EA停止工作时，应使用通常在OnDeinit()函数中被调用的EventKillTimer()消除计时器。</p> <p>每个EA和每个指标都使用其自己的计时器，并从该计时器单独接收事件。mql5程序关闭期间，如果计时器已经创建但没有被EventKillTimer()函数禁用，那么计时器则被强制销毁。</p> <p>如果您不满足于每秒一次，需要更频繁地接收计时器事件，请使用EventSetMillisecondTimer()来创建高分辨率计时器。</p> <p>策略测试中使用1000毫秒最小间隔。一般来说，当计时器周期减少时，测试时间会增加，因为计时器事件的处理程序会更频繁地被调用。在实时模式下工作时，由于硬件的限制，计时器事件在10-16毫秒内生成不超过1次。</p> <p>每个程序只能启动一个计时器。每个mql5应用程序和图表都有其自己的事件队列，所有新到达的事件也都包括其中。如果这个队列已经包括Timer事件，或者这个事件正在处理阶段，那么新的Timer事件就不能添加到mql5应用程序队列中。</p> <p>EA样例，OnTimer()处理程序</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                               OnTimer_Sample.mq5 | </span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Example of using the timer for calculating the trading server time&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;It is recommended to run the EA at the end of a trading week before the weekend&quot;</span> </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA交易初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 创建一个1秒周期的计时器 </span>
   <span class="token function">EventSetTimer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
<span class="token comment">//--- </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA交易去初始化函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 完成工作后销毁计时器 </span>
   <span class="token function">EventKillTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA报价函数                                                        | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- </span>
  
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| Timer函数                                                         | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- OnTimer()首次调用的时间 </span>
   <span class="token keyword">static</span> datetime start_time<span class="token operator">=</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 第一次调用OnTimer()期间交易服务器的时间 </span>
   <span class="token keyword">static</span> datetime start_tradeserver_time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 计算交易服务器时间 </span>
   <span class="token keyword">static</span> datetime calculated_server_time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 本地PC时间 </span>
   datetime local_time<span class="token operator">=</span><span class="token function">TimeLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 目前估计的交易服务器时间 </span>
   datetime trade_server_time<span class="token operator">=</span><span class="token function">TimeTradeServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果由于某种原因而未知服务器时间，则提前退出 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>trade_server_time<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果尚未设置初始交易服务器的值 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>start_tradeserver_time<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      start_tradeserver_time<span class="token operator">=</span>trade_server_time<span class="token punctuation">;</span> 
      <span class="token comment">//--- 设置交易服务器的计算值       </span>
      <span class="token function">Print</span><span class="token punctuation">(</span>trade_server_time<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      calculated_server_time<span class="token operator">=</span>trade_server_time<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 增加OnTimer()第一次调用的时间 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>start_tradeserver_time<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 
         calculated_server_time<span class="token operator">=</span>calculated_server_time<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//---  </span>
   string com<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;                  Start time: %s\r\n&quot;</span><span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>start_time<span class="token punctuation">,</span>TIME_MINUTES<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   com<span class="token operator">=</span>com<span class="token operator">+</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;                  Local time: %s\r\n&quot;</span><span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>local_time<span class="token punctuation">,</span>TIME_MINUTES<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   com<span class="token operator">=</span>com<span class="token operator">+</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;TimeTradeServer time: %s\r\n&quot;</span><span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>trade_server_time<span class="token punctuation">,</span>TIME_MINUTES<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   com<span class="token operator">=</span>com<span class="token operator">+</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot; EstimatedServer time: %s\r\n&quot;</span><span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>calculated_server_time<span class="token punctuation">,</span>TIME_MINUTES<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 显示图表上所有计数器的值 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>另见</p> <p>EventSetTimer、EventSetMillisecondTimer、EventKillTimer、 GetTickCount、GetMicrosecondCount、客户端事件</p> <h2 id="_13-7-ontrade"><a href="#_13-7-ontrade" class="header-anchor">#</a> 13.7 OnTrade</h2> <p>当Trade事件发生时在EA中调用这个函数。这个函数旨在处理订单、持仓和交易列表的变化。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>  <span class="token function">OnTrade</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>返回值
无返回值</p> <p>注意
OnTrade()只为EA交易调用。即使您在指标和脚本中添加了具有相同名称和类型的函数，也不能在这些指标和脚本中使用此函数。</p> <p>对于任何交易操作（下达挂单、开仓/平仓、下止损单、激活挂单等），订单和交易的历史和/或持仓和当前订单的列表都被适当更改。</p> <p>当处理一个订单时，交易服务器向程序端发送一条关于传入Trade事件的消息。若要从历史记录中检索订单和交易的相关数据，需要先使用HistorySelect()执行交易历史请求。</p> <p>如果出现以下情况，则服务器生成交易事件：
更改活跃订单，
更改持仓，
更改交易，
更改交易历史。</p> <p>每一个 Trade事件都可能作为一个或多个交易请求的结果出现。交易请求使用OrderSend()或OrderSendAsync()，被发送到服务器。每个请求都可能导致多个交易事件。您不能依赖“一个请求，一个交易事件”的声明，因为事件的处理可能分为几个阶段执行，并且每个操作都可能更改订单的状态、持仓和交易历史记录。</p> <p>OnTrade()处理程序在适当调用OnTradeTransaction()之后被调用。通常，在OnTrade ()和OnTradeTransaction ()调用的数量上没有确切的相关性。OnTrade()一次调用对应一次或多次的OnTradeTransaction调用。</p> <p>EA样例，OnTrade()处理程序</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                               OnTrade_Sample.mq5 | </span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
  
input    <span class="token keyword">int</span> days<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">;</span>            <span class="token comment">//按天计算的交易历史深度 </span>
<span class="token comment">//--- 在全局范围内设置交易历史的界限 </span>
datetime     start<span class="token punctuation">;</span>             <span class="token comment">// 缓存中交易历史的开始日期 </span>
datetime     end<span class="token punctuation">;</span>               <span class="token comment">// 缓存中交易历史的结束日期 </span>
<span class="token comment">//--- 全局计数器 </span>
<span class="token keyword">int</span>          orders<span class="token punctuation">;</span>            <span class="token comment">// 活跃订单数量 </span>
<span class="token keyword">int</span>          positions<span class="token punctuation">;</span>         <span class="token comment">// 持仓数量 </span>
<span class="token keyword">int</span>          deals<span class="token punctuation">;</span>             <span class="token comment">// 交易历史缓存中的交易数量 </span>
<span class="token keyword">int</span>          history_orders<span class="token punctuation">;</span>    <span class="token comment">// 交易历史缓存中的订单数量 </span>
<span class="token keyword">bool</span>         started<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>     <span class="token comment">// 计数器相关性标识 </span>
  
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA交易初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- </span>
   end<span class="token operator">=</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   start<span class="token operator">=</span>end<span class="token operator">-</span>days<span class="token operator">*</span><span class="token function">PeriodSeconds</span><span class="token punctuation">(</span>PERIOD_D1<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Limits of the history to be loaded: start - %s, end - %s&quot;</span><span class="token punctuation">,</span> 
               <span class="token function">TimeToString</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">InitCounters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|  持仓、订单和交易计数器的初始化                                       | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">InitCounters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 加载历史 </span>
   <span class="token keyword">bool</span> selected<span class="token operator">=</span><span class="token function">HistorySelect</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>selected<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s. Failed to load history from %s to %s to cache. Error code: %d&quot;</span><span class="token punctuation">,</span> 
                  __FUNCTION__<span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 获取当前值 </span>
   orders<span class="token operator">=</span><span class="token function">OrdersTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   positions<span class="token operator">=</span><span class="token function">PositionsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   deals<span class="token operator">=</span><span class="token function">HistoryDealsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   history_orders<span class="token operator">=</span><span class="token function">HistoryOrdersTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   started<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Counters of orders, positions and deals successfully initialized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>   
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA报价函数                                                        | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>started<span class="token punctuation">)</span> <span class="token function">SimpleTradeProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> <span class="token function">InitCounters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 当Trade事件到达时被调用                                             | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>started<span class="token punctuation">)</span> <span class="token function">SimpleTradeProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> <span class="token function">InitCounters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 处理交易和历史变化的示例                                            | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">SimpleTradeProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   end<span class="token operator">=</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ResetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 从指定的时间间隔下载交易历史到程序缓存 </span>
   <span class="token keyword">bool</span> selected<span class="token operator">=</span><span class="token function">HistorySelect</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>selected<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s. Failed to load history from %s to %s to cache. Error code: %d&quot;</span><span class="token punctuation">,</span> 
                  __FUNCTION__<span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 获取当前值 </span>
   <span class="token keyword">int</span> curr_orders<span class="token operator">=</span><span class="token function">OrdersTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span> curr_positions<span class="token operator">=</span><span class="token function">PositionsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span> curr_deals<span class="token operator">=</span><span class="token function">HistoryDealsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span> curr_history_orders<span class="token operator">=</span><span class="token function">HistoryOrdersTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 检查活跃订单的数量是否发生变化 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>curr_orders<span class="token operator">!=</span>orders<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 活跃订单的数量已经发生变化 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Number of orders has been changed. Previous value is %d, current value is %d&quot;</span><span class="token punctuation">,</span> 
                  orders<span class="token punctuation">,</span>curr_orders<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 更新值 </span>
      orders<span class="token operator">=</span>curr_orders<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 持仓数量的变化 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>curr_positions<span class="token operator">!=</span>positions<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 持仓的数量已经发生变化 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Number of positions has been changed. Previous value is %d, current value is %d&quot;</span><span class="token punctuation">,</span> 
                  positions<span class="token punctuation">,</span>curr_positions<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 更新值 </span>
      positions<span class="token operator">=</span>curr_positions<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 交易历史缓存中的交易数量的变化 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>curr_deals<span class="token operator">!=</span>deals<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 交易历史缓存中的交易数量已经发生变化 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Number of deals has been changed. Previous value is %d, current value is %d&quot;</span><span class="token punctuation">,</span> 
                  deals<span class="token punctuation">,</span>curr_deals<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 更新值 </span>
      deals<span class="token operator">=</span>curr_deals<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 交易历史缓存中的历史订单数量的变化 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>curr_history_orders<span class="token operator">!=</span>history_orders<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 交易历史缓存中的历史订单数量已经发生变化 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Number of orders in history has been changed. Previous value is %d, current value is %d&quot;</span><span class="token punctuation">,</span> 
                  history_orders<span class="token punctuation">,</span>curr_history_orders<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token comment">//--- 更新值 </span>
     history_orders<span class="token operator">=</span>curr_history_orders<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 检查是否有必要更改缓存中请求的交易历史的限制 </span>
   <span class="token function">CheckStartDateInTradeHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|  更改请求交易历史的开始日期                                          | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">CheckStartDateInTradeHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 初始时间间隔，如果我们现在开始工作 </span>
   datetime curr_start<span class="token operator">=</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>days<span class="token operator">*</span><span class="token function">PeriodSeconds</span><span class="token punctuation">(</span>PERIOD_D1<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 确保交易历史的开始限制没有消失 </span>
<span class="token comment">//--- 预定日期超过1天 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>curr_start<span class="token operator">-</span>start<span class="token operator">&gt;</span><span class="token function">PeriodSeconds</span><span class="token punctuation">(</span>PERIOD_D1<span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 修正在缓存区载入历史的开始日期 </span>
      start<span class="token operator">=</span>curr_start<span class="token punctuation">;</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;New start limit of the trade history to be loaded: start =&gt; %s&quot;</span><span class="token punctuation">,</span> 
                  <span class="token function">TimeToString</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 现在重新载入更新间隔的交易历史 </span>
      <span class="token function">HistorySelect</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 为进一步比较，修正历史中交易和订单的计数器 </span>
      history_orders<span class="token operator">=</span><span class="token function">HistoryOrdersTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      deals<span class="token operator">=</span><span class="token function">HistoryDealsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">/* Sample output: 
  Limits of the history to be loaded: start - 2018.07.16 18:11, end - 2018.07.23 18:11 
  The counters of orders, positions and deals are successfully initialized 
  Number of orders has been changed. Previous value 0, current value 1 
  Number of orders has been changed. Previous value 1, current value 0 
  Number of positions has been changed. Previous value 0, current value 1 
  Number of deals has been changed. Previous value 0, current value 1 
  Number of orders in the history has been changed. Previous value 0, current value 1 
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br></div></div><p>另见
OrderSend、OrderSendAsync、OnTradeTransaction、客户端事件</p> <h2 id="_13-8-ontradetransaction"><a href="#_13-8-ontradetransaction" class="header-anchor">#</a> 13.8 OnTradeTransaction</h2> <p>当TradeTransaction事件发生时在EA中调用这个函数。这个函数旨在处理交易请求执行结果。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>  <span class="token function">OnTradeTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
   <span class="token keyword">const</span> MqlTradeTransaction<span class="token operator">&amp;</span>    trans<span class="token punctuation">,</span>     <span class="token comment">// 交易事务结构 </span>
   <span class="token keyword">const</span> MqlTradeRequest<span class="token operator">&amp;</span>        request<span class="token punctuation">,</span>   <span class="token comment">// 请求结构 </span>
   <span class="token keyword">const</span> MqlTradeResult<span class="token operator">&amp;</span>         result     <span class="token comment">// 回应结构 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>参数
trans</p> <p>[in] MqlTradeTransaction类型变量描述了在交易账户上进行的交易。</p> <p>request</p> <p>[in] MqlTradeRequest类型变量描述了导致交易的交易请求。它只包含TRADE_TRANSACTION_REQUEST类型交易的值。</p> <p>result</p> <p>[in] MqlTradeResult类型变量描述了导致交易的交易请求的执行结果。它只包含TRADE_TRANSACTION_REQUEST类型交易的值。</p> <p>返回值
无返回值</p> <p>注意
调用OnTradeTransaction()来处理在下列情况下由交易服务器发送至程序端的TradeTransaction事件：</p> <p>使用OrderSend()/OrderSendAsync()函数，从MQL5程序发送交易请求及其后续执行；
通过GUI手动发送交易请求及其后续执行；
激活服务器上的挂单和止损单；
在交易服务器端执行操作。</p> <p>关于交易类型的数据包含在trans变量的类型字段中。交易事务类型在ENUM_TRADE_TRANSACTION_TYPE枚举中描述：
TRADE_TRANSACTION_ORDER_ADD – 添加一个新的活跃订单
TRADE_TRANSACTION_ORDER_UPDATE – 更改现有订单
TRADE_TRANSACTION_ORDER_DELETE – 从活跃订单列表删除一个订单
TRADE_TRANSACTION_DEAL_ADD – 在历史中添加一笔交易
TRADE_TRANSACTION_DEAL_UPDATE – 在历史中改变一笔交易
TRADE_TRANSACTION_DEAL_DELETE – 从历史删除一笔交易
TRADE_TRANSACTION_HISTORY_ADD – 在历史中添加一个订单作为执行或取消的结果
TRADE_TRANSACTION_HISTORY_UPDATE – 在订单历史中更改一个订单
TRADE_TRANSACTION_HISTORY_DELETE – 从订单历史中删除一个订单
TRADE_TRANSACTION_POSITION – 与交易执行无关的持仓变化
TRADE_TRANSACTION_REQUEST – 已收到服务器处理交易请求的通知和处理结果。
当处理TRADE_TRANSACTION_REQUEST类型交易时，需要分析OnTradeTransaction()函数的第二和第三个参数 – request和result – 来获取额外信息。</p> <p>发送买入交易请求会导致交易账户上的一系列交易：1) 请求被接受进行处理，2) 为该账户创建了一个适当的购买订单，3) 然后执行订单，4) 已执行订单从活跃订单列表中移除，5) 添加到订单历史中，6) 随后事务被添加到历史中以及 7) 创建新持仓。所有这些阶段都是交易事务过程。每一个这类交易事务到达程序端就是TradeTransaction事件。不保证这些交易到达程序端的优先级。因此，在开发您的EA交易时，您不应该期望一组交易将在另一组之后到达。</p> <p>当交易由EA的OnTradeTransaction()处理程序进行处理时，程序端将继续处理传入的交易事务。因此，在OnTradeTransaction()操作过程中，交易账户状态可能会发生变化。例如，当MQL5程序处理添加新订单时，它可以被执行，被从已开设订单的列表中删除以及被移动到历史中。所有这些事件的消息都将通知该程序。</p> <p>交易事务队列长度由1024个要素组成。如果OnTradeTransaction()处理另一个事务时间太长，那么之前的事务就可能被队列中的新事物所取代。</p> <p>适当调用OnTradeTransaction()之后调用OnTrade()处理程序。通常，在OnTrade ()和OnTradeTransaction ()调用的数量上没有确切的相关性。OnTrade()一次调用对应一次或多次的OnTradeTransaction调用。</p> <p>每一个Trade事件都可能作为一个或多个交易请求的结果出现。交易请求使用OrderSend()或OrderSendAsync()，被发送到服务器。每个请求都可能导致多个交易事件。您不能依赖“一个请求，一个交易事件”的声明，因为事件的处理可能分为几个阶段执行，并且每个操作都可能更改订单的状态、持仓和交易历史记录。</p> <p>EA样例，OnTradeTransaction()处理程序</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                    OnTradeTransaction_Sample.mq5 | </span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Sample listener of TradeTransaction events&quot;</span> </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA交易初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- </span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;LAST PING=%.f ms&quot;</span><span class="token punctuation">,</span> 
               <span class="token function">TerminalInfoInteger</span><span class="token punctuation">(</span>TERMINAL_PING_LAST<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA报价函数                                                        | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- </span>
  
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| TradeTransaction函数                                              | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTradeTransaction</span><span class="token punctuation">(</span><span class="token keyword">const</span> MqlTradeTransaction <span class="token operator">&amp;</span>trans<span class="token punctuation">,</span> 
                        <span class="token keyword">const</span> MqlTradeRequest <span class="token operator">&amp;</span>request<span class="token punctuation">,</span> 
                        <span class="token keyword">const</span> MqlTradeResult <span class="token operator">&amp;</span>result<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">static</span> <span class="token keyword">int</span> counter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">// counter of OnTradeTransaction() calls </span>
   <span class="token keyword">static</span> uint lasttime<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// time of the OnTradeTransaction() last call </span>
<span class="token comment">//--- </span>
   uint time<span class="token operator">=</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果最后一个交易事务在1秒之前执行， </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>time<span class="token operator">-</span>lasttime<span class="token operator">&gt;</span><span class="token number">1000</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      counter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 那么这是一个新交易操作，计数器可被重置 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>IS_DEBUG_MODE<span class="token punctuation">)</span> 
         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot; New trade operation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   lasttime<span class="token operator">=</span>time<span class="token punctuation">;</span> 
   counter<span class="token operator">++</span><span class="token punctuation">;</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span>counter<span class="token punctuation">,</span><span class="token string">&quot;. &quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 交易请求执行的结果 </span>
   ulong            lastOrderID   <span class="token operator">=</span>trans<span class="token punctuation">.</span>order<span class="token punctuation">;</span> 
   ENUM_ORDER_TYPE  lastOrderType <span class="token operator">=</span>trans<span class="token punctuation">.</span>order_type<span class="token punctuation">;</span> 
   ENUM_ORDER_STATE lastOrderState<span class="token operator">=</span>trans<span class="token punctuation">.</span>order_state<span class="token punctuation">;</span> 
<span class="token comment">//--- 执行交易的交易品种名称 </span>
   string trans_symbol<span class="token operator">=</span>trans<span class="token punctuation">.</span>symbol<span class="token punctuation">;</span> 
<span class="token comment">//--- 交易事务类型 </span>
   ENUM_TRADE_TRANSACTION_TYPE  trans_type<span class="token operator">=</span>trans<span class="token punctuation">.</span>type<span class="token punctuation">;</span> 
   <span class="token keyword">switch</span><span class="token punctuation">(</span>trans<span class="token punctuation">.</span>type<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">case</span>  TRADE_TRANSACTION_POSITION<span class="token operator">:</span>   <span class="token comment">//持仓变化 </span>
        <span class="token punctuation">{</span> 
         ulong pos_ID<span class="token operator">=</span>trans<span class="token punctuation">.</span>position<span class="token punctuation">;</span> 
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;MqlTradeTransaction: Position  #%d %s modified: SL=%.5f TP=%.5f&quot;</span><span class="token punctuation">,</span> 
                     pos_ID<span class="token punctuation">,</span>trans_symbol<span class="token punctuation">,</span>trans<span class="token punctuation">.</span>price_sl<span class="token punctuation">,</span>trans<span class="token punctuation">.</span>price_tp<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> TRADE_TRANSACTION_REQUEST<span class="token operator">:</span>     <span class="token comment">// sending a trade request </span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;MqlTradeTransaction: TRADE_TRANSACTION_REQUEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> TRADE_TRANSACTION_DEAL_ADD<span class="token operator">:</span>    <span class="token comment">// 添加一个交易 </span>
        <span class="token punctuation">{</span> 
         ulong          lastDealID   <span class="token operator">=</span>trans<span class="token punctuation">.</span>deal<span class="token punctuation">;</span> 
         ENUM_DEAL_TYPE lastDealType <span class="token operator">=</span>trans<span class="token punctuation">.</span>deal_type<span class="token punctuation">;</span> 
         <span class="token keyword">double</span>        lastDealVolume<span class="token operator">=</span>trans<span class="token punctuation">.</span>volume<span class="token punctuation">;</span> 
         <span class="token comment">//--- 内部系统中的交易ID(Trade ID) - 由交易所分配的单号 </span>
         string Exchange_ticket<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HistoryDealSelect</span><span class="token punctuation">(</span>lastDealID<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            Exchange_ticket<span class="token operator">=</span><span class="token function">HistoryDealGetString</span><span class="token punctuation">(</span>lastDealID<span class="token punctuation">,</span>DEAL_EXTERNAL_ID<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span>Exchange_ticket<span class="token operator">!=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> 
            Exchange_ticket<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;(Exchange deal=%s)&quot;</span><span class="token punctuation">,</span>Exchange_ticket<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;MqlTradeTransaction: %s deal #%d %s %s %.2f lot   %s&quot;</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>trans_type<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                     lastDealID<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>lastDealType<span class="token punctuation">)</span><span class="token punctuation">,</span>trans_symbol<span class="token punctuation">,</span>lastDealVolume<span class="token punctuation">,</span>Exchange_ticket<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> TRADE_TRANSACTION_HISTORY_ADD<span class="token operator">:</span> <span class="token comment">// 在历史中添加一个订单 </span>
        <span class="token punctuation">{</span> 
         <span class="token comment">//--- 内部系统中的订单ID - 由交易所分配的单号 </span>
         string Exchange_ticket<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span>lastOrderState<span class="token operator">==</span>ORDER_STATE_FILLED<span class="token punctuation">)</span> 
           <span class="token punctuation">{</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HistoryOrderSelect</span><span class="token punctuation">(</span>lastOrderID<span class="token punctuation">)</span><span class="token punctuation">)</span> 
               Exchange_ticket<span class="token operator">=</span><span class="token function">HistoryOrderGetString</span><span class="token punctuation">(</span>lastOrderID<span class="token punctuation">,</span>ORDER_EXTERNAL_ID<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span>Exchange_ticket<span class="token operator">!=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> 
               Exchange_ticket<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;(Exchange ticket=%s)&quot;</span><span class="token punctuation">,</span>Exchange_ticket<span class="token punctuation">)</span><span class="token punctuation">;</span> 
           <span class="token punctuation">}</span> 
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;MqlTradeTransaction: %s order #%d %s %s %s   %s&quot;</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>trans_type<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                     lastOrderID<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>lastOrderType<span class="token punctuation">)</span><span class="token punctuation">,</span>trans_symbol<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>lastOrderState<span class="token punctuation">)</span><span class="token punctuation">,</span>Exchange_ticket<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">// 其他交易事务 </span>
        <span class="token punctuation">{</span> 
         <span class="token comment">//--- 内部系统中的订单ID - 由莫斯科交易所(Moscow Exchange)分配的单号 </span>
         string Exchange_ticket<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span>lastOrderState<span class="token operator">==</span>ORDER_STATE_PLACED<span class="token punctuation">)</span> 
           <span class="token punctuation">{</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">OrderSelect</span><span class="token punctuation">(</span>lastOrderID<span class="token punctuation">)</span><span class="token punctuation">)</span> 
               Exchange_ticket<span class="token operator">=</span><span class="token function">OrderGetString</span><span class="token punctuation">(</span>ORDER_EXTERNAL_ID<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span>Exchange_ticket<span class="token operator">!=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> 
               Exchange_ticket<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Exchange ticket=%s&quot;</span><span class="token punctuation">,</span>Exchange_ticket<span class="token punctuation">)</span><span class="token punctuation">;</span> 
           <span class="token punctuation">}</span> 
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;MqlTradeTransaction: %s order #%d %s %s   %s&quot;</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>trans_type<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                     lastOrderID<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>lastOrderType<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>lastOrderState<span class="token punctuation">)</span><span class="token punctuation">,</span>Exchange_ticket<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      <span class="token keyword">break</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 订单单号     </span>
   ulong orderID_result<span class="token operator">=</span>result<span class="token punctuation">.</span>order<span class="token punctuation">;</span> 
   string retcode_result<span class="token operator">=</span><span class="token function">GetRetcodeID</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>retcode<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>orderID_result<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;MqlTradeResult: order #%d retcode=%s &quot;</span><span class="token punctuation">,</span>orderID_result<span class="token punctuation">,</span>retcode_result<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//---    </span>
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 将数字响应代码转换为字符串记忆                                       | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
string <span class="token function">GetRetcodeID</span><span class="token punctuation">(</span><span class="token keyword">int</span> retcode<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token keyword">switch</span><span class="token punctuation">(</span>retcode<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">case</span> <span class="token number">10004</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_REQUOTE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10006</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_REJECT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10007</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_CANCEL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10008</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_PLACED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10009</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_DONE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10010</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_DONE_PARTIAL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10011</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_ERROR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10012</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_TIMEOUT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10013</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_INVALID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10014</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_INVALID_VOLUME&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10015</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_INVALID_PRICE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10016</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_INVALID_STOPS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10017</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_TRADE_DISABLED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10018</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_MARKET_CLOSED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10019</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_NO_MONEY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10020</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_PRICE_CHANGED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10021</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_PRICE_OFF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10022</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_INVALID_EXPIRATION&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10023</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_ORDER_CHANGED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10024</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_TOO_MANY_REQUESTS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10025</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_NO_CHANGES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10026</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_SERVER_DISABLES_AT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10027</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_CLIENT_DISABLES_AT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10028</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_LOCKED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10029</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_FROZEN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10030</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_INVALID_FILL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10031</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_CONNECTION&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10032</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_ONLY_REAL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10033</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_LIMIT_ORDERS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10034</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_LIMIT_VOLUME&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10035</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_INVALID_ORDER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">case</span> <span class="token number">10036</span><span class="token operator">:</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_POSITION_CLOSED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token keyword">default</span><span class="token operator">:</span> 
         <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_RETCODE_UNKNOWN=&quot;</span><span class="token operator">+</span><span class="token function">IntegerToString</span><span class="token punctuation">(</span>retcode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">break</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- </span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br></div></div><p>另见</p> <p>OrderSend、OrderSendAsync、OnTradeTransaction、交易请求结构、交易事务结构、交易事务类型、交易操作类型、 客户端事件</p> <h2 id="_13-9-onbookevent"><a href="#_13-9-onbookevent" class="header-anchor">#</a> 13.9 OnBookEvent</h2> <p>当BookEvent事件发生时在指标和EA中调用这个函数。它是用来处理市场深度的变化。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>  <span class="token function">OnBookEvent</span><span class="token punctuation">(</span> 
   <span class="token keyword">const</span> string<span class="token operator">&amp;</span>  symbol         <span class="token comment">//交易品种 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数
交易品种</p> <p>[in] BookEvent到达的交易品种名称</p> <p>返回值
无返回值</p> <p>注意
若要获得任何交易品种的BookEvent事件，只需使用MarketBookAdd()函数，为该交易品种订阅接收该事件。若要为特定交易品种取消订阅接收BookEvent，则调用MarketBookRelease()函数。</p> <p>BookEvent在整个图表中进行传播。这意味着，如果图表上的一个应用程序使用MarketBookAdd函数订阅BookEvent，那么在相同图表上启用的所有其他指标和EA以及OnBookEvent()处理程序也会收到这个事件。因此，有必要分析传递到OnBookEvent()处理程序的交易品种名称，并将其作为交易品种参数。</p> <p>为运行在相同图表上的所有应用程序提供按交易品种分类的单独的BookEvent计数器。这意味着每个图表对不同的交易品种可能有多个订阅，并且为每个交易品种提供一个计数器。从BookEvent订阅和取消订阅，只在一个图表中更改指定交易品种的订阅计数器。换句话说，对于相同的交易品种，BookEvent可能有两个相邻的图表，但订阅计数值不同。</p> <p>初始的订阅计数值为零。每调用一次MarketBookAdd()，图表上特定交易品种的订阅计数器都会增加1个（图表交易品种和MarketBookAdd()中的交易品种不必匹配）。当调用MarketBookRelease()时，在图表中指定交易品种的订阅计数器就会减少1个。任何交易品种的BookEvent事件都在图表中广播，直至计数器的值等于零。因此，很重要的一点就是，每个包含了MarketBookAdd ()调用的MQL5程序都在其工作结束时使用MarketBookRelease ()为每个交易品种正确取消订阅获取事件。为此，MarketBookAdd()和MarketBookRelease()的调用数量甚至都应该适用于整个MQL5程序生命周期内的每个调用。在程序中使用标识或自定义订阅计数器可以使您安全地处理BookEvent事件，并阻止禁用订阅，以在同一图表内的第三方程序中获取该事件。</p> <p>即使处理之前的BookEvent处理还没有结束，BookEvent 事件也不会被跳过，会始终被置于队列之中。</p> <p>例如</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                           OnBookEvent_Sample.mq5 | </span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com/en/articles/2635&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Example of measuring the market depth refresh rate using OnBookEvent()&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;The code is taken from the article https://www.mql5.com/en/articles/2635&quot;</span> </span>
<span class="token comment">//--- 输入参数 </span>
input ulong ExtCollectTime   <span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">;</span>  <span class="token comment">// test time in seconds </span>
input ulong ExtSkipFirstTicks<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>  <span class="token comment">// number of ticks skipped at start </span>
<span class="token comment">//--- 订阅BookEvent事件的标识 </span>
<span class="token keyword">bool</span> book_subscribed<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 接受来自市场深度的请求的数组 </span>
MqlBookInfo  book<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA交易初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 显示开始 </span>
   <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Waiting for the first %I64u ticks to arrive&quot;</span><span class="token punctuation">,</span>ExtSkipFirstTicks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Waiting for the first %I64u ticks to arrive&quot;</span><span class="token punctuation">,</span>ExtSkipFirstTicks<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 启用市场深度广播 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MarketBookAdd</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      book_subscribed<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: MarketBookAdd(%s) function returned true&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>_Symbol<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: MarketBookAdd(%s) function returned false! GetLastError()=%d&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>_Symbol<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 成功初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 去初始化EA交易                                                     | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnDeinit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> reason<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 显示去初始化原因代码 </span>
   <span class="token function">Print</span><span class="token punctuation">(</span>__FUNCTION__<span class="token punctuation">,</span><span class="token string">&quot;: Deinitialization reason code = &quot;</span><span class="token punctuation">,</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token comment">//--- 取消订阅以获取市场深度事件 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>book_subscribed<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">MarketBookRelease</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">)</span><span class="token punctuation">)</span> 
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: MarketBookRelease(%s) returned false! GetLastError()=%d&quot;</span><span class="token punctuation">,</span>_Symbol<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">else</span> 
         book_subscribed<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//---  </span>
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| BookEvent函数                                                     | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnBookEvent</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>symbol<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token keyword">static</span> ulong starttime<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>             <span class="token comment">// 测试开始时间 </span>
   <span class="token keyword">static</span> ulong tickcounter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>           <span class="token comment">// 市场深度更新计数器 </span>
<span class="token comment">//--- 只有当我们自己订阅市场深度事件时处理它们 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>book_subscribed<span class="token punctuation">)</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 只为特定交易品种计算更新 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>symbol<span class="token operator">!=</span>_Symbol<span class="token punctuation">)</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 跳过第一个报价来清空队列和进行准备 </span>
   tickcounter<span class="token operator">++</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>tickcounter<span class="token operator">&lt;</span>ExtSkipFirstTicks<span class="token punctuation">)</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记住开始时间 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>tickcounter<span class="token operator">==</span>ExtSkipFirstTicks<span class="token punctuation">)</span>  
      starttime<span class="token operator">=</span><span class="token function">GetMicrosecondCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 请求市场深度数据 </span>
   <span class="token function">MarketBookGet</span><span class="token punctuation">(</span>symbol<span class="token punctuation">,</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 什么时候停止？   </span>
   ulong endtime<span class="token operator">=</span><span class="token function">GetMicrosecondCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>starttime<span class="token punctuation">;</span> 
   ulong ticks  <span class="token operator">=</span><span class="token number">1</span><span class="token operator">+</span>tickcounter<span class="token operator">-</span>ExtSkipFirstTicks<span class="token punctuation">;</span> 
<span class="token comment">// 从测试开始以后，已经过去多少毫秒？ </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>endtime<span class="token operator">&gt;</span>ExtCollectTime<span class="token operator">*</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>  
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%I64u ticks for %.1f seconds: %.1f ticks/sec &quot;</span><span class="token punctuation">,</span>ticks<span class="token punctuation">,</span>endtime<span class="token operator">/</span><span class="token number">1000.0</span><span class="token operator">/</span><span class="token number">1000.0</span><span class="token punctuation">,</span>ticks<span class="token operator">*</span><span class="token number">1000.0</span><span class="token operator">*</span><span class="token number">1000.0</span><span class="token operator">/</span>endtime<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token function">ExpertRemove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 在评论字段中显示计数器 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>endtime<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
      <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%I64u ticks for %.1f seconds: %.1f ticks/sec &quot;</span><span class="token punctuation">,</span>ticks<span class="token punctuation">,</span>endtime<span class="token operator">/</span><span class="token number">1000.0</span><span class="token operator">/</span><span class="token number">1000.0</span><span class="token punctuation">,</span>ticks<span class="token operator">*</span><span class="token number">1000.0</span><span class="token operator">*</span><span class="token number">1000.0</span><span class="token operator">/</span>endtime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br></div></div><p>另见
MarketBookAdd、MarketBookRelease、MarketBookGet、 OnTrade、OnTradeTransaction、OnTick、 事件处理函数、程序运行、客户端事件</p> <h2 id="_13-10-onchartevent"><a href="#_13-10-onchartevent" class="header-anchor">#</a> 13.10 OnChartEvent</h2> <p>当ChartEvent事件发生时在指标和EA中调用这个函数。这个函数意在处理由用户或者MQL5程序所做的图表更改。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>  <span class="token function">OnChartEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
   <span class="token keyword">const</span> <span class="token keyword">int</span>       id<span class="token punctuation">,</span>       <span class="token comment">// 事件ID  </span>
   <span class="token keyword">const</span> <span class="token keyword">long</span><span class="token operator">&amp;</span>     lparam<span class="token punctuation">,</span>   <span class="token comment">// 长整型(long)事件参数 </span>
   <span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">&amp;</span>   dparam<span class="token punctuation">,</span>   <span class="token comment">// 长整型(double)事件参数 </span>
   <span class="token keyword">const</span> string<span class="token operator">&amp;</span>   sparam    <span class="token comment">// 字符串型(string)事件参数 </span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数
id</p> <p>[in] 来自ENUM_CHART_EVENT枚举的事件ID。</p> <p>lparam</p> <p>[in] 长整型(long)事件参数</p> <p>dparam</p> <p>[in] 双精度型(double)事件参数</p> <p>sparam</p> <p>[in] 字符串型(string)事件参数</p> <p>返回值
无返回值</p> <p>注意
共有11种事件类型可以使用预定义OnChartEvent()函数来处理。为自定义事件提供了从CHARTEVENT_CUSTOM到CHARTEVENT_CUSTOM_LAST包含的65535个ID。若要生成自定义事件，请使用EventChartCustom()函数。</p> <p>来自ENUM_CHART_EVENT 枚举的简短事件描述：</p> <p>CHARTEVENT_KEYDOWN ― 当图表窗口处于焦点时，按下键盘上的一个按键；</p> <p>CHARTEVENT_MOUSE_MOVE ― 移动鼠标，并且鼠标按键点击（如果图表 CHART_EVENT_MOUSE_MOVE=true）；
CHARTEVENT_OBJECT_CREATE ― 创建一个图形对象（如果图表 CHART_EVENT_OBJECT_CREATE=true）；
CHARTEVENT_OBJECT_CHANGE ― 通过属性对话框更改对象属性；
CHARTEVENT_OBJECT_DELETE ― 删除一个图形对象（如果图表 CHART_EVENT_OBJECT_DELETE=true）；
CHARTEVENT_CLICK ― 点击图表；
CHARTEVENT_OBJECT_CLICK ― 鼠标单击属于图表的图形对象；
CHARTEVENT_OBJECT_DRAG ― 用鼠标拖动图形对象；
CHARTEVENT_OBJECT_ENDEDIT ― 在图形对象的“编辑”输入框中完成文本编辑(OBJ_EDIT)；
CHARTEVENT_CHART_CHANGE ― 更改图表；
CHARTEVENT_CUSTOM+n ― 自定义事件ID，这里n的范围是从0到65535。CHARTEVENT_CUSTOM_LAST包含最后可接受的自定义事件ID (CHARTEVENT_CUSTOM+65535)。</p> <p>所有MQL5程序都使用了不同于应用程序主线程的其他线程。主应用程序线程负责处理所有的Windows系统消息，反过来，作为该处理的结果，为其自身的应用程序生成Windows消息。例如，在图表上移动鼠标（WM_MOUSE_MOVE事件）为随后呈现的应用程序窗口生成几个系统消息，并将内部消息发送到在图表上启动的EA和指标。可能会出现这样的情况，主要的应用程序线程还没有处理WM_PAINT系统消息（因此还没有呈现修改过的图表），而EA或指标却已经收到了鼠标移动事件。在这种情况下，只有在呈现图表之后，图表属性CHART_FIRST_VISIBLE_BAR才会更改。</p> <p>对于每种事件类型，OnChartEvent()函数的输入都具有处理该事件所需的某些值。该表列出了通过参数传递的事件和值。</p> <table><thead><tr><th style="text-align:left;">事件</th> <th style="text-align:left;">'id' 参数值</th> <th style="text-align:left;">'lparam'参数值</th> <th style="text-align:left;">'dparam'参数值</th> <th style="text-align:left;">'sparam'参数值</th></tr></thead> <tbody><tr><td style="text-align:left;">Keystroke事件</td> <td style="text-align:left;">CHARTEVENT_KEYDOWN</td> <td style="text-align:left;">按下按键代码</td> <td style="text-align:left;">在按键处于按下状态时生成的按键响应的数量</td> <td style="text-align:left;">位掩码的字符串值，描述键盘按键的状态</td></tr> <tr><td style="text-align:left;">鼠标事件 （如果图表CHART_EVENT_MOUSE_MOVE=true）</td> <td style="text-align:left;">CHARTEVENT_MOUSE_MOVE</td> <td style="text-align:left;">X 坐标</td> <td style="text-align:left;">Y 坐标</td> <td style="text-align:left;">位掩码的字符串值，描述鼠标按键的状态</td></tr> <tr><td style="text-align:left;">鼠标滚轮事件(如果CHART_EVENT_MOUSE_WHEEL=true为图表设置)</td> <td style="text-align:left;">CHARTEVENT_MOUSE_WHEEL</td> <td style="text-align:left;">键盘按键和鼠标按键的状态标识，光标的X和Y坐标。请参阅示例中的描述</td> <td style="text-align:left;">鼠标滚轮滚动的Delta值</td> <td style="text-align:left;">―</td></tr> <tr><td style="text-align:left;">创建一个图形对象（如果图表CHART_EVENT_OBJECT_CREATE=true）</td> <td style="text-align:left;">CHARTEVENT_OBJECT_CREATE</td> <td style="text-align:left;">―</td> <td style="text-align:left;">―</td> <td style="text-align:left;">已创建图形对象的名称</td></tr> <tr><td style="text-align:left;">通过属性对话框更改对象属性</td> <td style="text-align:left;">CHARTEVENT_OBJECT_CHANGE</td> <td style="text-align:left;">―</td> <td style="text-align:left;">―</td> <td style="text-align:left;">已更改图形对象的名称</td></tr> <tr><td style="text-align:left;">移除一个图形对象（如果图表CHART_EVENT_OBJECT_DELETE=true）</td> <td style="text-align:left;">CHARTEVENT_OBJECT_DELETE</td> <td style="text-align:left;">―</td> <td style="text-align:left;">―</td> <td style="text-align:left;">已移除图形对象的名称</td></tr> <tr><td style="text-align:left;">图表点击图表</td> <td style="text-align:left;">CHARTEVENT_CLICK</td> <td style="text-align:left;">X 坐标</td> <td style="text-align:left;">Y 坐标</td> <td style="text-align:left;">―</td></tr> <tr><td style="text-align:left;">鼠标点击图形对象</td> <td style="text-align:left;">CHARTEVENT_OBJECT_CLICK</td> <td style="text-align:left;">X 坐标</td> <td style="text-align:left;">Y 坐标</td> <td style="text-align:left;">事件所发生的图形对象的名称</td></tr> <tr><td style="text-align:left;">使用鼠标移动图形对象</td> <td style="text-align:left;">CHARTEVENT_OBJECT_DRAG</td> <td style="text-align:left;">―</td> <td style="text-align:left;">―</td> <td style="text-align:left;">已移动图形对象的名称</td></tr> <tr><td style="text-align:left;">在图形对象输入框的“输入字段”中完成文本编辑</td> <td style="text-align:left;">CHARTEVENT_OBJECT_ENDEDIT</td> <td style="text-align:left;">―</td> <td style="text-align:left;">―</td> <td style="text-align:left;">“输入字段”图形对象的名称，在这里完成文本编辑</td></tr> <tr><td style="text-align:left;">通过属性对话框窗口，调整图表大小或更改图表属性</td> <td style="text-align:left;">CHARTEVENT_CHART_CHANGE</td> <td style="text-align:left;">―</td> <td style="text-align:left;">―</td> <td style="text-align:left;">―</td></tr> <tr><td style="text-align:left;">N个数字的自定义事件</td> <td style="text-align:left;">CHARTEVENT_CUSTOM+N</td> <td style="text-align:left;">通过EventChartCustom()函数定义的值</td> <td style="text-align:left;">通过EventChartCustom()函数定义的值</td> <td style="text-align:left;">通过EventChartCustom()函数定义的值</td></tr></tbody></table> <p>示例图表事件监听器：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                          OnChartEvent_Sample.mq5 | </span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Sample chart event listener and custom events generator&quot;</span> </span>
<span class="token comment">//--- 服务键ID </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_NUMPAD_5</span>       <span class="token expression"><span class="token number">12</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_LEFT</span>           <span class="token expression"><span class="token number">37</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_UP</span>             <span class="token expression"><span class="token number">38</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_RIGHT</span>          <span class="token expression"><span class="token number">39</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_DOWN</span>           <span class="token expression"><span class="token number">40</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_NUMLOCK_DOWN</span>   <span class="token expression"><span class="token number">98</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_NUMLOCK_LEFT</span>  <span class="token expression"><span class="token number">100</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_NUMLOCK_5</span>     <span class="token expression"><span class="token number">101</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_NUMLOCK_RIGHT</span> <span class="token expression"><span class="token number">102</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_NUMLOCK_UP</span>    <span class="token expression"><span class="token number">104</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA交易初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 显示CHARTEVENT_CUSTOM常数值 </span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;CHARTEVENT_CUSTOM=&quot;</span><span class="token punctuation">,</span>CHARTEVENT_CUSTOM<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Launched the EA &quot;</span><span class="token punctuation">,</span><span class="token function">MQLInfoString</span><span class="token punctuation">(</span>MQL5_PROGRAM_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置接收图表对象创建事件的标识 </span>
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token function">ChartID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>CHART_EVENT_OBJECT_CREATE<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置接收图表对象移除事件的标识 </span>
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token function">ChartID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>CHART_EVENT_OBJECT_DELETE<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 启用鼠标滚轮来滚动信息 </span>
   <span class="token function">ChartSetInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>CHART_EVENT_MOUSE_WHEEL<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 强制更新图表属性确保做好事件处理的准备 </span>
   <span class="token function">ChartRedraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA报价函数                                                        | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 用于生成自定义事件的报价计数器 </span>
   <span class="token keyword">static</span> <span class="token keyword">int</span> tick_counter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 通过这个值除以累积的报价 </span>
   <span class="token keyword">int</span> simple_number<span class="token operator">=</span><span class="token number">113</span><span class="token punctuation">;</span> 
<span class="token comment">//---  </span>
   tick_counter<span class="token operator">++</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果报价计数器是simple_number的倍数，则发送自定义事件 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>tick_counter<span class="token operator">%</span>simple_number<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 形成自定义事件ID（从0到65535） </span>
      ushort custom_event_id<span class="token operator">=</span><span class="token function">ushort</span><span class="token punctuation">(</span>tick_counter<span class="token operator">%</span><span class="token number">65535</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//---  发送参数填充的自定义事件 </span>
      <span class="token function">EventChartCustom</span><span class="token punctuation">(</span><span class="token function">ChartID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>custom_event_id<span class="token punctuation">,</span>tick_counter<span class="token punctuation">,</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SYMBOL_BID<span class="token punctuation">)</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 添加到日志来分析示例结果 </span>
      <span class="token function">Print</span><span class="token punctuation">(</span>__FUNCTION__<span class="token punctuation">,</span><span class="token string">&quot;: Sent a custom event ID=&quot;</span><span class="token punctuation">,</span>custom_event_id<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//---      </span>
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| ChartEvent 函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnChartEvent</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> id<span class="token punctuation">,</span> 
                  <span class="token keyword">const</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>lparam<span class="token punctuation">,</span> 
                  <span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">&amp;</span>dparam<span class="token punctuation">,</span> 
                  <span class="token keyword">const</span> string <span class="token operator">&amp;</span>sparam<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 按键响应 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span>CHARTEVENT_KEYDOWN<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>lparam<span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token keyword">case</span> KEY_NUMLOCK_LEFT<span class="token operator">:</span>  <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Pressed KEY_NUMLOCK_LEFT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">break</span><span class="token punctuation">;</span> 
         <span class="token keyword">case</span> KEY_LEFT<span class="token operator">:</span>          <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Pressed KEY_LEFT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token keyword">break</span><span class="token punctuation">;</span> 
         <span class="token keyword">case</span> KEY_NUMLOCK_UP<span class="token operator">:</span>    <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Pressed KEY_NUMLOCK_UP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">break</span><span class="token punctuation">;</span> 
         <span class="token keyword">case</span> KEY_UP<span class="token operator">:</span>            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Pressed KEY_UP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">break</span><span class="token punctuation">;</span> 
         <span class="token keyword">case</span> KEY_NUMLOCK_RIGHT<span class="token operator">:</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Pressed KEY_NUMLOCK_RIGHT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">break</span><span class="token punctuation">;</span> 
         <span class="token keyword">case</span> KEY_RIGHT<span class="token operator">:</span>         <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Pressed KEY_RIGHT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span> 
         <span class="token keyword">case</span> KEY_NUMLOCK_DOWN<span class="token operator">:</span>  <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Pressed KEY_NUMLOCK_DOWN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">break</span><span class="token punctuation">;</span> 
         <span class="token keyword">case</span> KEY_DOWN<span class="token operator">:</span>          <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Pressed KEY_DOWN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token keyword">break</span><span class="token punctuation">;</span> 
         <span class="token keyword">case</span> KEY_NUMPAD_5<span class="token operator">:</span>      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Pressed KEY_NUMPAD_5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">break</span><span class="token punctuation">;</span> 
         <span class="token keyword">case</span> KEY_NUMLOCK_5<span class="token operator">:</span>     <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Pressed KEY_NUMLOCK_5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span> 
         <span class="token keyword">default</span><span class="token operator">:</span>                <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Pressed unlisted key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 左击图表 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span>CHARTEVENT_CLICK<span class="token punctuation">)</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Mouse click coordinates on a chart: x = &quot;</span><span class="token punctuation">,</span>lparam<span class="token punctuation">,</span><span class="token string">&quot;  y = &quot;</span><span class="token punctuation">,</span>dparam<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 点击图形对象 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span>CHARTEVENT_OBJECT_CLICK<span class="token punctuation">)</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Clicking a mouse button on an object named '&quot;</span><span class="token operator">+</span>sparam<span class="token operator">+</span><span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 被移除的对象 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span>CHARTEVENT_OBJECT_DELETE<span class="token punctuation">)</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Removed object named &quot;</span><span class="token punctuation">,</span>sparam<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 被创建的对象 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span>CHARTEVENT_OBJECT_CREATE<span class="token punctuation">)</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Created object named &quot;</span><span class="token punctuation">,</span>sparam<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 被更改的对象 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span>CHARTEVENT_OBJECT_CHANGE<span class="token punctuation">)</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Changed object named &quot;</span><span class="token punctuation">,</span>sparam<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 被移动的对象或被改变的定位点坐标 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span>CHARTEVENT_OBJECT_DRAG<span class="token punctuation">)</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Changing anchor points of object named &quot;</span><span class="token punctuation">,</span>sparam<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 在“编辑”图形对象的输入字段更改文本 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span>CHARTEVENT_OBJECT_ENDEDIT<span class="token punctuation">)</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Changed text in Edit object &quot;</span><span class="token punctuation">,</span>sparam<span class="token punctuation">,</span><span class="token string">&quot;  id=&quot;</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 鼠标移动事件 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span>CHARTEVENT_MOUSE_MOVE<span class="token punctuation">)</span> 
      <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token string">&quot;POINT: &quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>lparam<span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>dparam<span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span><span class="token function">MouseState</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>sparam<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span>CHARTEVENT_MOUSE_WHEEL<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 考虑这个事件的鼠标按键和滚轮的状态 </span>
      <span class="token keyword">int</span> flg_keys <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>lparam<span class="token operator">&gt;&gt;</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// Ctrl 和 Shift 键，鼠标按键的状态标识 </span>
      <span class="token keyword">int</span> x_cursor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span>lparam<span class="token punctuation">;</span>         <span class="token comment">// 鼠标滚轮事件发生的X坐标 </span>
      <span class="token keyword">int</span> y_cursor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span>lparam<span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 鼠标滚轮事件发生的Y坐标 </span>
      <span class="token keyword">int</span> delta    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>dparam<span class="token punctuation">;</span>                <span class="token comment">// 鼠标滚动的总值，到达 +120 或 -120 时触发 </span>
      <span class="token comment">//--- 处理标识 </span>
      string str_keys<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flg_keys<span class="token operator">&amp;</span><span class="token number">0x0001</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 
         str_keys<span class="token operator">+=</span><span class="token string">&quot;LMOUSE &quot;</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flg_keys<span class="token operator">&amp;</span><span class="token number">0x0002</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 
         str_keys<span class="token operator">+=</span><span class="token string">&quot;RMOUSE &quot;</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flg_keys<span class="token operator">&amp;</span><span class="token number">0x0004</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 
         str_keys<span class="token operator">+=</span><span class="token string">&quot;SHIFT &quot;</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flg_keys<span class="token operator">&amp;</span><span class="token number">0x0008</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 
         str_keys<span class="token operator">+=</span><span class="token string">&quot;CTRL &quot;</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flg_keys<span class="token operator">&amp;</span><span class="token number">0x0010</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 
         str_keys<span class="token operator">+=</span><span class="token string">&quot;MMOUSE &quot;</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flg_keys<span class="token operator">&amp;</span><span class="token number">0x0020</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 
         str_keys<span class="token operator">+=</span><span class="token string">&quot;X1MOUSE &quot;</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flg_keys<span class="token operator">&amp;</span><span class="token number">0x0040</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 
         str_keys<span class="token operator">+=</span><span class="token string">&quot;X2MOUSE &quot;</span><span class="token punctuation">;</span> 
  
      <span class="token keyword">if</span><span class="token punctuation">(</span>str_keys<span class="token operator">!=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> 
         str_keys<span class="token operator">=</span><span class="token string">&quot;, keys='&quot;</span><span class="token operator">+</span><span class="token function">StringSubstr</span><span class="token punctuation">(</span>str_keys<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token function">StringLen</span><span class="token punctuation">(</span>str_keys<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;'&quot;</span><span class="token punctuation">;</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: X=%d, Y=%d, delta=%d%s&quot;</span><span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>CHARTEVENT_MOUSE_WHEEL<span class="token punctuation">)</span><span class="token punctuation">,</span>x_cursor<span class="token punctuation">,</span>y_cursor<span class="token punctuation">,</span>delta<span class="token punctuation">,</span>str_keys<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 使用属性对话框窗口调整图表大小或更改图表属性的事件 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span>CHARTEVENT_CHART_CHANGE<span class="token punctuation">)</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Changing the chart size or properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 自定义事件 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">&gt;</span>CHARTEVENT_CUSTOM<span class="token punctuation">)</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Custom event ID=%d, lparam=%d, dparam=%G, sparam=%s&quot;</span><span class="token punctuation">,</span>id<span class="token punctuation">,</span>lparam<span class="token punctuation">,</span>dparam<span class="token punctuation">,</span>sparam<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 鼠标点选位置                                                       | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
string <span class="token function">MouseState</span><span class="token punctuation">(</span>uint state<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   string res<span class="token punctuation">;</span> 
   res<span class="token operator">+=</span><span class="token string">&quot;\nML: &quot;</span>   <span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token string">&quot;DN&quot;</span><span class="token operator">:</span><span class="token string">&quot;UP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 鼠标左移 </span>
   res<span class="token operator">+=</span><span class="token string">&quot;\nMR: &quot;</span>   <span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token operator">&amp;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token string">&quot;DN&quot;</span><span class="token operator">:</span><span class="token string">&quot;UP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 鼠标右移  </span>
   res<span class="token operator">+=</span><span class="token string">&quot;\nMM: &quot;</span>   <span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token operator">&amp;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token string">&quot;DN&quot;</span><span class="token operator">:</span><span class="token string">&quot;UP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 鼠标居中 </span>
   res<span class="token operator">+=</span><span class="token string">&quot;\nMX: &quot;</span>   <span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token operator">&amp;</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token string">&quot;DN&quot;</span><span class="token operator">:</span><span class="token string">&quot;UP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 鼠标点选第一个X键 </span>
   res<span class="token operator">+=</span><span class="token string">&quot;\nMY: &quot;</span>   <span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token operator">&amp;</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token string">&quot;DN&quot;</span><span class="token operator">:</span><span class="token string">&quot;UP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 鼠标点选第二个 X 键 </span>
   res<span class="token operator">+=</span><span class="token string">&quot;\nSHIFT: &quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token operator">&amp;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token string">&quot;DN&quot;</span><span class="token operator">:</span><span class="token string">&quot;UP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 移位键 </span>
   res<span class="token operator">+=</span><span class="token string">&quot;\nCTRL: &quot;</span> <span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token string">&quot;DN&quot;</span><span class="token operator">:</span><span class="token string">&quot;UP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 控制键 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br></div></div><p>另见
EventChartCustom、图表事件类型、事件处理函数、程序运行、客户端事件</p> <h2 id="_13-11-ontester"><a href="#_13-11-ontester" class="header-anchor">#</a> 13.11 OnTester</h2> <p>当Tester事件发生时在EA中调用这个函数，测试之后执行必要的操作。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">double</span>  <span class="token function">OnTester</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>返回值
用于评估测试结果的自定义标准优化的值。</p> <p>注意
OnTester()函数只有在测试EA时可被使用，主要用于计算在优化输入参数时用作‘Custom max（最大自定义）’准则的值。</p> <p>在遗传优化过程中，在一代内对结果进行降序排列。这意味着从优化准则的角度来看，具有最高价值的结果被认为是最高的。这种排序最糟糕的值被排在最后，并随后丢弃。因此，它们不参与形成下一代。</p> <p>因此，OnTester()函数不仅允许您创建和保存您自己的测试结果报告，还可以控制优化过程，找出交易策略的最佳参数。</p> <p>以下就是计算自定义准则优化的示例。意在计算结余图形的线性回归。这在使用结余图形优化策略，并将结果与“结余 + 最大夏普比率”准则进行比较文章中进行描述。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                              OnTester_Sample.mq5 | </span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Sample EA with the OnTester() handler&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;As a custom optimization criterion, &quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;the ratio of the balance graph linear regression&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;divided by the deviation mean-square error is returned&quot;</span> </span>
<span class="token comment">//--- 包含交易操作类 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Trade\Trade.mqh&gt;</span></span>
<span class="token comment">//--- EA输入参数 </span>
input <span class="token keyword">double</span> Lots               <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>     <span class="token comment">// 交易量 </span>
input <span class="token keyword">int</span>    Slippage           <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>      <span class="token comment">// 可允许滑移 </span>
input <span class="token keyword">int</span>    MovingPeriod       <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>      <span class="token comment">// 移动平均线时间 </span>
input <span class="token keyword">int</span>    MovingShift        <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>       <span class="token comment">// 移动平均线移位 </span>
<span class="token comment">//--- 全局变量 </span>
<span class="token keyword">int</span>    IndicatorHandle<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 指标句柄 </span>
<span class="token keyword">bool</span>   IsHedging<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment">// 账户标识 </span>
CTrade trade<span class="token punctuation">;</span>              <span class="token comment">// 为执行交易操作 </span>
<span class="token comment">//---  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EA_MAGIC</span> <span class="token expression"><span class="token number">18052018</span> </span></span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 检查持仓开仓条件                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">CheckForOpen</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   MqlRates rt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 仅在新柱形图开始进行交易 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyRates</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>rt<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">2</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;CopyRates of &quot;</span><span class="token punctuation">,</span>_Symbol<span class="token punctuation">,</span><span class="token string">&quot; failed, no history&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 报价量 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>rt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tick_volume<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 接收移动平均线值 </span>
   <span class="token keyword">double</span>   ma<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>IndicatorHandle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>ma<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;CopyBuffer from iMA failed, no data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 检查信号是否存在 </span>
   ENUM_ORDER_TYPE signal<span class="token operator">=</span>WRONG_VALUE<span class="token punctuation">;</span> 
<span class="token comment">//--- 蜡烛图开盘高于移动平均线但收盘低于移动平均线 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>rt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>open <span class="token operator">&gt;</span> ma<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> rt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>close <span class="token operator">&lt;</span> ma<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      signal<span class="token operator">=</span>ORDER_TYPE_BUY<span class="token punctuation">;</span>    <span class="token comment">//买入信号 </span>
   <span class="token keyword">else</span> <span class="token comment">// 蜡烛图开盘低于移动平均线但收盘高于移动平均线 </span>
     <span class="token punctuation">{</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span>rt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>open <span class="token operator">&lt;</span> ma<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> rt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>close <span class="token operator">&gt;</span> ma<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
         signal<span class="token operator">=</span>ORDER_TYPE_SELL<span class="token punctuation">;</span><span class="token comment">// 卖出信号 </span>
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 附加检查 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>signal<span class="token operator">!=</span>WRONG_VALUE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">TerminalInfoInteger</span><span class="token punctuation">(</span>TERMINAL_TRADE_ALLOWED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">Bars</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">100</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token keyword">double</span> price<span class="token operator">=</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>signal<span class="token operator">==</span>ORDER_TYPE_SELL <span class="token operator">?</span> SYMBOL_BID<span class="token operator">:</span>SYMBOL_ASK<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         trade<span class="token punctuation">.</span><span class="token function">PositionOpen</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>signal<span class="token punctuation">,</span>Lots<span class="token punctuation">,</span>price<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- </span>
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 检查持仓平仓条件                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">CheckForClose</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   MqlRates rt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 仅在新柱形图开始进行交易 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyRates</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>rt<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">2</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;CopyRates of &quot;</span><span class="token punctuation">,</span>_Symbol<span class="token punctuation">,</span><span class="token string">&quot; failed, no history&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>rt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tick_volume<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 接收移动平均线值 </span>
   <span class="token keyword">double</span>   ma<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>IndicatorHandle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>ma<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;CopyBuffer from iMA failed, no data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 已使用PositionSelect()提前选择持仓 </span>
   <span class="token keyword">bool</span> signal<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span> 
   <span class="token keyword">long</span> type<span class="token operator">=</span><span class="token function">PositionGetInteger</span><span class="token punctuation">(</span>POSITION_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 蜡烛图开盘高于移动平均线但收盘低于移动平均线――关闭卖出持仓 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>POSITION_TYPE_SELL <span class="token operator">&amp;&amp;</span> rt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>open<span class="token operator">&gt;</span>ma<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> rt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>close <span class="token operator">&lt;</span> ma<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      signal<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 蜡烛图开盘低于移动平均线但收盘高于移动平均线――关闭买入持仓 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>POSITION_TYPE_BUY <span class="token operator">&amp;&amp;</span> rt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>open<span class="token operator">&lt;</span>ma<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> rt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>close<span class="token operator">&gt;</span>ma<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      signal<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 附加检查 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>signal<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">TerminalInfoInteger</span><span class="token punctuation">(</span>TERMINAL_TRADE_ALLOWED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">Bars</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">100</span><span class="token punctuation">)</span> 
         trade<span class="token punctuation">.</span><span class="token function">PositionClose</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>Slippage<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- </span>
  <span class="token punctuation">}</span> 
<span class="token comment">//+-------------------------------------------------------------------+ </span>
<span class="token comment">//| 选择一个考虑账户类型的持仓：单边持仓或锁仓持仓                            | </span>
<span class="token comment">//+-------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">SelectPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token keyword">bool</span> res<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 选择一个锁仓账户系统的持仓 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>IsHedging<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      uint total<span class="token operator">=</span><span class="token function">PositionsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">for</span><span class="token punctuation">(</span>uint i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>total<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         string position_symbol<span class="token operator">=</span><span class="token function">PositionGetSymbol</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span>_Symbol<span class="token operator">==</span>position_symbol <span class="token operator">&amp;&amp;</span> EA_MAGIC<span class="token operator">==</span><span class="token function">PositionGetInteger</span><span class="token punctuation">(</span>POSITION_MAGIC<span class="token punctuation">)</span><span class="token punctuation">)</span> 
           <span class="token punctuation">{</span> 
            res<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span> 
           <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 选择一个单边账户系统的持仓 </span>
   <span class="token keyword">else</span> 
     <span class="token punctuation">{</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PositionSelect</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">)</span><span class="token punctuation">)</span> 
         <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">else</span> 
         <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">PositionGetInteger</span><span class="token punctuation">(</span>POSITION_MAGIC<span class="token punctuation">)</span><span class="token operator">==</span>EA_MAGIC<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//---check Magic number </span>
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 执行结果 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA交易初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 设置一个交易类型：单边交易类型或锁仓交易类型 </span>
   IsHedging<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ENUM_ACCOUNT_MARGIN_MODE<span class="token punctuation">)</span><span class="token function">AccountInfoInteger</span><span class="token punctuation">(</span>ACCOUNT_MARGIN_MODE<span class="token punctuation">)</span><span class="token operator">==</span>ACCOUNT_MARGIN_MODE_RETAIL_HEDGING<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 初始化一个用于正确持仓控制的对象 </span>
   trade<span class="token punctuation">.</span><span class="token function">SetExpertMagicNumber</span><span class="token punctuation">(</span>EA_MAGIC<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   trade<span class="token punctuation">.</span><span class="token function">SetMarginMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   trade<span class="token punctuation">.</span><span class="token function">SetTypeFillingBySymbol</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   trade<span class="token punctuation">.</span><span class="token function">SetDeviationInPoints</span><span class="token punctuation">(</span>Slippage<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 创建移动平均线指标 </span>
   IndicatorHandle<span class="token operator">=</span><span class="token function">iMA</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">,</span>MovingPeriod<span class="token punctuation">,</span>MovingShift<span class="token punctuation">,</span>MODE_SMA<span class="token punctuation">,</span>PRICE_CLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>IndicatorHandle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Error creating iMA indicator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- ok </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA报价函数                                                        | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 如果已开仓，请检查平仓条件 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SelectPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
      <span class="token function">CheckForClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 检查持仓开仓条件 </span>
   <span class="token function">CheckForOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 测试函数                                                          | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">double</span> <span class="token function">OnTester</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 自定义准则优化值（越高越好） </span>
   <span class="token keyword">double</span> ret<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 将交易结果转到数组 </span>
   <span class="token keyword">double</span> array<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span> trades_volume<span class="token punctuation">;</span> 
   <span class="token function">GetTradeResultsToArray</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span>trades_volume<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span> trades<span class="token operator">=</span><span class="token function">ArraySize</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果少于10个交易，那么测试结果没有正值 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>trades <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> 
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 每个交易的平均结果 </span>
   <span class="token keyword">double</span> average_pl<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token function">ArraySize</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> 
      average_pl<span class="token operator">+=</span>array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 
   average_pl<span class="token operator">/=</span>trades<span class="token punctuation">;</span> 
<span class="token comment">//--- 显示单测试模式的消息 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MQLInfoInteger</span><span class="token punctuation">(</span>MQL_TESTER<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">MQLInfoInteger</span><span class="token punctuation">(</span>MQL_OPTIMIZATION<span class="token punctuation">)</span><span class="token punctuation">)</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Trades=%d, Average profit=%.2f&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>trades<span class="token punctuation">,</span>average_pl<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 计算利润图的线性回归比 </span>
   <span class="token keyword">double</span> a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>std_error<span class="token punctuation">;</span> 
   <span class="token keyword">double</span> chart<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CalculateLinearRegression</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span>chart<span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> 
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 计算回归线与图表偏差的误差 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CalculateStdError</span><span class="token punctuation">(</span>chart<span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>std_error<span class="token punctuation">)</span><span class="token punctuation">)</span> 
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 计算趋势利润与标准偏差的比率 </span>
   ret<span class="token operator">=</span>a<span class="token operator">*</span>trades<span class="token operator">/</span>std_error<span class="token punctuation">;</span> 
<span class="token comment">//--- 返回自定义标准优化值 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 获取交易的利润/亏损的数组                                           | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">GetTradeResultsToArray</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>pl_results<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>volume<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 请求完整的交易历史 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">HistorySelect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   uint total_deals<span class="token operator">=</span><span class="token function">HistoryDealsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   volume<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置预付款数组的初始大小 - 根据历史中的交易数量 </span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>pl_results<span class="token punctuation">,</span>total_deals<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 解决交易结果的交易计数器 - 盈利或亏损 </span>
   <span class="token keyword">int</span> counter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   ulong ticket_history_deal<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 检查所有交易 </span>
   <span class="token keyword">for</span><span class="token punctuation">(</span>uint i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>total_deals<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 选择一个交易  </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ticket_history_deal<span class="token operator">=</span><span class="token function">HistoryDealGetTicket</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         ENUM_DEAL_ENTRY deal_entry  <span class="token operator">=</span><span class="token punctuation">(</span>ENUM_DEAL_ENTRY<span class="token punctuation">)</span><span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>ticket_history_deal<span class="token punctuation">,</span>DEAL_ENTRY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">long</span>            deal_type   <span class="token operator">=</span><span class="token function">HistoryDealGetInteger</span><span class="token punctuation">(</span>ticket_history_deal<span class="token punctuation">,</span>DEAL_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">double</span>          deal_profit <span class="token operator">=</span><span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>ticket_history_deal<span class="token punctuation">,</span>DEAL_PROFIT<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">double</span>          deal_volume <span class="token operator">=</span><span class="token function">HistoryDealGetDouble</span><span class="token punctuation">(</span>ticket_history_deal<span class="token punctuation">,</span>DEAL_VOLUME<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 我们只对交易操作感兴趣         </span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>deal_type<span class="token operator">!=</span>DEAL_TYPE_BUY<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>deal_type<span class="token operator">!=</span>DEAL_TYPE_SELL<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">continue</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 只有解决盈利/亏损的交易 </span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>deal_entry<span class="token operator">!=</span>DEAL_ENTRY_IN<span class="token punctuation">)</span> 
           <span class="token punctuation">{</span> 
            <span class="token comment">//--- 将交易结果写入数组并增加交易的计数器 </span>
            pl_results<span class="token punctuation">[</span>counter<span class="token punctuation">]</span><span class="token operator">=</span>deal_profit<span class="token punctuation">;</span> 
            volume<span class="token operator">+=</span>deal_volume<span class="token punctuation">;</span> 
            counter<span class="token operator">++</span><span class="token punctuation">;</span> 
           <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 设置数组的最终大小 </span>
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>pl_results<span class="token punctuation">,</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 计算线性回归 y=a*x+b                                               | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">CalculateLinearRegression</span><span class="token punctuation">(</span><span class="token keyword">double</span>  <span class="token operator">&amp;</span>change<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>chartline<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                               <span class="token keyword">double</span>  <span class="token operator">&amp;</span>a_coef<span class="token punctuation">,</span><span class="token keyword">double</span>  <span class="token operator">&amp;</span>b_coef<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 检查数据充分性 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ArraySize</span><span class="token punctuation">(</span>change<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">)</span> 
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 创建一个累积图表数组 </span>
   <span class="token keyword">int</span> N<span class="token operator">=</span><span class="token function">ArraySize</span><span class="token punctuation">(</span>change<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ArrayResize</span><span class="token punctuation">(</span>chartline<span class="token punctuation">,</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   chartline<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>change<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> 
      chartline<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>chartline<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>change<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 现在，计算回归比率 </span>
   <span class="token keyword">double</span> x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>x2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>xy<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      x<span class="token operator">=</span>x<span class="token operator">+</span>i<span class="token punctuation">;</span> 
      y<span class="token operator">=</span>y<span class="token operator">+</span>chartline<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 
      xy<span class="token operator">=</span>xy<span class="token operator">+</span>i<span class="token operator">*</span>chartline<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 
      x2<span class="token operator">=</span>x2<span class="token operator">+</span>i<span class="token operator">*</span>i<span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   a_coef<span class="token operator">=</span><span class="token punctuation">(</span>N<span class="token operator">*</span>xy<span class="token operator">-</span>x<span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>N<span class="token operator">*</span>x2<span class="token operator">-</span>x<span class="token operator">*</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   b_coef<span class="token operator">=</span><span class="token punctuation">(</span>y<span class="token operator">-</span>a_coef<span class="token operator">*</span>x<span class="token punctuation">)</span><span class="token operator">/</span>N<span class="token punctuation">;</span> 
<span class="token comment">//--- </span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|  计算指定a和b的平均-平方偏差误差                                     | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span>  <span class="token function">CalculateStdError</span><span class="token punctuation">(</span><span class="token keyword">double</span>  <span class="token operator">&amp;</span>data<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">double</span>  a_coef<span class="token punctuation">,</span><span class="token keyword">double</span>  b_coef<span class="token punctuation">,</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>std_err<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 平方和错误 </span>
   <span class="token keyword">double</span> error<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   <span class="token keyword">int</span> N<span class="token operator">=</span><span class="token function">ArraySize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>N<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> 
      error<span class="token operator">=</span><span class="token function">MathPow</span><span class="token punctuation">(</span>a_coef<span class="token operator">*</span>i<span class="token operator">+</span>b_coef<span class="token operator">-</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   std_err<span class="token operator">=</span><span class="token function">MathSqrt</span><span class="token punctuation">(</span>error<span class="token operator">/</span><span class="token punctuation">(</span>N<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//---  </span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br></div></div><p>另见
测试交易策略、TesterHideIndicators、处理优化结果、 TesterStatistics、OnTesterInit、OnTesterDeinit、 OnTesterPass、MQL_TESTER、 MQL_OPTIMIZATION、FileOpen、FileWrite、FileLoad、FileSave</p> <h2 id="_13-12-ontesterinit"><a href="#_13-12-ontesterinit" class="header-anchor">#</a> 13.12 OnTesterInit</h2> <p>当TesterInit事件发生时在EA中调用这个函数，以便在策略测试优化之前执行必要的操作。有两种函数类型。</p> <p>返回结果的版本</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>  <span class="token function">OnTesterInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>返回值</p> <p>int 类型值，0意味着优化开始之前图表上启动的EA的成功初始化。</p> <p>建议使用返回执行结果的OnTesterInit()调用，因为它不仅可以程序初始化，还可以在早期优化停止的情况下返回一个错误代码。返回INIT_SUCCEEDED 以外的任何值，(0)表示错误，没有启动优化。</p> <p>没有结果返回的版本只为与旧代码兼容而保留。不建议使用</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>  <span class="token function">OnTesterInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意
TesterInit事件在策略测试开始期间EA优化之前生成。在该事件中，带有OnTesterDeInit()或OnTesterPass()事件处理程序的EA会在单独的程序端图表上自动下载。它包括测试中已经制定的交易品种和周期。</p> <p>这类事件接收TesterInit、TesterDeinit和TesterPass事件，但不接收 Init、Deinit和NewTick事件。因此，优化期间处理每次传递结果的所有必要逻辑都应该在OnTesterInit ()、OnTesterDeinit ()和OnTesterPass ()处理程序中实施。</p> <p>策略优化期间每次单独传递的结果都可以使用FrameAdd ()函数，通过来自OnTester ()处理程序的框架进行传递。</p> <p>OnTesterInit()函数被用来在优化开始之前启动EA交易，以便进一步处理优化结果。它经常与OnTesterDeinit()处理程序一起使用。</p> <p>OnTesterInit()的执行时间是有限的。如果超过限定时间，EA会被强制停止，而优化本身也会被取消。在测试日志中显示一条消息：</p> <p>测试器
OnTesterInit工作时间过长。测试器不能被初始化。</p> <p>来自OnTick的示例。添加OnTesterInit()处理程序来设置优化参数：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|                                          OnTesterInit_Sample.mq5 | </span>
<span class="token comment">//|                        Copyright 2018, MetaQuotes Software Corp. | </span>
<span class="token comment">//|                                             https://www.mql5.com | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">copyright </span><span class="token string">&quot;Copyright 2018, MetaQuotes Software Corp.&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">link      </span><span class="token string">&quot;https://www.mql5.com&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">version   </span><span class="token string">&quot;1.00&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;Sample EA with the OnTesterInit() handler,&quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;in which values and limitations of &quot;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">property</span> <span class="token expression">description </span><span class="token string">&quot;inputs during optimization are set&quot;</span> </span>
  
input <span class="token keyword">double</span> lots<span class="token operator">=</span><span class="token number">0.</span> <span class="token number">1</span><span class="token punctuation">;</span>       <span class="token comment">// 交易量手数 </span>
input <span class="token keyword">double</span> kATR<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>          <span class="token comment">// ATR中的信号蜡烛长度 </span>
input <span class="token keyword">int</span>    ATRperiod<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>    <span class="token comment">// ATR指标周期 </span>
input <span class="token keyword">int</span>    holdbars<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>      <span class="token comment">// 保持持仓的柱形图数量 </span>
input <span class="token keyword">int</span>    slippage<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>     <span class="token comment">// 可允许滑移 </span>
input <span class="token keyword">bool</span>   revers<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment">//反向信号？ </span>
input ulong  EXPERT_MAGIC<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// EA幻数 </span>
<span class="token comment">//--- 用于存储ATR指标句柄 </span>
<span class="token keyword">int</span> atr_handle<span class="token punctuation">;</span> 
<span class="token comment">//--- 在这里，我们将存储ATR最后值和蜡烛体 </span>
<span class="token keyword">double</span> last_atr<span class="token punctuation">,</span>last_body<span class="token punctuation">;</span> 
datetime lastbar_timeopen<span class="token punctuation">;</span> 
<span class="token keyword">double</span> trade_lot<span class="token punctuation">;</span> 
<span class="token comment">//--- 请记住优化开始时间 </span>
datetime optimization_start<span class="token punctuation">;</span> 
<span class="token comment">//--- 用于在优化结束后在图表上显示持续时间 </span>
string report<span class="token punctuation">;</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| TesterInit 函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTesterInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 设置优化的输入值 </span>
   <span class="token function">ParameterSetRange</span><span class="token punctuation">(</span><span class="token string">&quot;lots&quot;</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ParameterSetRange</span><span class="token punctuation">(</span><span class="token string">&quot;kATR&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">3.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">7.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ParameterSetRange</span><span class="token punctuation">(</span><span class="token string">&quot;ATRperiod&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ParameterSetRange</span><span class="token punctuation">(</span><span class="token string">&quot;holdbars&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ParameterSetRange</span><span class="token punctuation">(</span><span class="token string">&quot;slippage&quot;</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ParameterSetRange</span><span class="token punctuation">(</span><span class="token string">&quot;revers&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">ParameterSetRange</span><span class="token punctuation">(</span><span class="token string">&quot;EXPERT_MAGIC&quot;</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">123456</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Initial values and optimization parameter limitations are set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 记得开始优化 </span>
   optimization_start<span class="token operator">=</span><span class="token function">TimeLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   report<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: optimization launched at %s&quot;</span><span class="token punctuation">,</span> 
                       __FUNCTION__<span class="token punctuation">,</span><span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_MINUTES<span class="token operator">|</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 显示图表上和程序端日志中的消息 </span>
   <span class="token function">Print</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">Comment</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//---    </span>
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| TesterDeinit函数                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTesterDeinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 优化持续时间 </span>
   string log_message<span class="token operator">=</span><span class="token function">StringFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: optimization took %d seconds&quot;</span><span class="token punctuation">,</span> 
                                   __FUNCTION__<span class="token punctuation">,</span><span class="token function">TimeLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>optimization_start<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span>log_message<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   report<span class="token operator">=</span>report<span class="token operator">+</span><span class="token string">&quot;\r\n&quot;</span><span class="token operator">+</span>log_message<span class="token punctuation">;</span> 
   <span class="token function">Comment</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA交易初始化函数                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">OnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 初始化全局变量 </span>
   last_atr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
   last_body<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 设置正确的交易量 </span>
   <span class="token keyword">double</span> min_lot<span class="token operator">=</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>SYMBOL_VOLUME_MIN<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   trade_lot<span class="token operator">=</span>lots<span class="token operator">&gt;</span>min_lot<span class="token operator">?</span> lots<span class="token operator">:</span>min_lot<span class="token punctuation">;</span>    
<span class="token comment">//--- 创建ATR指标句柄 </span>
   atr_handle<span class="token operator">=</span><span class="token function">iATR</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">,</span>ATRperiod<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>atr_handle<span class="token operator">==</span>INVALID_HANDLE<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: failed to create iATR, error code %d&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- EA成功初始化 </span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>INIT_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| EA报价函数                                                        | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">OnTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 交易信号 </span>
   <span class="token keyword">static</span> <span class="token keyword">int</span> signal<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// +1表示买入信号， -1 表示卖出信号 </span>
<span class="token comment">//--- 检查和关闭‘holdbars’柱形图之前开仓的旧持仓 </span>
   <span class="token function">ClosePositionsByBars</span><span class="token punctuation">(</span>holdbars<span class="token punctuation">,</span>slippage<span class="token punctuation">,</span>EXPERT_MAGIC<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 检查新柱形图 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNewBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 检查信号是否存在      </span>
      signal<span class="token operator">=</span><span class="token function">CheckSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 如果持有单边持仓，跳过信号-等候直至关闭 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>signal<span class="token operator">!=</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PositionsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ENUM_ACCOUNT_MARGIN_MODE<span class="token punctuation">)</span><span class="token function">AccountInfoInteger</span><span class="token punctuation">(</span>ACCOUNT_MARGIN_MODE<span class="token punctuation">)</span><span class="token operator">==</span>ACCOUNT_MARGIN_MODE_RETAIL_NETTING<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      signal<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 退出NewTick事件处理程序，并在新柱形图出现之前不要进入市场 </span>
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 对于锁仓账户，每个持仓都是单独持仓和平仓 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>signal<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 买入信号 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>signal<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Buy signal! Revers=%s&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span><span class="token function">string</span><span class="token punctuation">(</span>revers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Buy</span><span class="token punctuation">(</span>trade_lot<span class="token punctuation">,</span>slippage<span class="token punctuation">,</span>EXPERT_MAGIC<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            signal<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      <span class="token comment">//--- 卖出信号 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>signal<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Sell signal! Revers=%s&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span><span class="token function">string</span><span class="token punctuation">(</span>revers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Sell</span><span class="token punctuation">(</span>trade_lot<span class="token punctuation">,</span>slippage<span class="token punctuation">,</span>EXPERT_MAGIC<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            signal<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- OnTick函数结束 </span>
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 检查新的交易信号                                                   | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">int</span> <span class="token function">CheckSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 0 意味着没有信号 </span>
   <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 获得倒数第二个完整柱形图的ATR值（柱形图索引是2） </span>
   <span class="token keyword">double</span> atr_value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>atr_handle<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>atr_value<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      last_atr<span class="token operator">=</span>atr_value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">//--- 获得最后关闭的柱形图的MqlRates类型数组数据 </span>
      MqlRates bar<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CopyRates</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>bar<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token comment">//--- 计算最后完整柱形图的柱体大小 </span>
         last_body<span class="token operator">=</span>bar<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>close<span class="token operator">-</span>bar<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>open<span class="token punctuation">;</span> 
         <span class="token comment">//--- 如果最后柱形图的柱体（索引为1）超过的之前ATR的值（柱形图索引为2），那么会收到一个交易信号 </span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MathAbs</span><span class="token punctuation">(</span>last_body<span class="token punctuation">)</span><span class="token operator">&gt;</span>kATR<span class="token operator">*</span>last_atr<span class="token punctuation">)</span> 
            res<span class="token operator">=</span>last_body<span class="token operator">&gt;</span><span class="token number">0</span><span class="token operator">?</span><span class="token number">1</span><span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 向上蜡烛图的正值 </span>
        <span class="token punctuation">}</span> 
      <span class="token keyword">else</span> 
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Failed to receive the last bar! Error&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
   <span class="token keyword">else</span> 
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Failed to receive ATR indicator value! Error&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果启用了反向交易模式 </span>
   res<span class="token operator">=</span>revers<span class="token operator">?</span><span class="token operator">-</span>res<span class="token operator">:</span>res<span class="token punctuation">;</span>  <span class="token comment">// 在必要时反转信号（返回-1而不是1，反之亦然） </span>
<span class="token comment">//--- 返回一个交易信号值 </span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//|  当新柱形图出现时返回'true'                                         | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">isNewBar</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">bool</span> print_log<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token keyword">static</span> datetime bartime<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//存储当前柱形图的开盘时间 </span>
<span class="token comment">//--- 获得零柱的开盘时间 </span>
   datetime currbar_time<span class="token operator">=</span><span class="token function">iTime</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>_Period<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 如果开盘时间更改，则新柱形图出现 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>bartime<span class="token operator">!=</span>currbar_time<span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      bartime<span class="token operator">=</span>currbar_time<span class="token punctuation">;</span> 
      lastbar_timeopen<span class="token operator">=</span>bartime<span class="token punctuation">;</span> 
      <span class="token comment">//--- 在日志中显示新柱形图开盘时间的数据       </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>print_log <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">MQLInfoInteger</span><span class="token punctuation">(</span>MQL_OPTIMIZATION<span class="token punctuation">)</span><span class="token operator">||</span><span class="token function">MQLInfoInteger</span><span class="token punctuation">(</span>MQL_TESTER<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token comment">//--- 显示新柱形图开盘时间的信息 </span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;%s: new bar on %s %s opened at %s&quot;</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>_Symbol<span class="token punctuation">,</span> 
                     <span class="token function">StringSubstr</span><span class="token punctuation">(</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>_Period<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                     <span class="token function">TimeToString</span><span class="token punctuation">(</span><span class="token function">TimeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 获取关于最后报价的数据 </span>
         MqlTick last_tick<span class="token punctuation">;</span> 
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SymbolInfoTick</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>last_tick<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;SymbolInfoTick() failed, error = &quot;</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 显示最后报价的时间，精确至毫秒 </span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Last tick was at %s.%03d&quot;</span><span class="token punctuation">,</span> 
                     <span class="token function">TimeToString</span><span class="token punctuation">(</span>last_tick<span class="token punctuation">.</span>time<span class="token punctuation">,</span>TIME_SECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span>last_tick<span class="token punctuation">.</span>time_msc<span class="token operator">%</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      <span class="token comment">//--- 我们有一个新柱形图 </span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 没有新柱形图 </span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 以指定交易量和市场价买入                                             | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">Buy</span><span class="token punctuation">(</span><span class="token keyword">double</span> volume<span class="token punctuation">,</span>ulong deviation<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>ulong  magicnumber<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 以市场价买入 </span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">MarketOrder</span><span class="token punctuation">(</span>ORDER_TYPE_BUY<span class="token punctuation">,</span>volume<span class="token punctuation">,</span>deviation<span class="token punctuation">,</span>magicnumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 以指定交易量和市场价卖出                                             | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">Sell</span><span class="token punctuation">(</span><span class="token keyword">double</span> volume<span class="token punctuation">,</span>ulong deviation<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>ulong  magicnumber<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 以市场价卖出 </span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">MarketOrder</span><span class="token punctuation">(</span>ORDER_TYPE_SELL<span class="token punctuation">,</span>volume<span class="token punctuation">,</span>deviation<span class="token punctuation">,</span>magicnumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 在柱形图中根据持有时间平仓                                           | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">void</span> <span class="token function">ClosePositionsByBars</span><span class="token punctuation">(</span><span class="token keyword">int</span> holdtimebars<span class="token punctuation">,</span>ulong deviation<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>ulong  magicnumber<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
   <span class="token keyword">int</span> total<span class="token operator">=</span><span class="token function">PositionsTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 持仓数量   </span>
<span class="token comment">//--- 重复持仓 </span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>total<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 持仓参数 </span>
      ulong  position_ticket<span class="token operator">=</span><span class="token function">PositionGetTicket</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                                      <span class="token comment">// 持仓单号 </span>
      string position_symbol<span class="token operator">=</span><span class="token function">PositionGetString</span><span class="token punctuation">(</span>POSITION_SYMBOL<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">//交易品种  </span>
      ulong  magic<span class="token operator">=</span><span class="token function">PositionGetInteger</span><span class="token punctuation">(</span>POSITION_MAGIC<span class="token punctuation">)</span><span class="token punctuation">;</span>                                  <span class="token comment">// 持仓幻数 </span>
      datetime position_open<span class="token operator">=</span><span class="token punctuation">(</span>datetime<span class="token punctuation">)</span><span class="token function">PositionGetInteger</span><span class="token punctuation">(</span>POSITION_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// 持仓开盘时间 </span>
      <span class="token keyword">int</span> bars<span class="token operator">=</span><span class="token function">iBarShift</span><span class="token punctuation">(</span>_Symbol<span class="token punctuation">,</span>PERIOD_CURRENT<span class="token punctuation">,</span>position_open<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                       <span class="token comment">// 开仓之前有多少柱形图 </span>
  
      <span class="token comment">//--- 如果持仓的生命周期很长，则幻数和交易品种匹配 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>bars<span class="token operator">&gt;</span>holdtimebars <span class="token operator">&amp;&amp;</span> magic<span class="token operator">==</span>magicnumber <span class="token operator">&amp;&amp;</span> position_symbol<span class="token operator">==</span>_Symbol<span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
         <span class="token keyword">int</span>    digits<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">SymbolInfoInteger</span><span class="token punctuation">(</span>position_symbol<span class="token punctuation">,</span>SYMBOL_DIGITS<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 小数位数 </span>
         <span class="token keyword">double</span> volume<span class="token operator">=</span><span class="token function">PositionGetDouble</span><span class="token punctuation">(</span>POSITION_VOLUME<span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">// 持仓交易量 </span>
         ENUM_POSITION_TYPE type<span class="token operator">=</span><span class="token punctuation">(</span>ENUM_POSITION_TYPE<span class="token punctuation">)</span><span class="token function">PositionGetInteger</span><span class="token punctuation">(</span>POSITION_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 持仓类型 </span>
         string str_type<span class="token operator">=</span><span class="token function">StringSubstr</span><span class="token punctuation">(</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token function">StringToLower</span><span class="token punctuation">(</span>str_type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//纠正消息格式的小写文本案例 </span>
         <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;Close position #%d %s %s %.2f&quot;</span><span class="token punctuation">,</span> 
                     position_ticket<span class="token punctuation">,</span>position_symbol<span class="token punctuation">,</span>str_type<span class="token punctuation">,</span>volume<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token comment">//--- 设置一个订单类型并发送交易请求 </span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>POSITION_TYPE_BUY<span class="token punctuation">)</span> 
            <span class="token function">MarketOrder</span><span class="token punctuation">(</span>ORDER_TYPE_SELL<span class="token punctuation">,</span>volume<span class="token punctuation">,</span>deviation<span class="token punctuation">,</span>magicnumber<span class="token punctuation">,</span>position_ticket<span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">else</span> 
            <span class="token function">MarketOrder</span><span class="token punctuation">(</span>ORDER_TYPE_BUY<span class="token punctuation">,</span>volume<span class="token punctuation">,</span>deviation<span class="token punctuation">,</span>magicnumber<span class="token punctuation">,</span>position_ticket<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span> 
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token comment">//| 准备和发送交易请求                                                  | </span>
<span class="token comment">//+------------------------------------------------------------------+ </span>
<span class="token keyword">bool</span> <span class="token function">MarketOrder</span><span class="token punctuation">(</span>ENUM_ORDER_TYPE type<span class="token punctuation">,</span><span class="token keyword">double</span> volume<span class="token punctuation">,</span>ulong slip<span class="token punctuation">,</span>ulong magicnumber<span class="token punctuation">,</span>ulong pos_ticket<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{</span> 
<span class="token comment">//--- 声明和初始化结构 </span>
   MqlTradeRequest request<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span> 
   MqlTradeResult  result<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span> 
   <span class="token keyword">double</span> price<span class="token operator">=</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SYMBOL_BID<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span>ORDER_TYPE_BUY<span class="token punctuation">)</span> 
      price<span class="token operator">=</span><span class="token function">SymbolInfoDouble</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SYMBOL_ASK<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//--- 请求参数 </span>
   request<span class="token punctuation">.</span>action   <span class="token operator">=</span>TRADE_ACTION_DEAL<span class="token punctuation">;</span>                     <span class="token comment">// 交易操作类型 </span>
   request<span class="token punctuation">.</span>position <span class="token operator">=</span>pos_ticket<span class="token punctuation">;</span>                            <span class="token comment">// 关闭情况下的持仓单号 </span>
   request<span class="token punctuation">.</span>symbol   <span class="token operator">=</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">// 交易品种 </span>
   request<span class="token punctuation">.</span>volume   <span class="token operator">=</span>volume<span class="token punctuation">;</span>                                <span class="token comment">// 交易量 </span>
   request<span class="token punctuation">.</span>type     <span class="token operator">=</span>type<span class="token punctuation">;</span>                                  <span class="token comment">// 订单类型 </span>
   request<span class="token punctuation">.</span>price    <span class="token operator">=</span>price<span class="token punctuation">;</span>                                 <span class="token comment">// 交易价格 </span>
   request<span class="token punctuation">.</span>deviation<span class="token operator">=</span>slip<span class="token punctuation">;</span>                                  <span class="token comment">// 可允许的价格偏差 </span>
   request<span class="token punctuation">.</span>magic    <span class="token operator">=</span>magicnumber<span class="token punctuation">;</span>                           <span class="token comment">// 订单幻数 </span>
<span class="token comment">//--- 发送请求 </span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OrderSend</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token punctuation">{</span> 
      <span class="token comment">//--- 显示数据失败 </span>
      <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;OrderSend %s %s %.2f at %.5f error %d&quot;</span><span class="token punctuation">,</span> 
                  request<span class="token punctuation">.</span>symbol<span class="token punctuation">,</span><span class="token function">EnumToString</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span>volume<span class="token punctuation">,</span>request<span class="token punctuation">.</span>price<span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment">//--- 通知成功操作 </span>
   <span class="token function">PrintFormat</span><span class="token punctuation">(</span><span class="token string">&quot;retcode=%u  deal=%I64u  order=%I64u&quot;</span><span class="token punctuation">,</span>result<span class="token punctuation">.</span>retcode<span class="token punctuation">,</span>result<span class="token punctuation">.</span>deal<span class="token punctuation">,</span>result<span class="token punctuation">.</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br></div></div><p>另见
测试交易策略、处理优化结果、OnTesterDeinit、 OnTesterPass、ParameterGetRange、ParameterSetRange</p> <h2 id="_13-13-ontesterdeinit"><a href="#_13-13-ontesterdeinit" class="header-anchor">#</a> 13.13 OnTesterDeinit</h2> <p>在EA优化之后，当TesterDeinit事件发生时在EA中调用这个函数。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>  <span class="token function">OnTesterDeinit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>返回值
无返回值</p> <p>注意
TesterDeinit事件在策略测试中的EA优化完成后生成。</p> <p>带有OnTesterDeInit()或OnTesterPass()事件处理程序的EA会在优化开始期间，在单独的程序端图表上自动下载。它包括测试中已经制定的交易品种和周期。该函数的设计目的是为最终处理所有的优化结果。</p> <p>请记住由测试代理使用FrameAdd()函数发送的优化框架可能会绑定在一起，并需要时间来交付。因此，不是所有的框架，以及TesterPass事件，可能在优化结束之前到达，并在OnTesterPass()中处理的。如果您想要得到OnTesterDeinit()中的所有迟到的框架，请使用FrameNext()函数来放置代码块。</p> <p>另见
测试交易策略、处理优化结果、TesterStatistics、 OnTesterInit、OnTesterPass、ParameterGetRange、 ParameterSetRange</p> <h2 id="_13-14-ontesterpass"><a href="#_13-14-ontesterpass" class="header-anchor">#</a> 13.14 OnTesterPass</h2> <p>当 TesterPass事件发生时，在EA中调用这个函数来处理EA优化期间的新数据框架。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>  <span class="token function">OnTesterPass</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>返回值
无返回值</p> <p>注意
TesterPass事件在接收策略测试中EA优化期间的框架时自动生成。</p> <p>带有OnTesterDeInit()或OnTesterPass()事件处理程序的EA会在优化开始期间，在单独的程序端图表上自动下载。它包括测试中已经制定的交易品种和周期。这个函数意味着处理优化期间从测试代理接收的框架。包含测试结果的框架应该使用FrameAdd()函数，从OnTester()处理程序来发送。</p> <p>请记住由测试代理使用FrameAdd()函数发送的优化框架可能会绑定在一起，并需要时间来交付。因此，不是所有的框架，以及TesterPass事件，可能在优化结束之前到达，并在OnTesterPass()中处理的。如果您想要得到OnTesterDeinit()中的所有迟到的框架，请使用FrameNext()函数来放置代码块。</p> <p>完成OnTesterDeinit()优化之后，可以使用FrameFirst()/FrameFilter和FrameNext()函数再次分类所有接收的框架。</p> <p>另见
测试交易策略、处理优化结果、OnTesterInit、 OnTesterDeinit、FrameFirst、FrameFilter、 FrameNext、FrameInputs</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mql5yao/Chapter/twelve.html" class="prev">
        12 第十二章 检测
      </a></span> <span class="next"><a href="/mql5yao/Chapter/fourteen.html">
        14 第十四章 市场信息
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/mql5yao/assets/js/app.f23448f4.js" defer></script><script src="/mql5yao/assets/js/3.a8269cb7.js" defer></script><script src="/mql5yao/assets/js/35.ee55e50b.js" defer></script>
  </body>
</html>
